<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>OFA | 出力（PDF / CSV）</title>
  <link rel="stylesheet" href="./style.css"/>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="h1">出力（PDF / CSV）</div>
      <div class="p">ドライバーも <b>日報PDF / 月報PDF / 月報CSV</b> を出力できます。</div>

      <div class="btnrow">
        <button class="btnGhost" onclick="location.href='./menu.html'">戻る</button>
      </div>

      <div style="margin-top:10px">
        <span id="roleBadge" class="badge"></span>
      </div>

      <div class="hr"></div>

      <div class="h2">日報PDF（指定日）</div>
      <div class="grid g2">
        <div>
          <label>対象日 <span class="req">*</span></label>
          <input id="day" type="date"/>
        </div>
        <div>
          <label>氏名（ドライバーは自動）</label>
          <input id="name" type="text" placeholder="例：森下 洸"/>
        </div>
      </div>
      <div class="btnrow">
        <button class="btnSub" id="dailyPdfBtn" type="button">日報PDFを作成（Drive保存→リンク）</button>
      </div>

      <div class="hr"></div>

      <div class="h2">月報CSV / 月報PDF（年月）</div>
      <div class="grid g2">
        <div>
          <label>対象年月 <span class="req">*</span></label>
          <input id="month" type="month"/>
        </div>
        <div>
          <label>氏名（ドライバーは自動）</label>
          <input id="mname" type="text" placeholder="例：森下 洸"/>
        </div>
      </div>
      <div class="btnrow">
        <button class="btnSub" id="monthlyCsvBtn" type="button">月報CSVを作成（ダウンロード）</button>
        <button class="btnSub" id="monthlyPdfBtn" type="button">月報PDFを作成（Drive保存→リンク）</button>
      </div>

      <div class="hr"></div>

      <div class="h2">管理者：全員検索（一覧）</div>
      <div class="p" id="adminNote"></div>
      <div class="btnrow">
        <button class="btn" id="adminListBtn" type="button">最新50件を表示</button>
      </div>
      <div id="list" style="margin-top:10px"></div>

      <div class="small" style="margin-top:10px">
        ※ドライバー名が端末に未保存の場合、先に「日常点呼」または「帰着点呼」を1回送信してください。<br/>
        （送信時に氏名を端末に記録し、以降は自動で出力できます）
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="./config.js"></script>
  <script src="./auth.js"></script>
  <script src="./utils.js"></script>
  <script>
    const role=requireLogin();
    const badge=document.getElementById("roleBadge");
    badge.textContent = role==="admin" ? "管理者ログイン中（全員出力可）" : "ドライバーログイン中（本人のみ）";
    badge.classList.add(role==="admin"?"admin":"driver");

    document.getElementById("day").value = todayISO();

    // ドライバーは本人名を自動固定
    const lastName = (localStorage.getItem("ofa_last_name")||"").trim();
    if(role!=="admin"){
      if(!lastName){
        toast("先に日常点呼または帰着点呼を1回送信してください（氏名を保存します）");
      }else{
        const n=document.getElementById("name");
        const mn=document.getElementById("mname");
        n.value=lastName; mn.value=lastName;
        n.readOnly=true; mn.readOnly=true;
      }
    }

    const adminNote=document.getElementById("adminNote");
    adminNote.textContent = role==="admin"
      ? "管理者は「氏名空欄」で全員対象にできます。"
      : "ドライバーは本人のみ出力（氏名は端末に固定されます）";

    function fixedName(inputId){
      const v=(document.getElementById(inputId).value||"").trim();
      if(role!=="admin" && !v) throw new Error("ドライバー氏名が未保存です。先に点呼を1回送信してください。");
      return v;
    }

    async function getJSON(params){
      const url = EXEC_URL + "?" + new URLSearchParams(params).toString();
      const res = await fetch(url, { method:"GET" });
      const text = await res.text();
      let json=null;
      try{ json=JSON.parse(text); }catch(e){ throw new Error("サーバー応答が不正です"); }
      if(!json.ok) throw new Error(json.error||"失敗");
      return json;
    }

    document.getElementById("dailyPdfBtn").onclick=async ()=>{
      try{
        toast("作成中...");
        const date = must("day","対象日");
        const name = fixedName("name");
        const r = await getJSON({ action:"dailyPdf", date, name, role });
        toast("作成完了");
        window.open(r.url, "_blank");
      }catch(e){ toast(e.message); }
    };

    document.getElementById("monthlyCsvBtn").onclick=async ()=>{
      try{
        toast("作成中...");
        const month = must("month","対象年月"); // YYYY-MM
        const name = fixedName("mname");
        const r = await getJSON({ action:"monthlyCsv", month, name, role });
        toast("作成完了");
        const a=document.createElement("a");
        a.href=r.url;
        a.download=r.filename || "monthly.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
      }catch(e){ toast(e.message); }
    };

    document.getElementById("monthlyPdfBtn").onclick=async ()=>{
      try{
        toast("作成中...");
        const month = must("month","対象年月");
        const name = fixedName("mname");
        const r = await getJSON({ action:"monthlyPdf", month, name, role });
        toast("作成完了");
        window.open(r.url, "_blank");
      }catch(e){ toast(e.message); }
    };

    document.getElementById("adminListBtn").onclick=async ()=>{
      try{
        if(role!=="admin") throw new Error("管理者のみ表示できます");
        toast("取得中...");
        const r = await getJSON({ action:"adminList" });
        const list=document.getElementById("list");
        list.innerHTML = r.items.map(it=>`
          <div class="card" style="margin:10px 0">
            <div class="small"><b>${it.datetime}</b> / ${it.type}</div>
            <div><b>${it.name}</b> / ${it.vehicleNo}</div>
            <div class="small">アルコール:${it.alcoholValue} / 免許:${it.licenseNo}</div>
          </div>
        `).join("");
        toast("表示しました");
      }catch(e){ toast(e.message); }
    };
  </script>
</body>
</html>
