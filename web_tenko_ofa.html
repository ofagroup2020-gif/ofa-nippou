<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OFA GROUP Webç‚¹å‘¼ãƒ»æ—¥å ±ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆDriveä¿å­˜ç‰ˆï¼‰</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --ofa-green:#17B978;
      --ofa-red:#E74C3C;
      --ofa-blue:#3498DB;
      --ofa-yellow:#F9CA24;
      --text-main:#2C3E50;
      --border:#E0E0E0;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:'Noto Sans JP',sans-serif;
      background:linear-gradient(180deg,#ff9f43,#ff6b6b,#9b59b6,#3498db,#2ecc71);
      background-attachment:fixed;
      color:var(--text-main);
      line-height:1.6;
    }
    .container{
      max-width:760px;
      margin:20px auto 40px;
      background:rgba(255,255,255,0.95);
      border-radius:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      overflow:hidden;
      backdrop-filter:blur(8px);
    }
    .header{
      background:linear-gradient(135deg,#ff7675,#f9ca24,#55efc4,#74b9ff,#a29bfe);
      background-size:300% 300%;
      animation: headerRainbow 12s ease infinite;
      color:#fff;
      padding:20px 16px 16px;
      text-align:center;
      position:relative;
    }
    @keyframes headerRainbow{
      0%{background-position:0% 50%;}
      50%{background-position:100% 50%;}
      100%{background-position:0% 50%;}
    }
    .header-top{
      display:flex;justify-content:center;align-items:center;gap:12px;margin-bottom:6px;
    }
    .header-logo-square{
      width:72px;height:72px;border-radius:16px;background:#fff;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 0 3px rgba(255,255,255,.7), 0 8px 18px rgba(0,0,0,.35);
    }
    .header-logo-square span{font-weight:900;font-size:30px;letter-spacing:1px;}
    .logo-o{color:#E74C3C;} .logo-f{color:#F1C40F;} .logo-a{color:#3498DB;}
    .header-brand-text{font-size:18px;font-weight:800;letter-spacing:2px;text-shadow:0 1px 3px rgba(0,0,0,.25);}
    .header-title{font-size:20px;font-weight:900;margin-top:4px;text-shadow:0 1px 3px rgba(0,0,0,.3);}
    .header-badges{
      margin-top:8px;display:flex;justify-content:center;flex-wrap:wrap;gap:6px;font-size:11px;
    }
    .header-badge{
      padding:4px 10px;border-radius:999px;
      background:rgba(255,255,255,.35);
      border:1px solid rgba(255,255,255,.8);
      backdrop-filter:blur(4px);
    }
    .tab-bar{display:flex;background:#fdfef9;border-bottom:1px solid #ecf0f1;}
    .tab-btn{
      flex:1;padding:10px 4px;border:none;background:none;font-weight:800;font-size:14px;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:4px;border-bottom:3px solid transparent;
    }
    .tab-btn span.icon{font-size:16px;}
    .tab-btn.active{border-bottom-color:var(--ofa-green);color:var(--ofa-green);background:#fff;}
    .content{padding:16px;}
    .section-title{
      margin:16px 0 10px;padding:8px 10px;background:#FDFBF5;border-radius:8px;
      font-weight:800;font-size:14px;color:#2d98da;position:relative;overflow:hidden;
    }
    .section-title::before{
      content:"";position:absolute;left:0;top:0;bottom:0;width:6px;
      background:linear-gradient(180deg,#ff7675,#f9ca24,#55efc4,#74b9ff,#a29bfe);
    }
    label{display:block;font-weight:800;font-size:13px;margin-top:12px;}
    .required-mark{color:var(--ofa-red);margin-left:4px;}
    input[type="text"],input[type="tel"],input[type="email"],input[type="date"],input[type="time"],input[type="number"],select,textarea{
      width:100%;padding:10px;margin-top:4px;border:1px solid var(--border);border-radius:12px;
      font-size:14px;background:#fbfffa;
    }
    textarea{resize:vertical;}
    .field-hint{font-size:11px;color:#777;margin-top:2px;}
    .small-note{font-size:12px;color:#555;background:#f7fbff;border:1px solid #e6f2ff;border-radius:10px;padding:10px;margin-top:10px;}
    .small-note b{color:#1f6fb2;}
    .radio-card-group{margin-top:8px;display:flex;gap:10px;flex-wrap:wrap;}
    .radio-card{
      flex:1 1 120px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;
      display:flex;align-items:center;gap:6px;font-size:13px;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.03);
    }
    .radio-card input{margin:0;}
    .primary-btn{
      width:100%;padding:14px;margin-top:20px;border:none;border-radius:999px;
      background:linear-gradient(135deg,#ff7675,#e74c3c);
      color:#fff;font-size:16px;font-weight:900;cursor:pointer;box-shadow:0 4px 0 #c0392b;
    }
    .primary-btn:active{transform:translateY(1px);box-shadow:none;}
    .primary-btn[disabled]{opacity:.55;cursor:not-allowed;box-shadow:none;transform:none;}
    .sub-btn{
      padding:8px 12px;border-radius:999px;border:none;font-size:12px;font-weight:900;cursor:pointer;
      display:inline-flex;align-items:center;gap:4px;margin:4px 6px 4px 0;
    }
    .sub-btn.gray{background:#f2f2f2;color:#555;}
    .sub-btn.blue{background:#eaf5ff;color:#2471a3;}
    .sub-btn.green{background:#e8fff3;color:#1e8449;}
    .sub-btn.danger{background:#fdecea;color:var(--ofa-red);}
    .message{margin-top:12px;font-size:13px;padding:10px 12px;border-radius:10px;display:none;}
    .message.success{display:block;background:#d4edda;color:#155724;}
    .message.error{display:block;background:#f8d7da;color:#721c24;}
    .message.info{display:block;background:#e8f4fd;color:#1b4f72;}
    .history-note{font-size:11px;color:#666;margin-bottom:4px;}
    .history-filter{
      margin:8px 0 10px;padding:10px;background:#f8f9f9;border-radius:12px;font-size:12px;border:1px solid #eee;
    }
    .history-filter-row{display:flex;align-items:center;gap:6px;margin-top:6px;}
    .history-filter-row input[type="date"]{flex:1;padding:8px 10px;font-size:12px;}
    #historyList{margin-top:10px;}
    .history-item{
      padding:10px 12px;border-radius:14px;border:1px solid #ddd;background:#fff;margin-bottom:8px;cursor:pointer;
      position:relative;box-shadow:0 2px 6px rgba(0,0,0,.08);
      display:flex;gap:8px;align-items:flex-start;
    }
    .history-item::after{
      content:"PDF";
      position:absolute;right:10px;top:8px;font-size:10px;padding:2px 6px;border-radius:999px;
      background:#ebf5fb;color:#2980b9;
    }
    .history-check{margin-top:4px;}
    .history-item-main{flex:1;}
    .history-item-title{font-size:14px;font-weight:900;}
    .history-item-sub{font-size:11px;color:#555;margin-top:2px;}
    .history-item-status{font-size:11px;margin-top:2px;color:#27ae60;}
    #pdfOutput{margin-top:10px;}
    .pdf-wrap{font-family:'Noto Sans JP',sans-serif;}
    .pdf-doc{
      border:1px solid #ccc;padding:16px 14px;margin-bottom:12px;background:#fff;border-radius:10px;
    }
    .pdf-header{text-align:center;border-bottom:3px solid var(--ofa-green);padding-bottom:6px;margin-bottom:10px;}
    .pdf-header-title{font-size:16px;font-weight:900;color:var(--ofa-blue);}
    .pdf-header-sub{font-size:11px;color:#555;}
    .pdf-section-box{margin-top:10px;}
    .pdf-section-title{
      background:#f8f9f9;padding:6px 8px;border-left:4px solid var(--ofa-yellow);
      font-size:12px;font-weight:900;color:var(--ofa-blue);margin-bottom:4px;
    }
    .pdf-row{display:flex;font-size:12px;padding:3px 0;border-bottom:1px dotted #eee;}
    .pdf-row-label{width:38%;font-weight:900;}
    .pdf-row-value{width:62%;}
    .pdf-status{
      margin:4px 0 6px;padding:6px 8px;font-size:11px;border-radius:6px;background:#d4edda;color:#155724;text-align:center;font-weight:800;
    }
    .pdf-status.incomplete{background:#fff3cd;color:#856404;}
    .month-table-wrap{overflow:auto;border:1px solid #e5e5e5;border-radius:10px;}
    table.month-table{width:100%;border-collapse:collapse;font-size:11px;min-width:760px;}
    .month-table th,.month-table td{border:1px solid #e5e5e5;padding:6px 6px;white-space:nowrap;}
    .month-table th{background:#1f5136;color:#fff;font-weight:900;}
    .month-table td{background:#fff;}
    .month-table .center{text-align:center;}
    .pill{
      display:inline-block;padding:2px 8px;border-radius:999px;font-size:10px;font-weight:900;
      border:1px solid #ddd;background:#f7f7f7;color:#555;
    }
    .pill.ok{background:#e8fff3;border-color:#baf2d1;color:#1e8449;}
    .pill.warn{background:#fff3cd;border-color:#ffeeba;color:#856404;}
    .a-link{color:#1f6fb2;text-decoration:underline;}
    .guide{margin-top:12px;border:1px solid #e7e7e7;border-radius:14px;background:#fff;overflow:hidden;}
    .guide .guide-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 14px;background:#f7fbff;font-weight:900;cursor:pointer;
    }
    .guide .guide-body{padding:12px 14px;display:none;font-size:13px;}
    .guide.open .guide-body{display:block;}
    .guide ul{margin:8px 0 0 18px;}
    .guide li{margin:6px 0;}
    body.printing{background:#fff !important;}
    @media print{
      body{background:#fff !important;}
      .container{box-shadow:none;border-radius:0;margin:0;max-width:none;}
      .header,.tab-bar,.content .form-area,.content .history-filter,.content .history-note,.content .top-actions{display:none !important;}
      #historyList{display:none !important;}
      #pdfOutput{margin:0 !important;}
      #pdfOutput .pdf-doc{border:none;margin:0;padding:10px 6px;}
      a{color:#000;text-decoration:none;}
    }
  </style>
</head>

<body>
<div class="container">
  <header class="header">
    <div class="header-top">
      <div class="header-logo-square">
        <span class="logo-o">O</span><span class="logo-f">F</span><span class="logo-a">A</span>
      </div>
      <div class="header-brand-text">OFA GROUP</div>
    </div>
    <div class="header-title">Webç‚¹å‘¼ãƒ»æ—¥å ±ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆDriveä¿å­˜ç‰ˆï¼‰</div>
    <div class="header-badges">
      <div class="header-badge">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å…¥åŠ› â†’ è¨¼è·¡ä¿å­˜</div>
      <div class="header-badge">å†™çœŸã¯Driveã¸ä¿å­˜ï¼ˆ60æ—¥ã§æ•´ç†ï¼‰</div>
      <div class="header-badge">æ—¥æ¬¡ãƒ»æœˆæ¬¡PDFå‡ºåŠ›</div>
    </div>
  </header>

  <div class="tab-bar">
    <button class="tab-btn active" data-tab="form"><span class="icon">ğŸ“</span>ç‚¹å‘¼ãƒ»æ—¥å ±å…¥åŠ›</button>
    <button class="tab-btn" data-tab="history"><span class="icon">ğŸ“„</span>å±¥æ­´ãƒ»æ¤œç´¢ãƒ»PDF</button>
  </div>

  <div class="content">
    <div id="tab_form" class="form-area">
      <div class="guide" id="guideBox">
        <div class="guide-head" id="guideToggle">
          <div>ğŸ“Œ ä½¿ã„æ–¹ï¼ˆã‚¿ãƒƒãƒ—ã§é–‹ãï¼‰</div>
          <div class="pill">ã‚¬ã‚¤ãƒ‰</div>
        </div>
        <div class="guide-body">
          <b>â‘  å‡ºç™ºç‚¹å‘¼</b> â†’ ä½“èª¿ãƒ»ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«å€¤ãƒ»è»Šç•ªãƒ»ç¢ºèªè€…ã‚’å…¥åŠ›ã—ä¿å­˜ã€‚<br/>
          <b>â‘¡ å¸°ç€ç‚¹å‘¼</b> â†’ åŒã˜æ—¥ä»˜ãƒ»åŒã˜ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã§å¸°ç€ã‚’å…¥åŠ›ã—ä¿å­˜ï¼ˆè‡ªå‹•ã§å‡ºç™ºè¨˜éŒ²ã«åˆä½“ï¼‰ã€‚<br/>
          <b>â‘¢ å±¥æ­´</b> â†’ æœŸé–“ã§çµã‚Šè¾¼ã¿ã€<b>æ—¥æ¬¡PDF</b>ï¼ˆ1ä»¶ï¼‰ or <b>æœˆæ¬¡PDF</b>ï¼ˆè¡¨ç¤ºä¸­ã¾ã¨ã‚ï¼‰ã‚’å‡ºåŠ›ã€‚<br/>
          <b>â‘£ å†™çœŸ</b> â†’ ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œçŸ¥å™¨ã®ç”»é¢å†™çœŸã‚’ã‚¢ãƒƒãƒ—ï¼ˆè‡ªå‹•åœ§ç¸®â†’Driveä¿å­˜ï¼‰ã€‚<br/><br/>
          <ul>
            <li>LINEå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§å°åˆ·ãŒä¸å®‰å®šãªæ™‚ã¯ã€ŒSafari/Chromeã§é–‹ãã€ã‚’æ¨å¥¨ã€‚</li>
            <li>å†™çœŸã¯ç«¯æœ«ã«ä¿å­˜ã—ã¾ã›ã‚“ï¼ˆDrive URLã ã‘å±¥æ­´ã«æ®‹ã—ã¾ã™ï¼‰ã€‚</li>
            <li>Driveå†…ã®å†™çœŸã¯<b>60æ—¥çµŒéã§è‡ªå‹•å‰Šé™¤ï¼ˆã‚´ãƒŸç®±ã¸ï¼‰</b>ã•ã‚Œã¾ã™ã€‚</li>
          </ul>
        </div>
      </div>

      <div class="small-note" style="margin-top:12px;">
        <b>Google Driveä¿å­˜ï¼š</b>GASï¼ˆWebã‚¢ãƒ—ãƒªï¼‰URLã‚’ã“ã®HTMLå†…ã«è¨­å®šã™ã‚Œã°å‹•ãã¾ã™ã€‚<br/>
        â€» å±¥æ­´ã¯<b>ã“ã®ç«¯æœ«ãƒ»ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶</b>ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆå†™çœŸã¯Driveã¸ï¼‰ã€‚
      </div>

      <form id="tenkoForm" autocomplete="off">
        <div class="section-title">0. ãƒ¢ãƒ¼ãƒ‰é¸æŠ</div>
        <label>ç‚¹å‘¼ãƒ¢ãƒ¼ãƒ‰ <span class="required-mark">*</span></label>
        <div class="radio-card-group">
          <label class="radio-card"><input type="radio" name="mode" value="å‡ºç™ºç‚¹å‘¼" checked>å‡ºç™ºç‚¹å‘¼</label>
          <label class="radio-card"><input type="radio" name="mode" value="å¸°ç€ç‚¹å‘¼">å¸°ç€ç‚¹å‘¼</label>
        </div>

        <div class="section-title">1. åŸºæœ¬æƒ…å ±</div>
        <label for="date">æ—¥ä»˜ <span class="required-mark">*</span></label>
        <input id="date" type="date" required>

        <label for="driverName">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å <span class="required-mark">*</span></label>
        <input id="driverName" type="text" required>

        <label for="company">æ‰€å±ä¼šç¤¾ <span class="required-mark">*</span></label>
        <input id="company" type="text" required>

        <label for="vehicleNo">è»Šä¸¡ç•ªå·ï¼ˆãƒŠãƒ³ãƒãƒ¼ï¼‰ <span class="required-mark">*</span></label>
        <input id="vehicleNo" type="text" placeholder="ä¾‹ï¼šé¹¿å…å³¶ 500 ã‚ 1234" required>

        <label for="checkerName">ç¢ºèªè€…ï¼ˆç‚¹å‘¼å®Ÿæ–½è€…ï¼‰ <span class="required-mark">*</span></label>
        <input id="checkerName" type="text" placeholder="ä¾‹ï¼šæ£®ä¸‹ / æ‹…å½“è€…å" required>

        <label for="tel">é›»è©±ç•ªå· <span class="required-mark">*</span></label>
        <input id="tel" type="tel" required>

        <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰</label>
        <input id="email" type="email">

        <label for="client">æ¡ˆä»¶ï¼ˆè·ä¸»ï¼‰</label>
        <input id="client" type="text">

        <label for="area">ã‚¨ãƒªã‚¢ï¼ˆéƒ½é“åºœçœŒï¼‰</label>
        <input id="area" type="text" placeholder="ä¾‹: é¹¿å…å³¶çœŒ / ç†Šæœ¬çœŒãªã©">

        <div id="section_departure">
          <div class="section-title">2. å‡ºç™ºå‰ãƒã‚§ãƒƒã‚¯</div>

          <label for="startPlace">å‡ºç™ºå ´æ‰€ï¼ˆè‡ªå®…ã€ã‚‚ã—ãã¯äº‹å‹™æ‰€ï¼‰</label>
          <input id="startPlace" type="text">

          <label for="workTime">å‡ºå‹¤æ™‚é–“</label>
          <input id="workTime" type="time">

          <label for="startTime">å‡ºç™ºæ™‚é–“ <span class="required-mark">*</span></label>
          <input id="startTime" type="time" required>

          <label for="condition">ä½“èª¿ <span class="required-mark">*</span></label>
          <select id="condition" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="è‰¯å¥½">è‰¯å¥½</option>
            <option value="æ™®é€š">æ™®é€š</option>
            <option value="ä¸èª¿">ä¸èª¿</option>
          </select>

          <label for="sleep">ç¡çœ æ™‚é–“ï¼ˆæ™‚é–“ï¼‰</label>
          <input id="sleep" type="number" step="0.5" placeholder="ä¾‹: 6.5">

          <label>é£²é…’ï¼ˆ24hä»¥å†…ï¼‰ <span class="required-mark">*</span></label>
          <div class="radio-card-group">
            <label class="radio-card"><input type="radio" name="drink" value="ãªã—" checked>ãªã—</label>
            <label class="radio-card"><input type="radio" name="drink" value="ã‚ã‚Š">ã‚ã‚Š</label>
          </div>

          <label>æœè–¬ï¼ˆé‹è»¢ã«å½±éŸ¿ã™ã‚‹è–¬ï¼‰</label>
          <div class="radio-card-group">
            <label class="radio-card"><input type="radio" name="medicine" value="ãªã—" checked>ãªã—</label>
            <label class="radio-card"><input type="radio" name="medicine" value="ã‚ã‚Š">ã‚ã‚Š</label>
          </div>

          <label for="temp">ä½“æ¸© (â„ƒ) <span class="required-mark">*</span></label>
          <input id="temp" type="number" step="0.1" required>

          <label for="alcoholValue">ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œæŸ»å€¤ (mg/L) <span class="required-mark">*</span></label>
          <input id="alcoholValue" type="text" required placeholder="ä¾‹: 0.00">

          <label for="startAlcoholPhoto">ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œæŸ» å†™çœŸï¼ˆå‡ºç™ºï¼‰ <span class="required-mark">*</span></label>
          <input id="startAlcoholPhoto" type="file" accept="image/*" required>
          <div class="field-hint">â€»è‡ªå‹•ã§åœ§ç¸®ã—ã¦Google Driveã¸ä¿å­˜ã—ã¾ã™ã€‚</div>

          <label for="startMeter">å‡ºç™ºå‰ãƒ¡ãƒ¼ã‚¿ãƒ¼ (km) <span class="required-mark">*</span></label>
          <input id="startMeter" type="number" required>
        </div>

        <div id="section_return" style="display:none;">
          <div class="section-title">2. å¸°ç€è¨˜éŒ²</div>

          <label for="returnPlace">å¸°ç€å ´æ‰€ <span class="required-mark">*</span></label>
          <input id="returnPlace" type="text" required>

          <label for="returnTime">å¸°ç€æ™‚é–“ï¼ˆè‡ªå®…ã‚‚ã—ãã¯äº‹å‹™æ‰€ï¼‰ <span class="required-mark">*</span></label>
          <input id="returnTime" type="time" required>

          <label for="returnAlcoholValue">ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œæŸ»å€¤ï¼ˆå¸°ç€ï¼‰(mg/L) <span class="required-mark">*</span></label>
          <input id="returnAlcoholValue" type="text" required placeholder="ä¾‹: 0.00">

          <label for="endAlcoholPhoto">ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œæŸ» å†™çœŸï¼ˆå¸°ç€ï¼‰ <span class="required-mark">*</span></label>
          <input id="endAlcoholPhoto" type="file" accept="image/*" required>
          <div class="field-hint">â€»è‡ªå‹•ã§åœ§ç¸®ã—ã¦Google Driveã¸ä¿å­˜ã—ã¾ã™ã€‚</div>

          <label for="returnMeter">å¸°ç€ãƒ¡ãƒ¼ã‚¿ãƒ¼ (km) <span class="required-mark">*</span></label>
          <input id="returnMeter" type="number" required>
        </div>

        <button id="saveBtn" type="submit" class="primary-btn">ã“ã®è¨˜éŒ²ã‚’ä¿å­˜ï¼ˆå†™çœŸã¯Driveã¸ï¼‰</button>
      </form>

      <div id="message" class="message"></div>
    </div>

    <div id="tab_history" style="display:none;">
      <div class="section-title" style="margin-top:0;">ä¿å­˜ã•ã‚ŒãŸç‚¹å‘¼å±¥æ­´</div>
      <div class="history-note">â€»ã“ã®ç«¯æœ«ãƒ»ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã ã‘å±¥æ­´ãŒä¿å­˜ã•ã‚Œã¾ã™ï¼ˆå†™çœŸã¯Drive URLã‚’ä¿å­˜ï¼‰</div>

      <div class="history-filter">
        <div><b>æœŸé–“ã§çµã‚Šè¾¼ã¿</b></div>
        <div class="history-filter-row">
          <input id="historyFrom" type="date">
          <span>ã€œ</span>
          <input id="historyTo" type="date">
        </div>
        <div style="margin-top:8px;">
          <button type="button" class="sub-btn gray" id="filterApplyBtn">ã“ã®æœŸé–“ã§çµã‚Šè¾¼ã¿</button>
          <button type="button" class="sub-btn gray" id="filterClearBtn">çµã‚Šè¾¼ã¿è§£é™¤</button>
          <button type="button" class="sub-btn blue" id="setThisMonthBtn">ä»Šæœˆ</button>
        </div>
      </div>

      <div id="historyList"></div>

      <div style="margin-top:10px;">
        <button type="button" class="sub-btn green" id="pdfPrintBtn" style="display:none;">è¡¨ç¤ºä¸­PDFã‚’å°åˆ· / ä¿å­˜</button>
        <button type="button" class="sub-btn gray" id="pdfBackBtn" style="display:none;">ä¸€è¦§ã«æˆ»ã‚‹</button>
        <button type="button" class="sub-btn blue" id="monthPdfBtn">è¡¨ç¤ºä¸­ã‚’æœˆæ¬¡PDFï¼ˆä¸€è¦§ï¼‰</button>
      </div>

      <div id="pdfOutput"></div>
    </div>
  </div>
</div>

<script>
/**
 * â˜…GAS Webã‚¢ãƒ—ãƒªURLï¼ˆ/exec ã¾ã§å«ã‚€ï¼‰
 */
const GAS_URL = "https://script.google.com/macros/s/AKfycbwfbh0zX5XdC8tpUOBwcmQKbXmK4COcV-_ozQKEnzdOunRqvGXh9ZYKuIr3qhpQO4o0/exec";

const LOCAL_KEY = "ofaGroupRecords_v2_drive";
const IMG_MAX_SIZE = 1280;
const IMG_QUALITY  = 0.72;

const form = document.getElementById("tenkoForm");
const messageBox = document.getElementById("message");
const saveBtn = document.getElementById("saveBtn");

const modeRadios = document.querySelectorAll('input[name="mode"]');
const sectionDeparture = document.getElementById("section_departure");
const sectionReturn = document.getElementById("section_return");

const historyList = document.getElementById("historyList");
const pdfOutput = document.getElementById("pdfOutput");
const pdfPrintBtn = document.getElementById("pdfPrintBtn");
const pdfBackBtn = document.getElementById("pdfBackBtn");
const monthPdfBtn = document.getElementById("monthPdfBtn");
const historyFrom = document.getElementById("historyFrom");
const historyTo = document.getElementById("historyTo");

let currentFilter = {from:null,to:null};

document.getElementById("date").value = new Date().toISOString().slice(0,10);

// ã‚¬ã‚¤ãƒ‰
document.getElementById("guideToggle").addEventListener("click",()=>{
  document.getElementById("guideBox").classList.toggle("open");
});

// ã‚¿ãƒ–
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    document.getElementById("tab_form").style.display = tab==="form" ? "block" : "none";
    document.getElementById("tab_history").style.display = tab==="history" ? "block" : "none";
    if(tab==="history"){
      resetPdfView();
      renderHistory();
    }
  });
});

// requiredåˆ‡æ›¿
const departureRequiredIds = ["startTime","condition","temp","alcoholValue","startMeter","startAlcoholPhoto"];
const returnRequiredIds = ["returnPlace","returnTime","returnMeter","returnAlcoholValue","endAlcoholPhoto"];
function setRequired(ids, flag){
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.required = flag;
  });
}
function updateModeView(){
  const mode = document.querySelector('input[name="mode"]:checked')?.value || "å‡ºç™ºç‚¹å‘¼";
  const isDeparture = (mode==="å‡ºç™ºç‚¹å‘¼");
  sectionDeparture.style.display = isDeparture ? "block" : "none";
  sectionReturn.style.display    = isDeparture ? "none"  : "block";
  setRequired(departureRequiredIds, isDeparture);
  setRequired(returnRequiredIds, !isDeparture);
}
modeRadios.forEach(r=>r.addEventListener("change",updateModeView));
updateModeView();

function getRecords(){
  const raw = localStorage.getItem(LOCAL_KEY);
  return raw ? JSON.parse(raw) : [];
}
function setRecords(list){
  localStorage.setItem(LOCAL_KEY, JSON.stringify(list));
}
function showMessage(text, type="success"){
  messageBox.textContent = text;
  messageBox.className = "message " + (type==="error" ? "error" : type==="info" ? "info" : "success");
}
function applyFilter(list){
  return list.filter(r=>{
    if(currentFilter.from && r.date < currentFilter.from) return false;
    if(currentFilter.to && r.date > currentFilter.to) return false;
    return true;
  });
}

// ãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³
document.getElementById("filterApplyBtn").addEventListener("click",()=>{
  currentFilter.from = historyFrom.value || null;
  currentFilter.to   = historyTo.value   || null;
  resetPdfView();
  renderHistory();
});
document.getElementById("filterClearBtn").addEventListener("click",()=>{
  historyFrom.value = "";
  historyTo.value = "";
  currentFilter = {from:null,to:null};
  resetPdfView();
  renderHistory();
});
document.getElementById("setThisMonthBtn").addEventListener("click",()=>{
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,"0");
  historyFrom.value = `${y}-${m}-01`;
  historyTo.value = new Date(y, now.getMonth()+1, 0).toISOString().slice(0,10);
  currentFilter.from = historyFrom.value;
  currentFilter.to = historyTo.value;
  resetPdfView();
  renderHistory();
});

// ç”»åƒåœ§ç¸®
function fileToCompressedDataURL(file, maxSize=IMG_MAX_SIZE, quality=IMG_QUALITY){
  return new Promise((resolve, reject)=>{
    if(!file) return resolve(null);
    const reader = new FileReader();
    reader.onload = ()=>{
      const img = new Image();
      img.onload = ()=>{
        const w = img.width, h = img.height;
        let nw=w, nh=h;
        const longSide = Math.max(w,h);
        if(longSide > maxSize){
          const scale = maxSize / longSide;
          nw = Math.round(w * scale);
          nh = Math.round(h * scale);
        }
        const canvas = document.createElement("canvas");
        canvas.width = nw; canvas.height = nh;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, nw, nh);
        resolve(canvas.toDataURL("image/jpeg", quality));
      };
      img.onerror = ()=>reject(new Error("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—"));
      img.src = reader.result;
    };
    reader.onerror = ()=>reject(new Error("ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•—"));
    reader.readAsDataURL(file);
  });
}

// GASã¸é€ä¿¡
async function uploadAlcoholPhotosToDrive(payload){
  if(!GAS_URL || GAS_URL.includes("PASTE_YOUR_GAS_WEBAPP_URL_HERE")){
    throw new Error("GAS_URL æœªè¨­å®šã§ã™ï¼ˆHTMLå†…ã®GAS_URLã« /exec ã‚’è²¼ã£ã¦ãã ã•ã„ï¼‰");
  }
  const res = await fetch(GAS_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload),
    mode:"cors"
  });
  const data = await res.json().catch(()=>null);
  if(!data || !data.ok) throw new Error(data?.error || "Driveä¿å­˜ã«å¤±æ•—");
  return data.urls || {};
}

// ä¿å­˜
form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const mode = document.querySelector('input[name="mode"]:checked').value;

  saveBtn.disabled = true;
  showMessage("ä¿å­˜ä¸­â€¦ï¼ˆå†™çœŸã‚’åœ§ç¸®â†’Driveã¸ä¿å­˜ï¼‰", "info");

  try{
    const base = {
      id: Date.now(),
      date: document.getElementById("date").value,
      driverName: document.getElementById("driverName").value.trim(),
      company: document.getElementById("company").value.trim(),
      vehicleNo: document.getElementById("vehicleNo").value.trim(),
      checkerName: document.getElementById("checkerName").value.trim(),
      tel: document.getElementById("tel").value.trim(),
      email: document.getElementById("email").value.trim(),
      client: document.getElementById("client").value.trim(),
      area: document.getElementById("area").value.trim(),
      modeLast: mode,
      submitTime: new Date().toLocaleTimeString("ja-JP"),
    };

    let records = getRecords();

    if(mode === "å‡ºç™ºç‚¹å‘¼"){
      const startFile = document.getElementById("startAlcoholPhoto").files?.[0] || null;
      const startDataUrl = await fileToCompressedDataURL(startFile);

      const uploaded = await uploadAlcoholPhotosToDrive({
        date: base.date, driver: base.driverName, vehicle: base.vehicleNo,
        startAlcoholPhoto: startDataUrl
      });

      const rec = {
        ...base,
        startTime: document.getElementById("startTime").value,
        condition: document.getElementById("condition").value,
        temp: document.getElementById("temp").value,
        alcoholValue: document.getElementById("alcoholValue").value.trim(),
        startAlcoholPhotoUrl: uploaded.startAlcoholPhotoUrl || "",
        startMeter: document.getElementById("startMeter").value,
      };

      records.push(rec);
      records.sort((a,b)=>b.id-a.id);
      setRecords(records);
      showMessage("âœ… å‡ºç™ºç‚¹å‘¼ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆå†™çœŸã¯Driveã¸ä¿å­˜æ¸ˆã¿ï¼‰", "success");

    }else{
      const endFile = document.getElementById("endAlcoholPhoto").files?.[0] || null;
      const endDataUrl = await fileToCompressedDataURL(endFile);

      const uploaded = await uploadAlcoholPhotosToDrive({
        date: base.date, driver: base.driverName, vehicle: base.vehicleNo,
        endAlcoholPhoto: endDataUrl
      });

      const depIndex = records.findIndex(r =>
        r.date === base.date &&
        r.driverName === base.driverName &&
        r.company === base.company &&
        r.vehicleNo === base.vehicleNo &&
        !r.returnTime
      );

      const retPart = {
        returnPlace: document.getElementById("returnPlace").value.trim(),
        returnTime: document.getElementById("returnTime").value,
        returnAlcoholValue: document.getElementById("returnAlcoholValue").value.trim(),
        endAlcoholPhotoUrl: uploaded.endAlcoholPhotoUrl || "",
        returnMeter: document.getElementById("returnMeter").value,
      };

      if(depIndex !== -1){
        records[depIndex] = { ...records[depIndex], ...retPart, modeLast:"å‡ºç™ºãƒ»å¸°ç€" };
        setRecords(records);
        showMessage("âœ… å‡ºç™ºè¨˜éŒ²ã«å¸°ç€ç‚¹å‘¼ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆå†™çœŸã¯Driveã¸ä¿å­˜æ¸ˆã¿ï¼‰", "success");
      }else{
        records.push({ ...base, ...retPart });
        records.sort((a,b)=>b.id-a.id);
        setRecords(records);
        showMessage("âœ… å¸°ç€ç‚¹å‘¼ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆå†™çœŸã¯Driveã¸ä¿å­˜æ¸ˆã¿ï¼‰", "success");
      }
    }

    form.reset();
    document.getElementById("date").value = new Date().toISOString().slice(0,10);
    updateModeView();

  }catch(err){
    showMessage("âŒ " + (err?.message || String(err)), "error");
  }finally{
    saveBtn.disabled = false;
  }
});

// å±¥æ­´
function renderHistory(){
  const all = getRecords();
  const list = applyFilter(all);
  historyList.innerHTML = "";
  if(list.length === 0){
    historyList.innerHTML = '<p style="text-align:center;color:#777;padding:12px;">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
    return;
  }
  list.forEach(rec=>{
    const statusLabel = rec.returnTime ? "å‡ºç™ºãƒ»å¸°ç€ è¨˜éŒ²æ¸ˆã¿" : (rec.startTime ? "å‡ºç™ºç‚¹å‘¼ã®ã¿" : "å¸°ç€ç‚¹å‘¼ã®ã¿");
    const div = document.createElement("div");
    div.className = "history-item";
    div.innerHTML = `
      <div class="history-item-main">
        <div class="history-item-title">${rec.date} / ${statusLabel}</div>
        <div class="history-item-sub">${rec.driverName || "-"} / ${rec.company || "-"} / ${rec.vehicleNo || "-"}</div>
        <div class="history-item-status">ç¢ºèªè€…: ${rec.checkerName || "-"} / æœ€çµ‚: ${rec.modeLast || "-"}</div>
      </div>`;
    div.addEventListener("click",()=>showRecordPdf(rec));
    historyList.appendChild(div);
  });
}
function resetPdfView(){
  pdfOutput.innerHTML = "";
  pdfPrintBtn.style.display = "none";
  pdfBackBtn.style.display = "none";
  historyList.style.display = "block";
}
pdfBackBtn.addEventListener("click", resetPdfView);

function buildSinglePdfHtml(rec){
  const startPhotoLink = rec.startAlcoholPhotoUrl ? `<a class="a-link" href="${rec.startAlcoholPhotoUrl}" target="_blank" rel="noopener">å†™çœŸã‚’é–‹ã</a>` : "-";
  const endPhotoLink = rec.endAlcoholPhotoUrl ? `<a class="a-link" href="${rec.endAlcoholPhotoUrl}" target="_blank" rel="noopener">å†™çœŸã‚’é–‹ã</a>` : "-";
  const completed = !!rec.returnTime;

  return `
    <div class="pdf-wrap">
      <div class="pdf-doc">
        <div class="pdf-header">
          <div class="pdf-header-title">OFA GROUP Webç‚¹å‘¼ï¼ˆDriveä¿å­˜ç‰ˆï¼‰</div>
          <div class="pdf-header-sub">${rec.date || "-"} / ${rec.driverName || "-"} / ${rec.company || "-"}</div>
        </div>
        <div class="pdf-status ${completed ? "" : "incomplete"}">
          ${completed ? "å‡ºç™ºãƒ»å¸°ç€ã¨ã‚‚ã«è¨˜éŒ²æ¸ˆã¿" : (rec.startTime ? "å‡ºç™ºç‚¹å‘¼ã®ã¿" : "å¸°ç€ç‚¹å‘¼ã®ã¿")}
        </div>

        <div class="pdf-section-box">
          <div class="pdf-section-title">åŸºæœ¬æƒ…å ±</div>
          <div class="pdf-row"><div class="pdf-row-label">è»Šä¸¡ç•ªå·</div><div class="pdf-row-value">${rec.vehicleNo || "-"}</div></div>
          <div class="pdf-row"><div class="pdf-row-label">ç¢ºèªè€…</div><div class="pdf-row-value">${rec.checkerName || "-"}</div></div>
        </div>

        ${rec.startTime ? `
        <div class="pdf-section-box">
          <div class="pdf-section-title">å‡ºç™º</div>
          <div class="pdf-row"><div class="pdf-row-label">å‡ºç™ºæ™‚é–“</div><div class="pdf-row-value">${rec.startTime || "-"}</div></div>
          <div class="pdf-row"><div class="pdf-row-label">ä½“æ¸©</div><div class="pdf-row-value">${rec.temp || "-"}â„ƒ</div></div>
          <div class="pdf-row"><div class="pdf-row-label">ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«å€¤</div><div class="pdf-row-value">${rec.alcoholValue || "-"} mg/L</div></div>
          <div class="pdf-row"><div class="pdf-row-label">å†™çœŸ</div><div class="pdf-row-value">${startPhotoLink}</div></div>
        </div>` : ""}

        ${rec.returnTime ? `
        <div class="pdf-section-box">
          <div class="pdf-section-title">å¸°ç€</div>
          <div class="pdf-row"><div class="pdf-row-label">å¸°ç€æ™‚é–“</div><div class="pdf-row-value">${rec.returnTime || "-"}></div></div>
          <div class="pdf-row"><div class="pdf-row-label">ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«å€¤</div><div class="pdf-row-value">${rec.returnAlcoholValue || "-"} mg/L</div></div>
          <div class="pdf-row"><div class="pdf-row-label">å†™çœŸ</div><div class="pdf-row-value">${endPhotoLink}</div></div>
        </div>` : ""}

      </div>
    </div>
  `;
}
function showRecordPdf(rec){
  pdfOutput.innerHTML = buildSinglePdfHtml(rec);
  pdfPrintBtn.style.display = "inline-flex";
  pdfBackBtn.style.display = "inline-flex";
  historyList.style.display = "none";
}
pdfPrintBtn.addEventListener("click", ()=>{
  document.body.classList.add("printing");
  setTimeout(()=>{
    window.print();
    setTimeout(()=>document.body.classList.remove("printing"), 300);
  }, 200);
});

function buildMonthPdfHtml(list){
  const sorted = [...list].sort((a,b)=> (a.date>b.date?1:a.date<b.date?-1:0));
  const fromTo = (currentFilter.from || "â€”") + " ã€œ " + (currentFilter.to || "â€”");
  const pill = (v)=>{
    if(v===undefined || v===null || v==="") return `<span class="pill warn">æœª</span>`;
    const s = String(v).trim();
    if(s==="0" || s==="0.0" || s==="0.00") return `<span class="pill ok">0.00</span>`;
    return `<span class="pill">${s}</span>`;
  };

  let html = `
    <div class="pdf-wrap">
      <div class="pdf-doc">
        <div class="pdf-header">
          <div class="pdf-header-title">ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ æœˆæ¬¡ä¸€è¦§ï¼ˆè¡¨ç¤ºä¸­ï¼‰</div>
          <div class="pdf-header-sub">æœŸé–“ï¼š${fromTo} / å‡ºåŠ›ï¼š${new Date().toLocaleString("ja-JP")}</div>
        </div>
        <div class="month-table-wrap">
          <table class="month-table">
            <thead>
              <tr>
                <th>æ—¥ä»˜</th><th>é‹è»¢è€…</th><th>è»Šä¸¡ç•ªå·</th>
                <th class="center">(å‡ºç™º)æ™‚åˆ»</th><th class="center">(å‡ºç™º)å€¤</th><th class="center">(å‡ºç™º)å†™çœŸ</th>
                <th class="center">(å¸°ç€)æ™‚åˆ»</th><th class="center">(å¸°ç€)å€¤</th><th class="center">(å¸°ç€)å†™çœŸ</th>
                <th>ç¢ºèªè€…</th><th>æ‰€å±</th>
              </tr>
            </thead>
            <tbody>
  `;
  sorted.forEach(r=>{
    const startLink = r.startAlcoholPhotoUrl ? `<a class="a-link" href="${r.startAlcoholPhotoUrl}" target="_blank" rel="noopener">é–‹ã</a>` : "-";
    const endLink = r.endAlcoholPhotoUrl ? `<a class="a-link" href="${r.endAlcoholPhotoUrl}" target="_blank" rel="noopener">é–‹ã</a>` : "-";
    html += `
      <tr>
        <td>${r.date||"-"}</td><td>${r.driverName||"-"}</td><td>${r.vehicleNo||"-"}</td>
        <td class="center">${r.startTime||"-"}</td><td class="center">${pill(r.alcoholValue)}</td><td class="center">${startLink}</td>
        <td class="center">${r.returnTime||"-"}</td><td class="center">${pill(r.returnAlcoholValue)}</td><td class="center">${endLink}</td>
        <td>${r.checkerName||"-"}</td><td>${r.company||"-"}</td>
      </tr>`;
  });

  html += `
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
  return html;
}
monthPdfBtn.addEventListener("click", ()=>{
  const list = applyFilter(getRecords());
  if(!list.length){ alert("è¡¨ç¤ºä¸­ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
  pdfOutput.innerHTML = buildMonthPdfHtml(list);
  pdfPrintBtn.style.display = "inline-flex";
  pdfBackBtn.style.display = "inline-flex";
  historyList.style.display = "none";
});

renderHistory();
</script>
</body>
</html>
