<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>OFAï½œWebç‚¹å‘¼ãƒ»æ—¥å ±ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆDriveä¿å­˜ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg1:#24b36b;
      --bg2:#6fd18a;
      --card:#ffffff;
      --text:#1d2a2a;
      --muted:#6b7b7b;
      --line:#e7ecec;
      --accent:#2b7cff;
      --accent2:#00b894;
      --danger:#ff4d4f;
      --btn:#ff5a5f;
      --btn2:#ff7a3d;
      --shadow: 0 10px 24px rgba(0,0,0,.10);
      --radius: 18px;
      --radius2: 14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(180deg, var(--bg2), var(--bg1));
      min-height:100vh;
      padding: 18px 12px 80px;
    }

    .wrap{max-width: 820px; margin: 0 auto;}
    .hero{
      border-radius: 24px;
      background: linear-gradient(135deg, #33c3a5, #58a8ff);
      padding: 22px 18px 18px;
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-40px -60px auto auto;
      width:220px; height:220px;
      background: rgba(255,255,255,.18);
      border-radius: 50%;
      transform: rotate(10deg);
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:64px;height:64px;border-radius:16px;
      background:#fff;
      display:grid;place-items:center;
      box-shadow: 0 8px 18px rgba(0,0,0,.12);
      flex:0 0 auto;
    }
    .logo span{
      font-weight:900;
      letter-spacing:.06em;
      font-size: 26px;
      background: linear-gradient(90deg,#ff4d4f,#ffb300,#2ecc71,#2b7cff);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .brand h1{
      margin:0;
      color:#fff;
      font-size: 20px;
      line-height:1.25;
      letter-spacing:.02em;
      text-shadow: 0 2px 10px rgba(0,0,0,.18);
    }
    .chips{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top: 12px;
    }
    .chip{
      background: rgba(255,255,255,.18);
      color:#fff;
      border: 1px solid rgba(255,255,255,.32);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      backdrop-filter: blur(6px);
      white-space: nowrap;
    }

    .card{
      margin-top: 12px;
      background: rgba(255,255,255,.92);
      border-radius: 24px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .tabs{
      display:flex;
      gap: 0;
      background: #f7f9f9;
      border-bottom: 1px solid var(--line);
    }
    .tab{
      flex:1;
      padding: 14px 10px;
      text-align:center;
      font-weight: 800;
      color: #2c3e50;
      cursor:pointer;
      position:relative;
      user-select:none;
    }
    .tab small{font-weight:700;color:var(--muted)}
    .tab.active{
      background:#fff;
    }
    .tab.active:after{
      content:"";
      position:absolute;
      left: 20px; right: 20px; bottom: 0px;
      height: 3px;
      background: linear-gradient(90deg, #00b894, #2b7cff);
      border-radius: 99px;
    }

    .pane{display:none; padding: 16px 14px 18px;}
    .pane.active{display:block;}

    .sectionTitle{
      display:flex;align-items:center;gap:8px;
      font-weight: 900;
      margin: 2px 0 10px;
      color:#1f2d2d;
    }
    .sectionTitle .emoji{
      width:26px;height:26px;border-radius:8px;
      background: linear-gradient(135deg,#ffd166,#06d6a0);
      display:grid;place-items:center;
      font-size: 16px;
    }
    .note{
      color: var(--muted);
      font-size: 12px;
      margin: 6px 0 14px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 720px){
      .grid.two{grid-template-columns: 1fr 1fr;}
      .grid.three{grid-template-columns: 1fr 1fr 1fr;}
    }

    label{
      display:block;
      font-weight: 800;
      font-size: 13px;
      margin-bottom: 6px;
      color:#243636;
    }
    .req{color: var(--danger); margin-left: 4px;}
    input, select, textarea{
      width:100%;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 16px;
      outline:none;
      background: #fff;
    }
    input[readonly]{
      background:#f2f5f5;
      color:#2c3e50;
    }
    textarea{min-height: 90px; resize: vertical;}

    .radioRow{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .pill{
      flex:1 1 140px;
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 10px 12px;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .pill input{width:auto}
    .pill.active{
      border-color: rgba(43,124,255,.35);
      box-shadow: 0 8px 18px rgba(43,124,255,.12);
    }

    .fileHint{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }
    .preview{
      display:flex; gap:10px; align-items:center;
      margin-top: 8px;
    }
    .thumb{
      width:52px;height:52px;border-radius: 14px;
      border: 1px solid var(--line);
      background: #f7f9f9;
      overflow:hidden;
      display:grid;place-items:center;
      color: var(--muted);
      flex:0 0 auto;
    }
    .thumb img{width:100%;height:100%;object-fit:cover}
    .preview .meta{font-size:12px;color:var(--muted)}
    .btnRow{margin-top: 14px; display:flex; gap: 10px; flex-wrap:wrap;}
    .btn{
      border:none;
      border-radius: 999px;
      padding: 14px 16px;
      font-weight: 900;
      cursor:pointer;
      color:#fff;
      background: linear-gradient(180deg, var(--btn2), var(--btn));
      box-shadow: 0 10px 22px rgba(255,90,95,.28);
      width: 100%;
      font-size: 16px;
    }
    .btn.secondary{
      background: linear-gradient(180deg,#4b9bff,#2b7cff);
      box-shadow: 0 10px 22px rgba(43,124,255,.22);
      width:auto;
      padding: 12px 14px;
      font-size: 14px;
    }
    .btn.gray{
      background: linear-gradient(180deg,#95a5a6,#7f8c8d);
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      width:auto;
      padding: 12px 14px;
      font-size: 14px;
    }

    .status{
      margin-top: 10px;
      padding: 12px 12px;
      border-radius: 14px;
      font-weight: 800;
      background: #f6f8f8;
      border: 1px solid var(--line);
      color:#2c3e50;
    }
    .status.ok{
      background: rgba(0,184,148,.10);
      border-color: rgba(0,184,148,.25);
      color:#0b6b58;
    }
    .status.err{
      background: rgba(255,77,79,.10);
      border-color: rgba(255,77,79,.25);
      color:#a61b1b;
    }

    .divider{height:1px;background:var(--line);margin: 14px 0;}

    .historyTop{
      padding: 14px 14px 10px;
      background: linear-gradient(90deg, rgba(255,209,102,.25), rgba(6,214,160,.15));
      border-radius: 18px;
      border:1px solid rgba(0,0,0,.04);
      margin-bottom: 12px;
    }

    .range{
      display:grid;
      grid-template-columns: 1fr 32px 1fr;
      gap: 10px;
      align-items:center;
    }
    .range .tilde{
      text-align:center;
      color:var(--muted);
      font-weight:900;
    }

    .list{
      margin-top: 10px;
      display:grid; gap: 10px;
    }
    .item{
      background:#fff;
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 12px 12px;
    }
    .itemHead{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-weight: 900;
    }
    .itemHead .date{color:#0b6b58}
    .itemHead .driver{color:#2b7cff}
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
      margin-top: 8px;
      color:#2c3e50;
      font-size: 13px;
    }
    .kv div span{color:var(--muted); font-weight:800}
    .links{margin-top: 8px; display:flex; gap:8px; flex-wrap:wrap;}
    .a{
      display:inline-block;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(43,124,255,.22);
      background: rgba(43,124,255,.08);
      color:#2b7cff;
      font-weight: 900;
      font-size: 12px;
      text-decoration:none;
    }
    .muted{color:var(--muted)}
    .empty{
      padding: 24px 10px;
      text-align:center;
      color:var(--muted);
      font-weight: 900;
    }

    @media print{
      body{background:#fff;padding:0}
      .hero,.tabs,.btnRow,.note,.status,.chips{display:none!important}
      .card{box-shadow:none;border-radius:0}
      .pane{display:block!important}
      .item{break-inside: avoid;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <div class="brand">
        <div class="logo"><span>OFA</span></div>
        <div>
          <h1>OFA GROUP<br>Webç‚¹å‘¼ãƒ»æ—¥å ±ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆDriveä¿å­˜ç‰ˆï¼‰</h1>
        </div>
      </div>
      <div class="chips">
        <div class="chip">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å…¥åŠ› â†’ è¨¼è·¡ä¿å­˜</div>
        <div class="chip">å†™çœŸã¯Driveã¸ä¿å­˜ï¼ˆ60æ—¥ã§æ•´ç†ï¼‰</div>
        <div class="chip">æ—¥æ¬¡ãƒ»æœˆæ¬¡PDFå‡ºåŠ›</div>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <div class="tab active" data-tab="form">ğŸ“ ç‚¹å‘¼ãƒ»æ—¥å ±å…¥åŠ›</div>
        <div class="tab" data-tab="history">ğŸ“ å±¥æ­´ãƒ»æ¤œç´¢ãƒ»PDF</div>
      </div>

      <!-- FORM -->
      <div class="pane active" id="pane-form">
        <div class="sectionTitle"><div class="emoji">ğŸ§¾</div>ç‚¹å‘¼ãƒ»æ—¥å ±å…¥åŠ›</div>
        <div class="note">
          â€»å†™çœŸã¯è‡ªå‹•ã§åœ§ç¸®ã—ã¦Google Driveã¸ä¿å­˜ã—ã¾ã™ã€‚ä¿å­˜å¾Œã€å±¥æ­´ã«è¨˜éŒ²ã•ã‚Œã¾ã™ï¼ˆã“ã®ç«¯æœ«ãƒ»ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ï¼‰ã€‚
        </div>

        <div class="grid two">
          <div>
            <label>æ—¥ä»˜<span class="req">*</span></label>
            <input id="date" type="text" readonly />
          </div>
          <div>
            <label>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å<span class="req">*</span></label>
            <input id="driver" type="text" placeholder="ä¾‹ï¼‰å±±ç”° å¤ªéƒ" autocomplete="name" />
          </div>

          <div>
            <label>æ‰€å±ä¼šç¤¾<span class="req">*</span></label>
            <input id="company" type="text" placeholder="ä¾‹ï¼‰æ ªå¼ä¼šç¤¾OFA / å”åŠ›ä¼šç¤¾å" />
          </div>
          <div>
            <label>è»Šä¸¡ç•ªå·<span class="req">*</span></label>
            <input id="vehicle" type="text" placeholder="ä¾‹ï¼‰é¹¿å…å³¶ 480 ã‚ 1234" />
          </div>

          <div>
            <label>ç¢ºèªè€…ï¼ˆç‚¹å‘¼å®Ÿæ–½è€…ï¼‰<span class="req">*</span></label>
            <input id="checker" type="text" placeholder="ä¾‹ï¼‰æ£®ä¸‹ / ç®¡ç†è€…å" />
          </div>
          <div>
            <label>ä½“èª¿<span class="req">*</span></label>
            <select id="condition">
              <option value="è‰¯å¥½">è‰¯å¥½</option>
              <option value="æ™®é€š">æ™®é€š</option>
              <option value="ä¸å®‰ã‚ã‚Š">ä¸å®‰ã‚ã‚Š</option>
              <option value="ä¸è‰¯">ä¸è‰¯</option>
            </select>
          </div>

          <div>
            <label>å‡ºç™ºæ™‚é–“<span class="req">*</span></label>
            <input id="startTime" type="time" />
          </div>
          <div>
            <label>å¸°åº«æ™‚é–“ï¼ˆä»»æ„ï¼‰</label>
            <input id="endTime" type="time" />
          </div>

          <div>
            <label>ç¡çœ æ™‚é–“ï¼ˆæ™‚é–“ï¼‰</label>
            <input id="sleepHours" type="number" step="0.5" min="0" placeholder="ä¾‹ï¼‰7" />
          </div>
          <div>
            <label>ä½“æ¸©ï¼ˆâ„ƒï¼‰<span class="req">*</span></label>
            <input id="temp" type="number" step="0.1" min="34" max="42" placeholder="ä¾‹ï¼‰36.5" />
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid two">
          <div>
            <label>é£²é…’ï¼ˆ24hä»¥å†…ï¼‰<span class="req">*</span></label>
            <div class="radioRow" id="drinkRow">
              <div class="pill active" data-name="drink" data-value="ãªã—">
                <input type="radio" name="drink" value="ãªã—" checked />
                <div>ãªã—</div>
              </div>
              <div class="pill" data-name="drink" data-value="ã‚ã‚Š">
                <input type="radio" name="drink" value="ã‚ã‚Š" />
                <div>ã‚ã‚Š</div>
              </div>
            </div>
          </div>

          <div>
            <label>æœè–¬ï¼ˆé‹è»¢ã«å½±éŸ¿ã™ã‚‹è–¬ï¼‰</label>
            <div class="radioRow" id="medRow">
              <div class="pill active" data-name="med" data-value="ãªã—">
                <input type="radio" name="med" value="ãªã—" checked />
                <div>ãªã—</div>
              </div>
              <div class="pill" data-name="med" data-value="ã‚ã‚Š">
                <input type="radio" name="med" value="ã‚ã‚Š" />
                <div>ã‚ã‚Š</div>
              </div>
            </div>
          </div>

          <div>
            <label>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œæŸ»å€¤ï¼ˆmg/Lï¼‰<span class="req">*</span></label>
            <input id="alcohol" type="number" step="0.01" min="0" placeholder="ä¾‹ï¼‰0" />
          </div>

          <div>
            <label>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œæŸ»å†™çœŸï¼ˆå‡ºç™ºï¼‰<span class="req">*</span></label>
            <input id="photoStart" type="file" accept="image/*" capture="environment" />
            <div class="fileHint">â€»è‡ªå‹•ã§åœ§ç¸®ã—ã¦Google Driveã¸ä¿å­˜ã—ã¾ã™ã€‚</div>
            <div class="preview" id="prevStart" style="display:none;">
              <div class="thumb"><img alt="preview" /></div>
              <div class="meta"></div>
            </div>
          </div>

          <div>
            <label>å‡ºç™ºå‰ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆkmï¼‰<span class="req">*</span></label>
            <input id="meterStart" type="number" step="1" min="0" placeholder="ä¾‹ï¼‰1234" />
          </div>
          <div>
            <label>å¸°åº«å¾Œãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆkmï¼‰</label>
            <input id="meterEnd" type="number" step="1" min="0" placeholder="ä»»æ„ï¼ˆå…¥åŠ›ã™ã‚‹ã¨èµ°è¡Œè·é›¢ã‚’è‡ªå‹•è¨ˆç®—ï¼‰" />
          </div>

          <div>
            <label>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œæŸ»å†™çœŸï¼ˆå¸°åº«ï¼šä»»æ„ï¼‰</label>
            <input id="photoEnd" type="file" accept="image/*" capture="environment" />
            <div class="fileHint">â€»ä»»æ„ã€‚å¿…è¦ãªé‹ç”¨ã®å ´åˆã®ã¿ã€‚</div>
            <div class="preview" id="prevEnd" style="display:none;">
              <div class="thumb"><img alt="preview" /></div>
              <div class="meta"></div>
            </div>
          </div>

          <div>
            <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="memo" placeholder="ä½“èª¿ã‚„æ³¨æ„ç‚¹ãªã©"></textarea>
          </div>
        </div>

        <div class="btnRow">
          <button class="btn" id="saveBtn">ã“ã®è¨˜éŒ²ã‚’ä¿å­˜ï¼ˆå†™çœŸã¯Driveã¸ï¼‰</button>
        </div>
        <div class="status" id="statusBox">æº–å‚™OK</div>

        <div class="divider"></div>

        <div class="note">
          <b>GAS URLï¼ˆ/execï¼‰</b>ï¼š<span id="gasUrlText" class="muted"></span><br>
          â€»URLãŒé•ã†ã¨ã€ŒLoad failedã€ã«ãªã‚Šã¾ã™ã€‚å¤‰æ›´ã™ã‚‹å ´åˆã¯ã€HTMLå†…ã® <code>GAS_URL</code> ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚
        </div>
        <div class="btnRow">
          <button class="btn secondary" id="testBtn">æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆGAS /exec ã¸ï¼‰</button>
          <button class="btn gray" id="resetBtn">ã“ã®ç«¯æœ«ã®å±¥æ­´ã‚’å…¨å‰Šé™¤ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰</button>
        </div>
      </div>

      <!-- HISTORY -->
      <div class="pane" id="pane-history">
        <div class="sectionTitle"><div class="emoji">ğŸ“š</div>å±¥æ­´ãƒ»æ¤œç´¢ãƒ»PDF</div>

        <div class="historyTop">
          <div style="font-weight:900;margin-bottom:8px;color:#0b6b58;">ä¿å­˜ã•ã‚ŒãŸç‚¹å‘¼å±¥æ­´</div>
          <div class="note" style="margin:0;">
            â€»ã“ã®ç«¯æœ«ãƒ»ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã ã‘å±¥æ­´ãŒä¿å­˜ã•ã‚Œã¾ã™ï¼ˆå†™çœŸã¯Drive URLã‚’ä¿å­˜ï¼‰
          </div>
        </div>

        <div class="grid two">
          <div>
            <label>æœŸé–“ã§çµã‚Šè¾¼ã¿</label>
            <div class="range">
              <input id="fromDate" type="date" />
              <div class="tilde">ã€œ</div>
              <input id="toDate" type="date" />
            </div>
          </div>
          <div>
            <label>æ¤œç´¢ï¼ˆãƒ‰ãƒ©ã‚¤ãƒãƒ¼/è»Šä¸¡/ä¼šç¤¾ï¼‰</label>
            <input id="q" type="text" placeholder="ä¾‹ï¼‰æ£®ä¸‹ / 1234 / OFA" />
          </div>
        </div>

        <div class="btnRow" style="margin-top:10px;">
          <button class="btn secondary" id="applyFilterBtn">ã“ã®æ¡ä»¶ã§çµã‚Šè¾¼ã¿</button>
          <button class="btn gray" id="clearFilterBtn">çµã‚Šè¾¼ã¿è§£é™¤</button>
          <button class="btn secondary" id="thisMonthBtn">ä»Šæœˆ</button>
        </div>

        <div class="divider"></div>

        <div class="btnRow">
          <button class="btn secondary" id="printBtn">è¡¨ç¤ºä¸­ã‚’PDFï¼ˆå°åˆ·ï¼‰</button>
          <button class="btn secondary" id="monthPdfBtn">è¡¨ç¤ºä¸­ã‚’æœˆæ¬¡PDFï¼ˆä¸€è¦§ï¼‰</button>
        </div>

        <div class="list" id="list"></div>
        <div class="empty" id="empty" style="display:none;">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      </div>
    </div>
  </div>

<script>
/** ===============================
 *  è¨­å®šï¼šGAS WebApp /exec URLï¼ˆæœ¬ç•ªï¼‰
 *  =============================== */
const GAS_URL = "https://script.google.com/macros/s/AKfycby-SNPWTc3DpJvlr2mxR0IbtMvWEURcAwk24mWbr-JV1cWJOhZREiLcoSA8FJJCl07WjQ/exec";

/** ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚­ãƒ¼ */
const LS_KEY = "OFA_TENKO_RECORDS_V1";

/** ===============================
 *  åˆæœŸåŒ–
 *  =============================== */
const $ = (id)=>document.getElementById(id);

function todayJST(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}/${m}/${day}`;
}
function nowTimeHHMM(){
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}

function setStatus(msg, type=""){
  const box = $("statusBox");
  box.className = "status" + (type ? (" " + type) : "");
  box.textContent = msg;
}

/** ===============================
 *  UIï¼šã‚¿ãƒ–
 *  =============================== */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");

    const target = tab.dataset.tab;
    document.querySelectorAll(".pane").forEach(p=>p.classList.remove("active"));
    if(target==="form") $("pane-form").classList.add("active");
    if(target==="history") {
      $("pane-history").classList.add("active");
      renderList();
    }
  });
});

/** ===============================
 *  UIï¼šãƒ©ã‚¸ã‚ª pill
 *  =============================== */
function bindPills(containerId){
  const root = $(containerId);
  root.querySelectorAll(".pill").forEach(p=>{
    p.addEventListener("click", ()=>{
      root.querySelectorAll(".pill").forEach(x=>x.classList.remove("active"));
      p.classList.add("active");
      p.querySelector("input").checked = true;
    });
  });
}
bindPills("drinkRow");
bindPills("medRow");

/** ===============================
 *  ç”»åƒï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‹åœ§ç¸®(base64)
 *  =============================== */
function setPreview(fileInput, previewWrapId){
  const wrap = $(previewWrapId);
  const img = wrap.querySelector("img");
  const meta = wrap.querySelector(".meta");

  const file = fileInput.files && fileInput.files[0];
  if(!file){
    wrap.style.display="none";
    return;
  }
  const url = URL.createObjectURL(file);
  img.src = url;
  meta.textContent = `${file.name}ï¼ˆ${Math.round(file.size/1024)}KBï¼‰`;
  wrap.style.display="flex";
}

$("photoStart").addEventListener("change", ()=>setPreview($("photoStart"), "prevStart"));
$("photoEnd").addEventListener("change", ()=>setPreview($("photoEnd"), "prevEnd"));

function fileToCompressedBase64(file, maxW=1280, quality=0.72){
  return new Promise((resolve, reject)=>{
    if(!file) return resolve("");

    const reader = new FileReader();
    reader.onerror = ()=>reject(new Error("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"));
    reader.onload = ()=>{
      const img = new Image();
      img.onload = ()=>{
        const ratio = img.width / img.height;
        const w = Math.min(maxW, img.width);
        const h = Math.round(w / ratio);

        const canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, w, h);

        const type = (file.type && file.type.includes("png")) ? "image/png" : "image/jpeg";
        const dataUrl = canvas.toDataURL(type, quality);
        resolve(dataUrl);
      };
      img.onerror = ()=>reject(new Error("ç”»åƒã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"));
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });
}

/** ===============================
 *  ãƒ­ãƒ¼ã‚«ãƒ«å±¥æ­´
 *  =============================== */
function loadRecords(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return [];
    return arr;
  }catch(e){
    return [];
  }
}
function saveRecords(arr){
  localStorage.setItem(LS_KEY, JSON.stringify(arr));
}
function addRecord(rec){
  const arr = loadRecords();
  arr.unshift(rec);
  saveRecords(arr);
}
function clearRecords(){
  localStorage.removeItem(LS_KEY);
}

/** ===============================
 *  GASã¸é€ä¿¡
 *  =============================== */
async function postToGAS(payload){
  const res = await fetch(GAS_URL, {
    method: "POST",
    headers: {"Content-Type":"text/plain;charset=utf-8"},
    body: JSON.stringify(payload),
  });

  if(!res.ok){
    throw new Error(`GASå¿œç­”ã‚¨ãƒ©ãƒ¼ï¼š${res.status}`);
  }
  const text = await res.text();
  let json;
  try{
    json = JSON.parse(text);
  }catch(e){
    throw new Error("GASã®è¿”å´ãŒJSONã§ã¯ã‚ã‚Šã¾ã›ã‚“");
  }
  return json;
}

/** ===============================
 *  ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 *  =============================== */
function getSelectedRadio(name){
  const el = document.querySelector(`input[name="${name}"]:checked`);
  return el ? el.value : "";
}
function must(value, label){
  if(value===undefined || value===null || String(value).trim()===""){
    throw new Error(`${label} ã¯å¿…é ˆã§ã™`);
  }
}

/** ===============================
 *  ä¿å­˜å‡¦ç†
 *  =============================== */
$("saveBtn").addEventListener("click", async ()=>{
  try{
    setStatus("ä¿å­˜ä¸­â€¦ï¼ˆå†™çœŸã‚’åœ§ç¸®â†’Driveã¸ä¿å­˜ï¼‰", "");

    const date = $("date").value.trim();
    const driver = $("driver").value.trim();
    const company = $("company").value.trim();
    const vehicle = $("vehicle").value.trim();
    const checker = $("checker").value.trim();
    const condition = $("condition").value;
    const startTime = $("startTime").value;
    const endTime = $("endTime").value;
    const sleepHours = $("sleepHours").value;
    const temp = $("temp").value;
    const drink = getSelectedRadio("drink");
    const med = getSelectedRadio("med");
    const alcohol = $("alcohol").value;
    const meterStart = $("meterStart").value;
    const meterEnd = $("meterEnd").value;
    const memo = $("memo").value.trim();

    must(date, "æ—¥ä»˜");
    must(driver, "ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å");
    must(company, "æ‰€å±ä¼šç¤¾");
    must(vehicle, "è»Šä¸¡ç•ªå·");
    must(checker, "ç¢ºèªè€…");
    must(startTime, "å‡ºç™ºæ™‚é–“");
    must(temp, "ä½“æ¸©");
    must(drink, "é£²é…’ï¼ˆ24hä»¥å†…ï¼‰");
    must(alcohol, "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œæŸ»å€¤");
    must(meterStart, "å‡ºç™ºå‰ãƒ¡ãƒ¼ã‚¿ãƒ¼");

    const fStart = $("photoStart").files && $("photoStart").files[0];
    must(fStart, "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œæŸ»å†™çœŸï¼ˆå‡ºç™ºï¼‰");

    const startB64 = await fileToCompressedBase64(fStart, 1280, 0.72);
    const fEnd = $("photoEnd").files && $("photoEnd").files[0];
    const endB64 = fEnd ? await fileToCompressedBase64(fEnd, 1280, 0.72) : "";

    const payload = {
      date, driver, company, vehicle, checker, condition,
      startTime, endTime, sleepHours, temp, drink, med,
      alcohol, meterStart, meterEnd, memo,
      startAlcoholPhoto: startB64,
      endAlcoholPhoto: endB64,
      client: { ua: navigator.userAgent, ts: new Date().toISOString() }
    };

    const out = await postToGAS(payload);
    if(!out || out.ok !== true){
      throw new Error(out && out.error ? out.error : "GASä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }

    const rec = {
      id: "TENKO_" + Date.now(),
      createdAt: new Date().toISOString(),
      date, driver, company, vehicle, checker, condition,
      startTime, endTime, sleepHours, temp, drink, med,
      alcohol, meterStart, meterEnd, memo,
      driveUrls: out.urls || {},
      gas: GAS_URL
    };
    addRecord(rec);

    setStatus("âœ… ä¿å­˜å®Œäº†ï¼ˆDriveã¸ä¿å­˜â†’å±¥æ­´ã«è¨˜éŒ²ã—ã¾ã—ãŸï¼‰", "ok");

    $("memo").value = "";
    $("photoStart").value = "";
    $("photoEnd").value = "";
    $("prevStart").style.display = "none";
    $("prevEnd").style.display = "none";
    document.querySelector('.tab[data-tab="history"]').click();

  }catch(e){
    console.error(e);
    setStatus("âŒ " + (e && e.message ? e.message : "Load failed"), "err");
  }
});

/** ===============================
 *  æ¥ç¶šãƒ†ã‚¹ãƒˆ
 *  =============================== */
$("testBtn").addEventListener("click", async ()=>{
  try{
    setStatus("æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­â€¦", "");
    const ping = { ping:true, ts:new Date().toISOString() };
    const out = await postToGAS(ping);
    if(out && out.ok===true){
      setStatus("âœ… æ¥ç¶šOKï¼ˆGASãŒå¿œç­”ã—ã¾ã—ãŸï¼‰", "ok");
    }else{
      throw new Error(out && out.error ? out.error : "GASãŒOKã‚’è¿”ã—ã¾ã›ã‚“");
    }
  }catch(e){
    setStatus("âŒ æ¥ç¶šNGï¼š" + (e.message || "Load failed"), "err");
  }
});

/** ===============================
 *  å±¥æ­´å‰Šé™¤ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
 *  =============================== */
$("resetBtn").addEventListener("click", ()=>{
  if(confirm("ã“ã®ç«¯æœ«ã®å±¥æ­´ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ï¼ˆDriveã®å†™çœŸã¯æ¶ˆãˆã¾ã›ã‚“ï¼‰ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")){
    clearRecords();
    setStatus("å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰", "ok");
    renderList();
  }
});

/** ===============================
 *  å±¥æ­´è¡¨ç¤º
 *  =============================== */
function parseYMD(s){
  if(!s) return "";
  return s.replaceAll("/","-");
}
function inRange(dateYMD, from, to){
  const d = parseYMD(dateYMD);
  if(from && d < from) return false;
  if(to && d > to) return false;
  return true;
}
function containsQ(rec, q){
  if(!q) return true;
  const t = (q || "").toLowerCase();
  const hay = [rec.driver, rec.vehicle, rec.company, rec.checker, rec.memo].join(" ").toLowerCase();
  return hay.includes(t);
}

function renderList(){
  const list = $("list");
  const empty = $("empty");
  list.innerHTML = "";

  const from = $("fromDate").value;
  const to = $("toDate").value;
  const q = ($("q").value || "").trim();

  const all = loadRecords();
  const filtered = all.filter(r => inRange(r.date, from, to) && containsQ(r, q));

  if(filtered.length===0){
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  filtered.forEach(r=>{
    const div = document.createElement("div");
    div.className = "item";

    const dist = (r.meterEnd && r.meterStart) ? (Number(r.meterEnd)-Number(r.meterStart)) : "";
    const distTxt = (dist!=="" && !Number.isNaN(dist)) ? `${dist}km` : "â€”";

    const startUrl = r.driveUrls && (r.driveUrls.startAlcoholPhotoUrl || "");
    const endUrl = r.driveUrls && (r.driveUrls.endAlcoholPhotoUrl || "");

    div.innerHTML = `
      <div class="itemHead">
        <div class="date">${r.date}ï¼ˆ${r.startTime || "--:--"}ï¼‰</div>
        <div class="driver">${escapeHtml(r.driver)} / ${escapeHtml(r.vehicle)}</div>
      </div>
      <div class="kv">
        <div><span>æ‰€å±ï¼š</span>${escapeHtml(r.company)}</div>
        <div><span>ç¢ºèªè€…ï¼š</span>${escapeHtml(r.checker)}</div>
        <div><span>ä½“èª¿ï¼š</span>${escapeHtml(r.condition)}</div>
        <div><span>ç¡çœ ï¼š</span>${escapeHtml(r.sleepHours || "â€”")}h</div>
        <div><span>ä½“æ¸©ï¼š</span>${escapeHtml(r.temp)}â„ƒ</div>
        <div><span>é£²é…’ï¼š</span>${escapeHtml(r.drink)}</div>
        <div><span>æœè–¬ï¼š</span>${escapeHtml(r.med || "â€”")}</div>
        <div><span>é…’ç²¾ï¼š</span>${escapeHtml(r.alcohol)} mg/L</div>
        <div><span>ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼š</span>${escapeHtml(r.meterStart)} â†’ ${escapeHtml(r.meterEnd || "â€”")}ï¼ˆ${distTxt}ï¼‰</div>
        <div><span>å¸°åº«ï¼š</span>${escapeHtml(r.endTime || "â€”")}</div>
      </div>
      ${r.memo ? `<div style="margin-top:8px;color:#2c3e50;font-size:13px;"><span class="muted" style="font-weight:800;">ãƒ¡ãƒ¢ï¼š</span>${escapeHtml(r.memo)}</div>` : ``}
      <div class="links">
        ${startUrl ? `<a class="a" href="${startUrl}" target="_blank" rel="noopener">å‡ºç™ºã‚¢ãƒ«ã‚³ãƒ¼ãƒ«å†™çœŸï¼ˆDriveï¼‰</a>` : ``}
        ${endUrl ? `<a class="a" href="${endUrl}" target="_blank" rel="noopener">å¸°åº«ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«å†™çœŸï¼ˆDriveï¼‰</a>` : ``}
      </div>
    `;
    list.appendChild(div);
  });
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

$("applyFilterBtn").addEventListener("click", renderList);
$("clearFilterBtn").addEventListener("click", ()=>{
  $("fromDate").value = "";
  $("toDate").value = "";
  $("q").value = "";
  renderList();
});
$("thisMonthBtn").addEventListener("click", ()=>{
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const first = `${y}-${m}-01`;
  const lastDay = new Date(y, d.getMonth()+1, 0).getDate();
  const last = `${y}-${m}-${String(lastDay).padStart(2,"0")}`;
  $("fromDate").value = first;
  $("toDate").value = last;
  renderList();
});

$("printBtn").addEventListener("click", ()=>window.print());
$("monthPdfBtn").addEventListener("click", ()=>{
  alert("ã“ã®ç”»é¢ã®ã€Œè¡¨ç¤ºä¸­ã€ã‚’ãã®ã¾ã¾å°åˆ·ï¼ˆPDFä¿å­˜ï¼‰ã—ã¦ãã ã•ã„ã€‚");
  window.print();
});

/** åˆæœŸå€¤ */
function init(){
  $("date").value = todayJST();
  $("startTime").value = nowTimeHHMM();
  $("gasUrlText").textContent = GAS_URL;
  setStatus("æº–å‚™OK", "");
}
init();
</script>
</body>
</html>
