/**
 * OFA GROUP Web点呼・日報受付スクリプト (メール・LINE通知機能付き)
 */

// *******************************************************************
// ★ 1. 設定情報: ここを必ずご自身の環境に合わせて変更してください ★
// *******************************************************************
var SHEET_URL = "https://docs.google.com/spreadsheets/d/XXXXXXXXXXXXXXXXXXXXXXXXX/edit"; 
var FOLDER_ID = "XXXXXXXXX"; 
// エラー通知先メールアドレス
var DEVELOPER_EMAIL = "YOUR_DEVELOPER_EMAIL@example.com";
// *******************************************************************

// --------------------------------------------------
// メイン処理: フォームからPOSTデータを受信する
// --------------------------------------------------
function doPost(e) {
  var result = {};
  
  try {
    // 1. 受信したJSONデータとファイルを解析
    var payload = JSON.parse(e.parameter.json);
    var data = payload; 
    
    // HTMLフォームから送信されるファイルデータを取得
    var licenseFile = e.parameter.licenseFile; 
    var carAbnormalFile = e.parameter.carAbnormalFile; 

    // 2. スプレッドシートを開き、シートを準備
    var ss = SpreadsheetApp.openByUrl(SHEET_URL);
    var sheet = ss.getSheetByName("Web点呼記録"); 
    if (!sheet) {
      // シートが存在しない場合は作成し、ヘッダー行を追記する
      sheet = ss.insertSheet("Web点呼記録");
      sheet.appendRow([
        "日付", "モード", "ドライバー名", "所属会社", "案件（荷主）", "エリア", "出庫ベース", "出庫場所", 
        "メールアドレス", "LINEトークン", // ← 新規追加
        "出勤時間", "出発時間", "体調", "睡眠時間(h)", "飲酒(24h)", "服薬", "体温(℃)", "アルコール(mg/L)", 
        "出発前メーター(km)", "メモ", "免許証URL",
        "ブレーキ", "タイヤ", "灯火類", "カメラ・ミラー", "車体外観", "その他点検", "点検メモ", "異常写真URL",
        "帰庫場所", "帰庫時間", "帰庫メーター(km)", "走行距離(km)", "休憩時間・場所", "代金入金状況", "代金入金額(円)",
        "道路・運行状況", "異常の詳細", "送信日時"
      ]);
    }

    // 3. ドライブへのファイル保存処理
    
    // 免許証ファイルを処理 (出発点呼時のみ実行、かつデータにURLがまだない場合)
    if (licenseFile && data.mode === '出発点呼' && !data.licenseUrl) {
      var fileName = data.driverName + '_免許証_' + Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyyMMdd') + '.jpg';
      data.licenseUrl = saveFileToDrive(licenseFile, FOLDER_ID, fileName); 
    }
    
    // 車両異常ファイルを処理
    if (carAbnormalFile) {
      var fileName = data.driverName + '_異常箇所_' + Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyyMMdd_HHmmss') + '.jpg';
      data.carAbnormalUrl = saveFileToDrive(carAbnormalFile, FOLDER_ID, fileName); 
    }
    
    // 4. スプレッドシートに書き込むデータの配列を準備
    var row = [
      // 01 基本情報
      data.date,
      data.mode,
      data.driverName,
      data.company,
      data.client,
      data.area,
      data.base,
      data.startPlace,
      data.email || "", // メールアドレス
      data.lineToken || "", // LINEトークン
      // 02 出発前
      data.workTime,
      data.startTime,
      data.condition,
      data.sleep,
      data.drink,
      data.medicine,
      data.temp,
      data.alcoholValue,
      data.startMeter,
      data.memo,
      data.licenseUrl || "", // 免許証URL
      // 03 日常点検
      data.check_brake,
      data.check_tire,
      data.check_light,
      data.check_camera,
      data.check_body,
      data.check_other,
      data.check_note,
      data.carAbnormalUrl || "", // 異常箇所写真URL
      // 04 帰庫後
      data.returnPlace,
      data.returnTime,
      data.returnMeter,
      data.distance,
      data.rest,
      data.codStatus,
      data.codAmount,
      data.roadStatus,
      data.abnormalDetail,
      Utilities.formatDate(new Date(), 'Asia/Tokyo', 'yyyy/MM/dd HH:mm:ss') // 送信日時
    ];

    // 5. スプレッドシートにデータを追加
    sheet.appendRow(row);
    
    // ----------------------------------------------
    // 6. ★ 通知処理の実行 (メールとLINE)
    // ----------------------------------------------
    
    var notificationMessage = createNotificationMessage(data); // 通知メッセージを整形
    
    // ドライバー本人宛にメール送信
    if (data.email) {
      sendEmailNotification(data.email, data.mode, notificationMessage, data.driverName);
    }
    
    // ドライバー本人宛にLINE通知
    if (data.lineToken) {
      sendLineNotification(data.lineToken, notificationMessage);
    }

    result.status = "SUCCESS";
    result.message = data.mode + "を正常に記録し、通知を送信しました。";

  } catch (e) {
    result.status = "ERROR";
    result.message = "エラーが発生しました: " + e.toString();
    // 開発者へのエラー通知
    MailApp.sendEmail(DEVELOPER_EMAIL, "GASエラー発生", "点呼フォームでエラー: " + e.toString()); 
  }

  // 成功時/エラー時に関わらず、コンテンツを出力
  return ContentService.createTextOutput(JSON.stringify(result))
                       .setMimeType(ContentService.MimeType.JSON);
}

// --------------------------------------------------
// ヘルパー関数: ドライブにファイルを保存する
// --------------------------------------------------
function saveFileToDrive(fileBlob, folderId, fileName) {
  try {
    var folder = DriveApp.getFolderById(folderId);
    var blob = Utilities.newBlob(Utilities.base64Decode(fileBlob.getDataAsString()), fileBlob.getContentType(), fileName);
    var file = folder.createFile(blob);
    return file.getUrl(); 
  } catch(e) {
    Logger.log("ファイル保存エラー: " + e.toString());
    return "ファイル保存エラー: " + e.toString();
  }
}

// --------------------------------------------------
// ヘルパー関数: 通知メッセージを整形する
// --------------------------------------------------
function createNotificationMessage(data) {
  // LINE通知は文字数制限があるため、メッセージを簡潔にする
  var msg = "【OFA Web点呼 控え】\n";
  msg += "モード: " + data.mode + " (" + data.date + ")\n";
  msg += "氏名: " + data.driverName + " / " + data.company + "\n";
  
  if (data.mode === '出発点呼') {
      msg += "\n■ 出発点呼\n";
      msg += "出発時間: " + data.startTime + "\n";
      msg += "体調: " + data.condition + " / 体温: " + data.temp + "℃\n";
      msg += "アルコール: " + data.alcoholValue + "mg/L\n";
      msg += "点検メモ: " + (data.check_note || "なし") + "\n";
      if (data.carAbnormalUrl && data.carAbnormalUrl.startsWith('http')) {
          msg += "異常写真URL: " + data.carAbnormalUrl + "\n";
      }
      msg += "\n--- 帰庫時は再度フォーム送信 ---";

  } else if (data.mode === '帰庫点呼（日報）') {
      msg += "\n■ 運行・帰庫記録\n";
      msg += "総走行距離: " + data.distance + "km\n";
      msg += "帰庫時間: " + data.returnTime + "\n";
      msg += "休憩時間: " + data.rest + "\n";
      msg += "道路状況: " + data.roadStatus + "\n";
      msg += "異常詳細: " + (data.abnormalDetail || "なし") + "\n";
      msg += "\n--- 本日もお疲れ様でした！ ---";
  }
  
  return msg;
}

// --------------------------------------------------
// ヘルパー関数: メールで通知を送る
// --------------------------------------------------
function sendEmailNotification(recipientEmail, mode, messageBody, driverName) {
  var subject = "【控え】OFA Web点呼 - " + mode + " (" + driverName + ")";
  try {
    MailApp.sendEmail({
      to: recipientEmail,
      subject: subject,
      body: messageBody,
      name: "OFA GROUP Web点呼システム" 
    });
    Logger.log("メールを送信しました: " + recipientEmail);
  } catch (e) {
    Logger.log("メール送信エラー: " + e.toString());
  }
}

// --------------------------------------------------
// ヘルパー関数: LINE Notifyで通知を送る
// --------------------------------------------------
function sendLineNotification(token, messageBody) {
  var lineNotifyUrl = "https://notify-api.line.me/api/notify";
  
  if (!token || token.length < 30) {
      Logger.log("LINE通知スキップ: トークンが無効です。");
      return;
  }
  
  try {
    var options = {
      "method": "post",
      "headers": {
        "Authorization": "Bearer " + token
      },
      "payload": {
        "message": "\n" + messageBody 
      }
    };
    UrlFetchApp.fetch(lineNotifyUrl, options);
    Logger.log("LINE通知を送信しました。");
  } catch (e) {
    Logger.log("LINE通知エラー: " + e.toString());
  }
}
