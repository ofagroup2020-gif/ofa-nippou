<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFA GROUP Webç‚¹å‘¼ãƒ»æ—¥å ±ãƒ•ã‚©ãƒ¼ãƒ </title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* -------------------------------------------------- */
        /* CSS: æ–°ãƒ‡ã‚¶ã‚¤ãƒ³ (OFAã‚°ãƒªãƒ¼ãƒ³ã€ãƒ–ãƒ­ãƒƒã‚¯ãƒ‡ã‚¶ã‚¤ãƒ³) */
        /* -------------------------------------------------- */
        :root {
            --color-ofa-green: #38C172;     /* OFAãƒ­ã‚´ã®ãƒ¡ã‚¤ãƒ³ã‚°ãƒªãƒ¼ãƒ³ */
            --color-ofa-red: #E74C3C;       /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³/å¿…é ˆãƒãƒ¼ã‚¯ã®èµ¤ */
            --color-ofa-blue: #3498DB;      /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã®é’ */
            --color-ofa-yellow: #F1C40F;    /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã®é»„ */
            --color-background-light: #F0FFF0; /* ãƒšãƒ¼ã‚¸èƒŒæ™¯ (è–„ã„ãƒšãƒ¼ãƒ«ã‚°ãƒªãƒ¼ãƒ³) */
            --color-container-bg: #FFFFFF;  /* ã‚³ãƒ³ãƒ†ãƒŠèƒŒæ™¯ */
            --color-text-dark: #2C3E50;
            --color-border-light: #E0E0E0;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-background-light);
            color: var(--color-text-dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 600px;
            margin: 30px auto;
            padding: 0;
            background-color: var(--color-container-bg);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®è§’ã‚’ä¸¸ã‚ã‚‹ãŸã‚ */
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ (ç”»åƒãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å†ç¾) */
        .header-area {
            background-color: var(--color-ofa-green);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }

        .ofa-logo-block {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        .ofa-logo-circle {
            background-color: white;
            color: var(--color-ofa-green);
            font-weight: 900;
            font-size: 24px;
            padding: 5px 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        h1 {
            font-size: 24px;
            margin: 0;
        }
        
        .sub-title {
            font-size: 14px;
            margin-top: 5px;
            font-weight: 400;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ ã¨å±¥æ­´ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .content-wrapper {
            padding: 20px;
        }
        
        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ« */
        .section-title {
            padding: 10px 15px;
            margin-top: 25px;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 16px;
            background-color: #F8F9F9; /* è–„ã„ã‚°ãƒ¬ãƒ¼ã®èƒŒæ™¯ */
            border-left: 5px solid var(--color-ofa-yellow); /* é»„è‰²ã®ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ */
            color: var(--color-ofa-blue); /* é’è‰²ã®æ–‡å­— */
        }
        
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* å…¥åŠ›æ¬„ */
        input[type="text"], input[type="date"], input[type="time"], input[type="number"], select, textarea {
            width: calc(100% - 20px);
            padding: 10px;
            margin-top: 5px;
            border: 1px solid var(--color-border-light);
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        /* ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ãƒ»ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ã‚«ãƒ¼ãƒ‰é¢¨ã« */
        .radio-group {
            margin-top: 10px;
            padding: 10px;
            background-color: #F8F9F9;
            border: 1px solid var(--color-border-light);
            border-radius: 4px;
        }
        
        .radio-group label {
            display: inline-block;
            margin-right: 20px;
            font-weight: normal;
            margin-top: 5px;
        }
        
        /* å¿…é ˆãƒãƒ¼ã‚¯ */
        .required::after {
            content: " *";
            color: var(--color-ofa-red);
            font-weight: bold;
            margin-left: 4px;
        }
        
        /* ãƒœã‚¿ãƒ³ */
        button {
            display: block;
            width: 100%;
            padding: 15px;
            margin-top: 30px;
            background-color: var(--color-ofa-red);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 3px 0 #A93226;
        }
        
        button:hover {
            background-color: #C0392B;
        }
        
        /* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ */
        .tab-buttons { display: flex; justify-content: space-around; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab-button { flex-grow: 1; padding: 10px 5px; background-color: #eee; border: none; cursor: pointer; font-size: 14px; font-weight: bold; transition: background-color 0.3s; }
        .tab-button.active { background-color: var(--color-ofa-green); color: white; }
        .tab-content { padding: 10px 0; }
        
        /* å±¥æ­´ä¸€è¦§ */
        .record-item { padding: 12px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; background-color: white; transition: background-color 0.2s; margin-bottom: 8px; border-left: 5px solid var(--color-ofa-blue); }
        .record-item:hover { background-color: #f0f0f0; }
        .record-item.completed { border-left-color: var(--color-ofa-red); }
        .record-item-title { font-weight: bold; font-size: 16px; }
        .record-item-mode { font-size: 12px; color: #666; margin-top: 2px; }

        /* PDF/å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            body > *:not(#pdfOutput) { display: none !important; }
            #pdfOutput { display: block !important; margin: 0; box-shadow: none; border: none; }
            .print-button, .back-button { display: none !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-area">
        <div class="ofa-logo-block">
            <div class="ofa-logo-circle">OFA</div>
            OFA GROUP
        </div>
        <h1>Webç‚¹å‘¼ãƒ»æ—¥å ±ãƒ•ã‚©ãƒ¼ãƒ </h1>
        <div class="sub-title">ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ &bull; PDFç”Ÿæˆ (ã“ã®ç«¯æœ«å†…ã®ã¿)</div>
    </div>

    <div class="content-wrapper">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('form')">ğŸ“ ç‚¹å‘¼ãƒ»æ—¥å ±å…¥åŠ›</button>
            <button class="tab-button" onclick="showTab('history')">ğŸ“‹ å±¥æ­´ãƒ»PDF</button>
        </div>

        <div id="tab_form" class="tab-content">
            <form id="tenkoForm">

                <div class="section-title">0. ãƒ¢ãƒ¼ãƒ‰é¸æŠ</div>
                <div class="radio-group">
                    <label><input type="radio" name="mode" value="å‡ºç™ºç‚¹å‘¼" required> å‡ºç™ºç‚¹å‘¼<span class="required"></span></label>
                    <label><input type="radio" name="mode" value="å¸°åº«ç‚¹å‘¼ï¼ˆæ—¥å ±ï¼‰"> å¸°åº«ç‚¹å‘¼ï¼ˆæ—¥å ±ï¼‰<span class="required"></span></label>
                </div>
                
                <div class="section-title">1. åŸºæœ¬æƒ…å ±</div>
                <label for="date">æ—¥ä»˜<span class="required"></span></label>
                <input type="date" id="date" required>
                
                <label for="driverName">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å<span class="required"></span></label>
                <input type="text" id="driverName" required>

                <label for="company">æ‰€å±ä¼šç¤¾<span class="required"></span></label>
                <input type="text" id="company" required>
                
                <label for="email">é€£çµ¡å…ˆï¼ˆä»»æ„ï¼‰</label>
                <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ¡ãƒ¢">
                
                <label for="client">æ¡ˆä»¶ï¼ˆè·ä¸»ï¼‰</label>
                <input type="text" id="client">

                <label for="area">ã‚¨ãƒªã‚¢</label>
                <input type="text" id="area">

                <label for="base">å‡ºåº«ãƒ™ãƒ¼ã‚¹</label>
                <input type="text" id="base">

                <label for="startPlace">å‡ºåº«å ´æ‰€</label>
                <input type="text" id="startPlace">

                <div id="section_departure">
                    <div class="section-title">2. å‡ºç™ºå‰ãƒã‚§ãƒƒã‚¯</div>
                    <label for="workTime">å‡ºå‹¤æ™‚é–“</label><input type="time" id="workTime">
                    <label for="startTime">å‡ºç™ºæ™‚é–“<span class="required"></span></label><input type="time" id="startTime" required>
                    <label for="condition">ä½“èª¿<span class="required"></span></label>
                    <select id="condition" required><option value="">é¸æŠã—ã¦ãã ã•ã„</option><option value="è‰¯å¥½">è‰¯å¥½</option><option value="æ™®é€š">æ™®é€š</option><option value="ä¸èª¿">ä¸èª¿</option></select>
                    <label for="sleep">ç¡çœ æ™‚é–“ (æ™‚é–“)</label><input type="number" id="sleep" step="0.5" placeholder="ä¾‹: 6.5">
                    <label for="drink">é£²é…’ (24hä»¥å†…)<span class="required"></span></label>
                    <div class="radio-group"><label><input type="radio" name="drink" value="ãªã—" required> ãªã—</label><label><input type="radio" name="drink" value="ã‚ã‚Š"> ã‚ã‚Š</label></div>
                    <label for="medicine">æœè–¬ (é‹è»¢ã«å½±éŸ¿ã™ã‚‹è–¬)</label>
                    <div class="radio-group"><label><input type="radio" name="medicine" value="ãªã—"> ãªã—</label><label><input type="radio" name="medicine" value="ã‚ã‚Š"> ã‚ã‚Š</label></div>
                    <label for="temp">ä½“æ¸© (Â°C)<span class="required"></span></label><input type="number" id="temp" step="0.1" required placeholder="ä¾‹: 36.5">
                    <label for="alcoholValue">ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œæŸ»å€¤ (mg/L)<span class="required"></span></label><input type="text" id="alcoholValue" required placeholder="ä¾‹: 0.00">
                    <label for="startMeter">å‡ºç™ºå‰ãƒ¡ãƒ¼ã‚¿ãƒ¼ (km)<span class="required"></span></label><input type="number" id="startMeter" required>
                    <label for="memo">ãƒ¡ãƒ¢</label><textarea id="memo" rows="3"></textarea>
                </div>


                <div id="section_check">
                    <div class="section-title">3. æ—¥å¸¸ç‚¹æ¤œãƒã‚§ãƒƒã‚¯</div>
                    <label>ãƒ–ãƒ¬ãƒ¼ã‚­</label><div class="radio-group"><label><input type="radio" name="check_brake" value="OK" required> OK</label><label><input type="radio" name="check_brake" value="ç•°å¸¸ã‚ã‚Š"> ç•°å¸¸ã‚ã‚Š</label></div>
                    <label>ã‚¿ã‚¤ãƒ¤</label><div class="radio-group"><label><input type="radio" name="check_tire" value="OK" required> OK</label><label><input type="radio" name="check_tire" value="ç•°å¸¸ã‚ã‚Š"> ç•°å¸¸ã‚ã‚Š</label></div>
                    <label>ç¯ç«é¡</label><div class="radio-group"><label><input type="radio" name="check_light" value="OK" required> OK</label><label><input type="radio" name="check_light" value="ç•°å¸¸ã‚ã‚Š"> ç•°å¸¸ã‚ã‚Š</label></div>
                    <label>ã‚«ãƒ¡ãƒ©ãƒ»ãƒŸãƒ©ãƒ¼</label><div class="radio-group"><label><input type="radio" name="check_camera" value="OK" required> OK</label><label><input type="radio" name="check_camera" value="ç•°å¸¸ã‚ã‚Š"> ç•°å¸¸ã‚ã‚Š</label></div>
                    <label>è»Šä½“å¤–è¦³</label><div class="radio-group"><label><input type="radio" name="check_body" value="OK" required> OK</label><label><input type="radio" name="check_body" value="ç•°å¸¸ã‚ã‚Š"> ç•°å¸¸ã‚ã‚Š</label></div>
                    <label>ãã®ä»–ç‚¹æ¤œ</label><div class="radio-group"><label><input type="radio" name="check_other" value="OK" required> OK</label><label><input type="radio" name="check_other" value="ç•°å¸¸ã‚ã‚Š"> ç•°å¸¸ã‚ã‚Š</label></div>
                    <label for="check_note">ç‚¹æ¤œãƒ¡ãƒ¢</label><textarea id="check_note" rows="3"></textarea>
                </div>

                <div id="section_return" style="display:none;">
                    <div class="section-title">4. é‹è¡Œãƒ»å¸°åº«è¨˜éŒ²</div>
                    <label for="returnPlace">å¸°åº«å ´æ‰€<span class="required"></span></label><input type="text" id="returnPlace" required>
                    <label for="returnTime">å¸°åº«æ™‚é–“<span class="required"></span></label><input type="time" id="returnTime" required>
                    <label for="returnMeter">å¸°åº«ãƒ¡ãƒ¼ã‚¿ãƒ¼ (km)<span class="required"></span></label><input type="number" id="returnMeter" required>
                    <label for="distance">ç·èµ°è¡Œè·é›¢ (è‡ªå‹•è¨ˆç®—)</label><input type="number" id="distance" readonly>
                    <label for="rest">ä¼‘æ†©æ™‚é–“ãƒ»å ´æ‰€ (ä¾‹: 1æ™‚é–“30åˆ†, é“ã®é§…)</label><input type="text" id="rest">
                    <label for="codStatus">ä»£é‡‘å…¥é‡‘çŠ¶æ³ (ç€æ‰•ã„/ç«‹æ›¿)<span class="required"></span></label>
                    <div class="radio-group"><label><input type="radio" name="codStatus" value="ãªã—" required> ãªã—</label><label><input type="radio" name="codStatus" value="å…¥é‡‘æ¸ˆ"> å…¥é‡‘æ¸ˆ</label><label><input type="radio" name="codStatus" value="å¾Œæ—¥å¯¾å¿œ"> å¾Œæ—¥å¯¾å¿œ</label></div>
                    <label for="codAmount">ä»£é‡‘å…¥é‡‘é¡ (å††)</label><input type="number" id="codAmount">
                    <label for="roadStatus">é“è·¯ãƒ»é‹è¡ŒçŠ¶æ³</label><textarea id="roadStatus" rows="3"></textarea>
                    <label for="abnormalDetail">é‹è¡Œä¸­ã®ç•°å¸¸ã®è©³ç´° (ã‚ã‚Œã°)</label><textarea id="abnormalDetail" rows="3"></textarea>
                </div>

                <button type="submit">ã“ã®è¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹</button>

            </form>
            <div id="message" class="message-box"></div>
        </div>
        
        <div id="tab_history" class="tab-content" style="display:none;">
            <div class="section-title" style="margin-top: 0;">ä¿å­˜ã•ã‚ŒãŸç‚¹å‘¼è¨˜éŒ² (ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã®ã¿)</div>
            <div id="historyList">
                <p style="text-align:center; color:#777; padding: 20px;">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            </div>
            
            <button id="pdfPrintButton" class="print-button" style="display:none; background-color: var(--color-ofa-blue);">PDFã‚’ä½œæˆã—ã¦å°åˆ·</button>
            <button id="pdfBackButton" class="back-button" style="display:none; margin-top:10px; background-color:#7F8C8D;" onclick="showTab('history')">å±¥æ­´ä¸€è¦§ã«æˆ»ã‚‹</button>
            
            <div id="pdfOutput" style="display:none;"></div>
        </div>
    </div>
</div>

<script>
    /* -------------------------------------------------- */
    /* JavaScript: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å‡¦ç†ã¨PDFç”Ÿæˆæ©Ÿèƒ½ (æ©Ÿèƒ½ã¯å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒä¸€) */
    /* -------------------------------------------------- */

    const LOCAL_STORAGE_KEY = 'ofaGroupRecords';

    const form = document.getElementById('tenkoForm');
    const modeRadios = document.getElementsByName('mode');
    const departureSection = document.getElementById('section_departure');
    const checkSection = document.getElementById('section_check');
    const returnSection = document.getElementById('section_return');
    const messageBox = document.getElementById('message');
    const startMeterInput = document.getElementById('startMeter');
    const returnMeterInput = document.getElementById('returnMeter');
    const distanceInput = document.getElementById('distance');
    const historyList = document.getElementById('historyList');
    const pdfOutput = document.getElementById('pdfOutput');
    const pdfPrintButton = document.getElementById('pdfPrintButton');
    const pdfBackButton = document.getElementById('pdfBackButton');

    // åˆæœŸåŒ–
    document.getElementById('date').value = new Date().toISOString().slice(0, 10);
    updateFormVisibility();
    loadRecordsAndRenderHistory();

    // --------------------------------------------------
    // 1. ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    // --------------------------------------------------
    function updateFormVisibility() {
        const mode = document.querySelector('input[name="mode"]:checked');
        if (!mode) return;
        
        const isDeparture = mode.value === 'å‡ºç™ºç‚¹å‘¼';
        const isReturn = mode.value === 'å¸°åº«ç‚¹å‘¼ï¼ˆæ—¥å ±ï¼‰';

        departureSection.style.display = isDeparture ? 'block' : 'none';
        checkSection.style.display = isDeparture ? 'block' : 'none';
        returnSection.style.display = isReturn ? 'block' : 'none';

        const requiredDeparture = departureSection.querySelectorAll('[required]');
        const requiredReturn = returnSection.querySelectorAll('[required]');

        requiredDeparture.forEach(el => el.required = isDeparture);
        requiredReturn.forEach(el => el.required = isReturn);
    }
    modeRadios.forEach(radio => radio.addEventListener('change', updateFormVisibility));

    // --------------------------------------------------
    // 2. è·é›¢è¨ˆç®—
    // --------------------------------------------------
    function calculateDistance() {
        const start = parseFloat(startMeterInput.value);
        const end = parseFloat(returnMeterInput.value);
        if (!isNaN(start) && !isNaN(end) && end >= start) {
            distanceInput.value = (end - start).toFixed(1);
        } else {
            distanceInput.value = '';
        }
    }
    returnMeterInput.addEventListener('input', calculateDistance);

    // --------------------------------------------------
    // 3. ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ (ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜)
    // --------------------------------------------------
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const mode = document.querySelector('input[name="mode"]:checked').value;

        // å…¨ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const formData = {
            id: Date.now(), // ãƒ¦ãƒ‹ãƒ¼ã‚¯ID
            date: document.getElementById('date').value,
            mode: mode,
            driverName: document.getElementById('driverName').value,
            company: document.getElementById('company').value,
            email: document.getElementById('email').value,
            client: document.getElementById('client').value,
            area: document.getElementById('area').value,
            base: document.getElementById('base').value,
            startPlace: document.getElementById('startPlace').value,
            submitTime: new Date().toLocaleTimeString('ja-JP'),
        };

        // ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        if (mode === 'å‡ºç™ºç‚¹å‘¼') {
            Object.assign(formData, {
                workTime: document.getElementById('workTime').value,
                startTime: document.getElementById('startTime').value,
                condition: document.getElementById('condition').value,
                sleep: document.getElementById('sleep').value,
                drink: document.querySelector('input[name="drink"]:checked').value,
                medicine: document.querySelector('input[name="medicine"]:checked')?.value || 'ãªã—',
                temp: document.getElementById('temp').value,
                alcoholValue: document.getElementById('alcoholValue').value,
                startMeter: document.getElementById('startMeter').value,
                memo: document.getElementById('memo').value,
                // ç‚¹æ¤œ
                check_brake: document.querySelector('input[name="check_brake"]:checked').value,
                check_tire: document.querySelector('input[name="check_tire"]:checked').value,
                check_light: document.querySelector('input[name="check_light"]:checked').value,
                check_camera: document.querySelector('input[name="check_camera"]:checked').value,
                check_body: document.querySelector('input[name="check_body"]:checked').value,
                check_other: document.querySelector('input[name="check_other"]:checked').value,
                check_note: document.getElementById('check_note').value,
            });
        } else if (mode === 'å¸°åº«ç‚¹å‘¼ï¼ˆæ—¥å ±ï¼‰') {
            Object.assign(formData, {
                returnPlace: document.getElementById('returnPlace').value,
                returnTime: document.getElementById('returnTime').value,
                returnMeter: document.getElementById('returnMeter').value,
                distance: document.getElementById('distance').value,
                rest: document.getElementById('rest').value,
                codStatus: document.querySelector('input[name="codStatus"]:checked').value,
                codAmount: document.getElementById('codAmount').value,
                roadStatus: document.getElementById('roadStatus').value,
                abnormalDetail: document.getElementById('abnormalDetail').value,
            });
        }
        
        saveRecord(formData);
        showMessage(mode + 'ã®è¨˜éŒ²ã‚’ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');
        form.reset();
        document.getElementById('date').value = new Date().toISOString().slice(0, 10);
        updateFormVisibility();
        loadRecordsAndRenderHistory(); // å±¥æ­´ã‚’æ›´æ–°
        showTab('history'); // å±¥æ­´ã‚¿ãƒ–ã«ç§»å‹•
    });
    
    // --------------------------------------------------
    // 4. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ“ä½œ
    // --------------------------------------------------
    function getRecords() {
        const records = localStorage.getItem(LOCAL_STORAGE_KEY);
        return records ? JSON.parse(records) : [];
    }

    function saveRecord(newRecord) {
        let records = getRecords();
        
        // å¸°åº«ç‚¹å‘¼ã®å ´åˆã€ç›´å‰ã®å‡ºç™ºç‚¹å‘¼è¨˜éŒ²ã‚’æ¢ã—ã¦çµåˆã™ã‚‹ï¼ˆåŒã˜æ—¥ã€åŒã˜ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ï¼‰
        if (newRecord.mode === 'å¸°åº«ç‚¹å‘¼ï¼ˆæ—¥å ±ï¼‰') {
            const departureRecordIndex = records.findIndex(r => 
                r.mode === 'å‡ºç™ºç‚¹å‘¼' && 
                r.date === newRecord.date && 
                r.driverName === newRecord.driverName &&
                !r.returnTime // å¸°åº«æƒ…å ±ãŒã¾ã ãªã„ã‚‚ã®
            );

            if (departureRecordIndex !== -1) {
                // æ—¢å­˜ã®å‡ºç™ºè¨˜éŒ²ã«å¸°åº«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸
                records[departureRecordIndex] = { ...records[departureRecordIndex], ...newRecord };
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(records));
                return;
            }
        }
        
        // æ–°ã—ã„è¨˜éŒ²ã¨ã—ã¦ä¿å­˜
        records.push(newRecord);
        records.sort((a, b) => b.id - a.id); // æ–°ã—ã„ã‚‚ã®ã‚’å…ˆé ­ã«
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(records));
    }

    // --------------------------------------------------
    // 5. å±¥æ­´ãƒªã‚¹ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    // --------------------------------------------------
    function loadRecordsAndRenderHistory() {
        const records = getRecords();
        historyList.innerHTML = '';

        if (records.length === 0) {
            historyList.innerHTML = '<p style="text-align:center; color:#777; padding: 20px;">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }

        records.forEach(record => {
            const isCompleted = record.mode === 'å¸°åº«ç‚¹å‘¼ï¼ˆæ—¥å ±ï¼‰' || (record.mode === 'å‡ºç™ºç‚¹å‘¼' && record.returnTime);
            const status = isCompleted ? ' (å¸°åº«å®Œäº†)' : (record.mode === 'å‡ºç™ºç‚¹å‘¼' ? ' (å¸°åº«å¾…ã¡)' : ' (å˜ç‹¬å¸°åº«)');
            
            const item = document.createElement('div');
            item.className = 'record-item' + (isCompleted ? ' completed' : '');
            item.innerHTML = `
                <div class="record-item-title">${record.date} ${status}</div>
                <div class="record-item-mode">${record.driverName} / ${record.company} / ${record.mode}</div>
            `;
            item.onclick = () => showRecordDetails(record);
            historyList.appendChild(item);
        });
    }

    // --------------------------------------------------
    // 6. è¨˜éŒ²è©³ç´°è¡¨ç¤ºã¨PDFç”Ÿæˆ
    // --------------------------------------------------
    function showRecordDetails(record) {
        // PDFå‡ºåŠ›ã‚¨ãƒªã‚¢ã«HTMLã‚’æ•´å½¢ã—ã¦æŒ¿å…¥
        pdfOutput.innerHTML = generateRecordHtml(record);
        
        // ã‚¿ãƒ–ã‚’PDFè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
        const tabContent = document.getElementById('tab_history');
        const listContainer = document.getElementById('historyList');

        tabContent.style.display = 'block';
        listContainer.style.display = 'none';
        pdfOutput.style.display = 'block';
        
        pdfPrintButton.style.display = 'block';
        pdfBackButton.style.display = 'block';
    }
    
    // PDF/å°åˆ·ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    pdfPrintButton.addEventListener('click', function() {
        window.print(); // ãƒ–ãƒ©ã‚¦ã‚¶ã®å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’èµ·å‹•
    });

    // è¨˜éŒ²ã®HTMLæ•´å½¢ (PDFå‡ºåŠ›ç”¨)
    function generateRecordHtml(data) {
        // å‡ºç™ºã¨å¸°åº«ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŒºåˆ¥ã™ã‚‹ãŸã‚ã«ã€ä¸€æ™‚çš„ãªå¤‰æ•°ã‚’ä½œæˆ
        const departureData = data.mode === 'å‡ºç™ºç‚¹å‘¼' ? data : getDepartureHalf(data);
        const returnData = data.mode === 'å¸°åº«ç‚¹å‘¼ï¼ˆæ—¥å ±ï¼‰' ? data : getReturnHalf(data);
        
        const isCompleted = departureData && returnData && (departureData.startMeter && returnData.returnMeter); // ãƒ¡ãƒ¼ã‚¿ãƒ¼æƒ…å ±ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèª

        let html = `
            <style>
                /* PDFç”¨ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
                .pdf-doc { font-family: 'Noto Sans JP', sans-serif; padding: 20px; border: 1px solid #ddd; }
                .pdf-header { text-align: center; margin-bottom: 20px; border-bottom: 3px solid #38C172; }
                .pdf-header h2 { color: #3498DB; margin: 0; }
                .pdf-section { margin-top: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
                .pdf-section-title { background-color: #F8F9F9; padding: 8px 10px; font-weight: bold; border-left: 5px solid #F1C40F; color: #3498DB; }
                .pdf-item { display: flex; border-bottom: 1px dotted #ccc; padding: 5px 0; font-size: 14px; }
                .pdf-item-label { width: 35%; font-weight: bold; }
                .pdf-item-value { width: 65%; }
                .pdf-status { background-color: ${isCompleted ? '#d4edda' : '#f8d7da'}; padding: 10px; text-align: center; font-weight: bold; margin-bottom: 15px; border-radius: 4px; }
            </style>
            <div class="pdf-doc">
                <div class="pdf-header">
                    <div style="color:#E74C3C; font-weight:bold;">OFA GROUP</div>
                    <h2>Webç‚¹å‘¼ãƒ»æ—¥å ± è¨˜éŒ² (${data.date})</h2>
                </div>
                <div class="pdf-status">${isCompleted ? 'é‹è¡Œå®Œäº† (å‡ºç™ºãƒ»å¸°åº« è¨˜éŒ²æ¸ˆã¿)' : (data.mode === 'å‡ºç™ºç‚¹å‘¼' ? 'å‡ºç™ºç‚¹å‘¼ã®ã¿è¨˜éŒ²' : 'å¸°åº«ç‚¹å‘¼ã®ã¿è¨˜éŒ²')}</div>
                
                <div class="pdf-section">
                    <div class="pdf-section-title">åŸºæœ¬æƒ…å ±</div>
                    <div class="pdf-item"><div class="pdf-item-label">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å:</div><div class="pdf-item-value">${data.driverName || '-'}</div></div>
                    <div class="pdf-item"><div class="pdf-item-label">æ‰€å±ä¼šç¤¾:</div><div class="pdf-item-value">${data.company || '-'}</div></div>
                    <div class="pdf-item"><div class="pdf-item-label">æ¡ˆä»¶/ã‚¨ãƒªã‚¢:</div><div class="pdf-item-value">${data.client || '-'} / ${data.area || '-'}</div></div>
                    <div class="pdf-item"><div class="pdf-item-label">å‡ºåº«ãƒ™ãƒ¼ã‚¹/å ´æ‰€:</div><div class="pdf-item-value">${data.base || '-'} / ${data.startPlace || '-'}</div></div>
                </div>
        `;
        
        // å‡ºç™ºç‚¹å‘¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³
        if (departureData && departureData.startTime) {
            html += `
                <div class="pdf-section">
                    <div class="pdf-section-title">å‡ºç™ºç‚¹å‘¼ (æ™‚åˆ»: ${departureData.startTime} è¨˜éŒ²æ™‚åˆ»: ${departureData.submitTime})</div>
                    <div class="pdf-item"><div class="pdf-item-label">ä½“èª¿/ä½“æ¸©:</div><div class="pdf-item-value">${departureData.condition || '-'} / ${departureData.temp || '-'}â„ƒ</div></div>
                    <div class="pdf-item"><div class="pdf-item-label">ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«å€¤:</div><div class="pdf-item-value">${departureData.alcoholValue || '-'} mg/L</div></div>
                    <div class="pdf-item"><div class="pdf-item-label">é£²é…’(24h)/æœè–¬:</div><div class="pdf-item-value">${departureData.drink || '-'} / ${departureData.medicine || '-'}</div></div>
                    <div class="pdf-item"><div class="pdf-item-label">å‡ºç™ºå‰ãƒ¡ãƒ¼ã‚¿ãƒ¼:</div><div class="pdf-item-value">${departureData.startMeter || '-'} km</div></div>
                    <div class="pdf-item"><div class="pdf-item-label">ãƒ¡ãƒ¢:</div><div class="pdf-item-value">${departureData.memo || '-'}</div></div>
                </div>
                <div class="pdf-section">
                    <div class="pdf-section-title">æ—¥å¸¸ç‚¹æ¤œ</div>
                    <div class="pdf-item"><div class="pdf-item-label">ãƒ–ãƒ¬ãƒ¼ã‚­/ã‚¿ã‚¤ãƒ¤:</div><div class="pdf-item-value">${departureData.check_brake || '-'} / ${departureData.check_tire || '-'}</div></div>
                    <div class="pdf-item"><div class="pdf-item-label">ç¯ç«é¡/ã‚«ãƒ¡ãƒ©:</div><div class="pdf-item-value">${departureData.check_light || '-'} / ${departureData.check_camera || '-'}</div></div>
                    <div class="pdf-item"><div class="pdf-item-label">è»Šä½“å¤–è¦³/ãã®ä»–:</div><div class="pdf-item-value">${departureData.check_body || '-'} / ${departureData.check_other || '-'}</div></div>
                    <div class="pdf-item"><div class="pdf-item-label">ç‚¹æ¤œãƒ¡ãƒ¢:</div><div class="pdf-item-value">${departureData.check_note || '-'}</div></div>
                </div>
            `;
        }
        
        // å¸°åº«ç‚¹å‘¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³
        if (returnData && returnData.returnTime) {
            html += `
                <div class="pdf-section">
                    <div class="pdf-section-title">å¸°åº«ç‚¹å‘¼/æ—¥å ± (æ™‚åˆ»: ${returnData.returnTime} è¨˜éŒ²æ™‚åˆ»: ${returnData.submitTime})</div>
                    <div class="pdf-item"><div class="pdf-item-label">å¸°åº«å ´æ‰€:</div><div class="pdf-item-value">${returnData.returnPlace || '-'}</div></div>
                    <div class="pdf-item"><div class="pdf-item-label">ç·èµ°è¡Œè·é›¢:</div><div class="pdf-item-value">${returnData.distance || '-'} km (å‡ºç™ºãƒ¡ãƒ¼ã‚¿ãƒ¼: ${departureData ? departureData.startMeter : '-'})</div></div>
                    <div class="pdf-item"><div class="pdf-item-label">ä¼‘æ†©æ™‚é–“/å ´æ‰€:</div><div class="pdf-item-value">${returnData.rest || '-'}</div></div>
                    <div class="pdf-item"><div class="pdf-item-label">ä»£é‡‘å…¥é‡‘çŠ¶æ³/é¡:</div><div class="pdf-item-value">${returnData.codStatus || '-'} / ${returnData.codAmount ? returnData.codAmount + 'å††' : '-'}</div></div>
                    <div class="pdf-item"><div class="pdf-item-label">é“è·¯ãƒ»é‹è¡ŒçŠ¶æ³:</div><div class="pdf-item-value">${returnData.roadStatus || '-'}</div></div>
                    <div class="pdf-item"><div class="pdf-item-label">ç•°å¸¸ã®è©³ç´°:</div><div class="pdf-item-value">${returnData.abnormalDetail || '-'}</div></div>
                </div>
            `;
        }

        html += '</div>';
        return html;
    }
    
    // --------------------------------------------------
    // 7. ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
    // --------------------------------------------------
    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
        
        document.getElementById(`tab_${tabId}`).style.display = 'block';
        document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');

        if (tabId === 'history') {
            loadRecordsAndRenderHistory();
            // å±¥æ­´ä¸€è¦§ã‚’è¡¨ç¤ºã—ã€PDFè©³ç´°è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            historyList.style.display = 'block';
            pdfOutput.style.display = 'none';
            pdfPrintButton.style.display = 'none';
            pdfBackButton.style.display = 'none';
        }
    }

    function showMessage(msg, type) {
        messageBox.className = 'message-box';
        messageBox.classList.add(type);
        messageBox.textContent = msg;
        messageBox.style.display = 'block';
    }
    
    // çµåˆã•ã‚ŒãŸè¨˜éŒ²ã‹ã‚‰ã€å‡ºç™ºéƒ¨åˆ†ã®ã¿ã‚’è¿”ã™ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function getDepartureHalf(data) {
        if (data.mode === 'å‡ºç™ºç‚¹å‘¼') return data;
        const departureKeys = ['workTime', 'startTime', 'condition', 'sleep', 'drink', 'medicine', 'temp', 'alcoholValue', 'startMeter', 'memo', 'check_brake', 'check_tire', 'check_light', 'check_camera', 'check_body', 'check_other', 'check_note'];
        const departureData = {};
        departureKeys.forEach(key => departureData[key] = data[key]);
        departureData.submitTime = data.submitTime;
        return departureData;
    }

    // çµåˆã•ã‚ŒãŸè¨˜éŒ²ã‹ã‚‰ã€å¸°åº«éƒ¨åˆ†ã®ã¿ã‚’è¿”ã™ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function getReturnHalf(data) {
        if (data.mode === 'å¸°åº«ç‚¹å‘¼ï¼ˆæ—¥å ±ï¼‰') return data;
        const returnKeys = ['returnPlace', 'returnTime', 'returnMeter', 'distance', 'rest', 'codStatus', 'codAmount', 'roadStatus', 'abnormalDetail'];
        const returnData = {};
        returnKeys.forEach(key => returnData[key] = data[key]);
        returnData.submitTime = data.submitTime;
        return returnData;
    }
</script>

</body>
</html>
