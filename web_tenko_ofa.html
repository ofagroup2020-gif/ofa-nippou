<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OFA GROUP Webç‚¹å‘¼ãƒ»æ—¥å ±ãƒ•ã‚©ãƒ¼ãƒ </title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --color-ofa-green: #38C172;
      --color-ofa-red: #E74C3C;
      --color-ofa-blue: #3498DB;
      --color-ofa-yellow: #F1C40F;
      --color-bg: #F0FFF0;
      --color-text: #2C3E50;
      --color-border: #E0E0E0;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--color-bg);
      color: var(--color-text);
      line-height: 1.6;
    }

    .container {
      max-width: 680px;
      margin: 24px auto;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.14);
      overflow: hidden;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header-area {
      background: linear-gradient(135deg, #38C172, #2ECC71);
      color: #fff;
      padding: 20px 18px 16px;
      text-align: center;
    }
    .ofa-logo-block {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      letter-spacing: .1em;
      margin-bottom: 6px;
      font-size: 15px;
    }
    .ofa-logo-circle {
      background: #fff;
      color: #38C172;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 18px;
      margin-right: 8px;
    }
    .header-main {
      font-size: 19px;
      font-weight: 800;
    }
    .header-sub {
      font-size: 11px;
      margin-top: 3px;
      opacity: 0.9;
    }
    .header-badge {
      margin-top: 6px;
      display: inline-block;
      background: rgba(0,0,0,0.18);
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 10px;
    }

    .content-wrapper {
      padding: 14px 14px 18px;
    }

    /* ã‚¿ãƒ– */
    .tab-buttons {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
      border-bottom: 2px solid #eee;
    }
    .tab-button {
      flex: 1;
      border: none;
      background: #f3f3f3;
      padding: 8px 4px;
      font-size: 12px;
      font-weight: 700;
      border-radius: 999px 999px 0 0;
      cursor: pointer;
      color: #555;
    }
    .tab-button.active {
      background: var(--color-ofa-green);
      color: #fff;
    }

    .tab-content {
      padding-top: 4px;
    }

    .section-title {
      margin-top: 16px;
      margin-bottom: 8px;
      padding: 7px 10px;
      font-size: 13px;
      font-weight: 700;
      background: #F8F9F9;
      border-left: 4px solid var(--color-ofa-yellow);
      color: var(--color-ofa-blue);
    }

    label {
      display: block;
      margin-top: 9px;
      font-size: 13px;
      font-weight: 600;
    }
    .required-mark::after {
      content: " *";
      color: var(--color-ofa-red);
      font-weight: 700;
      margin-left: 3px;
    }

    input[type="text"],
    input[type="date"],
    input[type="time"],
    input[type="number"],
    input[type="email"],
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      margin-top: 3px;
      border-radius: 8px;
      border: 1px solid var(--color-border);
      font-size: 13px;
      background: #FAFFFA;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--color-ofa-green);
      box-shadow: 0 0 0 2px rgba(56,193,114,0.2);
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .radio-group {
      margin-top: 5px;
      padding: 7px 8px;
      background: #F8F9F9;
      border-radius: 8px;
      border: 1px solid var(--color-border);
      font-size: 13px;
    }
    .radio-group label {
      display: inline-block;
      margin-right: 14px;
      font-weight: 500;
      margin-top: 2px;
    }

    button.main-btn {
      display: block;
      width: 100%;
      margin-top: 18px;
      padding: 11px;
      border-radius: 10px;
      border: none;
      background: var(--color-ofa-red);
      color: #fff;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 3px 0 #A93226;
      transition: background .2s, transform .05s, box-shadow .05s;
    }
    button.main-btn:hover {
      background: #C0392B;
    }
    button.main-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 0 #A93226;
    }

    .message-box {
      margin-top: 10px;
      padding: 7px 9px;
      border-radius: 8px;
      font-size: 12px;
      display: none;
    }
    .message-box.success {
      background: #E8F8F3;
      border: 1px solid #A9DFBF;
      color: #1E8449;
    }
    .message-box.error {
      background: #FDEDEC;
      border: 1px solid #F5B7B1;
      color: #C0392B;
    }

    /* å±¥æ­´ã‚¨ãƒªã‚¢ */
    .history-top {
      font-size: 11px;
      color: #777;
      margin-bottom: 6px;
    }
    .history-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }
    .history-filters input {
      font-size: 11px;
      padding: 5px 6px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background:#FBFFFB;
      flex: 1;
      min-width: 120px;
    }

    .history-actions {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .sub-btn {
      flex: 1;
      min-width: 120px;
      padding: 7px 8px;
      border-radius: 999px;
      border: none;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
    }
    .sub-btn.blue {
      background: var(--color-ofa-blue);
      color: #fff;
    }
    .sub-btn.gray {
      background: #ECF0F1;
      color: #333;
    }
    .sub-btn.red {
      background: var(--color-ofa-red);
      color: #fff;
    }

    .record-item {
      padding: 9px 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
      margin-bottom: 7px;
      cursor: pointer;
      font-size: 12px;
      border-left: 4px solid var(--color-ofa-blue);
      transition: background .15s, transform .05s;
    }
    .record-item.completed {
      border-left-color: var(--color-ofa-green);
    }
    .record-item:hover {
      background: #f5f5f5;
      transform: translateY(-1px);
    }
    .record-item-title {
      font-weight: 700;
      font-size: 12px;
    }
    .record-item-sub {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
    }

    /* PDF è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆå°åˆ·ç”¨ï¼‰ */
    @media print {
      body > *:not(#pdfOutput) {
        display: none !important;
      }
      #pdfOutput {
        display: block !important;
        margin: 0;
        box-shadow: none;
        border: none;
      }
    }

    .pdf-doc {
      font-family: 'Noto Sans JP', sans-serif;
      padding: 16px 16px 22px;
      border: 1px solid #ddd;
    }
    .pdf-header {
      text-align: center;
      border-bottom: 2px solid var(--color-ofa-green);
      padding-bottom: 6px;
      margin-bottom: 8px;
    }
    .pdf-header-main {
      font-size: 15px;
      font-weight: 700;
      color: var(--color-ofa-blue);
    }
    .pdf-header-sub {
      font-size: 10px;
      color: #555;
    }
    .pdf-section {
      margin-top: 8px;
      border-top: 1px solid #eee;
      padding-top: 4px;
    }
    .pdf-section-title {
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 3px;
      color: var(--color-ofa-blue);
    }
    .pdf-row {
      display: flex;
      font-size: 11px;
      padding: 2px 0;
    }
    .pdf-label {
      width: 34%;
      font-weight: 600;
    }
    .pdf-value {
      width: 66%;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header-area">
    <div class="ofa-logo-block">
      <div class="ofa-logo-circle">OFA</div>
      OFA GROUP
    </div>
    <div class="header-main">Webç‚¹å‘¼ãƒ»æ—¥å ±ãƒ•ã‚©ãƒ¼ãƒ </div>
    <div class="header-sub">ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã ã‘ä¸€æ™‚ä¿å­˜ï¼PDFã¯å„è‡ªã§ä¿å­˜ãƒ»LINEå…±æœ‰OK</div>
    <div class="header-badge">â€» è«‹æ±‚ã§ã¯ãªãã€Œãƒ‰ãƒ©ã‚¤ãƒãƒ¼æœ¬äººã®è¨˜éŒ²ç”¨ãƒ„ãƒ¼ãƒ«ã€ã§ã™</div>
  </div>

  <div class="content-wrapper">
    <div class="tab-buttons">
      <button class="tab-button active" onclick="showTab('form')">ğŸ“ ç‚¹å‘¼ãƒ»æ—¥å ±å…¥åŠ›</button>
      <button class="tab-button" onclick="showTab('history')">ğŸ“‹ å±¥æ­´ãƒ»æ¤œç´¢ãƒ»PDF</button>
    </div>

    <!-- ã‚¿ãƒ–ï¼šå…¥åŠ› -->
    <div id="tab_form" class="tab-content">
      <form id="tenkoForm">
        <div class="section-title">0. ãƒ¢ãƒ¼ãƒ‰é¸æŠ</div>
        <div class="radio-group">
          <label><input type="radio" name="mode" value="å‡ºç™ºç‚¹å‘¼"> å‡ºç™ºç‚¹å‘¼</label>
          <label><input type="radio" name="mode" value="å¸°åº«ç‚¹å‘¼ï¼ˆæ—¥å ±ï¼‰"> å¸°åº«ç‚¹å‘¼ï¼ˆæ—¥å ±ï¼‰</label>
          <div style="font-size:10px;color:#777;margin-top:4px;">
            å‡ºç™ºæ™‚ã¨å¸°åº«æ™‚ã§ãã‚Œãã‚Œå…¥åŠ›ã—ã¾ã™ã€‚åŒã˜æ—¥ãƒ»åŒã˜ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ãƒ»åŒã˜ä¼šç¤¾ãªã‚‰è‡ªå‹•ã§1ä»¶ã«ã¾ã¨ã‚ã¾ã™ã€‚
          </div>
        </div>

        <div class="section-title">1. åŸºæœ¬æƒ…å ±</div>
        <label for="date" class="required-mark">æ—¥ä»˜</label>
        <input type="date" id="date" required>

        <label for="driverName" class="required-mark">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å</label>
        <input type="text" id="driverName" required>

        <label for="company" class="required-mark">æ‰€å±ä¼šç¤¾</label>
        <input type="text" id="company" required>

        <label for="email">é€£çµ¡å…ˆï¼ˆä»»æ„ï¼‰</label>
        <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„LINEåãªã©ãƒ¡ãƒ¢ã§ã‚‚OK">

        <label for="client">æ¡ˆä»¶ï¼ˆè·ä¸»ï¼‰</label>
        <input type="text" id="client">

        <label for="area">ã‚¨ãƒªã‚¢</label>
        <input type="text" id="area">

        <label for="base">å‡ºåº«ãƒ™ãƒ¼ã‚¹</label>
        <input type="text" id="base">

        <label for="startPlace">å‡ºåº«å ´æ‰€</label>
        <input type="text" id="startPlace">

        <!-- å‡ºç™ºç‚¹å‘¼ -->
        <div id="section_departure">
          <div class="section-title">2. å‡ºç™ºå‰ãƒã‚§ãƒƒã‚¯</div>

          <label for="workTime">å‡ºå‹¤æ™‚é–“</label>
          <input type="time" id="workTime">

          <label for="startTime" class="required-mark">å‡ºç™ºæ™‚é–“</label>
          <input type="time" id="startTime">

          <label for="condition" class="required-mark">ä½“èª¿</label>
          <select id="condition">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="è‰¯å¥½">è‰¯å¥½</option>
            <option value="æ™®é€š">æ™®é€š</option>
            <option value="ä¸èª¿">ä¸èª¿</option>
          </select>

          <label for="sleep">ç¡çœ æ™‚é–“ï¼ˆæ™‚é–“ï¼‰</label>
          <input type="number" id="sleep" step="0.5" placeholder="ä¾‹: 6.5">

          <label class="required-mark">é£²é…’ (24hä»¥å†…)</label>
          <div class="radio-group">
            <label><input type="radio" name="drink" value="ãªã—"> ãªã—</label>
            <label><input type="radio" name="drink" value="ã‚ã‚Š"> ã‚ã‚Š</label>
          </div>

          <label>æœè–¬ï¼ˆé‹è»¢ã«å½±éŸ¿ã™ã‚‹è–¬ï¼‰</label>
          <div class="radio-group">
            <label><input type="radio" name="medicine" value="ãªã—"> ãªã—</label>
            <label><input type="radio" name="medicine" value="ã‚ã‚Š"> ã‚ã‚Š</label>
          </div>

          <label for="temp" class="required-mark">ä½“æ¸© (â„ƒ)</label>
          <input type="number" id="temp" step="0.1" placeholder="ä¾‹: 36.6">

          <label for="alcoholValue" class="required-mark">ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œæŸ»å€¤ (mg/L)</label>
          <input type="text" id="alcoholValue" placeholder="ä¾‹: 0.00">

          <label for="startMeter" class="required-mark">å‡ºç™ºå‰ãƒ¡ãƒ¼ã‚¿ãƒ¼ (km)</label>
          <input type="number" id="startMeter" placeholder="ä¾‹: 12345">

          <label for="memo">ãƒ¡ãƒ¢</label>
          <textarea id="memo" placeholder="è·ç‰©ã®ç‰¹å¾´ãƒ»æ³¨æ„ç‚¹ãªã©"></textarea>
        </div>

        <!-- æ—¥å¸¸ç‚¹æ¤œ -->
        <div id="section_check">
          <div class="section-title">3. æ—¥å¸¸ç‚¹æ¤œãƒã‚§ãƒƒã‚¯</div>

          <label class="required-mark">ãƒ–ãƒ¬ãƒ¼ã‚­</label>
          <div class="radio-group">
            <label><input type="radio" name="check_brake" value="OK"> OK</label>
            <label><input type="radio" name="check_brake" value="ç•°å¸¸ã‚ã‚Š"> ç•°å¸¸ã‚ã‚Š</label>
          </div>

          <label class="required-mark">ã‚¿ã‚¤ãƒ¤</label>
          <div class="radio-group">
            <label><input type="radio" name="check_tire" value="OK"> OK</label>
            <label><input type="radio" name="check_tire" value="ç•°å¸¸ã‚ã‚Š"> ç•°å¸¸ã‚ã‚Š</label>
          </div>

          <label class="required-mark">ç¯ç«é¡</label>
          <div class="radio-group">
            <label><input type="radio" name="check_light" value="OK"> OK</label>
            <label><input type="radio" name="check_light" value="ç•°å¸¸ã‚ã‚Š"> ç•°å¸¸ã‚ã‚Š</label>
          </div>

          <label class="required-mark">ã‚«ãƒ¡ãƒ©ãƒ»ãƒŸãƒ©ãƒ¼</label>
          <div class="radio-group">
            <label><input type="radio" name="check_camera" value="OK"> OK</label>
            <label><input type="radio" name="check_camera" value="ç•°å¸¸ã‚ã‚Š"> ç•°å¸¸ã‚ã‚Š</label>
          </div>

          <label class="required-mark">è»Šä½“å¤–è¦³</label>
          <div class="radio-group">
            <label><input type="radio" name="check_body" value="OK"> OK</label>
            <label><input type="radio" name="check_body" value="ç•°å¸¸ã‚ã‚Š"> ç•°å¸¸ã‚ã‚Š</label>
          </div>

          <label class="required-mark">ãã®ä»–ç‚¹æ¤œ</label>
          <div class="radio-group">
            <label><input type="radio" name="check_other" value="OK"> OK</label>
            <label><input type="radio" name="check_other" value="ç•°å¸¸ã‚ã‚Š"> ç•°å¸¸ã‚ã‚Š</label>
          </div>

          <label for="check_note">ç‚¹æ¤œãƒ¡ãƒ¢</label>
          <textarea id="check_note" placeholder="æ°—ã«ãªã£ãŸç‚¹ãªã©"></textarea>
        </div>

        <!-- å¸°åº« -->
        <div id="section_return" style="display:none;">
          <div class="section-title">4. é‹è¡Œãƒ»å¸°åº«è¨˜éŒ²</div>

          <label for="returnPlace" class="required-mark">å¸°åº«å ´æ‰€</label>
          <input type="text" id="returnPlace">

          <label for="returnTime" class="required-mark">å¸°åº«æ™‚é–“</label>
          <input type="time" id="returnTime">

          <label for="returnMeter" class="required-mark">å¸°åº«ãƒ¡ãƒ¼ã‚¿ãƒ¼ (km)</label>
          <input type="number" id="returnMeter">

          <label for="distance">ç·èµ°è¡Œè·é›¢ (è‡ªå‹•è¨ˆç®—)</label>
          <input type="number" id="distance" readonly>

          <label for="rest">ä¼‘æ†©æ™‚é–“ãƒ»å ´æ‰€</label>
          <input type="text" id="rest" placeholder="ä¾‹: 1æ™‚é–“30åˆ† / SAä¼‘æ†©ãªã©">

          <label class="required-mark">ä»£é‡‘å…¥é‡‘çŠ¶æ³ (ç€æ‰•ã„/ç«‹æ›¿)</label>
          <div class="radio-group">
            <label><input type="radio" name="codStatus" value="ãªã—"> ãªã—</label>
            <label><input type="radio" name="codStatus" value="å…¥é‡‘æ¸ˆ"> å…¥é‡‘æ¸ˆ</label>
            <label><input type="radio" name="codStatus" value="å¾Œæ—¥å¯¾å¿œ"> å¾Œæ—¥å¯¾å¿œ</label>
          </div>

          <label for="codAmount">ä»£é‡‘å…¥é‡‘é¡ (å††)</label>
          <input type="number" id="codAmount">

          <label for="roadStatus">é“è·¯ãƒ»é‹è¡ŒçŠ¶æ³</label>
          <textarea id="roadStatus"></textarea>

          <label for="abnormalDetail">é‹è¡Œä¸­ã®ç•°å¸¸ã®è©³ç´°</label>
          <textarea id="abnormalDetail"></textarea>
        </div>

        <button type="submit" class="main-btn">ã“ã®è¨˜éŒ²ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜</button>
      </form>

      <div id="message" class="message-box"></div>
    </div>

    <!-- ã‚¿ãƒ–ï¼šå±¥æ­´ -->
    <div id="tab_history" class="tab-content" style="display:none;">
      <div class="section-title" style="margin-top:0;">ä¿å­˜ã•ã‚ŒãŸç‚¹å‘¼è¨˜éŒ²</div>
      <div class="history-top">
        ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¸­ã ã‘ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚PDFä¿å­˜ãƒ»LINEå…±æœ‰ãƒ»å°åˆ·ã¯è‡ªç”±ã§ã™ã€‚
      </div>

      <div class="history-filters">
        <input type="date" id="filterDateFrom" placeholder="é–‹å§‹æ—¥">
        <input type="date" id="filterDateTo" placeholder="çµ‚äº†æ—¥">
        <input type="text" id="filterDriver" placeholder="ãƒ‰ãƒ©ã‚¤ãƒãƒ¼åã§æ¤œç´¢">
      </div>

      <div class="history-actions">
        <button class="sub-btn blue" id="btnPrintPdf" style="display:none;">ã“ã®ç”»é¢ã‚’PDFå°åˆ·</button>
        <button class="sub-btn gray" id="btnBackList" style="display:none;">ä¸€è¦§ã«æˆ»ã‚‹</button>
        <button class="sub-btn red" id="btnResetHistory">å±¥æ­´ã‚’å…¨ã¦ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <div id="historyList"></div>
      <div id="pdfOutput" style="display:none;"></div>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = 'ofaGroupTenkoRecords_v2';

  const form = document.getElementById('tenkoForm');
  const messageBox = document.getElementById('message');

  const modeRadios = document.getElementsByName('mode');
  const sectionDeparture = document.getElementById('section_departure');
  const sectionCheck = document.getElementById('section_check');
  const sectionReturn = document.getElementById('section_return');

  const startMeterInput = document.getElementById('startMeter');
  const returnMeterInput = document.getElementById('returnMeter');
  const distanceInput = document.getElementById('distance');

  const historyList = document.getElementById('historyList');
  const pdfOutput = document.getElementById('pdfOutput');
  const btnPrintPdf = document.getElementById('btnPrintPdf');
  const btnBackList = document.getElementById('btnBackList');
  const btnResetHistory = document.getElementById('btnResetHistory');

  const filterDateFrom = document.getElementById('filterDateFrom');
  const filterDateTo = document.getElementById('filterDateTo');
  const filterDriver = document.getElementById('filterDriver');

  // åˆæœŸæ—¥ä»˜
  document.getElementById('date').value = new Date().toISOString().slice(0,10);

  // ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã‚‹è¡¨ç¤ºåˆ‡æ›¿
  function updateFormVisibility() {
    const modeEl = document.querySelector('input[name="mode"]:checked');
    if (!modeEl) {
      // æœªé¸æŠæ™‚ã¯å‡ºç™ºãƒ¢ãƒ¼ãƒ‰æƒ³å®šã§å‡ºã—ã¦ãŠã
      sectionDeparture.style.display = 'block';
      sectionCheck.style.display = 'block';
      sectionReturn.style.display = 'none';
      return;
    }
    const mode = modeEl.value;
    if (mode === 'å‡ºç™ºç‚¹å‘¼') {
      sectionDeparture.style.display = 'block';
      sectionCheck.style.display = 'block';
      sectionReturn.style.display = 'none';
    } else {
      sectionDeparture.style.display = 'none';
      sectionCheck.style.display = 'none';
      sectionReturn.style.display = 'block';
    }
  }
  for (let i = 0; i < modeRadios.length; i++) {
    modeRadios[i].addEventListener('change', updateFormVisibility);
  }

  // è·é›¢è‡ªå‹•è¨ˆç®—
  function calcDistance() {
    const s = parseFloat(startMeterInput.value);
    const e = parseFloat(returnMeterInput.value);
    if (!isNaN(s) && !isNaN(e) && e >= s) {
      distanceInput.value = (e - s).toFixed(1);
    } else {
      distanceInput.value = '';
    }
  }
  startMeterInput.addEventListener('input', calcDistance);
  returnMeterInput.addEventListener('input', calcDistance);

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  function showMessage(text, type) {
    messageBox.textContent = text;
    messageBox.className = 'message-box ' + type;
    messageBox.style.display = 'block';
    setTimeout(() => {
      messageBox.style.display = 'none';
    }, 3000);
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ˜ãƒ«ãƒ‘ãƒ¼
  function loadRecords() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch(e) {
      console.error(e);
      return [];
    }
  }
  function saveRecords(records) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
  }

  // ãƒ¬ã‚³ãƒ¼ãƒ‰ä¿å­˜ï¼ˆå‡ºç™ºã¨å¸°åº«ã‚’çµåˆï¼‰
  function saveRecord(record) {
    let records = loadRecords();

    if (record.mode === 'å¸°åº«ç‚¹å‘¼ï¼ˆæ—¥å ±ï¼‰') {
      const idx = records.findIndex(r =>
        (r.mode === 'å‡ºç™ºç‚¹å‘¼' || r.mode === 'é‹è¡Œå®Œäº†') &&
        r.date === record.date &&
        r.driverName === record.driverName &&
        r.company === record.company &&
        !r.returnTime // ã¾ã å¸°åº«å…¥ã£ã¦ãªã„ã‚‚ã®
      );
      if (idx !== -1) {
        const base = records[idx];
        const merged = {
          ...base,
          ...record,
          mode: 'é‹è¡Œå®Œäº†'
        };
        // è·é›¢è‡ªå‹•è¨ˆç®—
        const s = parseFloat(merged.startMeter);
        const e = parseFloat(merged.returnMeter);
        if (!isNaN(s) && !isNaN(e) && e >= s) {
          merged.distance = (e - s).toFixed(1);
        }
        records[idx] = merged;
      } else {
        // å‡ºç™ºãŒãªã„å˜ç‹¬å¸°åº«
        records.push(record);
      }
    } else {
      // å‡ºç™ºç‚¹å‘¼ã¯ãã®ã¾ã¾è¿½åŠ 
      records.push(record);
    }

    // æ—¥ä»˜ï¼‹æ™‚é–“é †ã§æ–°ã—ã„é †ã«
    records.sort((a, b) => (b.id || 0) - (a.id || 0));
    saveRecords(records);
  }

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
  form.addEventListener('submit', function(e) {
    e.preventDefault();

    const modeEl = document.querySelector('input[name="mode"]:checked');
    if (!modeEl) {
      showMessage('å‡ºç™ºç‚¹å‘¼ï¼å¸°åº«ç‚¹å‘¼ã®ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
      return;
    }
    const mode = modeEl.value;

    const date = document.getElementById('date').value;
    const driverName = document.getElementById('driverName').value.trim();
    const company = document.getElementById('company').value.trim();

    if (!date || !driverName || !company) {
      showMessage('æ—¥ä»˜ãƒ»ãƒ‰ãƒ©ã‚¤ãƒãƒ¼åãƒ»æ‰€å±ä¼šç¤¾ã¯å¿…é ˆã§ã™ã€‚', 'error');
      return;
    }

    const baseData = {
      id: Date.now(),
      date,
      driverName,
      company,
      email: document.getElementById('email').value.trim(),
      client: document.getElementById('client').value.trim(),
      area: document.getElementById('area').value.trim(),
      base: document.getElementById('base').value.trim(),
      startPlace: document.getElementById('startPlace').value.trim(),
      mode,
      createdAt: new Date().toISOString()
    };

    let record = { ...baseData };

    if (mode === 'å‡ºç™ºç‚¹å‘¼') {
      const startTime = document.getElementById('startTime').value;
      const condition = document.getElementById('condition').value;
      const temp = document.getElementById('temp').value;
      const alcoholValue = document.getElementById('alcoholValue').value;
      const startMeter = document.getElementById('startMeter').value;
      const drinkEl = document.querySelector('input[name="drink"]:checked');
      const check_brake = document.querySelector('input[name="check_brake"]:checked');
      const check_tire = document.querySelector('input[name="check_tire"]:checked');
      const check_light = document.querySelector('input[name="check_light"]:checked');
      const check_camera = document.querySelector('input[name="check_camera"]:checked');
      const check_body = document.querySelector('input[name="check_body"]:checked');
      const check_other = document.querySelector('input[name="check_other"]:checked');

      if (!startTime || !condition || !temp || !alcoholValue || !startMeter ||
          !drinkEl || !check_brake || !check_tire || !check_light ||
          !check_camera || !check_body || !check_other) {
        showMessage('å‡ºç™ºç‚¹å‘¼ã®å¿…é ˆé …ç›®ãŒæœªå…¥åŠ›ã§ã™ã€‚èµ¤ã„å°ã®ã‚ã‚‹é …ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
      }

      record = {
        ...record,
        workTime: document.getElementById('workTime').value,
        startTime,
        condition,
        sleep: document.getElementById('sleep').value,
        drink: drinkEl.value,
        medicine: (document.querySelector('input[name="medicine"]:checked') || {}).value || 'ãªã—',
        temp,
        alcoholValue,
        startMeter,
        memo: document.getElementById('memo').value,
        check_brake: check_brake.value,
        check_tire: check_tire.value,
        check_light: check_light.value,
        check_camera: check_camera.value,
        check_body: check_body.value,
        check_other: check_other.value,
        check_note: document.getElementById('check_note').value
      };
    } else { // å¸°åº«ç‚¹å‘¼
      const returnPlace = document.getElementById('returnPlace').value.trim();
      const returnTime = document.getElementById('returnTime').value;
      const returnMeter = document.getElementById('returnMeter').value;
      const codStatusEl = document.querySelector('input[name="codStatus"]:checked');

      if (!returnPlace || !returnTime || !returnMeter || !codStatusEl) {
        showMessage('å¸°åº«ç‚¹å‘¼ã®å¿…é ˆé …ç›®ãŒæœªå…¥åŠ›ã§ã™ã€‚èµ¤ã„å°ã®ã‚ã‚‹é …ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
      }

      // ã“ã“ã§ã‚‚è·é›¢è¨ˆç®—è©¦ã¿ã‚‹ï¼ˆå‡ºç™ºãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒæ®‹ã£ã¦ã„ã‚Œã°ï¼‰
      let distanceVal = document.getElementById('distance').value;
      if (!distanceVal) {
        const s = parseFloat(startMeterInput.value);
        const e = parseFloat(returnMeter);
        if (!isNaN(s) && !isNaN(e) && e >= s) {
          distanceVal = (e - s).toFixed(1);
        }
      }

      record = {
        ...record,
        returnPlace,
        returnTime,
        returnMeter,
        distance: distanceVal || '',
        rest: document.getElementById('rest').value,
        codStatus: codStatusEl.value,
        codAmount: document.getElementById('codAmount').value,
        roadStatus: document.getElementById('roadStatus').value,
        abnormalDetail: document.getElementById('abnormalDetail').value
      };
    }

    saveRecord(record);
    showMessage(mode + 'ã®è¨˜éŒ²ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸã€‚', 'success');

    form.reset();
    document.getElementById('date').value = new Date().toISOString().slice(0,10);
    updateFormVisibility();
    renderHistory();
    showTab('history');
  });

  // å±¥æ­´è¡¨ç¤ºï¼ˆãƒ•ã‚£ãƒ«ã‚¿ä»˜ãï¼‰
  function renderHistory() {
    const records = loadRecords();
    historyList.innerHTML = '';

    pdfOutput.style.display = 'none';
    btnPrintPdf.style.display = 'none';
    btnBackList.style.display = 'none';

    let filtered = records.slice();

    const fromVal = filterDateFrom.value;
    const toVal = filterDateTo.value;
    const driverVal = filterDriver.value.trim();

    if (fromVal) {
      filtered = filtered.filter(r => r.date >= fromVal);
    }
    if (toVal) {
      filtered = filtered.filter(r => r.date <= toVal);
    }
    if (driverVal) {
      filtered = filtered.filter(r => (r.driverName || '').includes(driverVal));
    }

    if (!filtered.length) {
      historyList.innerHTML = '<p style="text-align:center;color:#777;padding:14px;">è©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }

    filtered.forEach(rec => {
      const item = document.createElement('div');
      const isCompleted = rec.mode === 'é‹è¡Œå®Œäº†';
      const modeLabel =
        rec.mode === 'é‹è¡Œå®Œäº†' ? 'å‡ºç™ºã€œå¸°åº«'
        : rec.mode === 'å¸°åº«ç‚¹å‘¼ï¼ˆæ—¥å ±ï¼‰' ? 'å¸°åº«ã®ã¿'
        : 'å‡ºç™ºã®ã¿';

      item.className = 'record-item' + (isCompleted ? ' completed' : '');
      item.innerHTML = `
        <div class="record-item-title">${rec.date} / ${rec.driverName}</div>
        <div class="record-item-sub">
          [${modeLabel}] ${rec.company || ''} ${rec.client ? ' / ' + rec.client : ''}
        </div>
      `;
      item.onclick = () => showRecordDetail(rec);
      historyList.appendChild(item);
    });
  }

  // è¨˜éŒ²è©³ç´° â†’ PDFè¡¨ç¤º
  function showRecordDetail(rec) {
    historyList.innerHTML = '';
    pdfOutput.style.display = 'block';
    btnPrintPdf.style.display = 'inline-block';
    btnBackList.style.display = 'inline-block';

    pdfOutput.innerHTML = generateRecordHtml(rec);
  }

  function safe(val) {
    return val || '-';
  }

  function generateRecordHtml(rec) {
    const modeLabel =
      rec.mode === 'é‹è¡Œå®Œäº†' ? 'å‡ºç™ºç‚¹å‘¼ã€œå¸°åº«ç‚¹å‘¼'
      : rec.mode === 'å¸°åº«ç‚¹å‘¼ï¼ˆæ—¥å ±ï¼‰' ? 'å¸°åº«ç‚¹å‘¼ï¼æ—¥å ±'
      : 'å‡ºç™ºç‚¹å‘¼';

    let html = `
      <div class="pdf-doc">
        <div class="pdf-header">
          <div class="pdf-header-main">OFA GROUP Webç‚¹å‘¼ãƒ»æ—¥å ± (${modeLabel})</div>
          <div class="pdf-header-sub">ã“ã®PDFã¯ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å€‹äººã®è¨˜éŒ²ç”¨ã§ã™</div>
        </div>

        <div class="pdf-section">
          <div class="pdf-section-title">åŸºæœ¬æƒ…å ±</div>
          <div class="pdf-row"><div class="pdf-label">æ—¥ä»˜</div><div class="pdf-value">${safe(rec.date)}</div></div>
          <div class="pdf-row"><div class="pdf-label">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å</div><div class="pdf-value">${safe(rec.driverName)}</div></div>
          <div class="pdf-row"><div class="pdf-label">æ‰€å±ä¼šç¤¾</div><div class="pdf-value">${safe(rec.company)}</div></div>
          <div class="pdf-row"><div class="pdf-label">æ¡ˆä»¶</div><div class="pdf-value">${safe(rec.client)}</div></div>
          <div class="pdf-row"><div class="pdf-label">ã‚¨ãƒªã‚¢</div><div class="pdf-value">${safe(rec.area)}</div></div>
          <div class="pdf-row"><div class="pdf-label">å‡ºåº«ãƒ™ãƒ¼ã‚¹</div><div class="pdf-value">${safe(rec.base)}</div></div>
          <div class="pdf-row"><div class="pdf-label">å‡ºåº«å ´æ‰€</div><div class="pdf-value">${safe(rec.startPlace)}</div></div>
        </div>
    `;

    // å‡ºç™ºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°
    if (rec.startTime || rec.startMeter || rec.condition || rec.temp || rec.alcoholValue) {
      html += `
        <div class="pdf-section">
          <div class="pdf-section-title">å‡ºç™ºç‚¹å‘¼</div>
          <div class="pdf-row"><div class="pdf-label">å‡ºå‹¤æ™‚é–“</div><div class="pdf-value">${safe(rec.workTime)}</div></div>
          <div class="pdf-row"><div class="pdf-label">å‡ºç™ºæ™‚é–“</div><div class="pdf-value">${safe(rec.startTime)}</div></div>
          <div class="pdf-row"><div class="pdf-label">ä½“èª¿</div><div class="pdf-value">${safe(rec.condition)}</div></div>
          <div class="pdf-row"><div class="pdf-label">ç¡çœ æ™‚é–“</div><div class="pdf-value">${safe(rec.sleep)}</div></div>
          <div class="pdf-row"><div class="pdf-label">é£²é…’(24h)</div><div class="pdf-value">${safe(rec.drink)}</div></div>
          <div class="pdf-row"><div class="pdf-label">æœè–¬</div><div class="pdf-value">${safe(rec.medicine)}</div></div>
          <div class="pdf-row"><div class="pdf-label">ä½“æ¸©</div><div class="pdf-value">${rec.temp ? rec.temp + ' â„ƒ' : '-'}</div></div>
          <div class="pdf-row"><div class="pdf-label">ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«å€¤</div><div class="pdf-value">${rec.alcoholValue ? rec.alcoholValue + ' mg/L' : '-'}</div></div>
          <div class="pdf-row"><div class="pdf-label">å‡ºç™ºå‰ãƒ¡ãƒ¼ã‚¿ãƒ¼</div><div class="pdf-value">${rec.startMeter ? rec.startMeter + ' km' : '-'}</div></div>
          <div class="pdf-row"><div class="pdf-label">ãƒ¡ãƒ¢</div><div class="pdf-value">${safe(rec.memo)}</div></div>
        </div>

        <div class="pdf-section">
          <div class="pdf-section-title">æ—¥å¸¸ç‚¹æ¤œ</div>
          <div class="pdf-row"><div class="pdf-label">ãƒ–ãƒ¬ãƒ¼ã‚­</div><div class="pdf-value">${safe(rec.check_brake)}</div></div>
          <div class="pdf-row"><div class="pdf-label">ã‚¿ã‚¤ãƒ¤</div><div class="pdf-value">${safe(rec.check_tire)}</div></div>
          <div class="pdf-row"><div class="pdf-label">ç¯ç«é¡</div><div class="pdf-value">${safe(rec.check_light)}</div></div>
          <div class="pdf-row"><div class="pdf-label">ã‚«ãƒ¡ãƒ©ãƒ»ãƒŸãƒ©ãƒ¼</div><div class="pdf-value">${safe(rec.check_camera)}</div></div>
          <div class="pdf-row"><div class="pdf-label">è»Šä½“å¤–è¦³</div><div class="pdf-value">${safe(rec.check_body)}</div></div>
          <div class="pdf-row"><div class="pdf-label">ãã®ä»–</div><div class="pdf-value">${safe(rec.check_other)}</div></div>
          <div class="pdf-row"><div class="pdf-label">ç‚¹æ¤œãƒ¡ãƒ¢</div><div class="pdf-value">${safe(rec.check_note)}</div></div>
        </div>
      `;
    }

    // å¸°åº«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°
    if (rec.returnTime || rec.returnMeter || rec.returnPlace || rec.codStatus || rec.roadStatus || rec.abnormalDetail) {
      html += `
        <div class="pdf-section">
          <div class="pdf-section-title">å¸°åº«ç‚¹å‘¼ï¼æ—¥å ±</div>
          <div class="pdf-row"><div class="pdf-label">å¸°åº«å ´æ‰€</div><div class="pdf-value">${safe(rec.returnPlace)}</div></div>
          <div class="pdf-row"><div class="pdf-label">å¸°åº«æ™‚é–“</div><div class="pdf-value">${safe(rec.returnTime)}</div></div>
          <div class="pdf-row"><div class="pdf-label">å¸°åº«ãƒ¡ãƒ¼ã‚¿ãƒ¼</div><div class="pdf-value">${rec.returnMeter ? rec.returnMeter + ' km' : '-'}</div></div>
          <div class="pdf-row"><div class="pdf-label">ç·èµ°è¡Œè·é›¢</div><div class="pdf-value">${rec.distance ? rec.distance + ' km' : '-'}</div></div>
          <div class="pdf-row"><div class="pdf-label">ä¼‘æ†©æ™‚é–“ãƒ»å ´æ‰€</div><div class="pdf-value">${safe(rec.rest)}</div></div>
          <div class="pdf-row"><div class="pdf-label">ä»£é‡‘å…¥é‡‘çŠ¶æ³</div><div class="pdf-value">${safe(rec.codStatus)}</div></div>
          <div class="pdf-row"><div class="pdf-label">ä»£é‡‘å…¥é‡‘é¡</div><div class="pdf-value">${rec.codAmount ? rec.codAmount + ' å††' : '-'}</div></div>
          <div class="pdf-row"><div class="pdf-label">é“è·¯ãƒ»é‹è¡ŒçŠ¶æ³</div><div class="pdf-value">${safe(rec.roadStatus)}</div></div>
          <div class="pdf-row"><div class="pdf-label">ç•°å¸¸ã®è©³ç´°</div><div class="pdf-value">${safe(rec.abnormalDetail)}</div></div>
        </div>
      `;
    }

    html += '</div>';
    return html;
  }

  // PDFå°åˆ·ãƒœã‚¿ãƒ³
  btnPrintPdf.addEventListener('click', () => {
    window.print(); // PDFä¿å­˜ãƒ»LINEå…±æœ‰ãªã©ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã§è‡ªç”±ã«
  });

  // ä¸€è¦§ã«æˆ»ã‚‹
  btnBackList.addEventListener('click', () => {
    renderHistory();
  });

  // å±¥æ­´å…¨ãƒªã‚»ãƒƒãƒˆ
  btnResetHistory.addEventListener('click', () => {
    if (!confirm('æœ¬å½“ã«ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã®å±¥æ­´ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    localStorage.removeItem(STORAGE_KEY);
    renderHistory();
    showMessage('å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚', 'success');
  });

  // ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´ã§å³æ™‚åæ˜ 
  filterDateFrom.addEventListener('change', renderHistory);
  filterDateTo.addEventListener('change', renderHistory);
  filterDriver.addEventListener('input', renderHistory);

  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
  function showTab(tab) {
    document.getElementById('tab_form').style.display = (tab === 'form') ? 'block' : 'none';
    document.getElementById('tab_history').style.display = (tab === 'history') ? 'block' : 'none';

    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.tab-button[onclick="showTab('${tab}')"]`).classList.add('active');

    if (tab === 'history') {
      renderHistory();
    }
  }

  // åˆæœŸè¡¨ç¤º
  updateFormVisibility();
  renderHistory();
</script>

</body>
</html>
