<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OFA GROUP Webç‚¹å‘¼ãƒ»æ—¥å ±ãƒ•ã‚©ãƒ¼ãƒ </title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

<!-- æœˆæ¬¡PDFç”¨ -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<style>
:root{--g:#17B978;--r:#E74C3C;--b:#3498DB;--y:#F9CA24;}
*{box-sizing:border-box}
body{
  margin:0;font-family:'Noto Sans JP',sans-serif;
  background:linear-gradient(180deg,#ff9f43,#ff6b6b,#9b59b6,#3498db,#2ecc71);
  background-attachment:fixed;
}
.container{
  max-width:760px;margin:18px auto 28px;background:rgba(255,255,255,0.96);
  border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden;
}
header{
  background:linear-gradient(135deg,#ff7675,#f9ca24,#55efc4,#74b9ff,#a29bfe);
  color:#fff;text-align:center;padding:18px 14px;
}
header .t{font-size:22px;font-weight:900;margin:0}
header .s{font-size:12px;margin:6px 0 0;opacity:.95}

.tab{display:flex;border-bottom:1px solid #e3e3e3;background:#f7f7f7}
.tab button{
  flex:1;padding:10px 8px;border:none;background:none;font-weight:800;cursor:pointer;
  border-bottom:3px solid transparent;
}
.tab button.active{background:#fff;color:var(--g);border-bottom-color:var(--g);}

.content{padding:14px 14px 18px}
label{display:block;font-size:13px;font-weight:800;margin-top:12px}
input,select,textarea{
  width:100%;padding:10px;margin-top:6px;border:1px solid #d6d6d6;border-radius:10px;font-size:14px;
  background:#fbfffa;
}
textarea{resize:vertical}

.note{
  font-size:12px;background:#f8f9f9;border-left:4px solid var(--g);
  padding:10px;border-radius:10px;margin-bottom:12px;line-height:1.6
}
.row2{display:flex;gap:10px}
.row2 > div{flex:1}
.btn{
  width:100%;margin-top:16px;padding:14px;border:none;border-radius:999px;
  background:linear-gradient(135deg,#ff7675,#e74c3c);color:#fff;font-size:16px;font-weight:900;cursor:pointer;
  box-shadow:0 4px 0 #c0392b;
}
.btn:active{transform:translateY(1px);box-shadow:none}
.btn2{
  width:100%;margin-top:10px;padding:12px;border:none;border-radius:999px;
  background:#f0f0f0;color:#333;font-size:14px;font-weight:900;cursor:pointer;
}
.small{font-size:11px;color:#555;margin-top:6px}
.hr{height:1px;background:#ececec;margin:14px 0}

.history-item{
  border:1px solid #ddd;border-radius:12px;padding:10px;margin-bottom:8px;background:#fff;
  box-shadow:0 2px 8px rgba(0,0,0,.06)
}
.history-item b{font-size:14px}
.sub{font-size:12px;color:#555;margin-top:4px;line-height:1.5}
.badge{
  display:inline-block;font-size:11px;padding:2px 8px;border-radius:999px;background:#ebf5fb;color:#2980b9;margin-left:6px
}
.warn{color:#a00;font-weight:900}

.pdf-photo{max-width:240px;border:1px solid #ccc;border-radius:10px}
</style>
</head>

<body>
<div class="container">

<header>
  <p class="t">OFA GROUP Webç‚¹å‘¼ãƒ»æ—¥å ±</p>
  <p class="s">ç¢ºèªè€…ãƒ»è»Šä¸¡ç•ªå·ãƒ»ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«å†™çœŸï¼ˆåœ§ç¸®ï¼‰ãƒ»æ—¥æ¬¡/æœˆæ¬¡PDFãƒ»Driveä¿å­˜å¯¾å¿œ</p>
</header>

<div class="tab">
  <button id="tabForm" class="active">ğŸ“ ç‚¹å‘¼å…¥åŠ›</button>
  <button id="tabHistory">ğŸ“„ å±¥æ­´ãƒ»å‡ºåŠ›</button>
</div>

<!-- å…¥åŠ› -->
<div class="content" id="formArea">
  <div class="note">
    <b>ã€ä½¿ã„æ–¹ã€‘</b><br>
    â‘  æœã€Œå‡ºç™ºç‚¹å‘¼ã€ã‚’å…¥åŠ› â†’ ä¿å­˜<br>
    â‘¡ å¸°å®…å¾Œã€Œå¸°ç€ç‚¹å‘¼ã€ã‚’å…¥åŠ› â†’ åŒæ—¥ãƒ»åŒãƒ‰ãƒ©ã‚¤ãƒãƒ¼ãƒ»åŒä¼šç¤¾ãƒ»åŒè»Šä¸¡ã®è¨˜éŒ²ã«è¿½è¨˜<br>
    â‘¢ å±¥æ­´ã‹ã‚‰ <b>æ—¥æ¬¡PDF / æœˆæ¬¡PDF</b> ã‚’å‡ºåŠ›ã§ãã¾ã™<br>
    â‘£ ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«å†™çœŸã¯è¨¼è·¡ã¨ã—ã¦ä¿å­˜ï¼ˆè‡ªå‹•åœ§ç¸®ï¼‰<br>
    <span class="warn">â€»LINEã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯PDFä¿å­˜ãŒå‹•ã‹ãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚Safari/Chromeã§é–‹ã„ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚</span>
  </div>

  <form id="tenkoForm" autocomplete="off">
    <label>ç‚¹å‘¼åŒºåˆ†</label>
    <select id="mode">
      <option value="start">å‡ºç™ºç‚¹å‘¼</option>
      <option value="end">å¸°ç€ç‚¹å‘¼</option>
    </select>

    <div class="row2">
      <div>
        <label>æ—¥ä»˜</label>
        <input type="date" id="date" required>
      </div>
      <div>
        <label>ç‚¹å‘¼æ™‚åˆ»</label>
        <input type="time" id="time" required>
      </div>
    </div>

    <label>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å</label>
    <input type="text" id="driver" required>

    <label>æ‰€å±ä¼šç¤¾</label>
    <input type="text" id="company" required>

    <div class="row2">
      <div>
        <label>è»Šä¸¡ç•ªå·ï¼ˆãƒŠãƒ³ãƒãƒ¼ï¼‰</label>
        <input type="text" id="vehicleNo" placeholder="ä¾‹ï¼šé¹¿å…å³¶ 480 ã‚ 12-34" required>
      </div>
      <div>
        <label>ç¢ºèªè€…ï¼ˆç‚¹å‘¼å®Ÿæ–½è€…ï¼‰</label>
        <input type="text" id="checker" placeholder="ä¾‹ï¼šå±±ä¸‹" required>
      </div>
    </div>

    <label>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«å€¤ (mg/L)</label>
    <input type="text" id="alcoholValue" placeholder="ä¾‹ï¼š0.00">

    <label>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œæŸ»å†™çœŸï¼ˆè¨¼è·¡ãƒ»è‡ªå‹•åœ§ç¸®ï¼‰</label>
    <input type="file" id="alcoholPhoto" accept="image/*" capture="environment">
    <div class="small">â€»ä¿å­˜å®¹é‡ç¯€ç´„ã®ãŸã‚ç”»åƒã¯è‡ªå‹•ã§åœ§ç¸®ã•ã‚Œã¾ã™ã€‚é•·æœŸä¿å­˜ã¯Driveä¿å­˜ãŒãŠã™ã™ã‚ã€‚</div>

    <button class="btn" type="submit">ã“ã®ç‚¹å‘¼ã‚’ä¿å­˜</button>
  </form>
</div>

<!-- å±¥æ­´ãƒ»å‡ºåŠ› -->
<div class="content" id="historyArea" style="display:none">
  <div class="note">
    <b>ğŸ“¤ å‡ºåŠ›</b><br>
    ãƒ»<b>æ—¥æ¬¡PDF</b>ï¼šæŒ‡å®šæ—¥ã®è¨˜éŒ²ï¼ˆå†™çœŸå…¥ã‚Šï¼‰<br>
    ãƒ»<b>æœˆæ¬¡PDF</b>ï¼š1ãƒ¶æœˆåˆ†ã®ä¸€è¦§ï¼ˆå†™çœŸã¯ã€Œã‚ã‚Š/ãªã—ã€ï¼‰<br>
    ãƒ»<b>Google Driveã¸ä¿å­˜</b>ï¼šPDF/ç”»åƒ/JSONã‚’Driveï¼‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸è¨˜éŒ²<br>
    <span class="warn">â€»LINEå†…ãƒ–ãƒ©ã‚¦ã‚¶ã¯éæ¨å¥¨</span>
  </div>

  <label>æ—¥æ¬¡PDFï¼ˆæ—¥ä»˜ï¼‰</label>
  <input type="date" id="dailyDate">
  <button class="btn2" id="dailyPdfBtn" type="button">æ—¥æ¬¡PDFå‡ºåŠ›ï¼ˆå†™çœŸã‚ã‚Šï¼‰</button>

  <label>æœˆæ¬¡PDFï¼ˆå¹´æœˆï¼‰</label>
  <input type="month" id="monthlyMonth">
  <button class="btn2" id="monthlyPdfBtn" type="button">æœˆæ¬¡PDFå‡ºåŠ›ï¼ˆä¸€è¦§ï¼‰</button>

  <div class="hr"></div>

  <label>Google Driveä¿å­˜ï¼ˆGAS WebApp URLï¼‰</label>
  <input type="text" id="gasUrl" placeholder="ã“ã“ã«GASã®Webã‚¢ãƒ—ãƒªURLã‚’è²¼ã‚‹ï¼ˆå¾Œè¿°ï¼‰">
  <div class="row2">
    <div>
      <label>Driveä¿å­˜ï¼ˆæ—¥ä»˜ï¼‰</label>
      <input type="date" id="driveDate">
    </div>
    <div style="display:flex;align-items:flex-end">
      <button class="btn2" id="driveSaveBtn" type="button" style="margin-top:0">ã“ã®æ—¥ã®è¨˜éŒ²ã‚’Driveã¸ä¿å­˜</button>
    </div>
  </div>
  <div class="small">
    â€»GAS URLã‚’è¨­å®šã™ã‚‹ã¨ã€æŒ‡å®šæ—¥ã®è¨˜éŒ²ã‚’Driveã¸ä¿å­˜ã§ãã¾ã™ï¼ˆPDFï¼‹ç”»åƒï¼‹JSONï¼‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¿½è¨˜ï¼‰<br>
    â€»URLæœªè¨­å®šã®å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®ã¿
  </div>

  <div class="hr"></div>
  <div id="historyList"></div>

  <button class="btn2" id="purgeBtn" type="button">60æ—¥è¶…ã®å¤ã„å†™çœŸã‚’å‰Šé™¤ï¼ˆè¨˜éŒ²ã¯æ®‹ã™ï¼‰</button>
  <button class="btn2" id="wipeBtn" type="button" style="background:#fdecea;color:#a00">å…¨å±¥æ­´ã‚’å‰Šé™¤ï¼ˆã“ã®ç«¯æœ«ï¼‰</button>
</div>

</div>

<script>
/* =========================
   è¨­å®š
========================= */
const KEY = 'ofa_tenko_records_v2';

/* =========================
   å…±é€šé–¢æ•°
========================= */
const getList = () => JSON.parse(localStorage.getItem(KEY) || '[]');
const setList = (d) => localStorage.setItem(KEY, JSON.stringify(d));

function todayISO(){ return new Date().toISOString().slice(0,10); }
function thisMonthISO(){ return new Date().toISOString().slice(0,7); }
function isLineInApp(){ return navigator.userAgent.toLowerCase().includes('line'); }

function daysBetween(aISO, bISO){
  const a = new Date(aISO + 'T00:00:00');
  const b = new Date(bISO + 'T00:00:00');
  return Math.floor((b - a) / (1000*60*60*24));
}

/* ç”»åƒåœ§ç¸®ï¼š900px / quality 0.7 */
async function fileToCompressedDataURL(file, maxW=900, quality=0.7){
  if(!file) return '';
  if(!file.type.startsWith('image/')) return '';

  const dataURL = await new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });

  const img = await new Promise((resolve, reject)=>{
    const i = new Image();
    i.onload = ()=>resolve(i);
    i.onerror = reject;
    i.src = dataURL;
  });

  const scale = Math.min(1, maxW / img.width);
  const w = Math.max(1, Math.round(img.width * scale));
  const h = Math.max(1, Math.round(img.height * scale));

  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,w,h);
  ctx.drawImage(img,0,0,w,h);

  return canvas.toDataURL('image/jpeg', quality);
}

/* =========================
   60æ—¥è¶…ï¼šå¤ã„å†™çœŸã ã‘å‰Šé™¤
========================= */
function purgeOldPhotos(days=60){
  const list = getList();
  const now = todayISO();
  let changed = false;

  for(const rec of list){
    const age = daysBetween(rec.date, now);
    if(age > days){
      if(rec.start?.photo){ rec.start.photo=''; changed=true; }
      if(rec.end?.photo){ rec.end.photo=''; changed=true; }
    }
  }
  if(changed) setList(list);
  return changed;
}

/* =========================
   ã‚¿ãƒ–
========================= */
tabForm.onclick = ()=>{
  tabForm.classList.add('active'); tabHistory.classList.remove('active');
  formArea.style.display='block'; historyArea.style.display='none';
};
tabHistory.onclick = ()=>{
  tabHistory.classList.add('active'); tabForm.classList.remove('active');
  historyArea.style.display='block'; formArea.style.display='none';
  renderHistory();
};

/* =========================
   ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯
   1æ—¥ = 1ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆdriver/company/vehicleNoå˜ä½ï¼‰
   ãã®ä¸­ã« start/end ã‚’æ ¼ç´
========================= */
tenkoForm.addEventListener('submit', async (e)=>{
  e.preventDefault();

  // ã¾ãšè‡ªå‹•å‰Šé™¤ï¼ˆ60æ—¥è¶…ã®å†™çœŸã ã‘ï¼‰ã‚’è»½ãå›ã™ï¼šå®¹é‡ãƒˆãƒ©ãƒ–ãƒ«ã‚’æ¸›ã‚‰ã™
  purgeOldPhotos(60);

  const modeVal = mode.value; // start/end
  const list = getList();

  const photoFile = alcoholPhoto.files?.[0] || null;
  const photoData = await fileToCompressedDataURL(photoFile, 900, 0.7);

  const part = {
    at: Date.now(),
    mode: modeVal,
    time: time.value,
    alcohol: alcoholValue.value || '',
    checker: checker.value || '',
    photo: photoData || '' // ç©ºãªã‚‰ä¿å­˜ã—ãªã„ã®ã¨åŒç¾©
  };

  const baseKey = {
    date: date.value,
    driver: driver.value.trim(),
    company: company.value.trim(),
    vehicleNo: vehicleNo.value.trim()
  };

  const idx = list.findIndex(r =>
    r.date===baseKey.date &&
    r.driver===baseKey.driver &&
    r.company===baseKey.company &&
    r.vehicleNo===baseKey.vehicleNo
  );

  if(idx>-1){
    list[idx][modeVal] = part;
    // ã¤ã„ã§ã«æœ€æ–°ã®ç¢ºèªè€…ã‚’ä¿æŒï¼ˆé–²è¦§ç”¨ï¼‰
    list[idx].lastChecker = part.checker || list[idx].lastChecker || '';
  }else{
    list.push({
      ...baseKey,
      start: modeVal==='start'?part:undefined,
      end: modeVal==='end'?part:undefined,
      lastChecker: part.checker || ''
    });
  }

  // ä¸¦ã³ï¼šæ–°ã—ã„æ—¥ä»˜ãŒä¸Š
  list.sort((a,b)=> (b.date||'').localeCompare(a.date||'') || (String(b.driver||'').localeCompare(String(a.driver||''))) );

  try{
    setList(list);
    alert('ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ï¼‰');
  }catch(err){
    // localStorageå®¹é‡ä¸è¶³ã®ã¨ã
    alert('ä¿å­˜å®¹é‡ãŒä¸è¶³ã—ã¾ã—ãŸã€‚\nã€Œ60æ—¥è¶…ã®å¤ã„å†™çœŸå‰Šé™¤ã€ã¾ãŸã¯Driveä¿å­˜ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚');
    console.error(err);
  }

  tenkoForm.reset();
  date.value = todayISO();
  dailyDate.value = date.value;
  driveDate.value = date.value;
  monthlyMonth.value = thisMonthISO();
});

/* =========================
   å±¥æ­´è¡¨ç¤º
========================= */
function renderHistory(){
  // å±¥æ­´ã«å…¥ã‚‹ãŸã³ã«è‡ªå‹•ã§å¤ã„å†™çœŸã‚’æ¶ˆã—ã¦å®¹é‡ã‚’å®ˆã‚‹ï¼ˆè¨˜éŒ²ã¯æ®‹ã™ï¼‰
  purgeOldPhotos(60);

  const list = getList();
  historyList.innerHTML = '';

  if(!list.length){
    historyList.innerHTML = '<div class="small">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
    return;
  }

  for(const r of list){
    const hasPhoto = !!(r.start?.photo || r.end?.photo);
    const st = r.start?.time || '-';
    const en = r.end?.time || '-';

    const div = document.createElement('div');
    div.className = 'history-item';
    div.innerHTML = `
      <b>${r.date}</b>
      <span class="badge">${hasPhoto ? 'å†™çœŸã‚ã‚Š' : 'å†™çœŸãªã—'}</span><br>
      <div class="sub">
        ${r.driver} / ${r.company}<br>
        è»Šä¸¡ï¼š${r.vehicleNo || '-'} / ç¢ºèªè€…ï¼š${(r.lastChecker||r.start?.checker||r.end?.checker||'-')}<br>
        å‡ºç™ºï¼š${st}ã€€å¸°ç€ï¼š${en}
      </div>
    `;
    historyList.appendChild(div);
  }
}

/* =========================
   PDFï¼ˆæ—¥æ¬¡ï¼‰
   - å†™çœŸå…¥ã‚Š
========================= */
dailyPdfBtn.onclick = ()=>{
  if(isLineInApp()){
    alert('LINEã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯PDFä¿å­˜ãŒå‹•ã‹ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚\nå³ä¸Šã€Œâ€¦ã€â†’ã€ŒSafari/Chromeã§é–‹ãã€ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  const day = dailyDate.value;
  const list = getList().filter(r=>r.date===day);
  if(!list.length){ alert('ãã®æ—¥ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

  const w = window.open('', '_blank');
  if(!w){ alert('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚Safari/Chromeã§ãŠè©¦ã—ãã ã•ã„ã€‚'); return; }

  const html = `
<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8">
<title>OFA ç‚¹å‘¼ï¼ˆæ—¥æ¬¡ï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
<style>
body{font-family:'Noto Sans JP',sans-serif;margin:18px}
h1{margin:0 0 8px;font-size:18px}
.card{border:1px solid #ccc;border-radius:12px;padding:12px;margin:12px 0}
.small{font-size:11px;color:#555}
img{max-width:260px;border:1px solid #ccc;border-radius:10px;margin-top:6px}
hr{border:none;border-top:1px solid #eee;margin:12px 0}
</style></head><body>
<h1>OFA GROUP ç‚¹å‘¼ï¼ˆæ—¥æ¬¡ï¼‰ - ${day}</h1>
<div class="small">å‡ºåŠ›æ—¥æ™‚ï¼š${new Date().toLocaleString('ja-JP')}</div>
${list.map(r=>{
  const start = r.start || {};
  const end = r.end || {};
  return `
  <div class="card">
    <div><b>${r.driver}</b> / ${r.company}</div>
    <div class="small">è»Šä¸¡ï¼š${r.vehicleNo || '-'} / ç¢ºèªè€…ï¼š${(start.checker||end.checker||r.lastChecker||'-')}</div>
    <hr>
    <div><b>å‡ºç™º</b>ï¼š${start.time||'-'}ã€€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ï¼š${start.alcohol||''}ã€€ç¢ºèªè€…ï¼š${start.checker||'-'}</div>
    ${start.photo ? `<img src="${start.photo}">` : `<div class="small">å‡ºç™ºå†™çœŸï¼šãªã—</div>`}
    <hr>
    <div><b>å¸°ç€</b>ï¼š${end.time||'-'}ã€€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ï¼š${end.alcohol||''}ã€€ç¢ºèªè€…ï¼š${end.checker||'-'}</div>
    ${end.photo ? `<img src="${end.photo}">` : `<div class="small">å¸°ç€å†™çœŸï¼šãªã—</div>`}
  </div>`;
}).join('')}
<script>window.print();</script>
</body></html>`;
  w.document.open();
  w.document.write(html);
  w.document.close();
};

/* =========================
   PDFï¼ˆæœˆæ¬¡ï¼šä¸€è¦§ï¼‰
   - å†™çœŸã¯ã€Œã‚ã‚Š/ãªã—ã€
========================= */
monthlyPdfBtn.onclick = ()=>{
  if(isLineInApp()){
    alert('LINEã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯PDFä¿å­˜ãŒå‹•ã‹ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚\nSafari/Chromeã§é–‹ã„ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  const ym = monthlyMonth.value; // YYYY-MM
  const list = getList().filter(r => (r.date||'').startsWith(ym));
  if(!list.length){ alert('ãã®æœˆã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

  const rows = list
    .slice()
    .sort((a,b)=> (a.date||'').localeCompare(b.date||'') || (String(a.driver||'').localeCompare(String(b.driver||''))))
    .map(r => {
      const hasPhoto = (r.start?.photo || r.end?.photo) ? 'ã‚ã‚Š' : 'ãªã—';
      return [
        r.date || '',
        r.driver || '',
        r.company || '',
        r.vehicleNo || '',
        r.start?.time || '',
        r.start?.checker || '',
        r.end?.time || '',
        r.end?.checker || '',
        hasPhoto
      ];
    });

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape', unit:'mm', format:'a4'});

  doc.setFontSize(14);
  doc.text(`OFA GROUP ç‚¹å‘¼ä¸€è¦§ï¼ˆ${ym}ï¼‰`, 14, 12);
  doc.setFontSize(10);
  doc.text(`å‡ºåŠ›æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}`, 14, 18);

  doc.autoTable({
    startY: 22,
    head: [[ 'æ—¥ä»˜','é‹è»¢è€…','æ‰€å±','è»Šä¸¡ç•ªå·','å‡ºç™º','å‡ºç™ºç¢ºèªè€…','å¸°ç€','å¸°ç€ç¢ºèªè€…','å†™çœŸ' ]],
    body: rows,
    styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
    headStyles: { fillColor: [23,185,120] },
    columnStyles: {
      0:{cellWidth:22},
      1:{cellWidth:26},
      2:{cellWidth:26},
      3:{cellWidth:32},
      4:{cellWidth:18},
      5:{cellWidth:22},
      6:{cellWidth:18},
      7:{cellWidth:22},
      8:{cellWidth:14}
    }
  });

  doc.save(`ç‚¹å‘¼ä¸€è¦§_${ym}.pdf`);
};

/* =========================
   Driveä¿å­˜ï¼ˆGASã¸é€ä¿¡ï¼‰
   - æŒ‡å®šæ—¥ã®è¨˜éŒ²ã‚’ã¾ã¨ã‚ã¦é€ã‚‹
   - GASå´ã§Driveä¿å­˜ï¼‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¿½è¨˜
========================= */
async function postToGas(url, payload){
  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if(!res.ok){
    const text = await res.text().catch(()=> '');
    throw new Error('GASé€ä¿¡å¤±æ•—: ' + res.status + ' ' + text);
  }
  return await res.json().catch(()=> ({}));
}

driveSaveBtn.onclick = async ()=>{
  const url = (gasUrl.value || '').trim();
  if(!url){ alert('GASã®Webã‚¢ãƒ—ãƒªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if(isLineInApp()){
    alert('LINEå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯Driveä¿å­˜ãŒå¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚Safari/Chromeæ¨å¥¨ã§ã™ã€‚');
  }

  const day = driveDate.value;
  const dayList = getList().filter(r=>r.date===day);
  if(!dayList.length){ alert('ãã®æ—¥ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

  // payloadï¼ˆç”»åƒã¯Base64ã®ã¾ã¾é€ã‚‹ï¼‰
  const payload = {
    app: 'OFA_TENKO',
    version: 'v2',
    date: day,
    createdAt: new Date().toISOString(),
    records: dayList
  };

  try{
    driveSaveBtn.disabled = true;
    driveSaveBtn.textContent = 'Driveã¸ä¿å­˜ä¸­...';
    const out = await postToGas(url, payload);
    alert('Driveä¿å­˜ã—ã¾ã—ãŸã€‚\n' + (out?.message || 'OK'));
  }catch(err){
    console.error(err);
    alert('Driveä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nGAS URLãƒ»å…¬é–‹è¨­å®šãƒ»é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  }finally{
    driveSaveBtn.disabled = false;
    driveSaveBtn.textContent = 'ã“ã®æ—¥ã®è¨˜éŒ²ã‚’Driveã¸ä¿å­˜';
  }
};

/* =========================
   ãƒœã‚¿ãƒ³ï¼šå¤ã„å†™çœŸå‰Šé™¤ / å…¨å‰Šé™¤
========================= */
purgeBtn.onclick = ()=>{
  const changed = purgeOldPhotos(60);
  alert(changed ? '60æ—¥è¶…ã®å¤ã„å†™çœŸã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆè¨˜éŒ²ã¯æ®‹ã—ã¦ã„ã¾ã™ï¼‰ã€‚' : 'å‰Šé™¤å¯¾è±¡ã®å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
  renderHistory();
};

wipeBtn.onclick = ()=>{
  if(confirm('ã“ã®ç«¯æœ«ã®ä¿å­˜å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
    localStorage.removeItem(KEY);
    renderHistory();
  }
};

/* =========================
   åˆæœŸå€¤
========================= */
date.value = todayISO();
dailyDate.value = todayISO();
driveDate.value = todayISO();
monthlyMonth.value = thisMonthISO();

// èµ·å‹•æ™‚ã«ã‚‚è‡ªå‹•ã§å¤ã„å†™çœŸå‰Šé™¤ï¼ˆå®¹é‡ä¿è­·ï¼‰
purgeOldPhotos(60);
</script>
</body>
</html>
