<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OFA GROUP Web点呼・日報フォーム</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Poppins:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* -------------------------------------------------- */
        /* CSS: ポップなデザインとOFAカラー (赤、青、黄、ペールグリーン) */
        /* -------------------------------------------------- */
        :root {
            --color-ofa-red: #E74C3C;      /* 赤 */
            --color-ofa-blue: #3498DB;     /* 青 */
            --color-ofa-yellow: #F1C40F;   /* 黄 */
            --color-background: #E8F8F5;   /* ベース背景色 (薄い緑/ペールグリーン) */
            --color-base-orange: #FDEBD0;  /* ページベース背景 (薄いオレンジ) */
            --color-text-dark: #2C3E50;
            --color-accent-light: #A3E4D7;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-background);
            color: var(--color-text-dark);
            line-height: 1.6;
        }
        
        /* ページベースの背景色を薄いオレンジに */
        .container {
            max-width: 600px;
            margin: 30px auto;
            padding: 25px;
            background-color: var(--color-base-orange); /* 薄いオレンジ */
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            border: 3px solid var(--color-accent-light);
        }
        
        /* ヘッダーエリア */
        .header-area {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 4px solid var(--color-ofa-yellow);
        }

        /* ロゴ風デザイン */
        .ofa-logo {
            display: inline-block;
            background-color: var(--color-ofa-red);
            color: white;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            padding: 5px 15px;
            border-radius: 6px;
            letter-spacing: 1px;
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        h1 {
            color: var(--color-ofa-blue);
            font-size: 32px;
            margin: 0;
            letter-spacing: 1px;
        }
        
        .sub-title {
            color: var(--color-text-dark);
            font-weight: 700;
            font-size: 18px;
            margin-top: 5px;
        }
        
        /* セクションタイトル */
        .section-title {
            background-color: var(--color-ofa-blue); /* 青 */
            color: white;
            padding: 12px 15px;
            margin-top: 30px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-weight: bold;
            border-left: 5px solid var(--color-ofa-yellow);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            font-size: 14px;
        }
        
        /* 入力欄 */
        input[type="text"], input[type="date"], input[type="time"], input[type="number"], select, textarea {
            width: calc(100% - 22px);
            padding: 10px;
            margin-top: 5px;
            border: 2px solid var(--color-accent-light);
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, input[type="date"]:focus, input[type="time"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            border-color: var(--color-ofa-blue);
            outline: none;
        }
        
        /* ラジオボタン・チェックボックスグループ */
        .radio-group, .checkbox-group {
            margin-top: 10px;
            padding: 8px 10px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
        }
        
        .radio-group label, .checkbox-group label {
            display: inline-block;
            margin-right: 25px;
            font-weight: normal;
            margin-top: 5px;
        }
        
        /* 必須マーク */
        .required::after {
            content: " *";
            color: var(--color-ofa-red);
            font-weight: bold;
        }
        
        /* ボタン */
        button {
            display: block;
            width: 100%;
            padding: 18px;
            margin-top: 40px;
            background-color: var(--color-ofa-red); /* 赤 */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 4px 0 var(--color-text-dark);
        }
        
        button:hover {
            background-color: #C0392B; /* 少し暗い赤 */
            box-shadow: 0 2px 0 var(--color-text-dark);
            transform: translateY(2px);
        }
        
        /* メッセージボックス */
        .message-box {
            padding: 15px;
            margin-top: 25px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            display: none;
            border: 2px solid;
        }
        
        .success {
            background-color: #D4EDDA;
            color: #155724;
            border-color: #C3E6CB;
        }
        
        .error {
            background-color: #F8D7DA;
            color: #721C24;
            border-color: #F5C6CB;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-area">
        <div class="ofa-logo">OFA GROUP</div>
        <h1>Web点呼・日報フォーム</h1>
        <div class="sub-title">乗務記録 &bull; 日常点検 &bull; 運転日報</div>
    </div>
    
    <form id="tenkoForm">

        <div class="section-title">0. モード選択 (必須)</div>
        <div class="radio-group required">
            <label><input type="radio" name="mode" value="出発点呼" required> 出発点呼</label>
            <label><input type="radio" name="mode" value="帰庫点呼（日報）"> 帰庫点呼（日報）</label>
        </div>

        <div class="section-title">1. 基本情報</div>
        <label for="date" class="required">日付</label>
        <input type="date" id="date" required>
        
        <label for="driverName" class="required">ドライバー名</label>
        <input type="text" id="driverName" required>

        <label for="company" class="required">所属会社</label>
        <input type="text" id="company" required>
        
        <label for="email" class="required">メールアドレス（控え送付先）</label>
        <input type="email" id="email" required placeholder="例: driver@example.com">
        
        <label for="client">案件（荷主）</label>
        <input type="text" id="client">

        <label for="area">エリア</label>
        <input type="text" id="area">

        <label for="base">出庫ベース</label>
        <input type="text" id="base">

        <label for="startPlace">出庫場所</label>
        <input type="text" id="startPlace">


        <div id="section_departure">
            <div class="section-title">2. 出発前チェック</div>
            
            <label for="workTime">出勤時間</label>
            <input type="time" id="workTime">

            <label for="startTime" class="required">出発時間</label>
            <input type="time" id="startTime" required>

            <label for="condition" class="required">体調</label>
            <select id="condition" required>
                <option value="">選択してください</option>
                <option value="良好">良好</option>
                <option value="普通">普通</option>
                <option value="不調">不調</option>
            </select>
            
            <label for="sleep">睡眠時間 (時間)</label>
            <input type="number" id="sleep" step="0.5" placeholder="例: 6.5">

            <label for="drink" class="required">飲酒 (24h以内)</label>
            <div class="radio-group required">
                <label><input type="radio" name="drink" value="なし" required> なし</label>
                <label><input type="radio" name="drink" value="あり"> あり</label>
            </div>

            <label for="medicine">服薬 (運転に影響する薬)</label>
            <div class="radio-group">
                <label><input type="radio" name="medicine" value="なし"> なし</label>
                <label><input type="radio" name="medicine" value="あり"> あり</label>
            </div>
            
            <label for="temp" class="required">体温 (°C)</label>
            <input type="number" id="temp" step="0.1" required placeholder="例: 36.5">

            <label for="alcoholValue" class="required">アルコール検査値 (mg/L)</label>
            <input type="text" id="alcoholValue" required placeholder="例: 0.00">
            
            <label for="startMeter" class="required">出発前メーター (km)</label>
            <input type="number" id="startMeter" required>
            
            <label for="licenseFile">免許証画像 (出発点呼時のみ)</label>
            <input type="file" id="licenseFile" accept="image/*">
            
            <label for="memo">メモ</label>
            <textarea id="memo" rows="3"></textarea>
        </div>


        <div id="section_check">
            <div class="section-title">3. 日常点検チェック</div>
            
            <label>ブレーキ</label>
            <div class="radio-group required">
                <label><input type="radio" name="check_brake" value="OK" required> OK</label>
                <label><input type="radio" name="check_brake" value="異常あり"> 異常あり</label>
            </div>
            
            <label>タイヤ</label>
            <div class="radio-group required">
                <label><input type="radio" name="check_tire" value="OK" required> OK</label>
                <label><input type="radio" name="check_tire" value="異常あり"> 異常あり</label>
            </div>
            
            <label>灯火類</label>
            <div class="radio-group required">
                <label><input type="radio" name="check_light" value="OK" required> OK</label>
                <label><input type="radio" name="check_light" value="異常あり"> 異常あり</label>
            </div>
            
            <label>カメラ・ミラー</label>
            <div class="radio-group required">
                <label><input type="radio" name="check_camera" value="OK" required> OK</label>
                <label><input type="radio" name="check_camera" value="異常あり"> 異常あり</label>
            </div>
            
            <label>車体外観</label>
            <div class="radio-group required">
                <label><input type="radio" name="check_body" value="OK" required> OK</label>
                <label><input type="radio" name="check_body" value="異常あり"> 異常あり</label>
            </div>
            
            <label>その他点検</label>
            <div class="radio-group required">
                <label><input type="radio" name="check_other" value="OK" required> OK</label>
                <label><input type="radio" name="check_other" value="異常あり"> 異常あり</label>
            </div>

            <label for="check_note">点検メモ</label>
            <textarea id="check_note" rows="3"></textarea>

            <label for="carAbnormalFile">車両異常箇所写真 (任意)</label>
            <input type="file" id="carAbnormalFile" accept="image/*">
        </div>

        <div id="section_return" style="display:none;">
            <div class="section-title">4. 運行・帰庫記録</div>
            
            <label for="returnPlace" class="required">帰庫場所</label>
            <input type="text" id="returnPlace" required>
            
            <label for="returnTime" class="required">帰庫時間</label>
            <input type="time" id="returnTime" required>
            
            <label for="returnMeter" class="required">帰庫メーター (km)</label>
            <input type="number" id="returnMeter" required>
            
            <label for="distance">総走行距離 (自動計算)</label>
            <input type="number" id="distance" readonly>
            
            <label for="rest">休憩時間・場所 (例: 1時間30分, 道の駅)</label>
            <input type="text" id="rest">
            
            <label for="codStatus" class="required">代金入金状況 (着払い/立替)</label>
            <div class="radio-group required">
                <label><input type="radio" name="codStatus" value="なし" required> なし</label>
                <label><input type="radio" name="codStatus" value="入金済"> 入金済</label>
                <label><input type="radio" name="codStatus" value="後日対応"> 後日対応</label>
            </div>
            
            <label for="codAmount">代金入金額 (円)</label>
            <input type="number" id="codAmount">

            <label for="roadStatus">道路・運行状況</label>
            <textarea id="roadStatus" rows="3"></textarea>

            <label for="abnormalDetail">運行中の異常の詳細 (あれば)</label>
            <textarea id="abnormalDetail" rows="3"></textarea>
        </div>

        <button type="submit">送信して記録する</button>

    </form>
    
    <div id="message" class="message-box"></div>
</div>

<script>
    /* -------------------------------------------------- */
    /* JavaScript: データの取得とGASへの送信処理 (変更なし) */
    /* -------------------------------------------------- */

    // ★★★ 1. 設定情報: ここを修正してください ★★★
    // 直前に発行された新しいGASのWebアプリURLに置き換えてください
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzNysioqG-A027lCsW5mc3hJpwJ15iVERw38hwKmScnm4eqCUROsRCWWvIHfyP5t0K8/exec'; 
    
    // 運行管理者グループのLINE Notifyトークンをここに固定で設定します
    const ADMIN_LINE_TOKEN = 'YOUR_ADMIN_GROUP_LINE_TOKEN'; 
    // ★★★ ---------------------------------- ★★★

    const form = document.getElementById('tenkoForm');
    const modeRadios = document.getElementsByName('mode');
    const departureSection = document.getElementById('section_departure');
    const checkSection = document.getElementById('section_check');
    const returnSection = document.getElementById('section_return');
    const messageBox = document.getElementById('message');
    const startMeterInput = document.getElementById('startMeter');
    const returnMeterInput = document.getElementById('returnMeter');
    const distanceInput = document.getElementById('distance');
    
    // 現在時刻と日付を設定
    document.getElementById('date').value = new Date().toISOString().slice(0, 10);
    
    // フォームの表示切り替えロジック
    function updateFormVisibility() {
        const mode = document.querySelector('input[name="mode"]:checked');
        if (!mode) return;
        
        const isDeparture = mode.value === '出発点呼';
        const isReturn = mode.value === '帰庫点呼（日報）';

        departureSection.style.display = isDeparture ? 'block' : 'none';
        checkSection.style.display = isDeparture ? 'block' : 'none';
        returnSection.style.display = isReturn ? 'block' : 'none';

        // 必須属性の動的な管理 (簡易版)
        const requiredDeparture = departureSection.querySelectorAll('[required]');
        const requiredReturn = returnSection.querySelectorAll('[required]');

        requiredDeparture.forEach(el => el.required = isDeparture);
        requiredReturn.forEach(el => el.required = isReturn);
    }

    // 総走行距離の自動計算
    function calculateDistance() {
        const start = parseFloat(startMeterInput.value);
        const end = parseFloat(returnMeterInput.value);
        if (!isNaN(start) && !isNaN(end) && end >= start) {
            distanceInput.value = (end - start).toFixed(1);
        } else {
            distanceInput.value = '';
        }
    }
    
    modeRadios.forEach(radio => radio.addEventListener('change', updateFormVisibility));
    returnMeterInput.addEventListener('input', calculateDistance);


    // Base64エンコード処理
    function getBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]); // Base64部分のみ
            reader.onerror = error => reject(error);
        });
    }

    // フォーム送信時のメイン処理
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // ローディング表示
        messageBox.className = 'message-box';
        messageBox.classList.add('success');
        messageBox.textContent = '送信中です... しばらくお待ちください。';
        messageBox.style.display = 'block';

        const mode = document.querySelector('input[name="mode"]:checked').value;
        const licenseFileEl = document.getElementById('licenseFile');
        const carAbnormalFileEl = document.getElementById('carAbnormalFile');
        
        let licenseBase64 = null;
        let carAbnormalBase64 = null;

        try {
            // ファイルのBase64エンコード
            if (licenseFileEl.files.length > 0) {
                licenseBase64 = await getBase64(licenseFileEl.files[0]);
            }
            if (carAbnormalFileEl.files.length > 0) {
                carAbnormalBase64 = await getBase64(carAbnormalFileEl.files[0]);
            }
        } catch(err) {
            showMessage('ファイルの読み込みに失敗しました。ファイルサイズが大きすぎる可能性があります。', 'error');
            return;
        }

        // フォームデータをJSONオブジェクトにまとめる
        const formData = {
            // 基本情報
            date: document.getElementById('date').value,
            mode: mode,
            driverName: document.getElementById('driverName').value,
            company: document.getElementById('company').value,
            email: document.getElementById('email').value,
            // ★ GASコードを修正しないため、固定トークンをここで挿入 ★
            lineToken: ADMIN_LINE_TOKEN, 
            // その他の基本情報
            client: document.getElementById('client').value,
            area: document.getElementById('area').value,
            base: document.getElementById('base').value,
            startPlace: document.getElementById('startPlace').value,
        };

        if (mode === '出発点呼') {
            Object.assign(formData, {
                // 出発前チェック
                workTime: document.getElementById('workTime').value,
                startTime: document.getElementById('startTime').value,
                condition: document.getElementById('condition').value,
                sleep: document.getElementById('sleep').value,
                drink: document.querySelector('input[name="drink"]:checked').value,
                medicine: document.querySelector('input[name="medicine"]:checked')?.value || '',
                temp: document.getElementById('temp').value,
                alcoholValue: document.getElementById('alcoholValue').value,
                startMeter: document.getElementById('startMeter').value,
                memo: document.getElementById('memo').value,
                // 日常点検
                check_brake: document.querySelector('input[name="check_brake"]:checked').value,
                check_tire: document.querySelector('input[name="check_tire"]:checked').value,
                check_light: document.querySelector('input[name="check_light"]:checked').value,
                check_camera: document.querySelector('input[name="check_camera"]:checked').value,
                check_body: document.querySelector('input[name="check_body"]:checked').value,
                check_other: document.querySelector('input[name="check_other"]:checked').value,
                check_note: document.getElementById('check_note').value,
            });
        } else if (mode === '帰庫点呼（日報）') {
            Object.assign(formData, {
                // 帰庫後記録
                returnPlace: document.getElementById('returnPlace').value,
                returnTime: document.getElementById('returnTime').value,
                returnMeter: document.getElementById('returnMeter').value,
                distance: document.getElementById('distance').value,
                rest: document.getElementById('rest').value,
                codStatus: document.querySelector('input[name="codStatus"]:checked').value,
                codAmount: document.getElementById('codAmount').value,
                roadStatus: document.getElementById('roadStatus').value,
                abnormalDetail: document.getElementById('abnormalDetail').value,
                // 帰庫時も出発時の情報を空で送る (スプレッドシートの列をずらさないため)
                startMeter: '', 
                startTime: '',
                workTime: ''
            });
        }

        // データをFormDataに格納して送信準備
        const dataToSend = new FormData();
        dataToSend.append('json', JSON.stringify(formData));
        
        if (licenseBase64) {
            // ファイルの拡張子とMIMEタイプを指定してBlobを作成 (GAS側で処理できるように)
            dataToSend.append('licenseFile', Utilities.newBlob(Utilities.base64Decode(licenseBase64), 'image/jpeg', 'license.jpg'));
        }
        if (carAbnormalBase64) {
            dataToSend.append('carAbnormalFile', Utilities.newBlob(Utilities.base64Decode(carAbnormalBase64), 'image/jpeg', 'abnormal.jpg'));
        }
        
        // GASへの送信
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                body: dataToSend,
            });
            
            const result = await response.json();

            if (result.status === 'SUCCESS') {
                showMessage(result.message + ' メールで控えをご確認ください。', 'success');
                // 成功後、モード選択と基本情報以外をクリア
                document.getElementById('tenkoForm').reset();
            } else {
                showMessage('送信エラー: ' + result.message + ' 設定を確認してください。', 'error');
            }

        } catch (error) {
            showMessage('通信エラーが発生しました。インターネット接続を確認してください。GAS_URLが正しいか確認してください。', 'error');
            console.error('Fetch Error:', error);
        }
    });

    // メッセージ表示ヘルパー
    function showMessage(msg, type) {
        messageBox.className = 'message-box';
        messageBox.classList.add(type);
        messageBox.textContent = msg;
        messageBox.style.display = 'block';
    }

    // 初期表示の更新
    updateFormVisibility();
</script>

</body>
</html>
