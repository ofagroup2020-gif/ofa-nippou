<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>OFA 管理者（月報PDF・期間検索）</title>
  <link rel="stylesheet" href="../style.css" />

  <!-- キャッシュ殺し（Chrome対策） -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
</head>

<body>
  <div class="header">
    <div class="logo">OFA</div>
    <div class="titlewrap">
      <div class="title">管理者（月報PDF・期間検索）</div>
      <div class="subtitle">端末内データ（IndexedDB）を検索して月報PDF / CSV を出力</div>
    </div>
    <a href="../index.html"><button class="rightTopBtn">戻る</button></a>
  </div>

  <div class="container">

    <!-- ① 管理者認証 -->
    <div class="card">
      <div class="h2">① 管理者認証</div>
      <div class="note">
        管理者パスは <strong>サイトに記載しません</strong>（LINEで共有する運用）。<br/>
        この端末の保存パスで認証します（localStorage）。
      </div>

      <label>管理者パス</label>
      <input id="a_pass" type="password" placeholder="LINEで共有されたパスを入力" />

      <div class="actions" style="margin-top:12px">
        <button class="btn" id="btnAdminLogin">ログイン</button>
        <button class="btn secondary" id="btnChangePass">管理者パス変更</button>
      </div>

      <div class="small" style="margin-top:8px">
        ※管理者パスは端末内保存です（サーバー送信しません）<br/>
        ※別端末で使う場合は、その端末でも同じパスを設定してください
      </div>

      <div class="divider"></div>
      <div class="note" id="adminState">未ログイン</div>
    </div>

    <!-- ② 月報検索 -->
    <div class="card" id="adminPanel" style="display:none">
      <div class="h2">② 月報検索（期間・拠点・氏名・電話）</div>
      <div class="note">
        まず <strong>期間（開始/終了）</strong> を指定して検索してください。<br/>
        拠点・氏名・電話は部分一致で絞り込みできます。<br/>
        <strong>氏名 or 電話番号 どちらか入力があれば検索OK</strong>（両方入れたらさらに絞り込み）。
      </div>

      <label>期間（開始）*</label>
      <input id="q_start" type="date" />

      <label>期間（終了）*</label>
      <input id="q_end" type="date" />

      <label>拠点（部分一致）</label>
      <input id="q_base" placeholder="例：鹿児島" />

      <label>氏名（部分一致）</label>
      <input id="q_name" placeholder="例：森下" />

      <label>電話番号（部分一致）</label>
      <input id="q_phone" inputmode="tel" placeholder="例：090 / 0803 / 0901234 など" />

      <div class="actions" style="margin-top:12px">
        <button class="btn" id="btnSearch">検索</button>
        <button class="btn secondary" id="btnCsv">CSV出力（検索結果）</button>
      </div>

      <div class="divider"></div>

      <!-- ③ 月報PDF -->
      <div class="h2" style="margin-top:0;">③ 月報PDF（OFAフォーマット）</div>
      <div class="note">
        検索結果をもとに月報PDFを作成します。<br/>
        PDFは 日本語文字化けしない方式（HTML→canvas→PDF）で生成します。
      </div>
      <button class="btn" id="btnMonthlyPdf">月報PDFを作成</button>

      <div class="divider"></div>

      <!-- ④ 結果 -->
      <div class="h2" style="margin-top:0;">④ 検索結果</div>
      <div class="note" id="resultSummary">まだ検索していません</div>
      <div id="resultBox"></div>
    </div>

    <div class="small" style="opacity:.7;margin-top:18px">
      © OFA GROUP / 管理者ページ（端末内データのみ・アップロード無し）
    </div>
  </div>

  <!-- deps（必ずこの順。v=でキャッシュ殺し） -->
  <script src="../js/db.js?v=20260124"></script>
  <script src="../js/pdf.js?v=20260124"></script>
  <script src="../js/csv.js?v=20260124"></script>

  <script>
    (function(){
      "use strict";

      const PASS_KEY  = "ofa_admin_pass_v1";
      const LOGIN_KEY = "ofa_admin_login_v1";
      const DEFAULT_PASS = "ofa-admin";

      const $ = (id) => document.getElementById(id);

      // iOS Chrome対策：click と pointerup の両方を拾う
      function bindTap(el, fn){
        if(!el) return;
        const handler = (e)=>{
          try { e.preventDefault(); } catch {}
          try { e.stopPropagation(); } catch {}
          fn();
        };
        el.addEventListener("click", handler, {passive:false});
        el.addEventListener("pointerup", handler, {passive:false});
      }

      const state = {
        loggedIn: false,
        lastSearch: null, // { tenko:[], daily:[], filters:{...} }
      };

      function safeGetLS(key){
        try { return localStorage.getItem(key); } catch { return null; }
      }
      function safeSetLS(key, val){
        try { localStorage.setItem(key, val); return true; } catch { return false; }
      }

      function getSavedPass(){
        return safeGetLS(PASS_KEY) || DEFAULT_PASS;
      }

      function setLoggedIn(v){
        state.loggedIn = !!v;
        safeSetLS(LOGIN_KEY, v ? "1" : "0");

        $("adminPanel").style.display = v ? "block" : "none";
        $("adminState").textContent = v ? "ログイン済み" : "未ログイン";
      }

      function ensureDates(){
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth()+1).padStart(2,"0");
        const dd = String(today.getDate()).padStart(2,"0");
        const ymd = `${yyyy}-${mm}-${dd}`;
        if (!$("q_end").value) $("q_end").value = ymd;

        // 月初を開始に
        const first = `${yyyy}-${mm}-01`;
        if (!$("q_start").value) $("q_start").value = first;
      }

      // ===== IndexedDB検索（db.jsの実装差分でも動くように直叩き） =====
      const OFA_DB_NAME = "ofa_nippou_db";
      const OFA_DB_VER  = 1;
      const STORE_TENKO = "tenko";
      const STORE_DAILY = "daily";

      function idbOpen(){
        return new Promise((resolve, reject)=>{
          const req = indexedDB.open(OFA_DB_NAME, OFA_DB_VER);
          req.onsuccess = ()=> resolve(req.result);
          req.onerror = ()=> reject(req.error);
        });
      }
      async function idbAll(store){
        const db = await idbOpen();
        return new Promise((resolve, reject)=>{
          const tx = db.transaction(store, "readonly");
          const req = tx.objectStore(store).getAll();
          req.onsuccess = ()=> resolve(req.result || []);
          req.onerror = ()=> reject(req.error);
        });
      }

      function toDate00(ymd){
        if (!ymd) return null;
        const d = new Date(ymd + "T00:00:00");
        return Number.isNaN(d.getTime()) ? null : d;
      }
      function toDate2359(ymd){
        if (!ymd) return null;
        const d = new Date(ymd + "T23:59:59");
        return Number.isNaN(d.getTime()) ? null : d;
      }
      function parseAnyDate(x){
        const d = new Date(x);
        return Number.isNaN(d.getTime()) ? null : d;
      }

      function includesPartial(hay, needle){
        if (!needle) return true;
        return String(hay || "").includes(String(needle));
      }

      function normalizePhone(s){
        return String(s || "").replace(/[^\d]/g, "");
      }
      function includesPhonePartial(hayPhone, needlePhone){
        if (!needlePhone) return true;
        return normalizePhone(hayPhone).includes(normalizePhone(needlePhone));
      }

      function renderResults(tenko, daily){
        const summary = `検索結果：点呼 ${tenko.length} 件 / 日報 ${daily.length} 件`;
        $("resultSummary").textContent = summary;

        const rowsTenko = tenko.map(t=>{
          const dt = (t.at||"").replace("T"," ").slice(0,16);
          const type = t.type === "arr" ? "帰着" : "出発";
          return `<tr>
            <td>${dt}</td>
            <td>${(t.name||"")}</td>
            <td>${(t.base||"")}</td>
            <td>${(t.phone||"")}</td>
            <td>${type}</td>
            <td>${(t.alcValue ?? 0)}</td>
            <td>${(t.abnormal||"なし")}</td>
          </tr>`;
        }).join("");

        const wrap = `
          <div style="overflow:auto">
            <table style="width:100%;border-collapse:collapse">
              <thead>
                <tr style="text-align:left;opacity:.8">
                  <th style="padding:8px 6px">日付</th>
                  <th style="padding:8px 6px">氏名</th>
                  <th style="padding:8px 6px">拠点</th>
                  <th style="padding:8px 6px">電話</th>
                  <th style="padding:8px 6px">区分</th>
                  <th style="padding:8px 6px">アルコール</th>
                  <th style="padding:8px 6px">異常</th>
                </tr>
              </thead>
              <tbody>
                ${rowsTenko || `<tr><td colspan="7" style="padding:10px;opacity:.7">点呼の該当なし</td></tr>`}
              </tbody>
            </table>
          </div>
        `;
        $("resultBox").innerHTML = wrap;
      }

      // ★必ず window に生やす（Can't find variable 根絶）
      window.searchMonthly = async function searchMonthly(){
        if (!state.loggedIn) {
          alert("先にログインしてください");
          return null;
        }

        const start = $("q_start").value;
        const end   = $("q_end").value;
        if (!start || !end) {
          alert("期間（開始/終了）を入力してください");
          return null;
        }

        const base  = $("q_base").value.trim();
        const name  = $("q_name").value.trim();
        const phone = $("q_phone").value.trim();

        // ★氏名 or 電話 どちらかがあれば検索OK（両方空なら注意）
        if (!name && !phone) {
          alert("氏名 or 電話番号 のどちらかを入力してください");
          return null;
        }

        const d0 = toDate00(start);
        const d1 = toDate2359(end);
        if (!d0 || !d1 || d0.getTime() > d1.getTime()){
          alert("期間が正しくありません");
          return null;
        }

        const [tenkoAll, dailyAll] = await Promise.all([idbAll(STORE_TENKO), idbAll(STORE_DAILY)]);

        const tenko = tenkoAll.filter(t=>{
          const dt = parseAnyDate(t.at);
          if (!dt) return false;
          if (dt.getTime() < d0.getTime() || dt.getTime() > d1.getTime()) return false;

          if (!includesPartial(t.base, base)) return false;

          // name は部分一致
          if (!includesPartial(t.name, name)) return false;

          // phone は数字化して部分一致
          if (!includesPhonePartial(t.phone, phone)) return false;

          return true;
        }).sort((a,b)=> (parseAnyDate(a.at)?.getTime()||0) - (parseAnyDate(b.at)?.getTime()||0));

        const daily = dailyAll.filter(r=>{
          const dt = toDate00(r.date) || parseAnyDate(r.createdAt || r.updatedAt || "");
          if (!dt) return false;
          if (dt.getTime() < d0.getTime() || dt.getTime() > d1.getTime()) return false;

          if (!includesPartial(r.base, base)) return false;
          if (!includesPartial(r.name, name)) return false;
          if (!includesPhonePartial(r.phone, phone)) return false;

          return true;
        }).sort((a,b)=> (toDate00(a.date)?.getTime()||0) - (toDate00(b.date)?.getTime()||0));

        state.lastSearch = { tenko, daily, filters:{start,end,base,name,phone} };
        renderResults(tenko, daily);
        return state.lastSearch;
      };

      window.makeMonthlyPdf = async function makeMonthlyPdf(){
        if (!state.loggedIn) { alert("先にログインしてください"); return; }
        if (!state.lastSearch) { alert("先に検索してください"); return; }

        const { tenko, daily, filters } = state.lastSearch;
        if (!tenko.length && !daily.length) {
          alert("検索結果が0件なので月報PDFを作れません");
          return;
        }

        // pdf.js側に月報用関数があれば呼ぶ（推奨）
        const title = `OFA_月報_${filters.start}_${filters.end}_${filters.base||"ALL"}_${filters.name||"NAME-ALL"}_${filters.phone||"PHONE-ALL"}`;

        if (typeof window.createMonthlyPdf === "function") {
          await window.createMonthlyPdf({ tenko, daily, filters, title });
          return;
        }

        // フォールバック（最低限の印刷PDF）
        const w = window.open("", "_blank");
        w.document.write(`<html><head><meta charset="utf-8"><title>${title}</title></head><body style="font-family:sans-serif;padding:16px">`);
        w.document.write(`<h2 style="margin:0 0 6px 0">OFA 月報</h2>`);
        w.document.write(`<div style="opacity:.8;margin-bottom:10px">期間：${filters.start} 〜 ${filters.end} / 拠点：${filters.base||"-"} / 氏名：${filters.name||"-"} / 電話：${filters.phone||"-"}</div>`);
        w.document.write(`<h3>点呼（${tenko.length}件）</h3><pre style="white-space:pre-wrap">${JSON.stringify(tenko, null, 2)}</pre>`);
        w.document.write(`<h3>日報（${daily.length}件）</h3><pre style="white-space:pre-wrap">${JSON.stringify(daily, null, 2)}</pre>`);
        w.document.write(`</body></html>`);
        w.document.close();
        w.focus();
        w.print();
      };

      window.exportMonthlyCsv = async function exportMonthlyCsv(){
        if (!state.loggedIn) { alert("先にログインしてください"); return; }
        if (!state.lastSearch) { alert("先に検索してください"); return; }
        const { tenko, daily, filters } = state.lastSearch;

        if (typeof window.exportCsvFromMonthly === "function") {
          await window.exportCsvFromMonthly({ tenko, daily, filters });
          return;
        }

        // 最低限：JSON保存（CSV関数が無い場合の保険）
        const blob = new Blob([JSON.stringify({filters, tenko, daily}, null, 2)], {type:"application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `OFA_monthly_${filters.start}_${filters.end}.json`;
        a.click();
      };

      document.addEventListener("DOMContentLoaded", ()=>{
        ensureDates();

        // 既にログイン状態なら復帰
        const was = safeGetLS(LOGIN_KEY) === "1";
        if (was) setLoggedIn(true);

        bindTap($("btnAdminLogin"), ()=>{
          const input = $("a_pass").value.trim();
          const saved = getSavedPass();
          if (input !== saved) {
            alert("現在のパスが違います");
            return;
          }
          setLoggedIn(true);
          alert("ログインしました");
        });

        bindTap($("btnChangePass"), ()=>{
          const cur = $("a_pass").value.trim();
          const saved = getSavedPass();
          if (cur !== saved) {
            alert("現在のパスが違います");
            return;
          }
          const next = prompt("新しい管理者パスを入力してください（この端末に保存）");
          if (!next) return;
          if (!safeSetLS(PASS_KEY, next)) {
            alert("保存できません（ブラウザ制限/プライベートの可能性）");
            return;
          }
          alert("管理者パスを変更しました（この端末のみ）");
        });

        bindTap($("btnSearch"), async ()=>{
          try { await window.searchMonthly(); }
          catch(err){ console.error(err); alert("検索に失敗しました"); }
        });

        bindTap($("btnCsv"), async ()=>{
          try { await window.exportMonthlyCsv(); }
          catch(err){ console.error(err); alert("CSV出力に失敗しました"); }
        });

        bindTap($("btnMonthlyPdf"), async ()=>{
          try { await window.makeMonthlyPdf(); }
          catch(err){ console.error(err); alert("月報PDFに失敗しました"); }
        });
      });

    })();
  </script>
</body>
</html>
