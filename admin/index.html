<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>OFA 管理者（月報PDF・期間検索）</title>
  <link rel="stylesheet" href="../style.css" />

  <!-- キャッシュ殺し（Chrome対策） -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
</head>

<body>
  <div class="header">
    <div class="logo">OFA</div>
    <div class="titlewrap">
      <div class="title">管理者（月報PDF・期間検索）</div>
      <div class="subtitle">端末内データ（IndexedDB）を検索して月報PDF / CSV を出力</div>
    </div>
    <a href="../index.html"><button class="rightTopBtn">戻る</button></a>
  </div>

  <div class="container">

    <!-- ① 管理者認証 -->
    <div class="card">
      <div class="h2">① 管理者認証</div>
      <div class="note">
        管理者パスは <strong>サイトに記載しません</strong>（LINEで共有運用）。<br/>
        この端末の保存パスで認証します（localStorage）。
      </div>

      <label>管理者パス</label>
      <input id="a_pass" type="password" placeholder="LINEで共有されたパスを入力" />

      <div class="actions" style="margin-top:12px">
        <button class="btn" id="btnAdminLogin">ログイン</button>
        <button class="btn secondary" id="btnChangePass">管理者パス変更</button>
      </div>

      <div class="small" style="margin-top:8px">
        ※管理者パスは端末内保存です（サーバー送信しません）<br/>
        ※別端末で使う場合は、その端末でも同じパスを設定してください
      </div>

      <div class="divider"></div>
      <div class="note" id="adminState">未ログイン</div>
    </div>

    <!-- ② 検索 -->
    <div class="card" id="adminPanel" style="display:none">
      <div class="h2">② 検索（期間必須 / 拠点・氏名・電話で絞り込み）</div>
      <div class="note">
        期間（開始/終了）は<strong>必須</strong>。<br/>
        絞り込みは <strong>拠点 / 氏名 / 電話 のどれか1つでもOK</strong>（部分一致）。<br/>
        ※未入力なら「全ドライバー」を集計します。
      </div>

      <label>期間（開始）*</label>
      <input id="q_start" type="date" />

      <label>期間（終了）*</label>
      <input id="q_end" type="date" />

      <div class="row">
        <div>
          <label>拠点（部分一致）</label>
          <input id="q_base" placeholder="例：鹿児島" />
        </div>
        <div>
          <label>氏名（部分一致）</label>
          <input id="q_name" placeholder="例：森下" />
        </div>
      </div>

      <label>電話番号（部分一致）</label>
      <input id="q_phone" placeholder="例：090" inputmode="tel" />

      <div class="actions" style="margin-top:12px">
        <button class="btn" id="btnSearch">検索</button>
        <button class="btn secondary" id="btnCsv">CSV出力（検索結果）</button>
      </div>

      <div class="divider"></div>

      <!-- ③ 月報PDF -->
      <div class="h2" style="margin-top:0;">③ 月報PDF（検索結果→ドライバー別）</div>
      <div class="note">
        検索結果を「ドライバー単位」でまとめてPDF作成します（1人=1ページ）。<br/>
        PDFは 日本語文字化けしない方式（HTML→canvas→PDF）で生成します。
      </div>
      <button class="btn" id="btnMonthlyPdf">月報PDFを作成</button>

      <div class="divider"></div>

      <!-- ④ 結果 -->
      <div class="h2" style="margin-top:0;">④ 検索結果（ドライバー別）</div>
      <div class="note" id="resultSummary">まだ検索していません</div>
      <div id="resultBox"></div>

      <div class="divider"></div>

      <div class="note">
        <b>使い方：</b>一覧の行をタップすると、そのドライバーで再検索（絞り込み）します。
      </div>
    </div>

    <div class="small" style="opacity:.7;margin-top:18px">
      © OFA GROUP / 管理者ページ（端末内データのみ・アップロード無し）
    </div>
  </div>

  <!-- deps（必ずこの順。v=でキャッシュ殺し） -->
  <script src="../js/db.js?v=20260124"></script>
  <script src="../js/pdf.js?v=20260124"></script>
  <script src="../js/csv.js?v=20260124"></script>

  <script>
    (function(){
      "use strict";

      const PASS_KEY  = "ofa_admin_pass_v1";
      const LOGIN_KEY = "ofa_admin_login_v1";
      const DEFAULT_PASS = "ofa-admin";

      const $ = (id) => document.getElementById(id);

      const state = {
        loggedIn: false,
        lastSearch: null, // { tenko:[], daily:[], filters:{...}, groups:[...] }
      };

      function safeGetLS(key){
        try { return localStorage.getItem(key); } catch { return null; }
      }
      function safeSetLS(key, val){
        try { localStorage.setItem(key, val); return true; } catch { return false; }
      }

      function getSavedPass(){
        return safeGetLS(PASS_KEY) || DEFAULT_PASS;
      }

      function setLoggedIn(v){
        state.loggedIn = !!v;
        if (v) safeSetLS(LOGIN_KEY, "1");
        else safeSetLS(LOGIN_KEY, "0");

        $("adminPanel").style.display = v ? "block" : "none";
        $("adminState").textContent = v ? "ログイン済み" : "未ログイン";
      }

      function ensureDates(){
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth()+1).padStart(2,"0");
        const dd = String(today.getDate()).padStart(2,"0");
        const ymd = `${yyyy}-${mm}-${dd}`;
        if (!$("q_end").value) $("q_end").value = ymd;

        // 月初を開始に
        const first = `${yyyy}-${mm}-01`;
        if (!$("q_start").value) $("q_start").value = first;
      }

      // ===== IndexedDB（直叩き） =====
      const OFA_DB_NAME = "ofa_nippou_db";
      const OFA_DB_VER  = 1;
      const STORE_TENKO = "tenko";
      const STORE_DAILY = "daily";

      function idbOpen(){
        return new Promise((resolve, reject)=>{
          const req = indexedDB.open(OFA_DB_NAME, OFA_DB_VER);
          req.onsuccess = ()=> resolve(req.result);
          req.onerror = ()=> reject(req.error);
        });
      }
      async function idbAll(store){
        const db = await idbOpen();
        return new Promise((resolve, reject)=>{
          const tx = db.transaction(store, "readonly");
          const req = tx.objectStore(store).getAll();
          req.onsuccess = ()=> resolve(req.result || []);
          req.onerror = ()=> reject(req.error);
        });
      }

      function toDate00(ymd){
        if (!ymd) return null;
        const d = new Date(ymd + "T00:00:00");
        return Number.isNaN(d.getTime()) ? null : d;
      }
      function toDate2359(ymd){
        if (!ymd) return null;
        const d = new Date(ymd + "T23:59:59");
        return Number.isNaN(d.getTime()) ? null : d;
      }
      function parseAnyDate(x){
        const d = new Date(x);
        return Number.isNaN(d.getTime()) ? null : d;
      }

      function includesPartial(hay, needle){
        if (!needle) return true;
        return String(hay || "").includes(String(needle));
      }

      function safeNum(n){
        const x = Number(n);
        return Number.isFinite(x) ? x : 0;
      }

      function normalizePhone(s){
        return String(s || "").replaceAll("-", "").replaceAll(" ", "");
      }

      // ===== グルーピング（ドライバー単位） =====
      function buildGroups(tenko, daily){
        const map = new Map();

        function keyOf(o){
          const name = (o.name || "").trim();
          const base = (o.base || "").trim();
          const phone = normalizePhone(o.phone || "");
          // phone優先（電話が一番ブレない）
          return (phone ? `P:${phone}` : `N:${name}|B:${base}`);
        }

        function ensure(o){
          const key = keyOf(o);
          if(!map.has(key)){
            map.set(key, {
              key,
              name: (o.name || "").trim(),
              base: (o.base || "").trim(),
              phone: (o.phone || "").trim(),
              tenko: [],
              daily: [],
            });
          }
          return map.get(key);
        }

        tenko.forEach(t=> ensure(t).tenko.push(t));
        daily.forEach(d=> ensure(d).daily.push(d));

        // 集計追加
        const groups = Array.from(map.values()).map(g=>{
          const sales = g.daily.reduce((acc,r)=> acc + safeNum(r.salesTotal ?? r.sales ?? r.uriage ?? r.total), 0);
          const profit = g.daily.reduce((acc,r)=> acc + safeNum(r.profit ?? r.rieki), 0);
          return {
            ...g,
            sales,
            profit,
            tenkoCount: g.tenko.length,
            dailyCount: g.daily.length,
          };
        });

        // 件数多い順に並べる（見やすい）
        groups.sort((a,b)=> (b.dailyCount + b.tenkoCount) - (a.dailyCount + a.tenkoCount));
        return groups;
      }

      function renderGroups(groups){
        $("resultSummary").textContent = `ドライバー ${groups.length} 人（タップでその人だけ絞り込み）`;

        if(!groups.length){
          $("resultBox").innerHTML = `<div class="note" style="opacity:.8">該当なし</div>`;
          return;
        }

        const rows = groups.map(g=>{
          const name = g.name || "（氏名なし）";
          const base = g.base || "（拠点なし）";
          const phone = g.phone || "（電話なし）";

          return `
            <div class="histItem" data-k="${g.key}" style="cursor:pointer">
              <div class="histTop">
                <div>
                  <div class="histTitle">${name} / ${base}</div>
                  <div class="histBody" style="margin-top:4px;opacity:.85">${phone}</div>
                  <div class="histBody" style="margin-top:6px;opacity:.8">
                    点呼 ${g.tenkoCount} 件 / 日報 ${g.dailyCount} 件
                    ／ 売上 ${g.sales} ／ 利益 ${g.profit}
                  </div>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                  <button class="miniBtn" data-act="pick" data-name="${name}" data-base="${base}" data-phone="${phone}">絞込</button>
                </div>
              </div>
            </div>
          `;
        }).join("");

        $("resultBox").innerHTML = rows;

        // タップで絞り込み（氏名/電話をセットして再検索）
        $("resultBox").querySelectorAll(".histItem").forEach(item=>{
          item.addEventListener("click", async ()=>{
            const btn = item.querySelector('[data-act="pick"]');
            if(!btn) return;
            $("q_name").value = btn.dataset.name === "（氏名なし）" ? "" : btn.dataset.name;
            $("q_base").value = btn.dataset.base === "（拠点なし）" ? "" : btn.dataset.base;
            $("q_phone").value = btn.dataset.phone === "（電話なし）" ? "" : btn.dataset.phone;
            await window.searchMonthly();
          }, {passive:true});
        });

        $("resultBox").querySelectorAll('[data-act="pick"]').forEach(btn=>{
          btn.addEventListener("click", async (e)=>{
            e.preventDefault(); e.stopPropagation();
            $("q_name").value = btn.dataset.name === "（氏名なし）" ? "" : btn.dataset.name;
            $("q_base").value = btn.dataset.base === "（拠点なし）" ? "" : btn.dataset.base;
            $("q_phone").value = btn.dataset.phone === "（電話なし）" ? "" : btn.dataset.phone;
            await window.searchMonthly();
          }, {passive:false});
        });
      }

      // ★ window.searchMonthly（必ず存在）
      window.searchMonthly = async function searchMonthly(){
        if (!state.loggedIn) {
          alert("先にログインしてください");
          return null;
        }

        const start = $("q_start").value;
        const end   = $("q_end").value;
        if (!start || !end) {
          alert("期間（開始/終了）は必須です");
          return null;
        }

        const base  = $("q_base").value.trim();
        const name  = $("q_name").value.trim();
        const phone = $("q_phone").value.trim();

        const d0 = toDate00(start);
        const d1 = toDate2359(end);
        if (!d0 || !d1 || d0.getTime() > d1.getTime()){
          alert("期間が正しくありません");
          return null;
        }

        const [tenkoAll, dailyAll] = await Promise.all([idbAll(STORE_TENKO), idbAll(STORE_DAILY)]);

        const phoneN = normalizePhone(phone);

        const tenko = tenkoAll.filter(t=>{
          const dt = parseAnyDate(t.at);
          if (!dt) return false;
          if (dt.getTime() < d0.getTime() || dt.getTime() > d1.getTime()) return false;

          if (!includesPartial(t.base, base)) return false;
          if (!includesPartial(t.name, name)) return false;

          // phoneはハイフン無し比較
          if (phoneN){
            const tp = normalizePhone(t.phone || "");
            if (!tp.includes(phoneN)) return false;
          }
          return true;
        });

        const daily = dailyAll.filter(r=>{
          const dt = toDate00(r.date) || parseAnyDate(r.createdAt || r.updatedAt || "");
          if (!dt) return false;
          if (dt.getTime() < d0.getTime() || dt.getTime() > d1.getTime()) return false;

          if (!includesPartial(r.base, base)) return false;
          if (!includesPartial(r.name, name)) return false;

          if (phoneN){
            const rp = normalizePhone(r.phone || "");
            if (!rp.includes(phoneN)) return false;
          }
          return true;
        });

        const filters = { start, end, base, name, phone };

        const groups = buildGroups(tenko, daily);

        state.lastSearch = { tenko, daily, filters, groups };
        renderGroups(groups);

        return state.lastSearch;
      };

      window.makeMonthlyPdf = async function makeMonthlyPdf(){
        if (!state.loggedIn) { alert("先にログインしてください"); return; }
        if (!state.lastSearch) { alert("先に検索してください"); return; }

        const { groups, filters } = state.lastSearch;
        if (!groups.length){ alert("検索結果が0件なのでPDFを作れません"); return; }

        // pdf.js 側の generateMonthlyPdf を呼ぶ（admin/js/pdf.jsを使う運用でもOK）
        if (typeof window.generateMonthlyPdf === "function") {
          // generateMonthlyPdf(groups, {from,to})
          await window.generateMonthlyPdf(groups, { from: filters.start, to: filters.end });
          return;
        }

        // もし driver側 pdf.js（createMonthlyPdf）しか無い場合
        if (typeof window.createMonthlyPdf === "function") {
          // 1人ずつ createMonthlyPdf を呼んでPDFは分割保存になるので注意
          for(const g of groups){
            await window.createMonthlyPdf({ tenko: g.tenko, daily: g.daily, filters, title: `OFA_月報_${g.base||"ALL"}_${g.name||"ALL"}` });
          }
          return;
        }

        alert("PDF機能が見つかりません（pdf.js）");
      };

      window.exportMonthlyCsv = async function exportMonthlyCsv(){
        if (!state.loggedIn) { alert("先にログインしてください"); return; }
        if (!state.lastSearch) { alert("先に検索してください"); return; }

        const { tenko, daily, filters } = state.lastSearch;

        if (typeof window.exportCsvFromMonthly === "function") {
          await window.exportCsvFromMonthly({ tenko, daily, filters });
          return;
        }

        // fallback: json
        const blob = new Blob([JSON.stringify({filters, tenko, daily}, null, 2)], {type:"application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `OFA_monthly_${filters.start}_${filters.end}.json`;
        a.click();
      };

      // ===== イベント束縛 =====
      document.addEventListener("DOMContentLoaded", ()=>{
        ensureDates();

        // ログイン復帰
        const was = safeGetLS(LOGIN_KEY) === "1";
        if (was) setLoggedIn(true);

        $("btnAdminLogin").addEventListener("click", (e)=>{
          e.preventDefault();
          const input = $("a_pass").value.trim();
          const saved = getSavedPass();
          if (input !== saved) {
            alert("現在のパスが違います");
            return;
          }
          setLoggedIn(true);
          alert("ログインしました");
        }, {passive:false});

        $("btnChangePass").addEventListener("click", (e)=>{
          e.preventDefault();
          const cur = $("a_pass").value.trim();
          const saved = getSavedPass();
          if (cur !== saved) {
            alert("現在のパスが違います");
            return;
          }
          const next = prompt("新しい管理者パスを入力してください（この端末に保存）");
          if (!next) return;
          if (!safeSetLS(PASS_KEY, next)) {
            alert("保存できません（ブラウザ制限/プライベートの可能性）");
            return;
          }
          alert("管理者パスを変更しました（この端末のみ）");
        }, {passive:false});

        $("btnSearch").addEventListener("click", async (e)=>{
          e.preventDefault();
          try { await window.searchMonthly(); }
          catch(err){ console.error(err); alert("検索に失敗しました"); }
        }, {passive:false});

        $("btnCsv").addEventListener("click", async (e)=>{
          e.preventDefault();
          try { await window.exportMonthlyCsv(); }
          catch(err){ console.error(err); alert("CSV出力に失敗しました"); }
        }, {passive:false});

        $("btnMonthlyPdf").addEventListener("click", async (e)=>{
          e.preventDefault();
          try { await window.makeMonthlyPdf(); }
          catch(err){ console.error(err); alert("月報PDFに失敗しました"); }
        }, {passive:false});
      });

    })();
  </script>
</body>
</html>
