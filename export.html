<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ—¥å ± / æœˆå ± / æœˆæ¬¡CSV</title>
  <style>
    :root{
      --bg:#070b16;--card:#0c1632;--card2:#0b1226;--txt:#e9eefc;--muted:#a8b3d6;
      --line:rgba(255,255,255,.10);--btn:#ffd400;--btn2:#2b3556;--input:#0b1736;
      --ok:#22c55e;--ng:#ef4444;
    }
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Noto Sans JP",Meiryo,sans-serif;background:var(--bg);color:var(--txt);}
    .wrap{max-width:450px;margin:0 auto;padding:18px 14px 36px;}
    .head{display:flex;align-items:center;justify-content:space-between;margin:6px 0 12px}
    .title{font-weight:900;font-size:18px}
    .back{background:transparent;border:1px solid var(--line);color:var(--txt);padding:10px 12px;border-radius:12px;font-weight:700}
    .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--line);border-radius:16px;padding:14px;margin:10px 0}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input{
      width:100%;box-sizing:border-box;background:var(--input);border:1px solid var(--line);
      border-radius:12px;color:var(--txt);padding:12px;font-size:14px;outline:none;
    }
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{display:block;width:100%;border:none;border-radius:14px;padding:14px 14px;font-weight:900;font-size:15px;margin-top:12px}
    .btn.yellow{background:var(--btn);color:#101010}
    .btn.gray{background:var(--btn2);color:var(--txt)}
    .note{color:var(--muted);font-size:12px;line-height:1.45;margin-top:10px}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);display:none;
      padding:12px 14px;border-radius:14px;color:#fff;font-weight:800;max-width:92%;text-align:center;z-index:9999}
    .toast.ok{background:rgba(34,197,94,.95)}
    .toast.ng{background:rgba(239,68,68,.95)}
    .resultBox{margin-top:12px;border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(0,0,0,.15)}
    .resultTitle{font-weight:900;margin-bottom:6px}
    .resultLink a{color:#7dd3fc;text-decoration:none;font-weight:800}
    .resultSmall{color:var(--muted);font-size:12px;margin-top:6px}
    .list{margin-top:10px}
    .row{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:1px solid var(--line);border-radius:12px;padding:10px 12px;margin:8px 0;background:rgba(0,0,0,.12)
    }
    .row .d{font-weight:900}
    .row .s{color:var(--muted);font-size:12px;margin-top:2px}
    .row button{
      border:none;border-radius:10px;padding:10px 12px;font-weight:900;background:linear-gradient(90deg,#ff8a00,#a855f7);color:#fff
    }
    .hr{height:1px;background:var(--line);margin:14px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div class="title">ğŸ“„ OFAï½œæ—¥å ± / æœˆå ± / CSV</div>
      <button class="back" onclick="location.href='index.html'">æˆ»ã‚‹</button>
    </div>

    <div class="card">
      <div class="note">
        âœ… æ—¥å ±PDFï¼šç‚¹å‘¼ã®<b>å…¨å†…å®¹</b>ï¼ˆèµ°è¡Œè·é›¢ãƒ»ç‚¹æ¤œãƒ»å…è¨±ãƒ»å†™çœŸãƒªãƒ³ã‚¯ï¼‰<br>
        âœ… æœˆå ±PDFï¼šå†™çœŸã¯<b>æœ‰/ç„¡ã®ã¿</b>ï¼ˆè©³ç´°ã¯æ—¥å ±PDFï¼‰<br>
        âœ… CSVï¼š<b>æ—¥ä»˜ç¯„å›²</b>ã§å‡ºåŠ›å¯èƒ½
      </div>

      <label>é‹è»¢è€…åï¼ˆä»»æ„ï¼šå…¥ã‚Œã‚‹ã¨ãã®äººã ã‘ï¼‰</label>
      <input id="name" placeholder="æœªå…¥åŠ›ãªã‚‰å…¨å“¡" />

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <label>æ—¥ä»˜ï¼ˆæ—¥å ±PDFç”¨ï¼‰</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label>æœˆï¼ˆYYYY-MM / æœˆå ±ãƒ»å±¥æ­´ç”¨ï¼‰</label>
          <input id="month" placeholder="ä¾‹ï¼š2025-12" inputmode="numeric" />
        </div>
      </div>

      <button class="btn yellow" onclick="makeDailyPdf()">æ—¥å ±PDFã‚’ä½œæˆ</button>
      <button class="btn gray" onclick="makeMonthlyPdf()">æœˆå ±PDFã‚’ä½œæˆ</button>

      <div class="hr"></div>

      <div class="h3" style="font-weight:900;margin:0 0 6px">CSVï¼ˆæ—¥ä»˜æŒ‡å®šï¼‰</div>
      <div class="grid2">
        <div>
          <label>é–‹å§‹æ—¥</label>
          <input id="from" type="date" />
        </div>
        <div>
          <label>çµ‚äº†æ—¥</label>
          <input id="to" type="date" />
        </div>
      </div>
      <button class="btn gray" onclick="makeCsvRange()">CSVã‚’ä½œæˆï¼ˆç¯„å›²ï¼‰</button>

      <div id="result"></div>

      <div class="hr"></div>

      <div class="h3" style="font-weight:900;margin:0 0 6px">æ—¥å ±PDF å±¥æ­´ï¼ˆæŒ‡å®šæœˆï¼‰</div>
      <div class="note">æœˆã‚’å…¥ã‚Œã¦ã€Œå±¥æ­´ã‚’èª­ã¿è¾¼ã‚€ã€â†’ æ—¥åˆ¥ã«ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§PDFç”Ÿæˆã§ãã¾ã™ã€‚</div>
      <button class="btn gray" onclick="loadHistory()">å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€ï¼ˆæŒ‡å®šæœˆï¼‰</button>
      <div id="history" class="list"></div>

      <div class="note">
        â€»PDFã¯Driveä¸Šã®PDFãªã®ã§ã€ãã®ã¾ã¾å°åˆ·ã§ãã¾ã™ï¼ˆå…±æœ‰ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/** â˜…ã‚ãªãŸã®æœ€æ–°GAS WebApp URLï¼ˆã“ã“ã ã‘åˆã‚ã›ã‚Œã°OKï¼‰ */
const GAS_WEBAPP_URL =
  "https://script.google.com/macros/s/AKfycbz34bn7t9d4RQhyZLlxy1-VFcxZq_BJTQlQrkBNeDzU6NSPOtgX-nUh5ckIhIWb0WMg-Q/exec";

function $(id){ return document.getElementById(id); }

function toast(msg, ok=false){
  const el = $("toast");
  el.textContent = msg;
  el.className = "toast " + (ok ? "ok" : "ng");
  el.style.display = "block";
  setTimeout(()=> el.style.display="none", 2600);
}

function normalizeYMD(v){
  return String(v||"").trim().replace(/\//g,"-");
}

function nowMonth(){
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}

function init(){
  if ($("date") && !$("date").value) $("date").value = new Date().toISOString().slice(0,10);
  if ($("from") && !$("from").value) $("from").value = new Date().toISOString().slice(0,10);
  if ($("to") && !$("to").value) $("to").value = new Date().toISOString().slice(0,10);
  if ($("month") && !$("month").value) $("month").value = nowMonth();
}
init();

async function callApi(params){
  const url = GAS_WEBAPP_URL + "?" + new URLSearchParams(params).toString();
  const res = await fetch(url, { method:"GET" });
  const json = await res.json().catch(()=>null);
  if (!json || !json.ok) throw new Error(json?.message || "å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ");
  return json;
}

function showResult(kind, url){
  const out = $("result");
  out.innerHTML = `
    <div class="resultBox">
      <div class="resultTitle">âœ… ä½œæˆå®Œäº†ï¼ˆ${kind}ï¼‰</div>
      <div class="resultLink"><a href="${url}" target="_blank" rel="noopener">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãï¼ˆDriveï¼‰</a></div>
      <div class="resultSmall">â€»ãƒªãƒ³ã‚¯ã‚’é–‹ã‘ãªã„å ´åˆï¼šDriveå…±æœ‰ï¼ˆãƒªãƒ³ã‚¯é–²è¦§ï¼‰è¨­å®šã‚’ç¢ºèª</div>
    </div>`;
}

async function makeDailyPdf(){
  try{
    const date = normalizeYMD($("date").value);
    const name = ($("name").value||"").trim();
    if (!date) throw new Error("æ—¥ä»˜ãŒå¿…è¦ã§ã™");
    toast("æ—¥å ±PDFã‚’ä½œæˆä¸­â€¦", true);
    const json = await callApi({ action:"dailyPdf", date, name });
    showResult("æ—¥å ±PDF", json.url);
    toast("ä½œæˆOK", true);
  }catch(e){ toast(e.message || String(e)); }
}

async function makeMonthlyPdf(){
  try{
    const month = ($("month").value||"").trim();
    const name = ($("name").value||"").trim();
    if (!/^\d{4}-\d{2}$/.test(month)) throw new Error("æœˆã¯ YYYY-MM ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š2025-12ï¼‰");
    toast("æœˆå ±PDFã‚’ä½œæˆä¸­â€¦", true);
    const json = await callApi({ action:"monthlyPdf", month, name });
    showResult("æœˆå ±PDF", json.url);
    toast("ä½œæˆOK", true);
  }catch(e){ toast(e.message || String(e)); }
}

async function makeCsvRange(){
  try{
    const from = normalizeYMD($("from").value);
    const to = normalizeYMD($("to").value);
    const name = ($("name").value||"").trim();
    if (!from || !to) throw new Error("é–‹å§‹æ—¥ãƒ»çµ‚äº†æ—¥ã‚’å…¥ã‚Œã¦ãã ã•ã„");
    toast("CSVã‚’ä½œæˆä¸­â€¦", true);
    // â€»GASå´ã« action=csvRange ã‚’è¿½åŠ ã—ã¾ã™ï¼ˆä¸‹ã«ã‚³ãƒ¼ãƒ‰ã‚ã‚Šï¼‰
    const json = await callApi({ action:"csvRange", from, to, name });
    showResult("CSVï¼ˆç¯„å›²ï¼‰", json.url);
    toast("ä½œæˆOK", true);
  }catch(e){ toast(e.message || String(e)); }
}

async function loadHistory(){
  try{
    const month = ($("month").value||"").trim();
    const name = ($("name").value||"").trim();
    if (!/^\d{4}-\d{2}$/.test(month)) throw new Error("æœˆã¯ YYYY-MM ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š2025-12ï¼‰");
    toast("å±¥æ­´èª­è¾¼ä¸­â€¦", true);
    // â€»GASå´ã« action=historyDays ã‚’è¿½åŠ ã—ã¾ã™ï¼ˆä¸‹ã«ã‚³ãƒ¼ãƒ‰ã‚ã‚Šï¼‰
    const json = await callApi({ action:"historyDays", month, name });
    renderHistory(json.days || []);
    toast("å±¥æ­´OK", true);
  }catch(e){ toast(e.message || String(e)); }
}

function renderHistory(days){
  const box = $("history");
  if (!days.length){
    box.innerHTML = `<div class="note" style="margin-top:8px">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }
  box.innerHTML = days.map(d => `
    <div class="row">
      <div>
        <div class="d">${d}</div>
        <div class="s">ã“ã®æ—¥ã®æ—¥å ±PDFã‚’ç”Ÿæˆ</div>
      </div>
      <button onclick="makeDailyPdfFrom('${d}')">PDF</button>
    </div>
  `).join("");
}

async function makeDailyPdfFrom(d){
  $("date").value = d;
  await makeDailyPdf();
}
</script>
</body>
</html>
