<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>OFA | 管理者 出力/検索</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body data-page="admin">
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">管理者：出力/検索</div>
          <div class="subtitle">日報PDF / 月報PDF / CSV（Driveリンクへ）</div>
        </div>
      </div>
      <a class="btn ghost" href="./index.html">戻る</a>
    </div>

    <div class="card rainbow-border">
      <div class="row" style="align-items:center;">
        <div class="hint" id="loginState" style="margin:0;"></div>
        <span class="badge">管理者</span>
      </div>

      <div class="hr"></div>

      <div class="grid grid2">
        <div>
          <label>対象氏名 <span class="req">*</span></label>
          <input id="name" type="text" placeholder="例：森下 洸" />
        </div>
        <div>
          <label>対象日付（任意）</label>
          <input id="date" type="date" />
        </div>
      </div>

      <div class="grid grid2">
        <div>
          <label>対象月（YYYY-MM）</label>
          <input id="month" type="month" />
        </div>
        <div>
          <label>管理者パスワード <span class="req">*</span></label>
          <input id="adminPw" type="password" placeholder="管理者パスワード" />
        </div>
      </div>

      <div class="btnrow">
        <button class="btn dark" id="btnDailyPdf" type="button">日報PDFを作成/表示</button>
        <button class="btn dark" id="btnMonthlyPdf" type="button">月報PDFを作成/表示</button>
      </div>
      <div class="btnrow">
        <button class="btn dark" id="btnMonthlyCsv" type="button">月報CSVを作成/表示</button>
        <button class="btn gray" id="btnOpenSheet" type="button">スプレッドシートを開く</button>
      </div>

      <p class="hint">※出力はGAS側でDriveへ生成し、そのリンクへリダイレクトします（CORSで落ちない）。</p>

      <div class="toast" id="toast"></div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script src="./common.js"></script>
  <script>
    (function(){
      guardAdmin();

      const toast = document.getElementById('toast');
      document.getElementById('loginState').textContent = 'ログイン中：' + (sessionStorage.getItem('ofa_role')||'');

      function adminCheck(){
        const pw = (document.getElementById('adminPw').value||'').trim();
        if(pw !== OFA_ADMIN_PASSWORD){
          showToast(toast, '管理者パスワードが違います');
          return false;
        }
        return true;
      }

      function mustName(){
        const n = (document.getElementById('name').value||'').trim();
        if(!n){ showToast(toast,'対象氏名を入力してください'); return false; }
        return true;
      }

      document.getElementById('btnDailyPdf').addEventListener('click', ()=>{
        if(!adminCheck() || !mustName()) return;
        const name = encodeURIComponent(document.getElementById('name').value.trim());
        const date = encodeURIComponent(document.getElementById('date').value || '');
        const url = `${GAS_WEBAPP_URL}?action=dailyPdf&name=${name}&date=${date}&adminPw=${encodeURIComponent(document.getElementById('adminPw').value.trim())}`;
        window.open(url, '_blank', 'noopener');
      });

      document.getElementById('btnMonthlyPdf').addEventListener('click', ()=>{
        if(!adminCheck() || !mustName()) return;
        const name = encodeURIComponent(document.getElementById('name').value.trim());
        const month = encodeURIComponent(document.getElementById('month').value || '');
        if(!month){ showToast(toast,'対象月（YYYY-MM）を選択してください'); return; }
        const url = `${GAS_WEBAPP_URL}?action=monthlyPdf&name=${name}&month=${month}&adminPw=${encodeURIComponent(document.getElementById('adminPw').value.trim())}`;
        window.open(url, '_blank', 'noopener');
      });

      document.getElementById('btnMonthlyCsv').addEventListener('click', ()=>{
        if(!adminCheck() || !mustName()) return;
        const name = encodeURIComponent(document.getElementById('name').value.trim());
        const month = encodeURIComponent(document.getElementById('month').value || '');
        if(!month){ showToast(toast,'対象月（YYYY-MM）を選択してください'); return; }
        const url = `${GAS_WEBAPP_URL}?action=monthlyCsv&name=${name}&month=${month}&adminPw=${encodeURIComponent(document.getElementById('adminPw').value.trim())}`;
        window.open(url, '_blank', 'noopener');
      });

      document.getElementById('btnOpenSheet').addEventListener('click', ()=>{
        window.open(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit`, '_blank', 'noopener');
      });
    })();
  </script>
</body>
</html>
