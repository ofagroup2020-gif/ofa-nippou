// admin/js/admin.js
// Admin page logic (local admin pass + period search)

(function(){
  "use strict";
  const $ = (id)=> document.getElementById(id);

  const PASS_KEY = "ofa_admin_pass";
  const LOGIN_KEY = "ofa_admin_logged_in";

  const state = { loggedIn:false, results:{tenko:[],daily:[],filters:null} };

  function normPhone(p){ return window.OFADB.normalizePhone(p); }

  function toast(msg){ alert(msg); }

  function ensureDefaultPass(){
    const cur = localStorage.getItem(PASS_KEY);
    if(!cur){
      // 初期パス（現場で必ず変更推奨）
      localStorage.setItem(PASS_KEY, "OFA-ADMIN");
    }
  }

  function setAdminState(){
    $("adminState").textContent = state.loggedIn ? "ログイン中" : "未ログイン";
    $("adminPanel").style.display = state.loggedIn ? "" : "none";
  }

  function login(){
    ensureDefaultPass();
    const pass = $("a_pass").value;
    const real = localStorage.getItem(PASS_KEY);
    if(pass && pass === real){
      state.loggedIn = true;
      localStorage.setItem(LOGIN_KEY, "1");
      setAdminState();
      toast("ログインしました");
    }else{
      toast("パスが違います");
    }
  }

  function changePass(){
    ensureDefaultPass();
    const cur = localStorage.getItem(PASS_KEY);
    const p1 = prompt("現在の管理者パスを入力してください");
    if(p1 !== cur){ toast("現在パスが違います"); return; }
    const p2 = prompt("新しい管理者パス（8文字以上推奨）");
    if(!p2 || p2.length < 4){ toast("短すぎます"); return; }
    localStorage.setItem(PASS_KEY, p2);
    toast("管理者パスを変更しました");
  }

  function inRange(d, start, end){
    return d && d >= start && d <= end;
  }

  function matchLike(text, key){
    if(!key) return true;
    return String(text||"").includes(key);
  }

  async function search(){
    if(!state.loggedIn){ toast("先にログインしてください"); return; }

    const start = $("q_start").value;
    const end   = $("q_end").value;
    if(!start || !end){ toast("期間（開始/終了）は必須です"); return; }

    const baseKey  = $("q_base").value.trim();
    const nameKey  = $("q_name").value.trim();
    const phoneKey = normPhone($("q_phone").value);

    // ルール：氏名 or 電話 どちらかが入っていればOK（片方で可）
    if(!nameKey && !phoneKey){
      toast("氏名 or 電話 のどちらかを入力してください（片方でOK）");
      return;
    }

    const tenko = await window.OFADB.getAll(window.OFADB.STORES.tenko);
    const daily = await window.OFADB.getAll(window.OFADB.STORES.daily);

    const tenkoHit = tenko.filter(t=>{
      const d = (t.at||"").slice(0,10);
      if(!inRange(d, start, end)) return false;
      if(baseKey && !matchLike(t.base, baseKey)) return false;

      const okName = nameKey && matchLike(t.name, nameKey);
      const okPhone= phoneKey && matchLike(t.phoneN || normPhone(t.phone), phoneKey);
      return okName || okPhone;
    });

    const dailyHit = daily.filter(r=>{
      const d = (r.date||"").slice(0,10);
      if(!inRange(d, start, end)) return false;
      if(baseKey && !matchLike(r.base, baseKey)) return false;

      const okName = nameKey && matchLike(r.name, nameKey);
      const okPhone= phoneKey && matchLike(r.phoneN || normPhone(r.phone), phoneKey);
      return okName || okPhone;
    });

    state.results = {
      tenko: tenkoHit,
      daily: dailyHit,
      filters: { start, end, base: baseKey, name: nameKey, phone: $("q_phone").value.trim() }
    };

    renderResults();
  }

  function renderResults(){
    const {tenko,daily,filters} = state.results;
    const box = $("resultBox");
    box.innerHTML = "";

    const sumSales  = daily.reduce((a,r)=> a + (Number(r.salesTotal)||0), 0);
    const sumProfit = daily.reduce((a,r)=> a + (Number(r.profit)||0), 0);
    const sumKm     = daily.reduce((a,r)=> a + (Number(r.km)||0), 0);

    $("resultSummary").textContent =
      `期間 ${filters.start}〜${filters.end} / 点呼 ${tenko.length}件 / 日報 ${daily.length}件 / 売上 ${sumSales} / 利益 ${sumProfit} / 走行 ${sumKm}km`;

    // group daily by driver (phoneN if available else name)
    const map = new Map();
    for(const r of daily){
      const key = (r.phoneN || normPhone(r.phone) || r.name || "unknown");
      if(!map.has(key)) map.set(key, {name:r.name, base:r.base, phone:r.phone, daily:[], tenko:[]});
      map.get(key).daily.push(r);
    }
    for(const t of tenko){
      const key = (t.phoneN || normPhone(t.phone) || t.name || "unknown");
      if(!map.has(key)) map.set(key, {name:t.name, base:t.base, phone:t.phone, daily:[], tenko:[]});
      map.get(key).tenko.push(t);
    }

    const list = Array.from(map.values()).sort((a,b)=> (a.base||"").localeCompare(b.base||""));
    if(!list.length){
      box.innerHTML = `<div class="note">該当なし</div>`;
      return;
    }

    for(const g of list){
      const sales  = g.daily.reduce((a,r)=> a + (Number(r.salesTotal)||0), 0);
      const profit = g.daily.reduce((a,r)=> a + (Number(r.profit)||0), 0);
      const km     = g.daily.reduce((a,r)=> a + (Number(r.km)||0), 0);

      const el = document.createElement("div");
      el.className = "monthRow";
      el.innerHTML = `
        <div class="top">
          <div style="font-weight:900">${g.name || "不明"} / ${g.base || "-"}</div>
          <div class="meta">${g.phone || ""}</div>
        </div>
        <div class="kpi">
          <span>点呼：${g.tenko.length}</span>
          <span>日報：${g.daily.length}</span>
          <span>売上：${sales}</span>
          <span>利益：${profit}</span>
          <span>走行：${km}km</span>
        </div>
      `;
      box.appendChild(el);
    }
  }

  async function exportCsv(){
    if(!state.results.filters){ toast("先に検索してください"); return; }
    const start = state.results.filters.start.replaceAll("-","");
    const end   = state.results.filters.end.replaceAll("-","");
    await window.OFACSV.exportSearchCsv({
      tenko: state.results.tenko,
      daily: state.results.daily,
      title: `OFA_search_${start}_${end}`
    });
  }

  async function monthlyPdf(){
    if(!state.results.filters){ toast("先に検索してください"); return; }
    await window.createMonthlyPdf({
      tenko: state.results.tenko,
      daily: state.results.daily,
      filters: state.results.filters,
      title: "OFA_月報_管理者"
    });
  }

  function init(){
    ensureDefaultPass();
    state.loggedIn = localStorage.getItem(LOGIN_KEY) === "1";
    setAdminState();

    // default dates: this month
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    const end = new Date(now.getFullYear(), now.getMonth()+1, 0);
    const f = (d)=> `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    $("q_start").value = f(start);
    $("q_end").value = f(end);

    $("btnAdminLogin").addEventListener("click", login);
    $("btnChangePass").addEventListener("click", changePass);
    $("btnSearch").addEventListener("click", search);
    $("btnCsv").addEventListener("click", exportCsv);
    $("btnMonthlyPdf").addEventListener("click", monthlyPdf);
  }

  window.addEventListener("DOMContentLoaded", init);
})();
