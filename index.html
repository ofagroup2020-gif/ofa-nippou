<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>OFA æ—¥å ±ï¼†æœˆæ¬¡å®Ÿç¸¾ãƒ„ãƒ¼ãƒ«ï¼ˆOFAãƒ‡ã‚¶ã‚¤ãƒ³ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #111;
      color: #222;
      font-size: 16px; /* ãƒ™ãƒ¼ã‚¹æ–‡å­—å¤§ãã‚ */
    }
    header {
      background: linear-gradient(135deg, #000000, #222222);
      color: #ffd700;
      padding: 14px 18px;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header span.logo {
      background: #ffd700;
      color: #000;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      margin-right: 8px;
    }
    .container {
      max-width: 1024px;
      margin: 0 auto;
      padding: 14px 10px 28px;
    }

    /* ã‚«ãƒ¼ãƒ‰é¢¨ */
    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,.18);
      border: 1px solid #f0f0f0;
    }

    .tabs {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      gap: 6px;
      margin-bottom: 10px;
    }
    .tab-btn {
      flex: 1;
      min-width: 110px;
      padding: 10px 8px;
      font-size: 14px;
      border: none;
      border-radius: 999px;
      background: #333;
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }
    .tab-btn.active {
      background: #ffd700;
      color: #000;
      font-weight: 700;
      box-shadow: 0 3px 8px rgba(0,0,0,.3);
    }

    .panel { display: none; }
    .panel.active { display: block; }

    h2 {
      font-size: 16px;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    h2 .emoji {
      font-size: 18px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 16px;
      margin-bottom: 10px;
    }
    .field {
      min-width: 140px;
      flex: 1;
    }
    label {
      font-size: 12px;
      display: block;
      margin-bottom: 4px;
      color: #555;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="month"],
    select {
      width: 100%;
      padding: 8px 10px;
      font-size: 15px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fafafa;
    }
    input[type="number"] { text-align: right; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-bottom: 8px;
    }
    th, td {
      border: 1px solid #eee;
      padding: 6px 4px;
      text-align: right;
    }
    th:first-child, td:first-child { text-align: left; }
    th {
      background: #fff8cf;
      font-weight: 600;
    }
    tr:nth-child(even) td {
      background: #fdfdfd;
    }
    tfoot td {
      font-weight: bold;
      background: #ffe680;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      padding: 8px 10px;
      font-size: 14px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fafafa;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0 4px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn-main {
      background: #ffd700;
      color: #000;
      font-weight: 700;
      box-shadow: 0 3px 6px rgba(0,0,0,.3);
    }
    .btn-sub {
      background: #f2f2f2;
      color: #222;
    }
    .btn-danger {
      background: #ff4d4f;
      color: #fff;
    }

    .note {
      font-size: 11px;
      color: #777;
      margin-top: 4px;
    }
    .badge {
      display: inline-block;
      background: #000;
      color: #ffd700;
      padding: 2px 6px;
      font-size: 10px;
      border-radius: 6px;
      margin-left: 4px;
    }
    .sum-box {
      font-size: 15px;
      margin-top: 6px;
      font-weight: 600;
    }
    .sum-box span {
      font-size: 18px;
      color: #e53935;
    }

    .pill-tag {
      display: inline-block;
      background: #000;
      color: #ffd700;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      margin-right: 4px;
    }

    @media (max-width:600px) {
      header {
        font-size: 16px;
        padding: 10px 12px;
      }
      .container {
        padding: 10px 8px 22px;
      }
      table {
        font-size: 12px;
      }
      .tab-btn {
        font-size: 13px;
        padding: 8px 6px;
      }
    }
  </style>
</head>
<body>
<header>
  <div>
    <span class="logo">OFA</span>
    OFA æ—¥å ± &amp; æœˆæ¬¡å®Ÿç¸¾ãƒ„ãƒ¼ãƒ«
  </div>
</header>

<div class="container">

  <div class="tabs card" style="margin-bottom:12px;">
    <button class="tab-btn active" data-target="tab-daily">ğŸ“… æ—¥å ±å…¥åŠ›</button>
    <button class="tab-btn" data-target="tab-unit">ğŸ’° å˜ä¾¡è¨­å®š</button>
    <button class="tab-btn" data-target="tab-monthly">ğŸ“Š æœˆæ¬¡å®Ÿç¸¾</button>
    <button class="tab-btn" data-target="tab-data">ğŸ—„ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
  </div>

  <!-- æ—¥å ±å…¥åŠ› -->
  <div id="tab-daily" class="panel active">
    <div class="card">
      <h2><span class="emoji">ğŸ“…</span>æ—¥å ±å…¥åŠ› <span class="badge">å˜ä¾¡ã¯ã€Œå˜ä¾¡è¨­å®šã€ã‹ã‚‰è‡ªå‹•åæ˜ </span></h2>

      <div class="row">
        <div class="field">
          <label for="dDate">æ—¥ä»˜</label>
          <input type="date" id="dDate">
        </div>
        <div class="field">
          <label for="dName">æ°å</label>
          <input type="text" id="dName" placeholder="ä¾‹ï¼šç”°æ‘ ç´³åŠ©">
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="dArea">ã‚¨ãƒªã‚¢</label>
          <input type="text" id="dArea" placeholder="ä¾‹ï¼šé¹¿å…å³¶å¸‚ä¼Šæ•·">
        </div>
        <div class="field">
          <label for="dClient">å–å¼•å…ˆ</label>
          <select id="dClient">
            <option value="">--é¸æŠã—ã¦ãã ã•ã„--</option>
            <option>ãƒ¤ãƒãƒˆé‹è¼¸</option>
            <option>ä½å·æ€¥ä¾¿</option>
            <option>æ—¥æœ¬éƒµä¾¿</option>
            <option>è¥¿æ¿ƒé‹è¼¸</option>
            <option>ç¦å±±é€šé‹</option>
            <option>Amazonï¼ˆSBSï¼‰</option>
            <option>Amazonï¼ˆä¸¸å’Œï¼‰</option>
            <option>Amazonï¼ˆç¥‡åœ’ï¼‰</option>
            <option>ãã®ä»–</option>
          </select>
        </div>
      </div>

      <div class="btn-row" style="margin-top:2px;">
        <button class="btn-sub" id="btnLoadUnitsFromSetting">ã“ã®å–å¼•å…ˆã®å˜ä¾¡ã‚’èª­ã¿è¾¼ã‚€</button>
        <button class="btn-sub" id="btnToday">ä»Šæ—¥ã®æ—¥ä»˜ã«ã™ã‚‹</button>
      </div>

      <h3 style="font-size:14px;margin:10px 0 6px;">
        è·ç‰©ç¨®åˆ¥ã”ã¨ã®å†…è¨³
        <span class="pill-tag">å®…é…</span>
        <span class="pill-tag">ãƒã‚¹</span>
        <span class="pill-tag">ãƒ¡ãƒ¼ãƒ«</span>
        <span class="pill-tag">ãƒãƒ£ãƒ¼ã‚¿ãƒ¼</span>
      </h3>

      <table>
        <thead>
          <tr>
            <th style="width:150px;">è·ç‰©ç¨®åˆ¥</th>
            <th style="width:90px;">å˜ä¾¡ï¼ˆå††ï¼‰</th>
            <th style="width:80px;">æ•°é‡</th>
            <th style="width:100px;">å°è¨ˆï¼ˆå††ï¼‰</th>
          </tr>
        </thead>
        <tbody>
          <tr data-key="ä¸€èˆ¬è·ç‰©ï¼ˆå®…é…ï¼‰">
            <td>ä¸€èˆ¬è·ç‰©ï¼ˆå®…é…ï¼‰</td>
            <td><input type="number" min="0" step="1" class="unit" data-key="ä¸€èˆ¬è·ç‰©ï¼ˆå®…é…ï¼‰"></td>
            <td><input type="number" min="0" step="1" class="qty" data-key="ä¸€èˆ¬è·ç‰©ï¼ˆå®…é…ï¼‰"></td>
            <td class="sub" data-key="ä¸€èˆ¬è·ç‰©ï¼ˆå®…é…ï¼‰">0</td>
          </tr>
          <tr data-key="ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°">
            <td>ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°</td>
            <td><input type="number" min="0" step="1" class="unit" data-key="ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°"></td>
            <td><input type="number" min="0" step="1" class="qty" data-key="ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°"></td>
            <td class="sub" data-key="ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°">0</td>
          </tr>
          <tr data-key="ãƒ¡ãƒ¼ãƒ«">
            <td>ãƒ¡ãƒ¼ãƒ«</td>
            <td><input type="number" min="0" step="1" class="unit" data-key="ãƒ¡ãƒ¼ãƒ«"></td>
            <td><input type="number" min="0" step="1" class="qty" data-key="ãƒ¡ãƒ¼ãƒ«"></td>
            <td class="sub" data-key="ãƒ¡ãƒ¼ãƒ«">0</td>
          </tr>
          <tr data-key="ä¸€èˆ¬é›†è·">
            <td>ä¸€èˆ¬é›†è·</td>
            <td><input type="number" min="0" step="1" class="unit" data-key="ä¸€èˆ¬é›†è·"></td>
            <td><input type="number" min="0" step="1" class="qty" data-key="ä¸€èˆ¬é›†è·"></td>
            <td class="sub" data-key="ä¸€èˆ¬é›†è·">0</td>
          </tr>
          <tr data-key="ä»£å¼•ã">
            <td>ä»£å¼•ã</td>
            <td><input type="number" min="0" step="1" class="unit" data-key="ä»£å¼•ã"></td>
            <td><input type="number" min="0" step="1" class="qty" data-key="ä»£å¼•ã"></td>
            <td class="sub" data-key="ä»£å¼•ã">0</td>
          </tr>
          <tr data-key="ãƒãƒ£ãƒ¼ã‚¿ãƒ¼ä¾¿">
            <td>ãƒãƒ£ãƒ¼ã‚¿ãƒ¼ä¾¿</td>
            <td><input type="number" min="0" step="1" class="unit" data-key="ãƒãƒ£ãƒ¼ã‚¿ãƒ¼ä¾¿"></td>
            <td><input type="number" min="0" step="1" class="qty" data-key="ãƒãƒ£ãƒ¼ã‚¿ãƒ¼ä¾¿" placeholder="ä¾‹ï¼š1"></td>
            <td class="sub" data-key="ãƒãƒ£ãƒ¼ã‚¿ãƒ¼ä¾¿">0</td>
          </tr>
          <tr data-key="ã‚¹ãƒãƒƒãƒˆä¾¿">
            <td>ã‚¹ãƒãƒƒãƒˆä¾¿</td>
            <td><input type="number" min="0" step="1" class="unit" data-key="ã‚¹ãƒãƒƒãƒˆä¾¿"></td>
            <td><input type="number" min="0" step="1" class="qty" data-key="ã‚¹ãƒãƒƒãƒˆä¾¿"></td>
            <td class="sub" data-key="ã‚¹ãƒãƒƒãƒˆä¾¿">0</td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td>åˆè¨ˆ</td>
            <td id="sum-unit" style="text-align:right;">-</td>
            <td id="sum-qty" style="text-align:right;">0</td>
            <td id="sum-amount" style="text-align:right;">0</td>
          </tr>
        </tfoot>
      </table>

      <div class="sum-box">ã“ã®æ—¥ã®å£²ä¸Šåˆè¨ˆï¼š<span id="dDayTotalBig">0</span> å††</div>

      <div style="margin-top:10px;">
        <label for="dMemo">ãƒ¡ãƒ¢ï¼ˆã‚¯ãƒ¬ãƒ¼ãƒ ãƒ»é…å»¶ãƒ»äº‹æ•…ãƒ»å‚™è€ƒãªã©ï¼‰</label>
        <textarea id="dMemo" placeholder="ä¾‹ï¼‰â—‹â—‹æ§˜ å†é…é”ã€Ã—Ã—ç•ªåœ°ãƒãƒ£ãƒ¼ã‚¿ãƒ¼ãªã©"></textarea>
      </div>

      <div class="btn-row">
        <button class="btn-main" id="btnSave">ã“ã®æ—¥ã‚’ä¿å­˜ / ä¸Šæ›¸ã</button>
        <button class="btn-sub" id="btnLoad">ã“ã®æ—¥ã‚’èª­ã¿è¾¼ã¿</button>
        <button class="btn-danger" id="btnClearDay">ã“ã®æ—¥ã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
      </div>
      <div class="note">
        ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ï¼ˆLocalStorageï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ç«¯æœ«ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å¤‰ãˆã‚‹ã¨å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚
      </div>
    </div>
  </div>

  <!-- å˜ä¾¡è¨­å®š -->
  <div id="tab-unit" class="panel">
    <div class="card">
      <h2><span class="emoji">ğŸ’°</span>å˜ä¾¡è¨­å®š <span class="badge">å–å¼•å…ˆ Ã— è·ç‰©ç¨®åˆ¥ã”ã¨ã«ç™»éŒ²</span></h2>
      <div class="row">
        <div class="field">
          <label for="uClient">å–å¼•å…ˆ</label>
          <select id="uClient">
            <option value="">--é¸æŠã—ã¦ãã ã•ã„--</option>
            <option>ãƒ¤ãƒãƒˆé‹è¼¸</option>
            <option>ä½å·æ€¥ä¾¿</option>
            <option>æ—¥æœ¬éƒµä¾¿</option>
            <option>è¥¿æ¿ƒé‹è¼¸</option>
            <option>ç¦å±±é€šé‹</option>
            <option>Amazonï¼ˆSBSï¼‰</option>
            <option>Amazonï¼ˆä¸¸å’Œï¼‰</option>
            <option>Amazonï¼ˆç¥‡åœ’ï¼‰</option>
            <option>ãã®ä»–</option>
          </select>
        </div>
        <div class="field" style="align-self:flex-end;flex:0 0 auto;">
          <div class="btn-row">
            <button class="btn-sub" id="btnUnitLoad">èª­ã¿è¾¼ã¿</button>
            <button class="btn-main" id="btnUnitSave">ä¿å­˜</button>
          </div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:160px;">è·ç‰©ç¨®åˆ¥</th>
            <th style="width:110px;">å˜ä¾¡ï¼ˆå††ï¼‰</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>ä¸€èˆ¬è·ç‰©ï¼ˆå®…é…ï¼‰</td>
            <td><input type="number" min="0" step="1" class="u-unit" data-key="ä¸€èˆ¬è·ç‰©ï¼ˆå®…é…ï¼‰" placeholder="ä¾‹ï¼š165"></td>
          </tr>
          <tr>
            <td>ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°</td>
            <td><input type="number" min="0" step="1" class="u-unit" data-key="ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°" placeholder="ä¾‹ï¼š64"></td>
          </tr>
          <tr>
            <td>ãƒ¡ãƒ¼ãƒ«</td>
            <td><input type="number" min="0" step="1" class="u-unit" data-key="ãƒ¡ãƒ¼ãƒ«"></td>
          </tr>
          <tr>
            <td>ä¸€èˆ¬é›†è·</td>
            <td><input type="number" min="0" step="1" class="u-unit" data-key="ä¸€èˆ¬é›†è·"></td>
          </tr>
          <tr>
            <td>ä»£å¼•ã</td>
            <td><input type="number" min="0" step="1" class="u-unit" data-key="ä»£å¼•ã" placeholder="ä¾‹ï¼š190"></td>
          </tr>
          <tr>
            <td>ãƒãƒ£ãƒ¼ã‚¿ãƒ¼ä¾¿</td>
            <td><input type="number" min="0" step="1" class="u-unit" data-key="ãƒãƒ£ãƒ¼ã‚¿ãƒ¼ä¾¿" placeholder="æ—¥é¡"></td>
          </tr>
          <tr>
            <td>ã‚¹ãƒãƒƒãƒˆä¾¿</td>
            <td><input type="number" min="0" step="1" class="u-unit" data-key="ã‚¹ãƒãƒƒãƒˆä¾¿"></td>
          </tr>
        </tbody>
      </table>
      <div class="note">
        ä¾‹ï¼‰ãƒ¤ãƒãƒˆé‹è¼¸ï¼šå®…é…165å††ï¼ä»£å¼•ã190å††ï¼ãƒã‚¹64å†† ãªã©ã‚’ç™»éŒ²ã—ã¦ãŠãã¨ã€<br>
        æ—¥å ±å…¥åŠ›ã§ã€Œã“ã®å–å¼•å…ˆã®å˜ä¾¡ã‚’èª­ã¿è¾¼ã‚€ã€ãƒœã‚¿ãƒ³ã§è‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ã€‚
      </div>
    </div>
  </div>

  <!-- æœˆæ¬¡å®Ÿç¸¾ -->
  <div id="tab-monthly" class="panel">
    <div class="card">
      <h2><span class="emoji">ğŸ“Š</span>æœˆæ¬¡å®Ÿç¸¾</h2>
      <div class="row">
        <div class="field">
          <label for="mMonth">è¡¨ç¤ºæœˆ</label>
          <input type="month" id="mMonth">
        </div>
        <div class="field" style="align-self:flex-end;flex:0 0 auto;">
          <div class="btn-row">
            <button class="btn-main" id="btnShowMonth">ã“ã®æœˆã®å®Ÿç¸¾ã‚’è¡¨ç¤º</button>
            <button class="btn-sub" id="btnExportCsv">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
          </div>
        </div>
      </div>
      <div id="monthlyResult" style="margin-top:8px;"></div>
      <div class="note">
        æ—¥åˆ¥ã«ã€Œå–å¼•å…ˆ Ã— è·ç‰©ç¨®åˆ¥ã€ã®æ•°é‡ã¨å£²ä¸Šã€æœˆåˆè¨ˆã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
      </div>
    </div>
  </div>

  <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
  <div id="tab-data" class="panel">
    <div class="card">
      <h2><span class="emoji">ğŸ—„</span>ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒï¼‰</h2>
      <p class="note">
        ä¿å­˜æ¸ˆã¿æ—¥å ±ãƒ‡ãƒ¼ã‚¿ï¼ˆLocalStorageï¼‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨å¾©å…ƒãŒã§ãã¾ã™ã€‚
      </p>
      <div class="btn-row">
        <button class="btn-sub" id="btnBackup">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆJSONè¡¨ç¤ºï¼‰</button>
        <button class="btn-sub" id="btnImport">JSONã‹ã‚‰å¾©å…ƒ</button>
        <button class="btn-danger" id="btnAllClear">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
      </div>
      <textarea id="dataArea" placeholder="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—JSONã®è¡¨ç¤ºãƒ»è²¼ã‚Šä»˜ã‘æ¬„"></textarea>
      <div class="note">
        JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒªãªã©ã«ä¿å­˜ã—ã¦ãŠãã¨ã€ç«¯æœ«å¤‰æ›´æ™‚ãªã©ã«è²¼ã‚Šä»˜ã‘ã¦å¾©å…ƒã§ãã¾ã™ã€‚
      </div>
    </div>
  </div>

</div>

<script>
  const STORAGE_KEY = "ofa_nippou_client_item_v2";
  const UNIT_KEY = "ofa_unit_settings_client_item_v1";
  const itemKeys = ["ä¸€èˆ¬è·ç‰©ï¼ˆå®…é…ï¼‰","ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°","ãƒ¡ãƒ¼ãƒ«","ä¸€èˆ¬é›†è·","ä»£å¼•ã","ãƒãƒ£ãƒ¼ã‚¿ãƒ¼ä¾¿","ã‚¹ãƒãƒƒãƒˆä¾¿"];

  function formatNumber(n) { return n.toLocaleString("ja-JP"); }
  function loadAllRecords() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return {};
      return JSON.parse(raw);
    } catch (e) { console.error(e); return {}; }
  }
  function saveAllRecords(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }
  function loadUnitSettings() {
    try {
      const raw = localStorage.getItem(UNIT_KEY);
      if (!raw) return {};
      return JSON.parse(raw);
    } catch (e) { console.error(e); return {}; }
  }
  function saveUnitSettings(settings) {
    localStorage.setItem(UNIT_KEY, JSON.stringify(settings));
  }
  function ymdFromDateStr(str) {
    if (!str) return null;
    const [y,m,d] = str.split("-").map(s => parseInt(s,10));
    if (!y || !m || !d) return null;
    return {y,m,d};
  }
  function getYoubi(str) {
    const info = ymdFromDateStr(str);
    if (!info) return "";
    const dt = new Date(info.y, info.m-1, info.d);
    const arr = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
    return arr[dt.getDay()];
  }

  // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.target).classList.add("active");
    });
  });

  // æ—¥å ±è¨ˆç®—
  function recalcDaily() {
    let sumQty = 0;
    let sumAmount = 0;
    itemKeys.forEach(key => {
      const unitEl = document.querySelector('.unit[data-key="'+key+'"]');
      const qtyEl = document.querySelector('.qty[data-key="'+key+'"]');
      const subEl = document.querySelector('.sub[data-key="'+key+'"]');
      const unit = parseFloat(unitEl.value) || 0;
      const qty = parseFloat(qtyEl.value) || 0;
      const sub = unit * qty;
      subEl.textContent = formatNumber(sub);
      sumQty += qty;
      sumAmount += sub;
    });
    document.getElementById("sum-qty").textContent = formatNumber(sumQty);
    document.getElementById("sum-amount").textContent = formatNumber(sumAmount);
    document.getElementById("sum-unit").textContent = "-";
    document.getElementById("dDayTotalBig").textContent = formatNumber(sumAmount);
  }

  document.addEventListener("input", function(e) {
    if (e.target.classList.contains("unit") || e.target.classList.contains("qty")) {
      recalcDaily();
    }
  });

  // ä»Šæ—¥ãƒœã‚¿ãƒ³
  document.getElementById("btnToday").addEventListener("click", () => {
    const today = new Date();
    const y = today.getFullYear();
    const m = String(today.getMonth()+1).padStart(2,"0");
    const d = String(today.getDate()).padStart(2,"0");
    document.getElementById("dDate").value = `${y}-${m}-${d}`;
  });

  // æ—¥å ±ä¿å­˜
  document.getElementById("btnSave").addEventListener("click", () => {
    const date = document.getElementById("dDate").value;
    if (!date) { alert("æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
    const records = loadAllRecords();
    const item = {};
    itemKeys.forEach(key => {
      const unit = parseFloat(document.querySelector('.unit[data-key="'+key+'"]').value) || 0;
      const qty  = parseFloat(document.querySelector('.qty[data-key="'+key+'"]').value) || 0;
      item[key] = { unit, qty };
    });
    const memo = document.getElementById("dMemo").value || "";
    const area = document.getElementById("dArea").value || "";
    const name = document.getElementById("dName").value || "";
    const client = document.getElementById("dClient").value || "";

    let dayTotal = 0;
    let totalQty = 0;
    itemKeys.forEach(k => {
      const u = item[k].unit || 0;
      const q = item[k].qty || 0;
      dayTotal += u*q;
      totalQty += q;
    });

    records[date] = { date, area, name, client, item, memo, totals: { totalQty, dayTotal } };
    saveAllRecords(records);
    recalcDaily();
    alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆ" + date + "ï¼‰ã€‚");
  });

  // æ—¥å ±èª­ã¿è¾¼ã¿
  document.getElementById("btnLoad").addEventListener("click", () => {
    const date = document.getElementById("dDate").value;
    if (!date) { alert("æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
    const records = loadAllRecords();
    if (!records[date]) { alert("ã“ã®æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
    const r = records[date];
    document.getElementById("dArea").value = r.area || "";
    document.getElementById("dName").value = r.name || "";
    document.getElementById("dClient").value = r.client || "";
    itemKeys.forEach(key => {
      const obj = (r.item && r.item[key]) ? r.item[key] : {unit:"",qty:""};
      document.querySelector('.unit[data-key="'+key+'"]').value = (obj.unit ?? "");
      document.querySelector('.qty[data-key="'+key+'"]').value = (obj.qty ?? "");
    });
    document.getElementById("dMemo").value = r.memo || "";
    recalcDaily();
    alert("èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ" + date + "ï¼‰ã€‚");
  });

  // æ—¥å ±å‰Šé™¤
  document.getElementById("btnClearDay").addEventListener("click", () => {
    const date = document.getElementById("dDate").value;
    if (!date) { alert("æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
    const records = loadAllRecords();
    if (!records[date]) { alert("ã“ã®æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
    if (!confirm(date + " ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    delete records[date];
    saveAllRecords(records);
    alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
  });

  // å˜ä¾¡è¨­å®š èª­ã¿è¾¼ã¿
  document.getElementById("btnUnitLoad").addEventListener("click", () => {
    const client = document.getElementById("uClient").value;
    if (!client) { alert("å–å¼•å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
    const settings = loadUnitSettings();
    const unitSet = settings[client] || {};
    document.querySelectorAll(".u-unit").forEach(input => {
      const key = input.dataset.key;
      input.value = unitSet[key] != null ? unitSet[key] : "";
    });
    alert("å˜ä¾¡è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
  });

  // å˜ä¾¡è¨­å®š ä¿å­˜
  document.getElementById("btnUnitSave").addEventListener("click", () => {
    const client = document.getElementById("uClient").value;
    if (!client) { alert("å–å¼•å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
    const settings = loadUnitSettings();
    const unitSet = {};
    document.querySelectorAll(".u-unit").forEach(input => {
      const key = input.dataset.key;
      const v = parseFloat(input.value);
      if (!isNaN(v)) unitSet[key] = v;
    });
    settings[client] = unitSet;
    saveUnitSettings(settings);
    alert("å˜ä¾¡ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆ" + client + "ï¼‰ã€‚");
  });

  // æ—¥å ±å´ã§å˜ä¾¡èª­è¾¼
  document.getElementById("btnLoadUnitsFromSetting").addEventListener("click", () => {
    const client = document.getElementById("dClient").value;
    if (!client) { alert("å–å¼•å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
    const settings = loadUnitSettings();
    const unitSet = settings[client];
    if (!unitSet) { alert("ã“ã®å–å¼•å…ˆã®å˜ä¾¡è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚å˜ä¾¡è¨­å®šã‚¿ãƒ–ã§ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚"); return; }
    itemKeys.forEach(key => {
      const unitEl = document.querySelector('.unit[data-key="'+key+'"]');
      if (unitEl) unitEl.value = unitSet[key] != null ? unitSet[key] : "";
    });
    recalcDaily();
    alert("å˜ä¾¡ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ" + client + "ï¼‰ã€‚");
  });

  // æœˆæ¬¡å®Ÿç¸¾ãƒ†ãƒ¼ãƒ–ãƒ«
  function buildMonthlyTable(monthStr) {
    const container = document.getElementById("monthlyResult");
    container.innerHTML = "";
    if (!monthStr) {
      container.textContent = "è¡¨ç¤ºæœˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
      return;
    }
    const [y,m] = monthStr.split("-").map(s => parseInt(s,10));
    if (!y || !m) {
      container.textContent = "è¡¨ç¤ºæœˆã‚’æ­£ã—ãé¸æŠã—ã¦ãã ã•ã„ã€‚";
      return;
    }
    const records = loadAllRecords();
    const rows = Object.values(records)
      .filter(r => {
        const info = ymdFromDateStr(r.date);
        return info && info.y === y && info.m === m;
      })
      .sort((a,b) => a.date.localeCompare(b.date));
    if (rows.length === 0) {
      container.textContent = "ã“ã®æœˆã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
      return;
    }

    const total = { dayTotal: 0 };
    const qtyByKey = {};
    itemKeys.forEach(k => qtyByKey[k] = 0);

    let html = '<table><thead><tr>' +
      '<th>æ—¥</th><th>æ›œ</th><th>å–å¼•å…ˆ</th>';
    itemKeys.forEach(k => {
      html += '<th>'+k+' æ•°é‡</th>';
    });
    html += '<th>æ—¥åˆè¨ˆï¼ˆå††ï¼‰</th></tr></thead><tbody>';

    rows.forEach(r => {
      const info = ymdFromDateStr(r.date);
      const d = info.d;
      const youbi = getYoubi(r.date);
      const item = r.item || {};
      let dayAmount = 0;
      html += '<tr>';
      html += '<td style="text-align:left;">'+d+'</td>';
      html += '<td>'+youbi+'</td>';
      html += '<td style="text-align:left;">'+(r.client || '')+'</td>';
      itemKeys.forEach(k => {
        const u = (item[k] && item[k].unit) ? item[k].unit : 0;
        const q = (item[k] && item[k].qty) ? item[k].qty : 0;
        const sub = u*q;
        html += '<td>'+formatNumber(q)+'</td>';
        dayAmount += sub;
        qtyByKey[k] += q;
      });
      total.dayTotal += dayAmount;
      html += '<td>'+formatNumber(dayAmount)+'</td>';
      html += '</tr>';
    });

    html += '</tbody><tfoot><tr>';
    html += '<td colspan="3" style="text-align:left;">åˆè¨ˆ</td>';
    itemKeys.forEach(k => {
      html += '<td>'+formatNumber(qtyByKey[k])+'</td>';
    });
    html += '<td>'+formatNumber(total.dayTotal)+'</td>';
    html += '</tr></tfoot></table>';

    container.innerHTML = html;
  }

  document.getElementById("btnShowMonth").addEventListener("click", () => {
    const month = document.getElementById("mMonth").value;
    buildMonthlyTable(month);
  });

  // CSVå‡ºåŠ›
  document.getElementById("btnExportCsv").addEventListener("click", () => {
    const month = document.getElementById("mMonth").value;
    if (!month) { alert("è¡¨ç¤ºæœˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚"); return; }
    const [y,m] = month.split("-").map(s => parseInt(s,10));
    const records = loadAllRecords();
    const rows = Object.values(records)
      .filter(r => {
        const info = ymdFromDateStr(r.date);
        return info && info.y === y && info.m === m;
      })
      .sort((a,b) => a.date.localeCompare(b.date));
    if (rows.length === 0) {
      alert("ã“ã®æœˆã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }
    let csv = "æ—¥,æ›œæ—¥,å–å¼•å…ˆ," + itemKeys.map(k => k+'æ•°é‡').join(",") + ",æ—¥åˆè¨ˆ(å††)\n";
    rows.forEach(r => {
      const info = ymdFromDateStr(r.date);
      const d = info.d;
      const youbi = getYoubi(r.date);
      const item = r.item || {};
      const arr = [d, youbi, (r.client || "")];
      let dayAmount = 0;
      itemKeys.forEach(k => {
        const u = (item[k] && item[k].unit) ? item[k].unit : 0;
        const q = (item[k] && item[k].qty) ? item[k].qty : 0;
        const sub = u*q;
        arr.push(q);
        dayAmount += sub;
      });
      arr.push(dayAmount);
      csv += arr.join(",") + "\n";
    });
    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ofa_client_item_"+month.replace("-","")+".csv";
    a.click();
    URL.revokeObjectURL(url);
  });

  // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
  document.getElementById("btnBackup").addEventListener("click", () => {
    const records = loadAllRecords();
    document.getElementById("dataArea").value = JSON.stringify(records, null, 2);
    alert("ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’JSONã¨ã—ã¦è¡¨ç¤ºã—ã¾ã—ãŸã€‚ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
  });

  document.getElementById("btnImport").addEventListener("click", () => {
    const txt = document.getElementById("dataArea").value.trim();
    if (!txt) { alert("JSONã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚"); return; }
    try {
      const obj = JSON.parse(txt);
      if (!confirm("è²¼ã‚Šä»˜ã‘ãŸJSONã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      saveAllRecords(obj);
      alert("å¾©å…ƒã—ã¾ã—ãŸã€‚");
    } catch (e) {
      alert("JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
    }
  });

  document.getElementById("btnAllClear").addEventListener("click", () => {
    if (!confirm("å…¨ã¦ã®æ—¥å ±ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    localStorage.removeItem(STORAGE_KEY);
    alert("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
  });

  // åˆæœŸå‡¦ç†
  (function init() {
    const today = new Date();
    const y = today.getFullYear();
    const m = String(today.getMonth()+1).padStart(2,"0");
    const d = String(today.getDate()).padStart(2,"0");
    document.getElementById("dDate").value = `${y}-${m}-${d}`;
    document.getElementById("mMonth").value = `${y}-${m}`;
    recalcDaily();
  })();
</script>
</body>
</html>
