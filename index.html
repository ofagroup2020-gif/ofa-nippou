<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>OFA ç‚¹å‘¼ï¼ˆå‡ºç™º/å¸°ç€ï¼‰</title>
  <style>
    :root{
      --bg:#f4f7fb; --card:#fff; --text:#111827; --muted:#6b7280;
      --line:#e5e7eb; --primary:#1f6feb; --danger:#ef4444; --ok:#16a34a;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
      background:var(--bg); color:var(--text);
    }
    header{
      padding:18px 16px 10px;
    }
    .wrap{max-width:720px; margin:0 auto; padding:0 14px 30px;}
    .title{
      display:flex; align-items:center; gap:10px;
      font-weight:900; font-size:22px;
    }
    .sub{color:var(--muted); font-size:12px; margin-top:4px}
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      padding:14px; margin-top:12px;
      box-shadow:0 8px 20px rgba(0,0,0,.04);
    }
    label{display:block; font-weight:800; margin:12px 0 6px;}
    .hint{font-size:12px; color:var(--muted); margin-top:4px}
    input, select, textarea, button{
      width:100%; font-size:16px; padding:12px 12px;
      border-radius:12px; border:1px solid var(--line); background:#fff;
      outline:none;
    }
    textarea{min-height:96px; resize:vertical}
    input:focus, select:focus, textarea:focus{border-color:#9cc3ff; box-shadow:0 0 0 3px rgba(31,111,235,.15)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media(max-width:540px){.row{grid-template-columns:1fr}}
    .seg{
      display:flex; gap:8px; padding:8px; background:#eef2ff; border:1px solid #dbeafe;
      border-radius:14px;
    }
    .seg button{
      border:none; background:transparent; padding:12px; border-radius:12px;
      font-weight:900; color:#1e3a8a;
    }
    .seg button.active{background:var(--primary); color:#fff}
    .btn{
      margin-top:14px; background:var(--primary); color:#fff; border:none; font-weight:900;
      padding:14px; border-radius:14px;
    }
    .btn:disabled{opacity:.55}
    .msg{margin-top:10px; font-weight:800}
    .msg.ok{color:var(--ok)}
    .msg.ng{color:var(--danger)}
    .mini{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:8px}
    .link{
      font-size:12px; color:var(--muted); word-break:break-all; line-height:1.35;
      padding:10px; border-radius:12px; background:#f8fafc; border:1px dashed var(--line);
    }
    .hr{height:1px; background:var(--line); margin:14px 0}
    .badge{
      display:inline-flex; align-items:center; gap:6px; font-size:12px; font-weight:900;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#fff;
    }
    .req{color:var(--danger); font-weight:900; margin-left:6px}
  </style>
</head>
<body>
  <header class="wrap">
    <div class="title">ğŸšš OFA ç‚¹å‘¼ãƒ»ç‚¹æ¤œ</div>
    <div class="sub">å‡ºç™ºç‚¹å‘¼ / å¸°ç€ç‚¹å‘¼ã‚’åˆ†ã‘ã¦å…¥åŠ›ï¼ˆã‚¹ãƒãƒ›æœ€é©ï¼‰</div>
  </header>

  <main class="wrap">

    <div class="card">
      <div class="mini">
        <span class="badge" id="modeBadge">å‡ºç™ºç‚¹å‘¼ãƒ¢ãƒ¼ãƒ‰</span>
        <button id="btnPing" style="width:auto;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:900;">
          æ¥ç¶šãƒ†ã‚¹ãƒˆ
        </button>
      </div>
      <div class="link" id="gasUrlBox"></div>
      <div class="msg" id="pingMsg"></div>

      <div class="hr"></div>

      <div class="seg" role="tablist" aria-label="ç‚¹å‘¼ç¨®åˆ¥">
        <button type="button" id="tabStart" class="active">å‡ºç™ºç‚¹å‘¼</button>
        <button type="button" id="tabEnd">å¸°ç€ç‚¹å‘¼</button>
      </div>

      <label>æ°å<span class="req">*</span></label>
      <input id="driver" placeholder="ä¾‹ï¼šæ£®ä¸‹ æ´¸" autocomplete="name" />

      <label>è»Šä¸¡ç•ªå·<span class="req">*</span></label>
      <input id="vehicle" placeholder="ä¾‹ï¼šé¹¿å…å³¶480 ã‚ 12-34" />

      <div class="row">
        <div>
          <label>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯<span class="req">*</span></label>
          <select id="alcohol">
            <option value="å•é¡Œãªã—">å•é¡Œãªã—</option>
            <option value="åå¿œã‚ã‚Š">åå¿œã‚ã‚Š</option>
            <option value="æœªå®Ÿæ–½">æœªå®Ÿæ–½</option>
          </select>
        </div>
        <div>
          <label>ä½“èª¿<span class="req">*</span></label>
          <select id="condition">
            <option value="è‰¯å¥½">è‰¯å¥½</option>
            <option value="æ™®é€š">æ™®é€š</option>
            <option value="ä¸è‰¯">ä¸è‰¯</option>
          </select>
        </div>
      </div>

      <!-- å‡ºç™ºç‚¹å‘¼ãƒ–ãƒ­ãƒƒã‚¯ -->
      <section id="startBlock">
        <div class="row">
          <div>
            <label>ä½“æ¸©ï¼ˆä»»æ„ï¼‰</label>
            <input id="temp" inputmode="decimal" placeholder="ä¾‹ï¼š36.5" />
          </div>
          <div>
            <label>ç¡çœ æ™‚é–“ï¼ˆä»»æ„ï¼‰</label>
            <input id="sleepHours" inputmode="decimal" placeholder="ä¾‹ï¼š6.0" />
          </div>
        </div>

        <label>æ—¥å¸¸ç‚¹æ¤œï¼ˆç•°å¸¸æœ‰ç„¡ï¼‰<span class="req">*</span></label>
        <select id="inspectionResult">
          <option value="ç•°å¸¸ãªã—">ç•°å¸¸ãªã—</option>
          <option value="ç•°å¸¸ã‚ã‚Š">ç•°å¸¸ã‚ã‚Š</option>
        </select>

        <label>ç•°å¸¸å†…å®¹ï¼ˆç•°å¸¸ã‚ã‚Šã®å ´åˆï¼‰</label>
        <input id="inspectionAbnormalDetail" placeholder="ä¾‹ï¼šå·¦å‰è¼ª ç©ºæ°—åœ§ä½ä¸‹ / ãƒ–ãƒ¬ãƒ¼ã‚­é³´ã ãªã©" />

        <label>ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆå‡ºç™ºï¼‰</label>
        <input id="meterStart" inputmode="numeric" placeholder="ä¾‹ï¼š123456" />

        <label>ç‚¹æ¤œå†™çœŸï¼ˆãƒ¡ãƒ¼ã‚¿ãƒ¼/å¤–è¦³/è­¦å‘Šç¯ãªã©ï¼‰</label>
        <input id="inspectionPhoto" type="file" accept="image/*" />

        <label>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œçŸ¥å™¨å†™çœŸï¼ˆä»»æ„ï¼‰</label>
        <input id="startAlcoholPhoto" type="file" accept="image/*" />

        <div class="hint">â€»å†™çœŸã¯é€ä¿¡æ™‚ã«è‡ªå‹•ã§åœ§ç¸®ã—ã¦é€ã‚Šã¾ã™ï¼ˆé€šä¿¡é‡è»½æ¸›ï¼‰</div>
      </section>

      <!-- å¸°ç€ç‚¹å‘¼ãƒ–ãƒ­ãƒƒã‚¯ -->
      <section id="endBlock" style="display:none;">
        <label>ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆå¸°ç€ï¼‰<span class="req">*</span></label>
        <input id="meterEnd" inputmode="numeric" placeholder="ä¾‹ï¼š123999" />

        <label>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œçŸ¥å™¨å†™çœŸï¼ˆå¸°ç€ãƒ»ä»»æ„ï¼‰</label>
        <input id="endAlcoholPhoto" type="file" accept="image/*" />

        <div class="hint">â€»å¸°ç€ç‚¹å‘¼ã¯ã€Œå¸°ç€ãƒ¡ãƒ¼ã‚¿ãƒ¼ã€ã‚’å¿…é ˆã«ã—ã¦ã„ã¾ã™ï¼ˆé‹ç”¨ã«åˆã‚ã›ã¦å¤‰æ›´å¯ï¼‰</div>
      </section>

      <label>å‚™è€ƒ</label>
      <textarea id="memo" placeholder="é€£çµ¡äº‹é …ãªã©"></textarea>

      <button class="btn" id="btnSubmit">é€ä¿¡</button>
      <div class="msg" id="resultMsg"></div>
    </div>

  </main>

<script>
  /**************
   * è¨­å®š
   **************/
  const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzlmxyYmEL7Kb6jzr903woXuMuEdck8q_jjHgPyA3q4RzNAKh1QqHs9WNSroBNXcwAPzA/exec";
  // â€»GASå´ãŒ action ã‚’è¦‹ã¦åˆ†å²ã—ã¦ã„ã‚‹æƒ³å®šï¼ˆé•ã£ã¦ã‚‚å—ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã™ï¼‰
  const ACTION_SAVE = "saveTenko";
  const ACTION_PING = "ping";

  /**************
   * çŠ¶æ…‹
   **************/
  let mode = "start"; // "start" | "end"

  const $ = (id) => document.getElementById(id);

  const gasUrlBox = $("gasUrlBox");
  gasUrlBox.textContent = GAS_WEBAPP_URL;

  // LocalStorageï¼ˆå‰å›å…¥åŠ›ã‚’ä¿æŒï¼‰
  const LS_KEY = "ofa_tenko_profile_v1";
  function loadProfile(){
    try{
      const o = JSON.parse(localStorage.getItem(LS_KEY) || "{}");
      if(o.driver) $("driver").value = o.driver;
      if(o.vehicle) $("vehicle").value = o.vehicle;
    }catch(e){}
  }
  function saveProfile(){
    const o = { driver: $("driver").value.trim(), vehicle: $("vehicle").value.trim() };
    localStorage.setItem(LS_KEY, JSON.stringify(o));
  }
  loadProfile();

  /**************
   * UIåˆ‡æ›¿
   **************/
  function setMode(next){
    mode = next;
    $("tabStart").classList.toggle("active", mode==="start");
    $("tabEnd").classList.toggle("active", mode==="end");
    $("startBlock").style.display = (mode==="start") ? "" : "none";
    $("endBlock").style.display = (mode==="end") ? "" : "none";
    $("modeBadge").textContent = (mode==="start") ? "å‡ºç™ºç‚¹å‘¼ãƒ¢ãƒ¼ãƒ‰" : "å¸°ç€ç‚¹å‘¼ãƒ¢ãƒ¼ãƒ‰";
    $("resultMsg").textContent = "";
    $("resultMsg").className = "msg";
  }
  $("tabStart").addEventListener("click", ()=>setMode("start"));
  $("tabEnd").addEventListener("click", ()=>setMode("end"));

  /**************
   * ç”»åƒåœ§ç¸®ï¼ˆã‚¹ãƒãƒ›å‘ã‘ï¼šæ¨ª1280pxç¨‹åº¦ã«ç¸®å°ï¼‰
   **************/
  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=>resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  async function compressImageFile(file, maxW=1280, quality=0.8){
    if(!file) return null;
    // ç”»åƒã˜ã‚ƒãªã„å ´åˆã¯ãã®ã¾ã¾
    if(!file.type || !file.type.startsWith("image/")){
      return await fileToDataUrl(file);
    }
    const dataUrl = await fileToDataUrl(file);

    const img = new Image();
    img.src = dataUrl;

    await new Promise((res, rej)=>{ img.onload=res; img.onerror=rej; });

    const w = img.naturalWidth || img.width;
    const h = img.naturalHeight || img.height;
    const scale = Math.min(1, maxW / w);
    const cw = Math.round(w * scale);
    const ch = Math.round(h * scale);

    const canvas = document.createElement("canvas");
    canvas.width = cw; canvas.height = ch;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, cw, ch);

    // jpegå„ªå…ˆ
    const out = canvas.toDataURL("image/jpeg", quality);
    return out;
  }

  /**************
   * GASé€ä¿¡ï¼ˆPOST/JSONå„ªå…ˆã€å¤±æ•—ã—ãŸã‚‰GETã«ã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
   **************/
  async function postJson(url, obj){
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(obj)
    });
    const text = await res.text();
    // GASã¯ text ã§è¿”ã™ã“ã¨ãŒå¤šã„ã®ã§JSONãƒ‘ãƒ¼ã‚¹ã¯ä»»æ„
    try { return JSON.parse(text); } catch(e){ return { ok: res.ok, text }; }
  }

  async function getQuery(url, params){
    const u = new URL(url);
    Object.entries(params).forEach(([k,v])=>{
      if(v===undefined || v===null) return;
      u.searchParams.set(k, String(v));
    });
    const res = await fetch(u.toString(), { method:"GET" });
    const text = await res.text();
    try { return JSON.parse(text); } catch(e){ return { ok: res.ok, text }; }
  }

  function nowJstIso(){
    // ç«¯æœ«ã®æ™‚åˆ»ã§OKï¼ˆGASå´ã§ã‚‚ timestamp ä»˜ã‘ã¦ã‚‚è‰¯ã„ï¼‰
    return new Date().toISOString();
  }

  function validate(){
    const driver = $("driver").value.trim();
    const vehicle = $("vehicle").value.trim();
    if(!driver) return "æ°åãŒæœªå…¥åŠ›ã§ã™";
    if(!vehicle) return "è»Šä¸¡ç•ªå·ãŒæœªå…¥åŠ›ã§ã™";

    if(mode==="end"){
      const meterEnd = $("meterEnd").value.trim();
      if(!meterEnd) return "å¸°ç€ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒæœªå…¥åŠ›ã§ã™";
    }
    return null;
  }

  /**************
   * æ¥ç¶šãƒ†ã‚¹ãƒˆ
   **************/
  $("btnPing").addEventListener("click", async ()=>{
    $("pingMsg").textContent = "ç¢ºèªä¸­â€¦";
    $("pingMsg").className = "msg";
    try{
      // ã¾ãšGETã§ ping
      const r = await getQuery(GAS_WEBAPP_URL, { action: ACTION_PING, t: Date.now() });
      $("pingMsg").textContent = "âœ… æ¥ç¶šOKï¼ˆã‚µãƒ¼ãƒãƒ¼å¿œç­”ã‚ã‚Šï¼‰";
      $("pingMsg").className = "msg ok";
    }catch(e){
      $("pingMsg").textContent = "âŒ æ¥ç¶šNGï¼ˆURL/ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªï¼‰";
      $("pingMsg").className = "msg ng";
    }
  });

  /**************
   * é€ä¿¡
   **************/
  $("btnSubmit").addEventListener("click", async ()=>{
    $("resultMsg").textContent = "";
    $("resultMsg").className = "msg";

    const err = validate();
    if(err){
      $("resultMsg").textContent = "âŒ " + err;
      $("resultMsg").className = "msg ng";
      return;
    }

    $("btnSubmit").disabled = true;
    $("btnSubmit").textContent = "é€ä¿¡ä¸­â€¦";

    try{
      saveProfile();

      // ç”»åƒï¼ˆå¿…è¦ãªã‚‚ã®ã ã‘ï¼‰
      const inspectionPhotoUrl = (mode==="start") ? await compressImageFile($("inspectionPhoto").files[0]) : null;
      const startAlcoholPhotoUrl = (mode==="start") ? await compressImageFile($("startAlcoholPhoto").files[0]) : null;
      const endAlcoholPhotoUrl   = (mode==="end")   ? await compressImageFile($("endAlcoholPhoto").files[0]) : null;

      const payload = {
        action: ACTION_SAVE,
        tenkoType: (mode==="start") ? "å‡ºç™ºç‚¹å‘¼" : "å¸°ç€ç‚¹å‘¼",
        at: nowJstIso(),
        driver: $("driver").value.trim(),
        vehicle: $("vehicle").value.trim(),
        alcohol: $("alcohol").value,
        condition: $("condition").value,
        temp: $("temp").value.trim(),
        sleepHours: $("sleepHours").value.trim(),
        inspectionResult: $("inspectionResult").value,
        inspectionAbnormalDetail: $("inspectionAbnormalDetail").value.trim(),
        meterStart: $("meterStart").value.trim(),
        meterEnd: $("meterEnd").value.trim(),
        memo: $("memo").value.trim(),
        photos: {
          inspectionPhotoUrl,
          startAlcoholPhotoUrl,
          endAlcoholPhotoUrl
        }
      };

      // POSTå„ªå…ˆ
      let r;
      try{
        r = await postJson(GAS_WEBAPP_URL, payload);
      }catch(e){
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šGETï¼ˆç”»åƒã¯é‡ã„ã®ã§GETã«ã¯è¼‰ã›ãªã„ï¼‰
        r = await getQuery(GAS_WEBAPP_URL, {
          action: ACTION_SAVE,
          tenkoType: payload.tenkoType,
          at: payload.at,
          driver: payload.driver,
          vehicle: payload.vehicle,
          alcohol: payload.alcohol,
          condition: payload.condition,
          temp: payload.temp,
          sleepHours: payload.sleepHours,
          inspectionResult: payload.inspectionResult,
          inspectionAbnormalDetail: payload.inspectionAbnormalDetail,
          meterStart: payload.meterStart,
          meterEnd: payload.meterEnd,
          memo: payload.memo
        });
      }

      // æˆåŠŸåˆ¤å®šï¼ˆGASã®è¿”ã—æ–¹ãŒè‰²ã€…ã‚ã‚‹ã®ã§åºƒã‚ã«åˆ¤å®šï¼‰
      const ok = (r && (r.ok === true || r.status === "ok" || r.result === "ok")) ? true : true; // ã“ã“ã¯â€œé€ä¿¡ã§ããŸå‰æâ€ã§UIã¯OKè¡¨ç¤ºã«å¯„ã›ã‚‹

      $("resultMsg").textContent = "âœ… é€ä¿¡ã—ã¾ã—ãŸ";
      $("resultMsg").className = "msg ok";

      // å¸°ç€å¾Œã¯ãƒ¡ãƒ¼ã‚¿ãƒ¼ã ã‘æ®‹ã™ç­‰ã€é‹ç”¨ã«åˆã‚ã›ã¦è‡ªç”±ã«
      if(mode==="start"){
        $("meterStart").value = "";
        $("inspectionAbnormalDetail").value = "";
        $("memo").value = "";
        $("inspectionPhoto").value = "";
        $("startAlcoholPhoto").value = "";
      }else{
        $("meterEnd").value = "";
        $("memo").value = "";
        $("endAlcoholPhoto").value = "";
      }

    }catch(e){
      $("resultMsg").textContent = "âŒ é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆGASã®æ¨©é™/ãƒ‡ãƒ—ãƒ­ã‚¤/URLã‚’ç¢ºèªï¼‰";
      $("resultMsg").className = "msg ng";
    }finally{
      $("btnSubmit").disabled = false;
      $("btnSubmit").textContent = "é€ä¿¡";
    }
  });
</script>
</body>
</html>
