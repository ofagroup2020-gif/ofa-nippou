<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OFA ç‚¹å‘¼ãƒ»ç‚¹æ¤œ</title>
  <style>
    :root{--b:#1e6fff;--bg:#f4f7fb;--card:#fff;--txt:#111;--muted:#666;--danger:#e53935;--ok:#2e7d32;}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;}
    body{margin:0;background:var(--bg);color:var(--txt);}
    header{padding:18px 16px 10px;max-width:860px;margin:0 auto;}
    h1{margin:0;font-size:22px;display:flex;align-items:center;gap:8px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px}
    .wrap{max-width:860px;margin:0 auto;padding:10px 16px 40px;}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.06);padding:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1}
    .btn{border:0;border-radius:12px;padding:12px 14px;background:var(--b);color:#fff;font-weight:700;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--b);border:1px solid rgba(30,111,255,.35)}
    .btn.small{padding:10px 12px;font-size:14px}
    .seg{display:flex;gap:10px;background:#eef4ff;padding:10px;border-radius:14px}
    .seg button{flex:1}
    label{display:block;font-weight:700;margin:12px 0 6px}
    input,select,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #d9e2f2;background:#fff;font-size:16px}
    textarea{min-height:90px}
    .req{color:#d32f2f;margin-left:4px}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .status{margin-top:10px;font-weight:800}
    .status.ng{color:var(--danger)}
    .status.ok{color:var(--ok)}
    .hr{height:1px;background:#e7eefc;margin:14px 0}
    .hide{display:none !important}
    .pill{display:inline-block;background:#eef4ff;color:#1e6fff;border:1px solid rgba(30,111,255,.25);padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;word-break:break-all;background:#f7f9ff;border:1px dashed #cfe0ff;padding:10px;border-radius:12px}
  </style>
</head>
<body>
<header>
  <h1>ğŸšš OFA ç‚¹å‘¼ãƒ»ç‚¹æ¤œ</h1>
  <div class="sub">å‡ºç™ºç‚¹å‘¼ / å¸°ç€ç‚¹å‘¼ã‚’åˆ†ã‘ã¦å…¥åŠ›ï¼ˆã‚¹ãƒãƒ›æœ€é©ï¼‰</div>
</header>

<div class="wrap">
  <div class="card">
    <div class="row">
      <button class="btn ghost small" id="modeStartBtn">å‡ºç™ºç‚¹å‘¼ãƒ¢ãƒ¼ãƒ‰</button>
      <button class="btn ghost small" id="pingBtn">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
    </div>

    <div class="hr"></div>

    <label>GAS Webã‚¢ãƒ—ãƒª URLï¼ˆ/execï¼‰</label>
    <div class="mono" id="gasUrlView"></div>
    <div class="status ng" id="connStatus">æœªãƒ†ã‚¹ãƒˆ</div>

    <div class="hr"></div>

    <div class="seg">
      <button class="btn small" id="segStart">å‡ºç™ºç‚¹å‘¼</button>
      <button class="btn small ghost" id="segEnd">å¸°ç€ç‚¹å‘¼</button>
    </div>

    <form id="form" autocomplete="off">
      <input type="hidden" id="type" value="start" />

      <label>æ°å<span class="req">*</span></label>
      <input id="driver" required placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ" />

      <label>è»Šä¸¡ç•ªå·<span class="req">*</span></label>
      <input id="vehicle" required placeholder="ä¾‹ï¼šé¹¿å…å³¶ 480 ã‚ 12-34" />

      <label>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯<span class="req">*</span></label>
      <select id="alcohol" required>
        <option value="å•é¡Œãªã—" selected>å•é¡Œãªã—</option>
        <option value="æœªå®Ÿæ–½">æœªå®Ÿæ–½</option>
        <option value="åå¿œã‚ã‚Š">åå¿œã‚ã‚Š</option>
      </select>

      <label>ä½“èª¿<span class="req">*</span></label>
      <select id="condition" required>
        <option value="è‰¯å¥½" selected>è‰¯å¥½</option>
        <option value="æ™®é€š">æ™®é€š</option>
        <option value="ä¸èª¿">ä¸èª¿</option>
      </select>

      <div id="startOnly">
        <label>ä½“æ¸©ï¼ˆä»»æ„ï¼‰</label>
        <input id="temp" inputmode="decimal" placeholder="ä¾‹ï¼š36.5" />

        <label>ç¡çœ æ™‚é–“ï¼ˆä»»æ„ï¼‰</label>
        <input id="sleep" inputmode="decimal" placeholder="ä¾‹ï¼š7" />

        <label>æ—¥å¸¸ç‚¹æ¤œï¼ˆç•°å¸¸æœ‰ç„¡ï¼‰<span class="req">*</span></label>
        <select id="inspection" required>
          <option value="ç•°å¸¸ãªã—" selected>ç•°å¸¸ãªã—</option>
          <option value="ç•°å¸¸ã‚ã‚Š">ç•°å¸¸ã‚ã‚Š</option>
        </select>

        <label>ç•°å¸¸å†…å®¹ï¼ˆç•°å¸¸ã‚ã‚Šã®å ´åˆï¼‰</label>
        <input id="inspectionDetail" placeholder="ä¾‹ï¼šå·¦å‰è¼ª ç©ºæ°—åœ§ä½ä¸‹ / ãƒ–ãƒ¬ãƒ¼ã‚­é³´ã ãªã©" />

        <label>ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆå‡ºç™ºï¼‰</label>
        <input id="meterStart" inputmode="numeric" placeholder="ä¾‹ï¼š12345" />

        <label>ç‚¹æ¤œå†™çœŸï¼ˆãƒ¡ãƒ¼ã‚¿ãƒ¼/å¤–è¦³/è­¦å‘Šç¯ãªã©ï¼‰</label>
        <input id="inspectionPhoto" type="file" accept="image/*" />

        <label>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œçŸ¥å™¨å†™çœŸï¼ˆä»»æ„ï¼‰</label>
        <input id="startAlcoholPhoto" type="file" accept="image/*" />

        <div class="hint">â€»å†™çœŸã¯é€ä¿¡æ™‚ã«è‡ªå‹•ã§åœ§ç¸®ã—ã¦é€ã‚Šã¾ã™ï¼ˆé€šä¿¡é‡è»½æ¸›ï¼‰</div>
      </div>

      <div id="endOnly" class="hide">
        <label>ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆå¸°ç€ï¼‰<span class="req">*</span></label>
        <input id="meterEnd" inputmode="numeric" placeholder="ä¾‹ï¼š23456" />

        <label>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œçŸ¥å™¨å†™çœŸï¼ˆå¸°ç€ãƒ»ä»»æ„ï¼‰</label>
        <input id="endAlcoholPhoto" type="file" accept="image/*" />

        <div class="hint">â€»å¸°ç€ç‚¹å‘¼ã¯ã€Œå¸°ç€ãƒ¡ãƒ¼ã‚¿ãƒ¼ã€ã‚’å¿…é ˆã«ã—ã¦ã„ã¾ã™ï¼ˆé‹ç”¨ã«åˆã‚ã›ã¦å¤‰æ›´å¯ï¼‰</div>
      </div>

      <label>å‚™è€ƒ</label>
      <textarea id="memo" placeholder="é€£çµ¡äº‹é …ãªã©"></textarea>

      <div style="margin-top:14px">
        <button class="btn" type="submit" id="sendBtn">é€ä¿¡</button>
      </div>
      <div class="status" id="sendStatus"></div>
    </form>
  </div>
</div>

<script>
  // â˜…ã“ã“ã ã‘ã‚ãªãŸã®æœ€æ–° /exec ã‚’å›ºå®š
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzPoeumcfRJb5LSoFRRxJRCebE2xwiRtzZy4ceQijaQxeeH6cGyXBayWMvoq74RdBwo7A/exec";

  const $ = (id)=>document.getElementById(id);

  $("gasUrlView").textContent = GAS_URL;

  function setMode(type){
    $("type").value = type;
    const isStart = type === "start";

    $("segStart").classList.toggle("ghost", !isStart);
    $("segEnd").classList.toggle("ghost", isStart);

    $("startOnly").classList.toggle("hide", !isStart);
    $("endOnly").classList.toggle("hide", isStart);

    // å¿…é ˆåˆ‡æ›¿ï¼ˆå¸°ç€ã ã‘ meterEnd å¿…é ˆï¼‰
    $("meterEnd").required = !isStart;

    // å‡ºç™ºæ™‚ã®å¿…é ˆé …ç›®
    $("inspection").required = isStart;

    // ãƒœã‚¿ãƒ³æ–‡è¨€
    $("sendBtn").textContent = isStart ? "å‡ºç™ºç‚¹å‘¼ã‚’é€ä¿¡" : "å¸°ç€ç‚¹å‘¼ã‚’é€ä¿¡";
  }

  $("segStart").addEventListener("click", ()=>setMode("start"));
  $("segEnd").addEventListener("click", ()=>setMode("end"));
  $("modeStartBtn").addEventListener("click", ()=>setMode("start"));
  setMode("start");

  async function ping(){
    $("connStatus").textContent = "ãƒ†ã‚¹ãƒˆä¸­...";
    $("connStatus").className = "status";
    try{
      const res = await fetch(GAS_URL + "?ping=1", { method:"GET" });
      const txt = await res.text();
      if(!res.ok) throw new Error("HTTP " + res.status + " " + txt);
      $("connStatus").textContent = "âœ… æ¥ç¶šOK";
      $("connStatus").className = "status ok";
      return true;
    }catch(e){
      $("connStatus").textContent = "âŒ æ¥ç¶šNGï¼ˆURL/ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªï¼‰";
      $("connStatus").className = "status ng";
      console.error(e);
      return false;
    }
  }
  $("pingBtn").addEventListener("click", ping);

  function fileToDataUrl(file, maxW=1280, quality=0.8){
    return new Promise((resolve,reject)=>{
      if(!file) return resolve("");
      const fr = new FileReader();
      fr.onerror = reject;
      fr.onload = ()=>{
        const img = new Image();
        img.onload = ()=>{
          const scale = Math.min(1, maxW / img.width);
          const w = Math.round(img.width * scale);
          const h = Math.round(img.height * scale);
          const cvs = document.createElement("canvas");
          cvs.width = w; cvs.height = h;
          const ctx = cvs.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);
          const dataUrl = cvs.toDataURL("image/jpeg", quality);
          resolve(dataUrl);
        };
        img.onerror = reject;
        img.src = fr.result;
      };
      fr.readAsDataURL(file);
    });
  }

  $("form").addEventListener("submit", async (ev)=>{
    ev.preventDefault();
    $("sendStatus").textContent = "";

    // ã¾ãšæ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆNGãªã‚‰é€ä¿¡ã—ãªã„ï¼‰
    const ok = await ping();
    if(!ok){
      $("sendStatus").textContent = "âŒ é€ä¿¡ã§ãã¾ã›ã‚“ï¼ˆæ¥ç¶šNGï¼‰";
      $("sendStatus").className = "status ng";
      return;
    }

    const type = $("type").value;

    // å†™çœŸã‚’ dataURL ã«ã—ã¦é€ã‚‹
    const inspectionPhoto = await fileToDataUrl($("inspectionPhoto").files[0]);
    const startAlcoholPhoto = await fileToDataUrl($("startAlcoholPhoto").files[0]);
    const endAlcoholPhoto = await fileToDataUrl($("endAlcoholPhoto").files[0]);

    const payload = {
      type,                           // start / end
      driver: $("driver").value.trim(),
      vehicle: $("vehicle").value.trim(),
      alcohol: $("alcohol").value,
      condition: $("condition").value,
      temp: $("temp").value.trim(),
      sleep: $("sleep").value.trim(),
      inspection: $("inspection").value,
      inspectionDetail: $("inspectionDetail").value.trim(),
      meterStart: $("meterStart").value.trim(),
      meterEnd: $("meterEnd").value.trim(),
      memo: $("memo").value.trim(),
      photos: {
        inspectionPhoto,
        startAlcoholPhoto,
        endAlcoholPhoto
      }
    };

    $("sendBtn").disabled = true;
    $("sendStatus").textContent = "é€ä¿¡ä¸­...";
    $("sendStatus").className = "status";

    try{
      const res = await fetch(GAS_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const txt = await res.text();
      if(!res.ok) throw new Error("HTTP " + res.status + " " + txt);

      const data = (()=>{ try{return JSON.parse(txt)}catch{return {ok:true, raw:txt}} })();
      if(!data.ok) throw new Error(data.error || "unknown error");

      $("sendStatus").textContent = "âœ… é€ä¿¡ã—ã¾ã—ãŸ";
      $("sendStatus").className = "status ok";

      // å¸°ç€/å‡ºç™ºã§å…¥åŠ›ã¯æ®‹ã—ã¦OKï¼ˆæ°åãƒ»è»Šç•ªã¯æ®‹ã™ï¼‰
      // å†™çœŸinputã¯ã‚¯ãƒªã‚¢ã•ã‚Œãªã„ãƒ–ãƒ©ã‚¦ã‚¶ã‚‚ã‚ã‚‹ã®ã§è»½ããƒªãƒ­ãƒ¼ãƒ‰ã—ãªã„
      $("inspectionPhoto").value = "";
      $("startAlcoholPhoto").value = "";
      $("endAlcoholPhoto").value = "";
      if(type==="end"){
        $("meterEnd").value = "";
      }
    }catch(e){
      console.error(e);
      $("sendStatus").textContent = "âŒ é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆGASã®æ¨©é™/ãƒ‡ãƒ—ãƒ­ã‚¤/URLã‚’ç¢ºèªï¼‰";
      $("sendStatus").className = "status ng";
    }finally{
      $("sendBtn").disabled = false;
    }
  });
</script>
</body>
</html>
