<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>OFA 点呼 / 日報 / 月報（フル・Firebaseログイン版）</title>

  <!-- jsPDF（端末でPDF生成） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --ofa-green:#22c55e;
      --ofa-blue:#60a5fa;
      --ofa-purple:#a78bfa;
      --ofa-pink:#f472b6;
      --ofa-yellow:#facc15;
      --text:#0b1220;
      --muted:#64748b;
      --line:#e5e7eb;
      --bg:#f7f8fb;
      --card:#ffffff;
      --danger:#ef4444;
      --good:#16a34a;
      --radius:18px;
      --shadow: 0 14px 38px rgba(2,6,23,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", "Segoe UI", sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(34,197,94,.18) 0%, rgba(34,197,94,0) 55%),
        radial-gradient(900px 600px at 90% 15%, rgba(96,165,250,.18) 0%, rgba(96,165,250,0) 55%),
        radial-gradient(1000px 700px at 50% 100%, rgba(244,114,182,.14) 0%, rgba(244,114,182,0) 55%),
        var(--bg);
      color:var(--text);
      padding:14px 12px 70px;
    }
    .wrap{max-width:720px;margin:0 auto}
    .brand{
      display:flex;gap:12px;align-items:center;margin:6px 4px 12px;
    }
    .logo{
      width:46px;height:46px;border-radius:14px;
      background: linear-gradient(135deg,var(--ofa-green),var(--ofa-blue),var(--ofa-purple),var(--ofa-pink));
      display:grid;place-items:center;font-weight:900;color:white;
      box-shadow: 0 10px 26px rgba(2,6,23,.12);
      letter-spacing:.5px;
    }
    h1{font-size:18px;margin:0;line-height:1.1}
    .sub{margin:4px 0 0;color:var(--muted);font-size:12px}

    .card{
      background: rgba(255,255,255,.92);
      border:1px solid rgba(2,6,23,.06);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      margin:10px 0;
    }
    .rainbow{
      border:2px solid transparent;
      background:
        linear-gradient(rgba(255,255,255,.92), rgba(255,255,255,.92)) padding-box,
        linear-gradient(135deg,var(--ofa-green),var(--ofa-blue),var(--ofa-purple),var(--ofa-pink),var(--ofa-yellow)) border-box;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;
      background: rgba(2,6,23,.04);
      border:1px solid rgba(2,6,23,.06);
      color: #0b1220;
      font-size:12px;
    }
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.ok{background:var(--good)}
    .dot.ng{background:var(--danger)}

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;
    }
    .tab{
      border:1px solid rgba(2,6,23,.10);
      background: white;
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
    }
    .tab.active{
      border-color: transparent;
      background: linear-gradient(90deg,var(--ofa-green),var(--ofa-blue),var(--ofa-purple),var(--ofa-pink));
      color: white;
      box-shadow: 0 10px 26px rgba(2,6,23,.12);
    }

    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(2,6,23,.10);
      background: white;
      color:var(--text);
      outline:none;
    }
    textarea{min-height:88px;resize:vertical}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    @media (max-width:560px){
      .grid2,.grid3{grid-template-columns:1fr}
    }

    .btn{
      width:100%;
      border:0;
      border-radius: 16px;
      padding:13px 12px;
      font-weight:900;
      color:#0b1020;
      cursor:pointer;
      background: linear-gradient(90deg,var(--ofa-green),var(--ofa-blue),var(--ofa-purple),var(--ofa-pink));
    }
    .btn2{
      width:100%;
      border:1px solid rgba(2,6,23,.12);
      border-radius: 16px;
      padding:12px 12px;
      font-weight:900;
      color:var(--text);
      cursor:pointer;
      background: rgba(255,255,255,.9);
    }
    .btnSmall{
      border:1px solid rgba(2,6,23,.12);
      border-radius: 14px;
      padding:10px 12px;
      font-weight:900;
      color:var(--text);
      cursor:pointer;
      background: rgba(255,255,255,.9);
      min-width: 160px;
      flex:1;
    }
    .muted{color:var(--muted);font-size:12px}
    .hr{height:1px;background:rgba(2,6,23,.08);margin:12px 0}

    .err{
      color:#7f1d1d;
      background:rgba(239,68,68,.12);
      border:1px solid rgba(239,68,68,.28);
      padding:10px;border-radius:14px;font-size:12px;display:none
    }
    .okmsg{
      color:#14532d;
      background:rgba(34,197,94,.12);
      border:1px solid rgba(34,197,94,.28);
      padding:10px;border-radius:14px;font-size:12px;display:none
    }
    .hidden{display:none !important;}

    .chipRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;
      background: rgba(2,6,23,.04);
      border:1px solid rgba(2,6,23,.08);
      font-size:12px;
    }
    .xbtn{
      border:0;background:transparent;cursor:pointer;
      font-weight:900;color:var(--danger);
    }

    .sectionTitle{
      margin:0 0 8px;
      font-size:14px;
      font-weight:900;
    }

    .req{color:var(--danger);font-weight:900;margin-left:4px}
    .warn{
      border:1px solid rgba(250,204,21,.35);
      background: rgba(250,204,21,.10);
      padding:10px;border-radius:14px;font-size:12px;color:#713f12;
    }

    .tableBox{
      border:1px solid rgba(2,6,23,.10);
      border-radius:16px;
      overflow:hidden;
      background:white;
    }
    .trow{
      display:flex;gap:10px;justify-content:space-between;
      padding:10px 12px;border-top:1px solid rgba(2,6,23,.08);
      font-size:12px;
    }
    .trow:first-child{border-top:0}
    .k{color:var(--muted)}
    .v{color:var(--text);font-weight:800;word-break:break-all}
    .right{text-align:right;margin-left:auto}

    .dangerInput{
      border-color: rgba(239,68,68,.6) !important;
      box-shadow: 0 0 0 3px rgba(239,68,68,.08);
    }
    footer{
      text-align:center;color:var(--muted);font-size:12px;margin:14px 0 0;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="brand">
    <div class="logo">OFA</div>
    <div>
      <h1>OFA 点呼 / 日報 / 月報（フル）</h1>
      <div class="sub" id="ver">v2026.01.10 / 白ベースUI / Firebaseログイン一本化 / Firestore保存（点呼・月報用データ） / 日報PDF端末生成 / 写真アップロードなし</div>
    </div>
  </div>

  <div class="card rainbow">
    <div class="sectionTitle">点呼の重要ルール（必読）</div>
    <ul style="margin:0;padding-left:18px;color:#0b1220;font-size:13px;line-height:1.55">
      <li>点呼は「業務開始前（出発）」と「業務終了後（帰着）」の2回</li>
      <li>アルコールチェックは必須（数値 + 酒気帯び判定）</li>
      <li>日常点検（車両点検）はフル必須（NG時は詳細メモ必須）</li>
      <li>日報は毎日PDFで提出（写真は日報PDFに入れるだけで、アップロードしません）</li>
      <li>月報は保存データから期間検索で出力（本人は本人分のみ／管理者は全件検索）</li>
    </ul>
  </div>

  <!-- AUTH -->
  <div class="card" id="authCard">
    <div class="row">
      <span class="badge"><span class="dot ng" id="authDot"></span><span id="authState">未ログイン</span></span>
      <span class="badge"><span class="k">role</span>&nbsp;<span class="v" id="roleLabel">-</span></span>
      <button class="btnSmall hidden" id="logoutBtn">ログアウト</button>
    </div>

    <div class="hr"></div>

    <div class="err" id="errBox"></div>
    <div class="okmsg" id="okBox"></div>

    <div id="authForm">
      <div class="grid2">
        <div>
          <label>メールアドレス<span class="req">*</span></label>
          <input id="email" type="email" placeholder="example@ofa.jp" autocomplete="email" />
        </div>
        <div>
          <label>パスワード<span class="req">*</span></label>
          <input id="pass" type="password" placeholder="8文字以上推奨" autocomplete="current-password" />
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <button class="btn2" id="loginBtn">ログイン</button>
        <button class="btn2" id="signupBtn">新規登録</button>
      </div>

      <div style="margin-top:10px" class="warn">
        ✅ 共通パスは廃止しました。<br>
        このログインで「誰が入力したか」を確実に残します。<br>
        管理者追加は Firestore の users/{uid} の role を admin にするだけです。
      </div>

      <p class="muted" style="margin:10px 2px 0;">
        ※管理者（最初の1名）は <b>ofa.group2020@gmail.com</b> を自動で admin にします（初期ブート用）
      </p>
    </div>
  </div>

  <!-- APP -->
  <div class="card hidden" id="appCard">
    <div class="row">
      <span class="badge"><span class="k">ログイン</span>&nbsp;<span class="v" id="who">-</span></span>
      <span class="badge"><span class="k">uid</span>&nbsp;<span class="v" id="uid">-</span></span>
    </div>

    <div class="hr"></div>

    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="tenkoStart">出発点呼</button>
      <button class="tab" data-tab="tenkoEnd">帰着点呼</button>
      <button class="tab" data-tab="daily">日報PDF</button>
      <button class="tab" data-tab="monthly">月報（検索/CSV）</button>
      <button class="tab hidden" data-tab="admin" id="adminTabBtn">管理者</button>
    </div>

    <div class="hr"></div>

    <!-- PANEL: 出発点呼 -->
    <div id="panel-tenkoStart">
      <div class="sectionTitle">点呼（出発）</div>
      <div class="muted">必須は赤い<span class="req">*</span>。未入力は送信時に赤枠になります。</div>

      <div class="grid2">
        <div>
          <label>点呼区分<span class="req">*</span></label>
          <input value="出発" disabled />
        </div>
        <div>
          <label>点呼日時（自動）</label>
          <input id="tenkoStartDatetime" disabled />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>氏名（本名）<span class="req">*</span></label>
          <input id="driverName" placeholder="例：森下 洸" />
        </div>
        <div>
          <label>事業者/拠点<span class="req">*</span></label>
          <select id="baseOffice">
            <option value="">選択</option>
            <option>鹿児島</option>
            <option>熊本</option>
            <option>福岡</option>
            <option>宮崎</option>
            <option>佐賀</option>
            <option>長崎</option>
            <option>大分</option>
            <option>その他</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>車両番号（ナンバー）<span class="req">*</span></label>
          <input id="vehicleNo" placeholder="例：鹿児島 480 れ 12-34" />
        </div>
        <div>
          <label>点呼実施方法<span class="req">*</span></label>
          <select id="tenkoMethod">
            <option value="">選択</option>
            <option>対面</option>
            <option>電話</option>
            <option>アプリ</option>
            <option>その他</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>出発ODO（走行距離計）<span class="req">*</span></label>
          <input id="odoStart" type="number" inputmode="numeric" placeholder="例：12345" />
        </div>
        <div>
          <label>帰着ODO（帰着点呼で入力）</label>
          <input disabled placeholder="帰着点呼で入力" />
        </div>
      </div>

      <div class="hr"></div>
      <div class="sectionTitle">健康・状態（必須）</div>

      <div class="grid3">
        <div>
          <label>睡眠時間(h)<span class="req">*</span></label>
          <input id="sleepHours" type="number" step="0.1" inputmode="decimal" placeholder="例：6.5" />
        </div>
        <div>
          <label>体温(℃)<span class="req">*</span></label>
          <input id="bodyTemp" type="number" step="0.1" inputmode="decimal" placeholder="例：36.5" />
        </div>
        <div>
          <label>体調<span class="req">*</span></label>
          <select id="condition">
            <option value="">選択</option>
            <option>良好</option>
            <option>注意</option>
            <option>不良</option>
          </select>
        </div>
      </div>

      <div class="grid3">
        <div>
          <label>疲労<span class="req">*</span></label>
          <select id="fatigue">
            <option value="">選択</option>
            <option>なし</option>
            <option>少し</option>
            <option>強い</option>
          </select>
        </div>
        <div>
          <label>服薬・体調影響<span class="req">*</span></label>
          <select id="medicineFlag">
            <option value="">選択</option>
            <option>なし</option>
            <option>あり</option>
          </select>
        </div>
        <div>
          <label>飲酒の有無<span class="req">*</span></label>
          <select id="drinking">
            <option value="">選択</option>
            <option>なし</option>
            <option>あり</option>
          </select>
        </div>
      </div>

      <label>服薬内容（「あり」の場合必須）</label>
      <input id="medicineNote" placeholder="例：風邪薬 1錠" />

      <div class="grid2">
        <div>
          <label>酒気帯び有無<span class="req">*</span></label>
          <select id="alcoholPresence">
            <option value="">選択</option>
            <option>なし</option>
            <option>疑い</option>
            <option>あり</option>
          </select>
        </div>
        <div>
          <label>アルコール数値<span class="req">*</span></label>
          <input id="alcoholValue" type="number" step="0.01" inputmode="decimal" placeholder="例：0.00" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>酒気帯び判定（数値と一致させる）<span class="req">*</span></label>
          <select id="alcoholJudge">
            <option value="">選択</option>
            <option>OK</option>
            <option>NG</option>
          </select>
        </div>
        <div>
          <label>免許証番号（必須）<span class="req">*</span></label>
          <input id="licenseNo" placeholder="例：第1234567890号" />
        </div>
      </div>

      <div class="hr"></div>
      <div class="sectionTitle">業務（必須）</div>

      <div class="card" style="padding:12px;margin:10px 0;border-radius:16px;border:1px solid rgba(2,6,23,.08);box-shadow:none;">
        <div class="sectionTitle" style="margin:0 0 6px;font-size:13px;">稼働案件（複数追加式）<span class="req">*</span></div>
        <div class="grid2">
          <input id="caseInput" placeholder="例：Amazon / ヤマト / スポット / 企業" />
          <button class="btn2" id="addCaseBtn" type="button">＋ 案件を追加</button>
        </div>
        <div class="chipRow" id="caseChips"></div>
        <div class="muted" style="margin-top:6px">※多くは1案件ですが、複数案件にも対応しています。</div>
      </div>

      <div class="grid2">
        <div>
          <label>積込拠点/エリア<span class="req">*</span></label>
          <input id="loadArea" placeholder="例：姶良 / 加治木 / 春山 / 近見 など" />
        </div>
        <div>
          <label>危険物・高額品の有無<span class="req">*</span></label>
          <select id="dangerGoods">
            <option value="">選択</option>
            <option>なし</option>
            <option>あり</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>
      <div class="sectionTitle">異常申告（必須）</div>
      <div class="grid2">
        <div>
          <label>異常の有無<span class="req">*</span></label>
          <select id="abnormalFlag">
            <option value="">選択</option>
            <option>なし</option>
            <option>あり</option>
          </select>
        </div>
        <div>
          <label>異常内容（「あり」の場合必須）</label>
          <input id="abnormalNote" placeholder="例：発熱 / 車両異音 / 体調不良 など" />
        </div>
      </div>

      <div class="hr"></div>
      <div class="sectionTitle">日常点検（車両点検）フル（必須）</div>

      <div class="row">
        <button class="btnSmall" type="button" id="allOkBtn">一括OKにする</button>
        <button class="btnSmall" type="button" id="allNgClearBtn">NG詳細をクリア</button>
      </div>

      <div class="card" style="padding:12px;margin:10px 0;border-radius:16px;border:1px solid rgba(2,6,23,.08);box-shadow:none;">
        <div class="sectionTitle" style="margin:0 0 8px;font-size:13px;">A. 安全走行に直結（必須）</div>
        <div class="grid2" id="inspectA"></div>

        <div class="hr"></div>
        <div class="sectionTitle" style="margin:0 0 8px;font-size:13px;">B. 車両状態（必須）</div>
        <div class="grid2" id="inspectB"></div>

        <div class="hr"></div>
        <div class="sectionTitle" style="margin:0 0 8px;font-size:13px;">C. 装備（必須）</div>
        <div class="grid2" id="inspectC"></div>

        <div class="hr"></div>
        <div class="sectionTitle" style="margin:0 0 8px;font-size:13px;">NG時のルール（必須）</div>
        <label>NG項目（複数）</label>
        <textarea id="ngItems" placeholder="NGになった項目が自動でここに並びます（編集可）"></textarea>

        <label>NG詳細メモ（NGが1つでもあれば必須）</label>
        <textarea id="ngDetail" placeholder="例：前輪右タイヤ空気圧不足。最寄りGSで補充予定。"></textarea>
        <div class="muted">※写真アップロードはしません（運用上、必要なら別途LINE等で共有）。</div>
      </div>

      <button class="btn" id="submitTenkoStart" type="button">出発点呼を保存（Firestore）</button>
      <p class="muted" style="margin:10px 2px 0;">※点呼データは保存し、月報集計・未実施チェックに使います。</p>
    </div>

    <!-- PANEL: 帰着点呼 -->
    <div id="panel-tenkoEnd" class="hidden">
      <div class="sectionTitle">点呼（帰着）</div>
      <div class="muted">出発ODOは今日の出発点呼から自動参照し、走行距離を自動計算します。</div>

      <div class="grid2">
        <div>
          <label>点呼区分<span class="req">*</span></label>
          <input value="帰着" disabled />
        </div>
        <div>
          <label>点呼日時（自動）</label>
          <input id="tenkoEndDatetime" disabled />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>氏名（本名）<span class="req">*</span></label>
          <input id="driverName2" placeholder="例：森下 洸（出発と同じでOK）" />
        </div>
        <div>
          <label>事業者/拠点<span class="req">*</span></label>
          <select id="baseOffice2">
            <option value="">選択</option>
            <option>鹿児島</option>
            <option>熊本</option>
            <option>福岡</option>
            <option>宮崎</option>
            <option>佐賀</option>
            <option>長崎</option>
            <option>大分</option>
            <option>その他</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>車両番号（ナンバー）<span class="req">*</span></label>
          <input id="vehicleNo2" placeholder="例：鹿児島 480 れ 12-34" />
        </div>
        <div>
          <label>点呼実施方法<span class="req">*</span></label>
          <select id="tenkoMethod2">
            <option value="">選択</option>
            <option>対面</option>
            <option>電話</option>
            <option>アプリ</option>
            <option>その他</option>
          </select>
        </div>
      </div>

      <div class="grid3">
        <div>
          <label>出発ODO（自動/参照）</label>
          <input id="odoStartRef" disabled placeholder="出発点呼があれば自動表示" />
        </div>
        <div>
          <label>帰着ODO<span class="req">*</span></label>
          <input id="odoEnd" type="number" inputmode="numeric" placeholder="例：12456" />
        </div>
        <div>
          <label>走行距離（自動）</label>
          <input id="distanceAuto" disabled placeholder="自動" />
        </div>
      </div>

      <div class="hr"></div>
      <div class="sectionTitle">健康・状態（必須）</div>

      <div class="grid3">
        <div>
          <label>睡眠時間(h)<span class="req">*</span></label>
          <input id="sleepHours2" type="number" step="0.1" inputmode="decimal" placeholder="例：6.5" />
        </div>
        <div>
          <label>体温(℃)<span class="req">*</span></label>
          <input id="bodyTemp2" type="number" step="0.1" inputmode="decimal" placeholder="例：36.5" />
        </div>
        <div>
          <label>体調<span class="req">*</span></label>
          <select id="condition2">
            <option value="">選択</option>
            <option>良好</option>
            <option>注意</option>
            <option>不良</option>
          </select>
        </div>
      </div>

      <div class="grid3">
        <div>
          <label>疲労<span class="req">*</span></label>
          <select id="fatigue2">
            <option value="">選択</option>
            <option>なし</option>
            <option>少し</option>
            <option>強い</option>
          </select>
        </div>
        <div>
          <label>服薬・体調影響<span class="req">*</span></label>
          <select id="medicineFlag2">
            <option value="">選択</option>
            <option>なし</option>
            <option>あり</option>
          </select>
        </div>
        <div>
          <label>飲酒の有無<span class="req">*</span></label>
          <select id="drinking2">
            <option value="">選択</option>
            <option>なし</option>
            <option>あり</option>
          </select>
        </div>
      </div>

      <label>服薬内容（「あり」の場合必須）</label>
      <input id="medicineNote2" placeholder="例：風邪薬 1錠" />

      <div class="grid2">
        <div>
          <label>酒気帯び有無<span class="req">*</span></label>
          <select id="alcoholPresence2">
            <option value="">選択</option>
            <option>なし</option>
            <option>疑い</option>
            <option>あり</option>
          </select>
        </div>
        <div>
          <label>アルコール数値<span class="req">*</span></label>
          <input id="alcoholValue2" type="number" step="0.01" inputmode="decimal" placeholder="例：0.00" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>酒気帯び判定<span class="req">*</span></label>
          <select id="alcoholJudge2">
            <option value="">選択</option>
            <option>OK</option>
            <option>NG</option>
          </select>
        </div>
        <div>
          <label>免許証番号（必須）<span class="req">*</span></label>
          <input id="licenseNo2" placeholder="例：第1234567890号" />
        </div>
      </div>

      <div class="hr"></div>
      <div class="sectionTitle">業務（必須）</div>

      <div class="card" style="padding:12px;margin:10px 0;border-radius:16px;border:1px solid rgba(2,6,23,.08);box-shadow:none;">
        <div class="sectionTitle" style="margin:0 0 6px;font-size:13px;">稼働案件（複数追加式）<span class="req">*</span></div>
        <div class="grid2">
          <input id="caseInput2" placeholder="例：Amazon / ヤマト / スポット / 企業" />
          <button class="btn2" id="addCaseBtn2" type="button">＋ 案件を追加</button>
        </div>
        <div class="chipRow" id="caseChips2"></div>
      </div>

      <div class="grid2">
        <div>
          <label>積込拠点/エリア<span class="req">*</span></label>
          <input id="loadArea2" placeholder="例：姶良 / 加治木 / 春山 / 近見 など" />
        </div>
        <div>
          <label>危険物・高額品の有無<span class="req">*</span></label>
          <select id="dangerGoods2">
            <option value="">選択</option>
            <option>なし</option>
            <option>あり</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>
      <div class="sectionTitle">異常申告（必須）</div>
      <div class="grid2">
        <div>
          <label>異常の有無<span class="req">*</span></label>
          <select id="abnormalFlag2">
            <option value="">選択</option>
            <option>なし</option>
            <option>あり</option>
          </select>
        </div>
        <div>
          <label>異常内容（「あり」の場合必須）</label>
          <input id="abnormalNote2" placeholder="例：積込遅れ / 車両トラブル / 体調不良 など" />
        </div>
      </div>

      <div class="hr"></div>
      <div class="sectionTitle">日常点検（車両点検）フル（必須）</div>

      <div class="row">
        <button class="btnSmall" type="button" id="allOkBtn2">一括OKにする</button>
        <button class="btnSmall" type="button" id="allNgClearBtn2">NG詳細をクリア</button>
      </div>

      <div class="card" style="padding:12px;margin:10px 0;border-radius:16px;border:1px solid rgba(2,6,23,.08);box-shadow:none;">
        <div class="sectionTitle" style="margin:0 0 8px;font-size:13px;">A. 安全走行に直結（必須）</div>
        <div class="grid2" id="inspectA2"></div>

        <div class="hr"></div>
        <div class="sectionTitle" style="margin:0 0 8px;font-size:13px;">B. 車両状態（必須）</div>
        <div class="grid2" id="inspectB2"></div>

        <div class="hr"></div>
        <div class="sectionTitle" style="margin:0 0 8px;font-size:13px;">C. 装備（必須）</div>
        <div class="grid2" id="inspectC2"></div>

        <div class="hr"></div>
        <div class="sectionTitle" style="margin:0 0 8px;font-size:13px;">NG時のルール（必須）</div>
        <label>NG項目（複数）</label>
        <textarea id="ngItems2" placeholder="NGになった項目が自動でここに並びます（編集可）"></textarea>

        <label>NG詳細メモ（NGが1つでもあれば必須）</label>
        <textarea id="ngDetail2" placeholder="例：ブレーキ違和感。整備工場へ連絡済み。"></textarea>
      </div>

      <button class="btn" id="submitTenkoEnd" type="button">帰着点呼を保存（Firestore）</button>
    </div>

    <!-- PANEL: 日報PDF -->
    <div id="panel-daily" class="hidden">
      <div class="sectionTitle">日報（業務実績）→ 端末でPDF生成して LINE/メールで共有</div>
      <div class="muted">※日報は「保存は最小限（数値のみ保存）」にできます。写真はアップロードせずPDFに埋め込みます。</div>

      <div class="grid2">
        <div>
          <label>稼働日<span class="req">*</span></label>
          <input id="dailyDate" type="date" />
        </div>
        <div>
          <label>案件（複数）<span class="req">*</span></label>
          <div class="grid2" style="gap:8px">
            <input id="dailyCaseInput" placeholder="例：Amazon" />
            <button class="btn2" id="dailyAddCaseBtn" type="button">＋追加</button>
          </div>
          <div class="chipRow" id="dailyCaseChips"></div>
        </div>
      </div>

      <div class="grid3">
        <div>
          <label>稼働開始<span class="req">*</span></label>
          <input id="workStart" type="time" />
        </div>
        <div>
          <label>稼働終了<span class="req">*</span></label>
          <input id="workEnd" type="time" />
        </div>
        <div>
          <label>休憩（分）<span class="req">*</span></label>
          <input id="breakMin" type="number" inputmode="numeric" placeholder="例：60" />
        </div>
      </div>

      <div class="grid3">
        <div>
          <label>走行距離（km）</label>
          <input id="dailyDistance" type="number" inputmode="decimal" placeholder="ODO差分があれば自動入力してもOK" />
        </div>
        <div>
          <label>配達個数<span class="req">*</span></label>
          <input id="delivered" type="number" inputmode="numeric" placeholder="例：120" />
        </div>
        <div>
          <label>不在数</label>
          <input id="absent" type="number" inputmode="numeric" placeholder="例：12" />
        </div>
      </div>

      <div class="grid3">
        <div>
          <label>再配達数</label>
          <input id="redelivery" type="number" inputmode="numeric" placeholder="例：6" />
        </div>
        <div>
          <label>返品/持戻り数</label>
          <input id="returned" type="number" inputmode="numeric" placeholder="例：1" />
        </div>
        <div>
          <label>クレーム<span class="req">*</span></label>
          <select id="complaintFlag">
            <option value="">選択</option>
            <option>なし</option>
            <option>あり</option>
          </select>
        </div>
      </div>

      <label>クレーム内容（ありの場合必須）</label>
      <textarea id="complaintNote" placeholder="例：誤配の指摘。再訪して謝罪対応。"></textarea>

      <div class="hr"></div>
      <div class="sectionTitle">売上（必須）</div>

      <div class="grid3">
        <div>
          <label>日当（固定報酬）<span class="req">*</span></label>
          <input id="payDaily" type="number" inputmode="numeric" placeholder="例：18000" />
        </div>
        <div>
          <label>インセンティブ</label>
          <input id="incentive" type="number" inputmode="numeric" placeholder="例：1500" />
        </div>
        <div>
          <label>概算利益（自動）</label>
          <input id="profitAuto" disabled placeholder="自動" />
        </div>
      </div>

      <div class="grid4">
        <div>
          <label>経費：高速</label>
          <input id="expToll" type="number" inputmode="numeric" placeholder="例：0" />
        </div>
        <div>
          <label>経費：駐車</label>
          <input id="expParking" type="number" inputmode="numeric" placeholder="例：0" />
        </div>
        <div>
          <label>経費：燃料</label>
          <input id="expFuel" type="number" inputmode="numeric" placeholder="例：2500" />
        </div>
        <div>
          <label>経費：その他</label>
          <input id="expOther" type="number" inputmode="numeric" placeholder="例：0" />
        </div>
      </div>

      <div class="hr"></div>
      <div class="sectionTitle">その他（必須）</div>

      <div class="grid2">
        <div>
          <label>事故/物損<span class="req">*</span></label>
          <select id="accidentFlag">
            <option value="">選択</option>
            <option>なし</option>
            <option>あり</option>
          </select>
        </div>
        <div>
          <label>遅延理由<span class="req">*</span></label>
          <select id="delayReason">
            <option value="">選択</option>
            <option>なし</option>
            <option>渋滞</option>
            <option>積込遅れ</option>
            <option>体調</option>
            <option>その他</option>
          </select>
        </div>
      </div>

      <label>事故/物損 詳細（ありの場合必須）</label>
      <textarea id="accidentNote" placeholder="例：接触。相手なし。写真と状況を本部へ報告済み。"></textarea>

      <div class="grid2">
        <div>
          <label>明日の稼働予定<span class="req">*</span></label>
          <select id="tomorrowPlan">
            <option value="">選択</option>
            <option>あり</option>
            <option>なし</option>
          </select>
        </div>
        <div>
          <label>写真（任意：PDFに入れるだけ）</label>
          <input id="dailyPhotos" type="file" accept="image/*" multiple />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btnSmall" id="pullDistanceBtn" type="button">点呼のODO差分を日報へ反映</button>
        <button class="btnSmall" id="makePdfBtn" type="button">PDF生成 → 共有</button>
      </div>

      <div class="hr"></div>
      <div class="row">
        <button class="btn2" id="saveDailyDataBtn" type="button">（保存）日報の数値データを保存（月報用）</button>
        <button class="btn2" id="clearDailyBtn" type="button">日報入力をクリア</button>
      </div>

      <p class="muted" style="margin:10px 2px 0;">
        ※写真はアップロードしません。PDFに埋め込んで共有するだけです。<br>
        ※月報のために「数値データだけ」保存できます（推奨）。
      </p>
    </div>

    <!-- PANEL: 月報 -->
    <div id="panel-monthly" class="hidden">
      <div class="sectionTitle">月報（期間検索 → 集計 → CSV出力）</div>
      <div class="muted">本人は本人分のみ検索できます。管理者は管理者画面で全件検索できます。</div>

      <div class="grid2">
        <div>
          <label>開始日<span class="req">*</span></label>
          <input id="mStart" type="date" />
        </div>
        <div>
          <label>終了日<span class="req">*</span></label>
          <input id="mEnd" type="date" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btnSmall" id="runMonthlyBtn" type="button">月報を作成（本人分）</button>
        <button class="btnSmall" id="csvMonthlyBtn" type="button">CSV出力</button>
      </div>

      <div class="hr"></div>

      <div class="tableBox" id="monthlySummaryBox">
        <div class="trow"><div class="k">ステータス</div><div class="v">未集計</div></div>
      </div>

      <div class="hr"></div>
      <div class="sectionTitle">点呼未実施日（出発/帰着どっちが抜けたか）</div>
      <div class="tableBox" id="missingTenkoBox">
        <div class="trow"><div class="k">ステータス</div><div class="v">未集計</div></div>
      </div>
    </div>

    <!-- PANEL: 管理者 -->
    <div id="panel-admin" class="hidden">
      <div class="sectionTitle">管理者：全データ検索 / 出力</div>
      <div class="muted">role=admin のみ表示。ドライバーは自分のデータのみ閲覧できます。</div>

      <div class="hr"></div>

      <div class="sectionTitle" style="font-size:13px">① 管理者の追加（role変更）</div>
      <div class="warn">
        Firestore で <b>users/{uid}</b> の <b>role</b> を <b>admin</b> に変更してください。<br>
        例：role: "driver" → "admin"
      </div>

      <div class="hr"></div>

      <div class="sectionTitle" style="font-size:13px">② 月報検索（全件）</div>
      <div class="grid2">
        <div>
          <label>開始日<span class="req">*</span></label>
          <input id="aStart" type="date" />
        </div>
        <div>
          <label>終了日<span class="req">*</span></label>
          <input id="aEnd" type="date" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>絞り込み（任意）：メール（部分一致）</label>
          <input id="aEmail" placeholder="例：@gmail.com / ofa.jp" />
        </div>
        <div>
          <label>絞り込み（任意）：UID（完全一致）</label>
          <input id="aUid" placeholder="例：YrR39KZ5k..." />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btnSmall" id="adminSearchBtn" type="button">検索して集計</button>
        <button class="btnSmall" id="adminCsvBtn" type="button">検索結果をCSV出力</button>
      </div>

      <div class="hr"></div>

      <div class="tableBox" id="adminSummaryBox">
        <div class="trow"><div class="k">ステータス</div><div class="v">未検索</div></div>
      </div>

      <div class="hr"></div>

      <div class="sectionTitle" style="font-size:13px">③ ログイン状況（オンライン/最終アクセス）</div>
      <div class="tableBox" id="sessionsBox">
        <div class="trow"><div class="k">読み込み</div><div class="v">未</div></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btnSmall" id="loadSessionsBtn" type="button">ログイン状況を更新</button>
      </div>
    </div>

  </div>

  <footer>© OFA GROUP</footer>
</div>

<script type="module">
  // Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    serverTimestamp,
    collection,
    query,
    where,
    orderBy,
    limit,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ===== Firebase設定（あなたのもの）=====
  const firebaseConfig = {
    apiKey: "AIzaSyBe8GHuQepazPDF-dc9XvGlqVNMsdV913E",
    authDomain: "ofatenkoapp.firebaseapp.com",
    projectId: "ofatenkoapp",
    storageBucket: "ofatenkoapp.firebasestorage.app",
    messagingSenderId: "6840450594",
    appId: "1:6840450594:web:441bbb4e2e4be061a6547b"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ===== UI refs =====
  const authDot = document.getElementById("authDot");
  const authState = document.getElementById("authState");
  const roleLabel = document.getElementById("roleLabel");
  const logoutBtn = document.getElementById("logoutBtn");
  const authForm = document.getElementById("authForm");
  const appCard = document.getElementById("appCard");
  const errBox = document.getElementById("errBox");
  const okBox = document.getElementById("okBox");

  const emailEl = document.getElementById("email");
  const passEl = document.getElementById("pass");
  const who = document.getElementById("who");
  const uidEl = document.getElementById("uid");

  // panels
  const tabs = document.getElementById("tabs");
  const panels = {
    tenkoStart: document.getElementById("panel-tenkoStart"),
    tenkoEnd: document.getElementById("panel-tenkoEnd"),
    daily: document.getElementById("panel-daily"),
    monthly: document.getElementById("panel-monthly"),
    admin: document.getElementById("panel-admin"),
  };
  const adminTabBtn = document.getElementById("adminTabBtn");

  // tenko start fields
  const tenkoStartDatetime = document.getElementById("tenkoStartDatetime");
  const driverName = document.getElementById("driverName");
  const baseOffice = document.getElementById("baseOffice");
  const vehicleNo = document.getElementById("vehicleNo");
  const tenkoMethod = document.getElementById("tenkoMethod");
  const odoStart = document.getElementById("odoStart");

  const sleepHours = document.getElementById("sleepHours");
  const bodyTemp = document.getElementById("bodyTemp");
  const condition = document.getElementById("condition");
  const fatigue = document.getElementById("fatigue");
  const medicineFlag = document.getElementById("medicineFlag");
  const medicineNote = document.getElementById("medicineNote");
  const drinking = document.getElementById("drinking");
  const alcoholPresence = document.getElementById("alcoholPresence");
  const alcoholValue = document.getElementById("alcoholValue");
  const alcoholJudge = document.getElementById("alcoholJudge");
  const licenseNo = document.getElementById("licenseNo");

  const loadArea = document.getElementById("loadArea");
  const dangerGoods = document.getElementById("dangerGoods");

  const abnormalFlag = document.getElementById("abnormalFlag");
  const abnormalNote = document.getElementById("abnormalNote");

  // tenko end fields
  const tenkoEndDatetime = document.getElementById("tenkoEndDatetime");
  const driverName2 = document.getElementById("driverName2");
  const baseOffice2 = document.getElementById("baseOffice2");
  const vehicleNo2 = document.getElementById("vehicleNo2");
  const tenkoMethod2 = document.getElementById("tenkoMethod2");
  const odoStartRef = document.getElementById("odoStartRef");
  const odoEnd = document.getElementById("odoEnd");
  const distanceAuto = document.getElementById("distanceAuto");

  const sleepHours2 = document.getElementById("sleepHours2");
  const bodyTemp2 = document.getElementById("bodyTemp2");
  const condition2 = document.getElementById("condition2");
  const fatigue2 = document.getElementById("fatigue2");
  const medicineFlag2 = document.getElementById("medicineFlag2");
  const medicineNote2 = document.getElementById("medicineNote2");
  const drinking2 = document.getElementById("drinking2");
  const alcoholPresence2 = document.getElementById("alcoholPresence2");
  const alcoholValue2 = document.getElementById("alcoholValue2");
  const alcoholJudge2 = document.getElementById("alcoholJudge2");
  const licenseNo2 = document.getElementById("licenseNo2");
  const loadArea2 = document.getElementById("loadArea2");
  const dangerGoods2 = document.getElementById("dangerGoods2");
  const abnormalFlag2 = document.getElementById("abnormalFlag2");
  const abnormalNote2 = document.getElementById("abnormalNote2");

  // daily fields
  const dailyDate = document.getElementById("dailyDate");
  const workStart = document.getElementById("workStart");
  const workEnd = document.getElementById("workEnd");
  const breakMin = document.getElementById("breakMin");
  const dailyDistance = document.getElementById("dailyDistance");
  const delivered = document.getElementById("delivered");
  const absent = document.getElementById("absent");
  const redelivery = document.getElementById("redelivery");
  const returned = document.getElementById("returned");
  const complaintFlag = document.getElementById("complaintFlag");
  const complaintNote = document.getElementById("complaintNote");
  const payDaily = document.getElementById("payDaily");
  const incentive = document.getElementById("incentive");
  const expToll = document.getElementById("expToll");
  const expParking = document.getElementById("expParking");
  const expFuel = document.getElementById("expFuel");
  const expOther = document.getElementById("expOther");
  const profitAuto = document.getElementById("profitAuto");
  const accidentFlag = document.getElementById("accidentFlag");
  const accidentNote = document.getElementById("accidentNote");
  const delayReason = document.getElementById("delayReason");
  const tomorrowPlan = document.getElementById("tomorrowPlan");
  const dailyPhotos = document.getElementById("dailyPhotos");

  const pullDistanceBtn = document.getElementById("pullDistanceBtn");
  const makePdfBtn = document.getElementById("makePdfBtn");
  const saveDailyDataBtn = document.getElementById("saveDailyDataBtn");
  const clearDailyBtn = document.getElementById("clearDailyBtn");

  // monthly
  const mStart = document.getElementById("mStart");
  const mEnd = document.getElementById("mEnd");
  const runMonthlyBtn = document.getElementById("runMonthlyBtn");
  const csvMonthlyBtn = document.getElementById("csvMonthlyBtn");
  const monthlySummaryBox = document.getElementById("monthlySummaryBox");
  const missingTenkoBox = document.getElementById("missingTenkoBox");

  // admin
  const aStart = document.getElementById("aStart");
  const aEnd = document.getElementById("aEnd");
  const aEmail = document.getElementById("aEmail");
  const aUid = document.getElementById("aUid");
  const adminSearchBtn = document.getElementById("adminSearchBtn");
  const adminCsvBtn = document.getElementById("adminCsvBtn");
  const adminSummaryBox = document.getElementById("adminSummaryBox");
  const sessionsBox = document.getElementById("sessionsBox");
  const loadSessionsBtn = document.getElementById("loadSessionsBtn");

  // ===== helpers =====
  const ADMIN_BOOTSTRAP_EMAIL = "ofa.group2020@gmail.com";

  function showErr(msg){
    errBox.style.display = "block";
    okBox.style.display = "none";
    errBox.textContent = msg;
  }
  function showOk(msg){
    okBox.style.display = "block";
    errBox.style.display = "none";
    okBox.textContent = msg;
    setTimeout(()=>{ okBox.style.display="none"; }, 2500);
  }
  function nowJpString(){
    return new Date().toLocaleString("ja-JP");
  }
  function dateKeyFromInput(dateStr){
    // yyyy-mm-dd
    return (dateStr || "").trim();
  }
  function todayKey(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function setDatetimeFields(){
    tenkoStartDatetime.value = nowJpString();
    tenkoEndDatetime.value = nowJpString();
  }
  setDatetimeFields();
  setInterval(setDatetimeFields, 30*1000);

  function clearDangerMarks(){
    document.querySelectorAll(".dangerInput").forEach(el=>el.classList.remove("dangerInput"));
  }
  function markRequired(el){ el.classList.add("dangerInput"); }

  async function ensureUserDoc(user){
    const uref = doc(db, "users", user.uid);
    const snap = await getDoc(uref);
    if(!snap.exists()){
      const role = (user.email && user.email.toLowerCase() === ADMIN_BOOTSTRAP_EMAIL) ? "admin" : "driver";
      await setDoc(uref, {
        email: user.email || null,
        role,
        name: "",
        createdAt: serverTimestamp()
      }, { merge:true });
    } else {
      const data = snap.data() || {};
      // bootstrap admin email
      if(user.email && user.email.toLowerCase() === ADMIN_BOOTSTRAP_EMAIL && data.role !== "admin"){
        await setDoc(uref, { role:"admin" }, { merge:true });
      }
      if(user.email && !data.email){
        await setDoc(uref, { email:user.email }, { merge:true });
      }
    }
  }

  async function getRole(user){
    const uref = doc(db, "users", user.uid);
    const snap = await getDoc(uref);
    return snap.exists() ? (snap.data().role || "driver") : "driver";
  }

  // sessions heartbeat
  let heartbeatTimer = null;
  async function startHeartbeat(user, role){
    const sref = doc(db, "sessions", user.uid);
    await setDoc(sref, {
      uid: user.uid,
      email: user.email || null,
      role: role || "driver",
      userAgent: navigator.userAgent,
      updatedAt: serverTimestamp()
    }, { merge:true });

    clearInterval(heartbeatTimer);
    heartbeatTimer = setInterval(async ()=>{
      try{
        await setDoc(sref, { updatedAt: serverTimestamp() }, { merge:true });
      }catch(e){}
    }, 60*1000);
  }

  async function stopHeartbeat(user){
    clearInterval(heartbeatTimer);
    heartbeatTimer = null;
    try{
      const sref = doc(db, "sessions", user.uid);
      await setDoc(sref, { updatedAt: serverTimestamp() }, { merge:true });
    }catch(e){}
  }

  function setLoggedOutUI(){
    authDot.classList.remove("ok"); authDot.classList.add("ng");
    authState.textContent = "未ログイン";
    roleLabel.textContent = "-";
    logoutBtn.classList.add("hidden");
    authForm.classList.remove("hidden");
    appCard.classList.add("hidden");
  }
  function setLoggedInUI(user, role){
    authDot.classList.remove("ng"); authDot.classList.add("ok");
    authState.textContent = "ログイン中";
    roleLabel.textContent = role || "-";
    logoutBtn.classList.remove("hidden");
    authForm.classList.add("hidden");
    appCard.classList.remove("hidden");
    who.textContent = user.email || "(メールなし)";
    uidEl.textContent = user.uid;
  }

  // ===== Auth actions =====
  document.getElementById("loginBtn").addEventListener("click", async ()=>{
    try{
      const email = (emailEl.value||"").trim();
      const pass = (passEl.value||"").trim();
      if(!email || !pass) return showErr("メールとパスワードを入力してください。");
      await signInWithEmailAndPassword(auth, email, pass);
      showOk("ログインしました。");
    }catch(e){
      showErr(e.message || "ログインに失敗しました。");
    }
  });

  document.getElementById("signupBtn").addEventListener("click", async ()=>{
    try{
      const email = (emailEl.value||"").trim();
      const pass = (passEl.value||"").trim();
      if(!email || !pass) return showErr("メールとパスワードを入力してください。");
      await createUserWithEmailAndPassword(auth, email, pass);
      showOk("登録しました。ログインできます。");
    }catch(e){
      showErr(e.message || "登録に失敗しました。");
    }
  });

  logoutBtn.addEventListener("click", async ()=>{
    const user = auth.currentUser;
    try{
      if(user) await stopHeartbeat(user);
      await signOut(auth);
      showOk("ログアウトしました。");
    }catch(e){
      showErr(e.message || "ログアウトに失敗しました。");
    }
  });

  // ===== Tab switch =====
  function openTab(tab){
    Object.keys(panels).forEach(k=>panels[k].classList.add("hidden"));
    panels[tab].classList.remove("hidden");
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    document.querySelector(`.tab[data-tab="${tab}"]`)?.classList.add("active");
  }
  tabs.addEventListener("click",(e
