<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>OFA ç‚¹å‘¼ãƒ»ç‚¹æ¤œ</title>
  <style>
    :root{
      --bg:#f3f6fb; --card:#fff; --text:#111827; --muted:#6b7280;
      --line:#e5e7eb; --blue:#1f6feb; --blue2:#1557c0; --danger:#d92d20; --ok:#16a34a;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width:720px;margin:0 auto;padding:18px 14px 40px}
    .title{display:flex;align-items:center;gap:10px;font-size:22px;font-weight:900;margin:8px 0 2px}
    .sub{color:var(--muted);font-size:13px;margin:0 0 14px}
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      padding:14px; box-shadow:0 6px 18px rgba(16,24,40,.06);
      margin:12px 0;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      appearance:none;border:0;border-radius:14px;padding:14px 14px;font-weight:800;
      background:var(--blue);color:#fff;width:100%;cursor:pointer;
    }
    .btn:active{background:var(--blue2)}
    .btn-ghost{
      background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe;
    }
    .tabs{display:flex;gap:10px}
    .tab{flex:1}
    .tab button{width:100%}
    .tab .active{background:var(--blue);color:#fff;border:0}
    .tab .inactive{background:#edf2f7;color:#111827;border:1px solid var(--line)}
    .label{font-size:14px;font-weight:900;margin:14px 2px 6px}
    .req{color:#ef4444;margin-left:4px}
    input,select,textarea{
      width:100%; padding:14px 12px; border-radius:14px; border:1px solid var(--line);
      background:#fff; font-size:16px; outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    .note{color:var(--muted);font-size:12px;margin-top:6px}
    .status{display:flex;align-items:center;gap:8px;font-weight:900}
    .dot{width:10px;height:10px;border-radius:999px;background:#9ca3af}
    .dot.ok{background:var(--ok)}
    .dot.ng{background:var(--danger)}
    .msg{
      margin-top:10px; padding:10px 12px; border-radius:14px; font-weight:800;
      border:1px solid var(--line); background:#f9fafb;
    }
    .msg.ok{border-color:#bbf7d0;background:#ecfdf5;color:#065f46}
    .msg.ng{border-color:#fecaca;background:#fef2f2;color:#7f1d1d}
    .small{font-size:12px;color:var(--muted);word-break:break-all}
    .divider{height:1px;background:var(--line);margin:12px 0}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">ğŸšš OFA ç‚¹å‘¼ãƒ»ç‚¹æ¤œ</div>
    <p class="sub">å‡ºç™ºç‚¹å‘¼ / å¸°ç€ç‚¹å‘¼ã‚’åˆ‡ã‚Šæ›¿ãˆã¦å…¥åŠ›ï¼ˆã‚¹ãƒãƒ›æœ€é©ï¼‰</p>

    <div class="card">
      <div class="row" style="gap:10px;align-items:center">
        <button class="btn btn-ghost" id="btnMode" type="button">å‡ºç™ºç‚¹å‘¼ãƒ¢ãƒ¼ãƒ‰</button>
        <button class="btn" id="btnPing" type="button">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
      </div>

      <div class="divider"></div>

      <div class="status" id="connStatus">
        <span class="dot" id="connDot"></span>
        <span id="connText">æœªç¢ºèª</span>
      </div>
      <div class="small" id="gasUrlView"></div>

      <div class="msg" id="topMsg" style="display:none;"></div>
    </div>

    <div class="card">
      <div class="tabs">
        <div class="tab">
          <button id="tabStart" class="btn active" type="button">å‡ºç™ºç‚¹å‘¼</button>
        </div>
        <div class="tab">
          <button id="tabEnd" class="btn inactive" type="button">å¸°ç€ç‚¹å‘¼</button>
        </div>
      </div>

      <form id="form">
        <div class="label">æ°å<span class="req">*</span></div>
        <input id="driver" name="driver" autocomplete="name" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ" required />

        <div class="label">è»Šä¸¡ç•ªå·<span class="req">*</span></div>
        <input id="vehicle" name="vehicle" placeholder="ä¾‹ï¼šé¹¿å…å³¶ 480 ã‚ 12-34" required />

        <div class="label">ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯<span class="req">*</span></div>
        <select id="alcohol" name="alcohol" required>
          <option value="å•é¡Œãªã—" selected>å•é¡Œãªã—</option>
          <option value="è¦å†æ¸¬å®š">è¦å†æ¸¬å®š</option>
          <option value="æ¤œçŸ¥ã‚ã‚Š">æ¤œçŸ¥ã‚ã‚Š</option>
        </select>

        <div class="label">ä½“èª¿<span class="req">*</span></div>
        <select id="condition" name="condition" required>
          <option value="è‰¯å¥½" selected>è‰¯å¥½</option>
          <option value="æ™®é€š">æ™®é€š</option>
          <option value="ä¸èª¿">ä¸èª¿</option>
        </select>

        <div id="startOnly">
          <div class="label">ä½“æ¸©ï¼ˆä»»æ„ï¼‰</div>
          <input id="temp" name="temp" inputmode="decimal" placeholder="ä¾‹ï¼š36.5" />

          <div class="label">ç¡çœ æ™‚é–“ï¼ˆä»»æ„ï¼‰</div>
          <input id="sleep" name="sleep" inputmode="decimal" placeholder="ä¾‹ï¼š6.5" />

          <div class="label">æ—¥å¸¸ç‚¹æ¤œï¼ˆç•°å¸¸æœ‰ç„¡ï¼‰<span class="req">*</span></div>
          <select id="inspection" name="inspection" required>
            <option value="ç•°å¸¸ãªã—" selected>ç•°å¸¸ãªã—</option>
            <option value="ç•°å¸¸ã‚ã‚Š">ç•°å¸¸ã‚ã‚Š</option>
          </select>

          <div class="label">ç•°å¸¸å†…å®¹ï¼ˆç•°å¸¸ã‚ã‚Šã®å ´åˆï¼‰</div>
          <input id="inspectionDetail" name="inspectionDetail" placeholder="ä¾‹ï¼šå·¦å‰è¼ª ç©ºæ°—åœ§ä½ä¸‹ / ãƒ–ãƒ¬ãƒ¼ã‚­é³´ã ãªã©" />

          <div class="label">ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆå‡ºç™ºï¼‰</div>
          <input id="meterStart" name="meterStart" inputmode="numeric" placeholder="ä¾‹ï¼š12345" />

          <div class="label">ç‚¹æ¤œå†™çœŸï¼ˆãƒ¡ãƒ¼ã‚¿ãƒ¼/å¤–è¦³/è­¦å‘Šç¯ãªã©ï¼‰</div>
          <input id="inspectionPhoto" name="inspectionPhoto" type="file" accept="image/*" />

          <div class="label">ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œçŸ¥å™¨å†™çœŸï¼ˆä»»æ„ï¼‰</div>
          <input id="startAlcoholPhoto" name="startAlcoholPhoto" type="file" accept="image/*" />

          <div class="note">â€»å†™çœŸã¯é€ä¿¡æ™‚ã«è‡ªå‹•åœ§ç¸®ã—ã¦é€ã‚Šã¾ã™ï¼ˆé€šä¿¡é‡è»½æ¸›ï¼‰</div>
        </div>

        <div id="endOnly" style="display:none;">
          <div class="label">ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆå¸°ç€ï¼‰<span class="req">*</span></div>
          <input id="meterEnd" name="meterEnd" inputmode="numeric" placeholder="ä¾‹ï¼š23456" />

          <div class="label">ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ¤œçŸ¥å™¨å†™çœŸï¼ˆå¸°ç€ãƒ»ä»»æ„ï¼‰</div>
          <input id="endAlcoholPhoto" name="endAlcoholPhoto" type="file" accept="image/*" />

          <div class="note">â€»å¸°ç€ç‚¹å‘¼ã¯ã€Œå¸°ç€ãƒ¡ãƒ¼ã‚¿ãƒ¼ã€ã‚’å¿…é ˆã«ã—ã¦ã„ã¾ã™ï¼ˆé‹ç”¨ã«åˆã‚ã›ã¦å¤‰æ›´å¯ï¼‰</div>
        </div>

        <div class="label">å‚™è€ƒ</div>
        <textarea id="memo" name="memo" placeholder="é€£çµ¡äº‹é …ãªã©"></textarea>

        <div style="margin-top:14px">
          <button class="btn" id="btnSend" type="submit">é€ä¿¡</button>
        </div>

        <div class="msg" id="sendMsg" style="display:none;"></div>
      </form>
    </div>
  </div>

<script>
/**
 * â˜…ã“ã“ã ã‘ãŒé‡è¦ï¼ˆGAS Webã‚¢ãƒ—ãƒªURLï¼‰
 * ã‚ãªãŸãŒæœ€æ–°ã§å‡ºã—ãŸURLã«å›ºå®šã—ã¦ã‚ã‚Šã¾ã™
 */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzoEn9NU_ejtAwjwYz4K5ahrVo5Usl_4KH22BvUV8-YFgsxAa8BAMOBZ3U2IudVSHsyvw/exec";

/** é€ä¿¡æ–¹å¼ï¼šCORSå›é¿ã®ãŸã‚ no-cors + text/plain ã§POST */
const FETCH_OPT_BASE = {
  method: "POST",
  mode: "no-cors",
  headers: { "Content-Type": "text/plain;charset=utf-8" },
};

let mode = "start"; // start / end

const el = (id)=>document.getElementById(id);
el("gasUrlView").textContent = GAS_URL;

function setMode(next){
  mode = next;
  const isStart = (mode === "start");
  el("btnMode").textContent = isStart ? "å‡ºç™ºç‚¹å‘¼ãƒ¢ãƒ¼ãƒ‰" : "å¸°ç€ç‚¹å‘¼ãƒ¢ãƒ¼ãƒ‰";

  el("tabStart").className = "btn " + (isStart ? "active" : "inactive");
  el("tabEnd").className   = "btn " + (!isStart ? "active" : "inactive");

  el("startOnly").style.display = isStart ? "" : "none";
  el("endOnly").style.display   = isStart ? "none" : "";

  // å¸°ç€ã¯ meterEnd å¿…é ˆ
  el("meterEnd").required = !isStart;

  // è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™
  el("sendMsg").style.display = "none";
}

el("tabStart").addEventListener("click", ()=>setMode("start"));
el("tabEnd").addEventListener("click", ()=>setMode("end"));
el("btnMode").addEventListener("click", ()=>setMode(mode==="start"?"end":"start"));

function setConn(ok, text){
  const dot = el("connDot");
  dot.classList.remove("ok","ng");
  dot.classList.add(ok ? "ok" : "ng");
  el("connText").textContent = text;
}

function showTopMsg(type, text){
  const box = el("topMsg");
  box.className = "msg " + (type === "ok" ? "ok" : "ng");
  box.textContent = text;
  box.style.display = "";
}

async function ping(){
  // no-corsã ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹æœ¬æ–‡ã¯èª­ã‚ãªã„ãŒã€åˆ°é”å¯å¦ã®ç›®å®‰ã«ã¯ãªã‚‹
  // GETã§ /exec?ping=1 ã‚’å©ã
  try{
    await fetch(GAS_URL + "?ping=1&_=" + Date.now(), { method:"GET", mode:"no-cors" });
    setConn(true, "æ¥ç¶šOKï¼ˆåˆ°é”ï¼‰");
    showTopMsg("ok","æ¥ç¶šã§ãã¾ã—ãŸã€‚é€ä¿¡ãƒ†ã‚¹ãƒˆOKã§ã™ã€‚");
  }catch(e){
    setConn(false, "æ¥ç¶šNG");
    showTopMsg("ng","æ¥ç¶šã§ãã¾ã›ã‚“ã€‚GASã®URL/ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }
}

el("btnPing").addEventListener("click", ping);

// ç”»åƒã‚’å°ã•ãã—ã¦ base64 ã«ã™ã‚‹ï¼ˆã‚¹ãƒãƒ›å‘ã‘è»½é‡ï¼‰
function fileToDataUrlCompressed(file, maxW=1280, quality=0.75){
  return new Promise((resolve,reject)=>{
    if(!file) return resolve("");
    const reader = new FileReader();
    reader.onload = ()=>{
      const img = new Image();
      img.onload = ()=>{
        const ratio = Math.min(1, maxW / img.width);
        const w = Math.round(img.width * ratio);
        const h = Math.round(img.height * ratio);
        const canvas = document.createElement("canvas");
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, w, h);
        const dataUrl = canvas.toDataURL("image/jpeg", quality);
        resolve(dataUrl);
      };
      img.onerror = ()=>reject(new Error("image load failed"));
      img.src = reader.result;
    };
    reader.onerror = ()=>reject(new Error("file read failed"));
    reader.readAsDataURL(file);
  });
}

function showSendMsg(type, text){
  const box = el("sendMsg");
  box.className = "msg " + (type === "ok" ? "ok" : "ng");
  box.textContent = text;
  box.style.display = "";
}

el("form").addEventListener("submit", async (ev)=>{
  ev.preventDefault();

  // å¿…é ˆãƒã‚§ãƒƒã‚¯ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨™æº–ï¼‰
  if(!el("form").reportValidity()) return;

  el("btnSend").disabled = true;
  el("btnSend").textContent = "é€ä¿¡ä¸­â€¦";

  try{
    const payload = {
      type: mode, // start / end
      driver: el("driver").value.trim(),
      vehicle: el("vehicle").value.trim(),
      alcohol: el("alcohol").value,
      condition: el("condition").value,
      temp: el("temp").value.trim(),
      sleep: el("sleep").value.trim(),
      inspection: el("inspection") ? el("inspection").value : "",
      inspectionDetail: el("inspectionDetail") ? el("inspectionDetail").value.trim() : "",
      meterStart: el("meterStart") ? el("meterStart").value.trim() : "",
      meterEnd: el("meterEnd") ? el("meterEnd").value.trim() : "",
      memo: el("memo").value.trim(),
      // å†™çœŸï¼ˆbase64ï¼‰
      inspectionPhoto: "",
      startAlcoholPhoto: "",
      endAlcoholPhoto: "",
    };

    // å†™çœŸåœ§ç¸®
    payload.inspectionPhoto = await fileToDataUrlCompressed(el("inspectionPhoto")?.files?.[0]);
    payload.startAlcoholPhoto = await fileToDataUrlCompressed(el("startAlcoholPhoto")?.files?.[0]);
    payload.endAlcoholPhoto = await fileToDataUrlCompressed(el("endAlcoholPhoto")?.files?.[0]);

    // é€ä¿¡ï¼ˆno-corsï¼‰
    await fetch(GAS_URL, {
      ...FETCH_OPT_BASE,
      body: JSON.stringify(payload),
    });

    // no-corsã¯æˆåŠŸ/å¤±æ•—ã®æœ¬æ–‡ã‚’èª­ã‚ãªã„ â†’ åˆ°é”ã—ãŸå‰æã§UIã ã‘æˆåŠŸè¡¨ç¤º
    showSendMsg("ok","âœ… é€ä¿¡ã—ã¾ã—ãŸ");
    // å…¥åŠ›ä¿æŒã—ãŸã„ã®ã§ãƒ•ã‚©ãƒ¼ãƒ ã¯ãƒªã‚»ãƒƒãƒˆã—ãªã„ï¼ˆå¿…è¦ãªã‚‰ä¸‹ã‚’æœ‰åŠ¹åŒ–ï¼‰
    // el("form").reset();

  }catch(e){
    showSendMsg("ng","âŒ é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé€šä¿¡/URL/æ¨©é™ã‚’ç¢ºèªï¼‰");
  }finally{
    el("btnSend").disabled = false;
    el("btnSend").textContent = "é€ä¿¡";
  }
});

// åˆæœŸè¡¨ç¤º
setMode("start");
setConn(false,"æœªç¢ºèª");
</script>
</body>
</html>
