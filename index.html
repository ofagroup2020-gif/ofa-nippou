<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OFA 点呼・日報（端末完結 / IndexedDB）</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">
      <img id="logoImg" src="https://ofagroup2020-gif.github.io/logo.png" alt="OFA" onerror="this.style.display='none'">
      <div>
        <div class="title">OFA 点呼・日報</div>
        <div class="sub">保存：IndexedDB / PDF：OFAカラー / 履歴 / CSV / 写真はPDF埋込のみ</div>
      </div>
    </div>
    <a class="badge" href="./admin/index.html">管理者へ</a>
  </div>
</header>

<div class="container">

  <div class="card">
    <div class="note">
      <b>運用ルール</b><br>
      ・点呼は <b>出発（業務開始前）</b> と <b>帰着（業務終了後）</b> を分けて入力します（ODOも別々）<br>
      ・写真はアップロードしません。<b>PDFに埋め込むだけ</b>です<br>
      ・日報（売上/経費など）は <b>任意（オプション）</b>。未入力でも保存/出力OK
    </div>
  </div>

  <!-- タブ -->
  <div class="card">
    <div class="tabs">
      <button class="tab active" id="tabProfile" onclick="switchTab('profile')">① 基本情報</button>
      <button class="tab" id="tabTenko" onclick="switchTab('tenko')">② 点呼</button>
      <button class="tab" id="tabDaily" onclick="switchTab('daily')">③ 日報（任意）</button>
      <button class="tab" id="tabHistory" onclick="switchTab('history')">④ 履歴 / CSV</button>
    </div>
  </div>

  <!-- ① 基本情報 -->
  <div class="card" id="panelProfile">
    <h2>① 基本情報（必須）</h2>

    <div class="row two">
      <div>
        <div class="label">氏名（本名）<span class="req">*</span></div>
        <input class="input" id="p_name" placeholder="例：森下洸">
      </div>
      <div>
        <div class="label">拠点（47都道府県 or 自由記入）<span class="req">*</span></div>
        <input class="input" id="p_base" list="prefList" placeholder="例：鹿児島 / 東京都 / その他">
        <datalist id="prefList">
          <option>北海道</option><option>青森県</option><option>岩手県</option><option>宮城県</option><option>秋田県</option><option>山形県</option><option>福島県</option>
          <option>茨城県</option><option>栃木県</option><option>群馬県</option><option>埼玉県</option><option>千葉県</option><option>東京都</option><option>神奈川県</option>
          <option>新潟県</option><option>富山県</option><option>石川県</option><option>福井県</option><option>山梨県</option><option>長野県</option>
          <option>岐阜県</option><option>静岡県</option><option>愛知県</option><option>三重県</option>
          <option>滋賀県</option><option>京都府</option><option>大阪府</option><option>兵庫県</option><option>奈良県</option><option>和歌山県</option>
          <option>鳥取県</option><option>島根県</option><option>岡山県</option><option>広島県</option><option>山口県</option>
          <option>徳島県</option><option>香川県</option><option>愛媛県</option><option>高知県</option>
          <option>福岡県</option><option>佐賀県</option><option>長崎県</option><option>熊本県</option><option>大分県</option><option>宮崎県</option><option>鹿児島県</option><option>沖縄県</option>
          <option>その他</option>
        </datalist>
      </div>
    </div>

    <div class="row two">
      <div>
        <div class="label">車両番号（任意）</div>
        <input class="input" id="p_carNo" placeholder="例：鹿児島 480 あ 21-15">
      </div>
      <div>
        <div class="label">運転免許証番号<span class="req">*</span></div>
        <input class="input" id="p_licenseNo" inputmode="numeric" placeholder="例：1234567890123456">
      </div>
    </div>

    <div class="row two">
      <div>
        <div class="label">電話番号<span class="req">*</span></div>
        <input class="input" id="p_phone" inputmode="tel" placeholder="例：08012345678">
      </div>
      <div>
        <div class="label">メールアドレス<span class="req">*</span></div>
        <input class="input" id="p_email" inputmode="email" placeholder="例：xxxxx@gmail.com">
      </div>
    </div>

    <hr>

    <h3>免許証写真（PDFに埋め込み：保存しません）</h3>
    <div class="row two">
      <div>
        <div class="label">免許証写真（任意）</div>
        <input class="input" type="file" id="p_licenseImg" accept="image/*">
        <div class="small">※ 画像は端末にもDBにも保存しません。PDF生成時だけ読み込みます。</div>
      </div>
      <div>
        <div class="label">プレビュー</div>
        <div class="card" style="padding:10px;border-radius:14px;border:1px solid #e8eef7">
          <img id="licensePreview" style="width:100%;max-height:220px;object-fit:contain;border-radius:12px;display:none;">
          <div id="licensePreviewNone" class="small">未選択</div>
        </div>
      </div>
    </div>

    <div class="row two">
      <button class="btn" onclick="saveProfile()">基本情報を保存</button>
      <button class="btn secondary" onclick="resetProfile()">基本情報をリセット</button>
    </div>

    <div style="margin-top:10px">
      <a class="pill" href="https://lin.ee/7sO7SCQ">OFAメンバー専用LINEへ問い合わせ</a>
    </div>
  </div>

  <!-- ② 点呼 -->
  <div class="card" id="panelTenko" style="display:none">
    <h2>② 点呼（出発 / 帰着）</h2>

    <div class="row two">
      <div>
        <div class="label">点呼区分<span class="req">*</span></div>
        <select class="input" id="t_type" onchange="syncOdoLabel()">
          <option value="">選択</option>
          <option value="出発">出発（業務開始前）</option>
          <option value="帰着">帰着（業務終了後）</option>
        </select>
      </div>
      <div>
        <div class="label">点呼日時（手入力）<span class="req">*</span></div>
        <input class="input" type="datetime-local" id="t_at">
        <div class="small">※ 自動入力はしません。あなたの運用に合わせて入力できます。</div>
      </div>
    </div>

    <div class="row three">
      <div>
        <div class="label">点呼方法<span class="req">*</span></div>
        <select class="input" id="t_method">
          <option value="">選択</option>
          <option>対面</option>
          <option>電話</option>
          <option>その他</option>
        </select>
      </div>
      <div>
        <div class="label">睡眠時間（h）</div>
        <input class="input" id="t_sleep" inputmode="decimal" placeholder="例：7.5">
      </div>
      <div>
        <div class="label">体温（℃）</div>
        <input class="input" id="t_temp" inputmode="decimal" placeholder="例：36.5">
      </div>
    </div>

    <div class="row three">
      <div>
        <div class="label">体調</div>
        <select class="input" id="t_condition">
          <option value="">選択</option>
          <option>良好</option><option>注意</option><option>不良</option>
        </select>
      </div>
      <div>
        <div class="label">疲労</div>
        <select class="input" id="t_fatigue">
          <option value="">選択</option>
          <option>なし</option><option>あり</option>
        </select>
      </div>
      <div>
        <div class="label">服薬</div>
        <select class="input" id="t_med">
          <option value="">選択</option>
          <option>なし</option><option>あり</option>
        </select>
      </div>
    </div>

    <div class="row two">
      <div>
        <div class="label" id="odoLabel">ODO（区分を選択）</div>
        <input class="input" id="t_odo" inputmode="numeric" placeholder="例：123456">
        <div class="small">出発→出発ODO、帰着→帰着ODO を入力します。</div>
      </div>
      <div>
        <div class="label">アルコール数値（任意・推奨）</div>
        <input class="input" id="t_alc" inputmode="decimal" placeholder="例：0.00">
        <div class="small">※ 運用に合わせて。未入力でもOK</div>
      </div>
    </div>

    <div class="row two">
      <div>
        <div class="label">アルコール測定写真（任意・推奨：保存しない）</div>
        <input class="input" type="file" id="t_alcImg" accept="image/*">
        <div class="small">※ 写真は保存しません。PDFに載せるだけ。</div>
      </div>
      <div>
        <div class="label">プレビュー</div>
        <div class="card" style="padding:10px;border-radius:14px;border:1px solid #e8eef7">
          <img id="alcPreview" style="width:100%;max-height:220px;object-fit:contain;border-radius:12px;display:none;">
          <div id="alcPreviewNone" class="small">未選択</div>
        </div>
      </div>
    </div>

    <hr>

    <h3>③ 日常点検（スクロール入力）</h3>
    <div class="scroll-box" id="checkBox"></div>

    <div class="label">特記事項（任意）</div>
    <textarea class="input" id="t_memo" placeholder="例：タイヤ空気圧注意、ライト球切れ など"></textarea>

    <div class="row two">
      <button class="btn" onclick="saveTenko()">点呼を保存（履歴へ）</button>
      <button class="btn secondary" onclick="makeTodayPdf()">今日のPDF（OFAフォーマット）</button>
    </div>
  </div>

  <!-- ③ 日報（任意） -->
  <div class="card" id="panelDaily" style="display:none">
    <h2>③ 日報（任意）</h2>

    <div class="note">
      日報は <b>任意入力</b>です。未入力でも点呼と履歴・PDF・CSVは回ります。<br>
      売上/経費/報酬は「入力したい人だけ」使える設計にしています。
    </div>

    <div class="row two" style="margin-top:10px">
      <div>
        <div class="label">稼働日（手入力）</div>
        <input class="input" type="date" id="d_date">
      </div>
      <div>
        <div class="label">案件（メイン：任意）</div>
        <input class="input" id="d_mainJob" placeholder="例：Amazon / 佐川 / 企業配 など">
      </div>
    </div>

    <div class="label">複数案件（追加式：任意）</div>
    <div id="jobsWrap"></div>
    <div class="right">
      <button class="btn small secondary inline" onclick="addJob()">＋案件を追加</button>
      <button class="btn small secondary inline" onclick="clearJobs()">案件を全削除</button>
    </div>

    <hr>

    <h3>売上・経費（任意）</h3>
    <div class="row three">
      <div>
        <div class="label">日当（固定）</div>
        <input class="input" id="d_pay" inputmode="numeric" placeholder="例：16000">
      </div>
      <div>
        <div class="label">インセンティブ</div>
        <input class="input" id="d_incentive" inputmode="numeric" placeholder="例：2000">
      </div>
      <div>
        <div class="label">燃料（経費）</div>
        <input class="input" id="d_fuel" inputmode="numeric" placeholder="例：3000">
      </div>
    </div>
    <div class="row three">
      <div>
        <div class="label">高速（経費）</div>
        <input class="input" id="d_toll" inputmode="numeric" placeholder="例：1200">
      </div>
      <div>
        <div class="label">駐車（経費）</div>
        <input class="input" id="d_parking" inputmode="numeric" placeholder="例：500">
      </div>
      <div>
        <div class="label">その他経費</div>
        <input class="input" id="d_otherCost" inputmode="numeric" placeholder="例：800">
      </div>
    </div>

    <div class="label">トラブル / 申し送り（任意）</div>
    <textarea class="input" id="d_trouble" placeholder="例：置き配トラブル、再配達、誤配 など"></textarea>

    <div class="row two">
      <button class="btn" onclick="saveDaily()">日報を保存（任意）</button>
      <button class="btn secondary" onclick="makeTodayCsv()">今日のCSV（ワンクリック）</button>
    </div>
  </div>

  <!-- ④ 履歴 / CSV -->
  <div class="card" id="panelHistory" style="display:none">
    <h2>④ 履歴 / CSV</h2>

    <div class="row three">
      <div>
        <div class="label">期間（開始）</div>
        <input class="input" type="date" id="h_from">
      </div>
      <div>
        <div class="label">期間（終了）</div>
        <input class="input" type="date" id="h_to">
      </div>
      <div>
        <div class="label">拠点フィルタ（任意）</div>
        <input class="input" id="h_base" placeholder="例：鹿児島 / 東京都">
      </div>
    </div>

    <div class="right" style="margin-top:10px">
      <button class="btn small secondary inline" onclick="reloadHistory()">検索して表示</button>
      <button class="btn small secondary inline" onclick="exportCsvRange()">期間CSV出力</button>
      <button class="btn small secondary inline" onclick="backupJson()">バックアップ書き出し（JSON）</button>
      <label class="btn small secondary inline" style="cursor:pointer">
        バックアップ取込（JSON）
        <input type="file" id="restoreFile" accept="application/json" style="display:none" onchange="restoreJson(event)">
      </label>
    </div>

    <div style="margin-top:12px" class="small">
      ※ CSVは <b>日本語ヘッダー</b>、Excel対策で <b>BOM付きUTF-8</b> で出力します。
    </div>

    <div id="historyTableWrap" style="margin-top:12px"></div>
  </div>

</div>

<!-- PDF化：日本語文字化け回避のため、画面を画像化してPDFへ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
/* =========================
   IndexedDB（1000件超対応）
========================= */
const DB_NAME = "ofa_nippo_db";
const DB_VER  = 1;
let db;

function openDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (e)=>{
      const d = e.target.result;
      if(!d.objectStoreNames.contains("profile")){
        d.createObjectStore("profile", { keyPath:"id" }); // id固定 "me"
      }
      if(!d.objectStoreNames.contains("tenko")){
        const s = d.createObjectStore("tenko", { keyPath:"id" });
        s.createIndex("by_at","at",{unique:false});
        s.createIndex("by_date","date",{unique:false});
        s.createIndex("by_base","base",{unique:false});
      }
      if(!d.objectStoreNames.contains("daily")){
        const s = d.createObjectStore("daily", { keyPath:"id" });
        s.createIndex("by_date","date",{unique:false});
        s.createIndex("by_base","base",{unique:false});
      }
    };
    req.onsuccess=()=>{ db=req.result; resolve(db); };
    req.onerror=()=>reject(req.error);
  });
}
function tx(store, mode="readonly"){
  return db.transaction(store, mode).objectStore(store);
}
function id(){
  return crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(16).slice(2));
}

/* =========================
   UI：タブ
========================= */
function switchTab(name){
  const map = {
    profile:["panelProfile","tabProfile"],
    tenko:["panelTenko","tabTenko"],
    daily:["panelDaily","tabDaily"],
    history:["panelHistory","tabHistory"],
  };
  for(const k in map){
    document.getElementById(map[k][0]).style.display = (k===name) ? "" : "none";
    document.getElementById(map[k][1]).classList.toggle("active", k===name);
  }
  if(name==="history") reloadHistory();
}

/* =========================
   日常点検：スクロール
========================= */
const CHECK_ITEMS = [
  "タイヤ空気圧","ブレーキ","ライト","ウインカー","ワイパー","ミラー",
  "エンジン音","オイル漏れ","冷却水","ベルト","車内整理","積載状態",
  "三角表示板/発炎筒","その他異常なし"
];
function renderChecklist(){
  const box = document.getElementById("checkBox");
  box.innerHTML = "";
  CHECK_ITEMS.forEach((t,i)=>{
    const row = document.createElement("div");
    row.className = "chk";
    row.innerHTML = `<input type="checkbox" id="chk_${i}"><label for="chk_${i}" style="flex:1">${t}</label>`;
    box.appendChild(row);
  });
}
function getChecklist(){
  const res=[];
  CHECK_ITEMS.forEach((t,i)=>{
    const c = document.getElementById("chk_"+i);
    if(c && c.checked) res.push(t);
  });
  return res;
}

/* =========================
   画像プレビュー（保存しない）
========================= */
async function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>resolve(r.result);
    r.onerror=()=>reject(r.error);
    r.readAsDataURL(file);
  });
}
let licenseDataURL = null;  // PDF用（保存しない）
let alcDataURL = null;      // PDF用（保存しない）

document.addEventListener("change", async (e)=>{
  if(e.target.id==="p_licenseImg"){
    const f=e.target.files?.[0];
    licenseDataURL=null;
    const img=document.getElementById("licensePreview");
    const none=document.getElementById("licensePreviewNone");
    if(!f){ img.style.display="none"; none.style.display=""; return; }
    licenseDataURL = await fileToDataURL(f);
    img.src = licenseDataURL;
    img.style.display="";
    none.style.display="none";
  }
  if(e.target.id==="t_alcImg"){
    const f=e.target.files?.[0];
    alcDataURL=null;
    const img=document.getElementById("alcPreview");
    const none=document.getElementById("alcPreviewNone");
    if(!f){ img.style.display="none"; none.style.display=""; return; }
    alcDataURL = await fileToDataURL(f);
    img.src = alcDataURL;
    img.style.display="";
    none.style.display="none";
  }
});

/* =========================
   基本情報
========================= */
async function loadProfile(){
  const s = tx("profile");
  const req = s.get("me");
  return new Promise((resolve)=>{
    req.onsuccess=()=>resolve(req.result||null);
    req.onerror=()=>resolve(null);
  });
}
async function saveProfile(){
  const name = p_name.value.trim();
  const base = p_base.value.trim();
  const licenseNo = p_licenseNo.value.trim();
  const phone = p_phone.value.trim();
  const email = p_email.value.trim();

  if(!name || !base || !licenseNo || !phone || !email){
    alert("必須項目（氏名・拠点・免許証番号・電話・メール）を入力してください");
    return;
  }

  const profile = {
    id:"me",
    name, base,
    carNo: p_carNo.value.trim(),
    licenseNo, phone, email,
    updatedAt: new Date().toISOString()
  };

  const s = tx("profile","readwrite");
  s.put(profile);
  s.transaction.oncomplete=()=>{
    alert("基本情報を保存しました");
    switchTab("tenko");
  };
}
async function resetProfile(){
  if(!confirm("基本情報をリセットします。よろしいですか？")) return;
  const s = tx("profile","readwrite");
  s.delete("me");
  s.transaction.oncomplete=()=>{
    ["p_name","p_base","p_carNo","p_licenseNo","p_phone","p_email"].forEach(id=>document.getElementById(id).value="");
    document.getElementById("p_licenseImg").value="";
    document.getElementById("licensePreview").style.display="none";
    document.getElementById("licensePreviewNone").style.display="";
    licenseDataURL=null;
    alert("リセットしました");
  };
}

/* =========================
   点呼：出発/帰着 分離
========================= */
function syncOdoLabel(){
  const t = t_type.value;
  const label = document.getElementById("odoLabel");
  if(t==="出発") label.textContent = "出発ODO（出発点呼で入力）";
  else if(t==="帰着") label.textContent = "帰着ODO（帰着点呼で入力）";
  else label.textContent = "ODO（区分を選択）";
}
async function saveTenko(){
  const profile = await loadProfile();
  if(!profile){
    alert("先に「基本情報を保存」してください");
    switchTab("profile");
    return;
  }

  const type = t_type.value;
  const at   = t_at.value;
  const method = t_method.value;

  if(!type || !at || !method){
    alert("必須（点呼区分・点呼日時・点呼方法）を入力してください");
    return;
  }

  const date = at.slice(0,10); // YYYY-MM-DD
  const odo = (t_odo.value||"").trim();

  const record = {
    id: id(),
    kind: "点呼",
    type, at,
    date,
    name: profile.name,
    base: profile.base,
    carNo: profile.carNo || "",
    licenseNo: profile.licenseNo,
    phone: profile.phone,
    email: profile.email,

    method,
    sleep: (t_sleep.value||"").trim(),
    temp: (t_temp.value||"").trim(),
    condition: t_condition.value || "",
    fatigue: t_fatigue.value || "",
    medication: t_med.value || "",
    alcoholValue: (t_alc.value||"").trim(),

    odo: odo, // 出発なら出発ODO、帰着なら帰着ODO
    checklist: getChecklist(),
    memo: (t_memo.value||"").trim(),

    createdAt: new Date().toISOString()
  };

  const s = tx("tenko","readwrite");
  s.put(record);
  s.transaction.oncomplete=async ()=>{
    alert("点呼を保存しました（履歴に追加）");
    // 走行距離の自動計算に使えるよう、日報画面の日付を自動セット（任意）
    if(!d_date.value) d_date.value = date;

    // 入力欄は残しつつ、次入力しやすく
    t_memo.value="";
    // そのまま日報へ行ける
    switchTab("daily");
  };
}

/* =========================
   日報（任意）
========================= */
let jobCount = 0;
function addJob(prefill={}){
  jobCount++;
  const wrap = document.getElementById("jobsWrap");
  const box = document.createElement("div");
  box.className="card";
  box.style.borderStyle="dashed";
  box.innerHTML = `
    <div class="right">
      <button class="btn small secondary inline" onclick="this.closest('.card').remove()">削除</button>
    </div>
    <div class="row two">
      <div>
        <div class="label">案件名（任意）</div>
        <input class="input job_name" placeholder="例：Amazon / 企業配" value="${prefill.name||""}">
      </div>
      <div>
        <div class="label">エリア（任意）</div>
        <input class="input job_area" placeholder="例：鹿児島市" value="${prefill.area||""}">
      </div>
    </div>
    <div class="row two">
      <div>
        <div class="label">開始（任意）</div>
        <input class="input job_start" placeholder="例：08:00" value="${prefill.start||""}">
      </div>
      <div>
        <div class="label">終了（任意）</div>
        <input class="input job_end" placeholder="例：18:00" value="${prefill.end||""}">
      </div>
    </div>
    <div class="row two">
      <div>
        <div class="label">配達個数（任意）</div>
        <input class="input job_cnt" inputmode="numeric" placeholder="例：120" value="${prefill.count||""}">
      </div>
      <div>
        <div class="label">メモ（任意）</div>
        <input class="input job_memo" placeholder="任意" value="${prefill.memo||""}">
      </div>
    </div>
  `;
  wrap.appendChild(box);
}
function clearJobs(){
  if(!confirm("案件欄をすべて削除します。よろしいですか？")) return;
  document.getElementById("jobsWrap").innerHTML="";
}
function readJobs(){
  const boxes = Array.from(document.querySelectorAll("#jobsWrap .card"));
  return boxes.map(b=>({
    name: b.querySelector(".job_name")?.value?.trim()||"",
    area: b.querySelector(".job_area")?.value?.trim()||"",
    start:b.querySelector(".job_start")?.value?.trim()||"",
    end:  b.querySelector(".job_end")?.value?.trim()||"",
    count:b.querySelector(".job_cnt")?.value?.trim()||"",
    memo: b.querySelector(".job_memo")?.value?.trim()||"",
  })).filter(x=> Object.values(x).some(v=>v));
}

function n(v){ // 数値化
  const x = parseFloat(String(v||"").replace(/,/g,""));
  return isNaN(x) ? 0 : x;
}
async function saveDaily(){
  const profile = await loadProfile();
  if(!profile){
    alert("先に「基本情報を保存」してください");
    switchTab("profile");
    return;
  }

  // 日報は任意。ただし保存するなら date が空のままは困るので補助
  const date = d_date.value || new Date().toISOString().slice(0,10);

  const rec = {
    id: id(),
    kind:"日報",
    date,
    name: profile.name,
    base: profile.base,
    carNo: profile.carNo || "",
    licenseNo: profile.licenseNo,
    phone: profile.phone,
    email: profile.email,

    mainJob: (d_mainJob.value||"").trim(),
    jobs: readJobs(),
    pay: (d_pay.value||"").trim(),
    incentive: (d_incentive.value||"").trim(),
    fuel: (d_fuel.value||"").trim(),
    toll: (d_toll.value||"").trim(),
    parking: (d_parking.value||"").trim(),
    otherCost: (d_otherCost.value||"").trim(),
    trouble: (d_trouble.value||"").trim(),

    createdAt: new Date().toISOString()
  };

  const s = tx("daily","readwrite");
  s.put(rec);
  s.transaction.oncomplete=()=>{
    alert("日報を保存しました（任意）");
    switchTab("history");
  };
}

/* =========================
   走行距離：出発/帰着を同日で突合
========================= */
async function listTenkoByRange(from, to){
  // 全件走査（1000件程度なら問題なし。さらに増えるなら index cursor にしてもOK）
  const s = tx("tenko");
  const req = s.getAll();
  return new Promise((resolve)=>{
    req.onsuccess=()=>{
      let arr=req.result||[];
      if(from) arr = arr.filter(r=>r.date>=from);
      if(to)   arr = arr.filter(r=>r.date<=to);
      resolve(arr);
    };
    req.onerror=()=>resolve([]);
  });
}
function calcDistanceMap(tenkos){
  // 同日で「出発ODO」「帰着ODO」両方ある場合に距離算出
  // 同日に複数ある場合は「最後に保存された出発」「最後に保存された帰着」を採用
  const map = {}; // key = date|name|base -> {startOdo,endOdo,distance}
  for(const r of tenkos){
    const key = `${r.date}__${r.name}__${r.base}`;
    map[key] ||= {date:r.date,name:r.name,base:r.base,startOdo:null,endOdo:null,distance:null};
    const odoNum = n(r.odo);
    if(!odoNum) continue;
    if(r.type==="出発") map[key].startOdo = odoNum;
    if(r.type==="帰着") map[key].endOdo = odoNum;
    if(map[key].startOdo!=null && map[key].endOdo!=null){
      map[key].distance = Math.max(0, map[key].endOdo - map[key].startOdo);
    }
  }
  return map;
}

/* =========================
   履歴表示
========================= */
async function reloadHistory(){
  const profile = await loadProfile();
  const baseFilter = (h_base.value||"").trim();

  const from = h_from.value || "";
  const to   = h_to.value || "";

  const tenkos = await listTenkoByRange(from,to);

  // 拠点フィルタ
  let filtered = tenkos;
  if(baseFilter) filtered = filtered.filter(r=>(r.base||"").includes(baseFilter));

  // 自分の端末用なので氏名一致を優先（管理者は admin で全部を見る）
  if(profile?.name){
    filtered = filtered.filter(r=>r.name===profile.name);
  }

  // 走行距離マップ（同日突合）
  const distMap = calcDistanceMap(filtered);

  // 並び替え（新しい順）
  filtered.sort((a,b)=> (b.at||"").localeCompare(a.at||""));

  const wrap = document.getElementById("historyTableWrap");
  if(filtered.length===0){
    wrap.innerHTML = `<div class="note">履歴がありません（期間条件を変えてみてください）</div>`;
    return;
  }

  let html = `<table class="table">
    <thead>
      <tr>
        <th>日時</th>
        <th>区分</th>
        <th>拠点</th>
        <th>ODO</th>
        <th>走行距離（同日突合）</th>
        <th>チェック</th>
        <th>特記事項</th>
      </tr>
    </thead><tbody>`;

  for(const r of filtered){
    const key = `${r.date}__${r.name}__${r.base}`;
    const d = distMap[key]?.distance;
    const distStr = (d==null) ? "-" : (d+" km");
    html += `<tr>
      <td>${escapeHtml(r.at||"")}</td>
      <td><b>${escapeHtml(r.type||"")}</b></td>
      <td>${escapeHtml(r.base||"")}</td>
      <td>${escapeHtml(r.odo||"")}</td>
      <td>${distStr}</td>
      <td>${escapeHtml((r.checklist||[]).join("、"))}</td>
      <td>${escapeHtml(r.memo||"")}</td>
    </tr>`;
  }
  html += `</tbody></table>`;
  wrap.innerHTML = html;
}
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

/* =========================
   CSV：日本語ヘッダー + BOM
========================= */
function downloadText(filename, text, mime="text/plain"){
  const blob = new Blob([text], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
async function exportCsvRange(){
  const profile = await loadProfile();
  const baseFilter = (h_base.value||"").trim();
  const from = h_from.value || "";
  const to   = h_to.value || "";
  let tenkos = await listTenkoByRange(from,to);

  if(baseFilter) tenkos = tenkos.filter(r=>(r.base||"").includes(baseFilter));
  if(profile?.name) tenkos = tenkos.filter(r=>r.name===profile.name);

  tenkos.sort((a,b)=> (a.at||"").localeCompare(b.at||""));

  const distMap = calcDistanceMap(tenkos);

  const headers = [
    "種別","氏名","拠点","車両番号","免許証番号","電話","メール",
    "点呼区分","点呼日時","点呼方法","睡眠時間(h)","体温(℃)","体調","疲労","服薬",
    "アルコール数値","ODO","走行距離(km:同日突合)","日常点検","特記事項"
  ];

  const rows = [headers];
  for(const r of tenkos){
    const key = `${r.date}__${r.name}__${r.base}`;
    const dist = distMap[key]?.distance;
    rows.push([
      "点呼",
      r.name||"", r.base||"", r.carNo||"", r.licenseNo||"", r.phone||"", r.email||"",
      r.type||"", r.at||"", r.method||"",
      r.sleep||"", r.temp||"", r.condition||"", r.fatigue||"", r.medication||"",
      r.alcoholValue||"", r.odo||"", (dist==null?"":String(dist)),
      (r.checklist||[]).join("、"),
      r.memo||""
    ]);
  }

  const csv = rows.map(cols=> cols.map(v=>{
    const s=String(v??"");
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(",")).join("\n");

  // Excel対策：BOM
  const bom = "\uFEFF";
  downloadText(`OFA_tenko_${from||"all"}_${to||"all"}.csv`, bom+csv, "text/csv;charset=utf-8");
}

/* =========================
   バックアップ / 復元
========================= */
async function backupJson(){
  const profile = await new Promise(res=>{
    const r = tx("profile").get("me"); r.onsuccess=()=>res(r.result||null); r.onerror=()=>res(null);
  });
  const tenko = await new Promise(res=>{
    const r = tx("tenko").getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=()=>res([]);
  });
  const daily = await new Promise(res=>{
    const r = tx("daily").getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=()=>res([]);
  });
  const data = { exportedAt:new Date().toISOString(), profile, tenko, daily };
  downloadText(`OFA_backup_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(data,null,2), "application/json");
}
async function restoreJson(ev){
  const file = ev.target.files?.[0];
  if(!file) return;
  const txt = await file.text();
  let data;
  try{ data=JSON.parse(txt); }catch(e){ alert("JSONが壊れています"); return; }

  if(!confirm("復元します。現在のデータは上書きされます。よろしいですか？")) return;

  // 全消しして入れ直し
  await new Promise(res=>{
    const t = db.transaction(["profile","tenko","daily"],"readwrite");
    t.objectStore("profile").clear();
    t.objectStore("tenko").clear();
    t.objectStore("daily").clear();
    t.oncomplete=()=>res();
  });
  await new Promise(res=>{
    const t = db.transaction(["profile","tenko","daily"],"readwrite");
    if(data.profile) t.objectStore("profile").put({...data.profile,id:"me"});
    (data.tenko||[]).forEach(x=>t.objectStore("tenko").put(x));
    (data.daily||[]).forEach(x=>t.objectStore("daily").put(x));
    t.oncomplete=()=>res();
  });
  alert("復元しました");
  location.reload();
}

/* =========================
   PDF（OFAフォーマット）
   - 画面テンプレを作って画像化 → PDFへ
   - 日本語文字化けしない
========================= */
async function makeTodayPdf(){
  const profile = await loadProfile();
  if(!profile){
    alert("先に「基本情報を保存」してください");
    switchTab("profile");
    return;
  }
  // 点呼入力の最低条件
  if(!t_type.value || !t_at.value || !t_method.value){
    alert("点呼（区分・日時・方法）は必須です");
    switchTab("tenko");
    return;
  }

  // 今日（指定日）の点呼を引いて「同日突合距離」も算出
  const date = t_at.value.slice(0,10);
  const tenkos = await listTenkoByRange(date,date);
  const self = tenkos.filter(r=>r.name===profile.name && r.base===profile.base);
  const distMap = calcDistanceMap(self);
  const key = `${date}__${profile.name}__${profile.base}`;
  const distance = distMap[key]?.distance ?? null;

  // OFA PDF用のHTMLを作る（見た目がそのままPDFに入る）
  const html = buildOFAReportHTML({
    profile,
    tenkoInput: {
      type: t_type.value,
      at: t_at.value,
      method: t_method.value,
      sleep: t_sleep.value,
      temp: t_temp.value,
      condition: t_condition.value,
      fatigue: t_fatigue.value,
      medication: t_med.value,
      alcoholValue: t_alc.value,
      odo: t_odo.value,
      checklist: getChecklist(),
      memo: t_memo.value
    },
    distance,
    licenseImg: licenseDataURL,
    alcoholImg: alcDataURL
  });

  const wrap = document.createElement("div");
  wrap.style.position="fixed";
  wrap.style.left="-9999px";
  wrap.style.top="0";
  wrap.style.width="794px"; // A4幅相当（96dpi想定）
  wrap.innerHTML = html;
  document.body.appendChild(wrap);

  // 画像化
  const canvas = await html2canvas(wrap, {scale:2, useCORS:true});
  const img = canvas.toDataURL("image/png");

  // PDFへ
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","mm","a4");
  const pageW = 210, pageH = 297;

  // 画像比率で高さ計算
  const imgProps = pdf.getImageProperties(img);
  const imgW = pageW;
  const imgH = (imgProps.height * imgW) / imgProps.width;

  let y = 0;
  if(imgH <= pageH){
    pdf.addImage(img, "PNG", 0, 0, imgW, imgH);
  }else{
    // 複数ページ対応
    let remain = imgH;
    let pos = 0;
    while(remain > 0){
      pdf.addImage(img, "PNG", 0, pos, imgW, imgH);
      remain -= pageH;
      pos -= pageH;
      if(remain > 0) pdf.addPage();
    }
  }

  const safeAt = (t_at.value||"").replace(/[:]/g,"-");
  pdf.save(`OFA_${profile.name}_${date}_${t_type.value}.pdf`);

  wrap.remove();
}

function buildOFAReportHTML({profile, tenkoInput, distance, licenseImg, alcoholImg}){
  const logo = "https://ofagroup2020-gif.github.io/logo.png";
  const distStr = (distance==null) ? "—" : `${distance} km（出発/帰着の同日突合）`;

  const checkList = (tenkoInput.checklist||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("") || "<li>未選択</li>";

  // 画像は「保存しない」が要件。ここはPDF生成時だけ埋める。
  const licenseBlock = licenseImg ? `<img src="${licenseImg}" style="width:260px;max-height:180px;object-fit:contain;border-radius:12px;border:1px solid #e8eef7">`
                                 : `<div style="font-size:12px;color:#6a7a8b">未添付</div>`;
  const alcBlock = alcoholImg ? `<img src="${alcoholImg}" style="width:260px;max-height:180px;object-fit:contain;border-radius:12px;border:1px solid #e8eef7">`
                              : `<div style="font-size:12px;color:#6a7a8b">未添付</div>`;

  return `
  <div style="font-family:-apple-system,BlinkMacSystemFont,'Hiragino Sans','Noto Sans JP',Arial,sans-serif;color:#1b2430;background:#fff">
    <div style="border-bottom:10px solid #12c8cf">
      <div style="background:#12c8cf;color:#fff;padding:14px 16px;font-weight:900;display:flex;justify-content:space-between;align-items:center">
        <div>OFA GROUP　点呼・日報（PDF）</div>
        <div style="font-size:12px;font-weight:800;background:rgba(255,255,255,.22);padding:6px 10px;border-radius:999px">端末完結</div>
      </div>
      <div style="height:8px;background:#7a55ff"></div>
    </div>

    <div style="padding:16px">
      <div style="display:flex;gap:12px;align-items:center">
        <img src="${logo}" onerror="this.style.display='none'" style="width:56px;height:56px;border-radius:14px;border:1px solid #eef2f7;background:#fff;object-fit:contain">
        <div>
          <div style="font-size:18px;font-weight:900">点呼票（${escapeHtml(tenkoInput.type)}）</div>
          <div style="font-size:12px;color:#5c6b7a">作成日時：${escapeHtml(tenkoInput.at)}</div>
        </div>
      </div>

      <div style="margin-top:12px;border:1px solid #e8eef7;border-radius:14px;overflow:hidden">
        <div style="background:#f7f9fc;padding:10px 12px;font-weight:900">基本情報</div>
        <table style="width:100%;border-collapse:collapse;font-size:12px">
          <tr>
            <td style="padding:10px;border-top:1px solid #eef2f7;width:16%">氏名</td>
            <td style="padding:10px;border-top:1px solid #eef2f7;width:34%"><b>${escapeHtml(profile.name)}</b></td>
            <td style="padding:10px;border-top:1px solid #eef2f7;width:16%">拠点</td>
            <td style="padding:10px;border-top:1px solid #eef2f7;width:34%"><b>${escapeHtml(profile.base)}</b></td>
          </tr>
          <tr>
            <td style="padding:10px;border-top:1px solid #eef2f7">車両番号</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">${escapeHtml(profile.carNo||"")}</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">免許証番号</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">${escapeHtml(profile.licenseNo)}</td>
          </tr>
          <tr>
            <td style="padding:10px;border-top:1px solid #eef2f7">電話</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">${escapeHtml(profile.phone)}</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">メール</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">${escapeHtml(profile.email)}</td>
          </tr>
        </table>
      </div>

      <div style="margin-top:12px;border:1px solid #e8eef7;border-radius:14px;overflow:hidden">
        <div style="background:#f7f9fc;padding:10px 12px;font-weight:900">点呼情報</div>
        <table style="width:100%;border-collapse:collapse;font-size:12px">
          <tr>
            <td style="padding:10px;border-top:1px solid #eef2f7;width:16%">区分</td>
            <td style="padding:10px;border-top:1px solid #eef2f7;width:34%"><b>${escapeHtml(tenkoInput.type)}</b></td>
            <td style="padding:10px;border-top:1px solid #eef2f7;width:16%">方法</td>
            <td style="padding:10px;border-top:1px solid #eef2f7;width:34%">${escapeHtml(tenkoInput.method||"")}</td>
          </tr>
          <tr>
            <td style="padding:10px;border-top:1px solid #eef2f7">睡眠</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">${escapeHtml(tenkoInput.sleep||"")}</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">体温</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">${escapeHtml(tenkoInput.temp||"")}</td>
          </tr>
          <tr>
            <td style="padding:10px;border-top:1px solid #eef2f7">体調</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">${escapeHtml(tenkoInput.condition||"")}</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">疲労</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">${escapeHtml(tenkoInput.fatigue||"")}</td>
          </tr>
          <tr>
            <td style="padding:10px;border-top:1px solid #eef2f7">服薬</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">${escapeHtml(tenkoInput.medication||"")}</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">アルコール</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">${escapeHtml(tenkoInput.alcoholValue||"")}</td>
          </tr>
          <tr>
            <td style="padding:10px;border-top:1px solid #eef2f7">ODO</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">${escapeHtml(tenkoInput.odo||"")}</td>
            <td style="padding:10px;border-top:1px solid #eef2f7">走行距離</td>
            <td style="padding:10px;border-top:1px solid #eef2f7"><b>${distStr}</b></td>
          </tr>
        </table>
      </div>

      <div style="margin-top:12px;display:flex;gap:12px">
        <div style="flex:1;border:1px solid #e8eef7;border-radius:14px;overflow:hidden">
          <div style="background:#f7f9fc;padding:10px 12px;font-weight:900">日常点検</div>
          <div style="padding:10px 12px;font-size:12px">
            <ul style="margin:0;padding-left:18px;line-height:1.55">${checkList}</ul>
          </div>
        </div>
        <div style="flex:1;border:1px solid #e8eef7;border-radius:14px;overflow:hidden">
          <div style="background:#f7f9fc;padding:10px 12px;font-weight:900">特記事項</div>
          <div style="padding:10px 12px;font-size:12px;white-space:pre-wrap;min-height:90px">${escapeHtml(tenkoInput.memo||"")}</div>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:12px">
        <div style="flex:1;border:1px solid #e8eef7;border-radius:14px;overflow:hidden">
          <div style="background:#f7f9fc;padding:10px 12px;font-weight:900">免許証写真（PDF埋め込みのみ）</div>
          <div style="padding:10px 12px">${licenseBlock}</div>
        </div>
        <div style="flex:1;border:1px solid #e8eef7;border-radius:14px;overflow:hidden">
          <div style="background:#f7f9fc;padding:10px 12px;font-weight:900">アルコール測定写真（PDF埋め込みのみ）</div>
          <div style="padding:10px 12px">${alcBlock}</div>
        </div>
      </div>

      <div style="margin-top:14px;font-size:11px;color:#6a7a8b">
        © OFA GROUP / 端末完結（保存：IndexedDB）/ 写真は保存せずPDFに埋め込みのみ
      </div>
    </div>
  </div>`;
}

/* =========================
   今日CSV（ワンクリック）
========================= */
async function makeTodayCsv(){
  const profile = await loadProfile();
  if(!profile){ alert("先に基本情報を保存してください"); return; }

  const date = d_date.value || new Date().toISOString().slice(0,10);

  const tenkos = await listTenkoByRange(date,date);
  const self = tenkos.filter(r=>r.name===profile.name && r.base===profile.base);
  const distMap = calcDistanceMap(self);
  const key = `${date}__${profile.name}__${profile.base}`;
  const dist = distMap[key]?.distance ?? "";

  const headers = [
    "日付","氏名","拠点","車両番号",
    "出発ODO","帰着ODO","走行距離(km)",
    "案件（メイン）","案件（複数：JSON）",
    "日当","インセンティブ","燃料","高速","駐車","その他経費","トラブル"
  ];

  // 出発/帰着ODOを抽出
  let startOdo="", endOdo="";
  for(const r of self){
    if(r.type==="出発" && r.odo) startOdo = r.odo;
    if(r.type==="帰着" && r.odo) endOdo = r.odo;
  }

  // 日報は「最新の1件」を採用（必要なら期間で集計も可能）
  const daily = await new Promise(res=>{
    const r = tx("daily").getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=()=>res([]);
  });
  const d = daily.filter(x=>x.date===date && x.name===profile.name && x.base===profile.base)
                 .sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||""))[0];

  const row = [
    date, profile.name, profile.base, profile.carNo||"",
    startOdo, endOdo, String(dist),
    d?.mainJob||"",
    d?.jobs ? JSON.stringify(d.jobs) : "",
    d?.pay||"", d?.incentive||"", d?.fuel||"", d?.toll||"", d?.parking||"", d?.otherCost||"", d?.trouble||""
  ];

  const csv = [headers,row].map(cols=>cols.map(v=>{
    const s=String(v??"");
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(",")).join("\n");

  downloadText(`OFA_daily_${date}.csv`, "\uFEFF"+csv, "text/csv;charset=utf-8");
}

/* =========================
   初期化
========================= */
(async function init(){
  await openDB();
  renderChecklist();

  // 既存プロフィールを画面へ
  const p = await loadProfile();
  if(p){
    p_name.value = p.name||"";
    p_base.value = p.base||"";
    p_carNo.value = p.carNo||"";
    p_licenseNo.value = p.licenseNo||"";
    p_phone.value = p.phone||"";
    p_email.value = p.email||"";
  }

  // 日付の補助（任意）
  const today = new Date().toISOString().slice(0,10);
  if(!d_date.value) d_date.value = today;
})();
</script>

</body>
</html>
