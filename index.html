<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OFA 点呼システム</title>
  <link rel="stylesheet" href="style.css" />
  <script defer src="config.js"></script>
  <script defer src="app.js"></script>
  <script defer src="auth.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">OFA</div>
      <div class="title">
        <h1><span data-appname>OFA</span></h1>
        <p>出発点呼 / 帰着点呼・日報 / PDF / 月報CSV（Drive保存）　v<span data-version></span></p>
      </div>
    </div>

    <div class="card rainbow-border rule">
      <div class="section-title">点呼の重要ルール（必読）</div>
      <ul>
        <li>点呼は「業務開始前（出発）」と「業務終了後（帰着）」の2回</li>
        <li>アルコールチェックは必須（数値 + 酒気帯び判定）</li>
        <li>免許証番号は必須（写真は任意）</li>
        <li>日常点検（車両点検）は必須（NG時は異常写真推奨）</li>
        <li>帰着点呼は日報PDF提出のため丁寧に記載</li>
      </ul>
    </div>

    <div class="card rainbow-border">
      <div class="topbar">
        <span class="badge" data-login-badge>未ログイン</span>
        <div class="right">
          <button class="btn btn-ghost" id="logoutBtn" type="button">ログアウト</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="section-title">ログイン（パスワード）</div>
      <div class="mini">
        パスワードは <a id="lineLink" target="_blank" rel="noopener">OFAメンバーLINE公式</a> で通知します（定期更新）。<br>
        ※ページ上にパスワードは表示しません。
      </div>

      <label class="req">パスワード</label>
      <input id="pass" type="password" placeholder="パスワードを入力" />

      <div class="row" style="margin-top:10px;">
        <div class="col">
          <button class="btn btn-rainbow" id="loginDriver" type="button">ドライバーでログイン</button>
        </div>
        <div class="col">
          <button class="btn btn-dark" id="loginAdmin" type="button">管理者でログイン</button>
        </div>
      </div>

      <div class="hr"></div>

      <a class="navbtn primary" id="goDeparture" href="departure.html">出発点呼</a>
      <a class="navbtn primary" id="goArrival" href="arrival.html">帰着点呼・日報</a>
      <a class="navbtn" id="goMy" href="my.html">ドライバー：出力/履歴</a>
      <a class="navbtn dark" id="goAdmin" href="admin.html">管理者：出力/検索</a>

      <div class="mini">※ログイン後に各ページへ進めます。</div>
    </div>

    <div class="mini" style="text-align:center;margin:18px 0;">© OFA GROUP</div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  OFA_APP.setVersion();
  OFA_AUTH.setLoginBadge();

  const cfg = window.OFA_CONFIG;
  document.getElementById("lineLink").href = cfg.LINE_URL;

  function guardLinks(){
    const s = OFA_AUTH.getSession();
    const dep = document.getElementById("goDeparture");
    const arr = document.getElementById("goArrival");
    const my  = document.getElementById("goMy");
    const adm = document.getElementById("goAdmin");
    if(!s){
      [dep,arr,my,adm].forEach(a=>a.style.pointerEvents="none");
      [dep,arr,my,adm].forEach(a=>a.style.opacity=".45");
      return;
    }
    // driver: departure/arrival/my OK, adminボタンは開けてもadmin.html側で弾く
    [dep,arr,my,adm].forEach(a=>a.style.pointerEvents="auto");
    [dep,arr,my,adm].forEach(a=>a.style.opacity="1");
  }
  guardLinks();

  document.getElementById("logoutBtn").addEventListener("click", ()=>{
    OFA_AUTH.clearSession();
    OFA_APP.toast("ログアウトしました");
    OFA_AUTH.setLoginBadge();
    guardLinks();
  });

  document.getElementById("loginDriver").addEventListener("click", ()=>{
    const pass = document.getElementById("pass").value.trim();
    const r = OFA_AUTH.login("driver", pass);
    if(!r.ok){ OFA_APP.toast(r.message); return; }
    OFA_APP.toast("ドライバーでログインしました");
    OFA_AUTH.setLoginBadge();
    guardLinks();
  });

  document.getElementById("loginAdmin").addEventListener("click", ()=>{
    const pass = document.getElementById("pass").value.trim();
    const r = OFA_AUTH.login("admin", pass);
    if(!r.ok){ OFA_APP.toast(r.message); return; }
    OFA_APP.toast("管理者でログインしました");
    OFA_AUTH.setLoginBadge();
    guardLinks();
  });
});
</script>
</body>
</html>
