<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>OFA 点呼 / 日報 / 月報（端末完結）</title>
  <style>
    :root{
      --bg1:#e9fff7;
      --bg2:#f6f2ff;
      --card:#ffffff;
      --text:#16303a;
      --muted:#5b6b73;
      --danger:#e74c3c;
      --ok:#2ecc71;
      --line:#06c755;
      --b:#e8eef1;
      --shadow:0 8px 22px rgba(0,0,0,.08);
      --r:18px;
      --gap:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Noto Sans JP", "Yu Gothic", "Meiryo", Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(0,255,204,.16), transparent 60%),
        radial-gradient(1200px 600px at 90% 0%, rgba(154,110,255,.16), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      padding:18px 14px 80px;
    }
    .wrap{max-width:980px;margin:0 auto}
    .header{
      display:flex;align-items:center;gap:12px;
      padding:14px 14px;
      border-radius:22px;
      background:rgba(255,255,255,.70);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      border:1px solid rgba(255,255,255,.6);
    }
    .logo{
      width:46px;height:46px;border-radius:16px;overflow:hidden;flex:0 0 auto;
      box-shadow:0 6px 16px rgba(0,0,0,.10);
    }
    .logo svg{display:block;width:100%;height:100%}
    .title h1{font-size:18px;margin:0;line-height:1.2}
    .title p{margin:3px 0 0;color:var(--muted);font-size:12px}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{
      font-size:12px;padding:7px 10px;border-radius:999px;border:1px solid var(--b);
      background:rgba(255,255,255,.75);
    }
    .pill.ok{border-color:rgba(46,204,113,.35)}
    .pill.warn{border-color:rgba(231,76,60,.35)}
    .grid{display:grid;grid-template-columns:1fr;gap:var(--gap);margin-top:14px}
    @media(min-width:920px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{
      background:rgba(255,255,255,.86);
      border:1px solid rgba(255,255,255,.65);
      border-radius:var(--r);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{margin:0 0 10px;font-size:16px}
    .note{
      background:rgba(255,255,255,.75);
      border:1px solid var(--b);
      padding:12px;border-radius:14px;
      color:var(--muted);font-size:13px;
    }
    .note b{color:var(--text)}
    .tabs{
      display:flex;gap:10px;flex-wrap:wrap;
      margin-top:12px;
    }
    .tabbtn{
      border:1px solid var(--b);
      background:rgba(255,255,255,.75);
      padding:10px 12px;border-radius:999px;
      font-weight:700;font-size:13px;
      cursor:pointer;
    }
    .tabbtn.active{
      border-color:rgba(0,0,0,.08);
      background: linear-gradient(90deg, rgba(0,255,204,.25), rgba(154,110,255,.25), rgba(255,77,166,.22));
    }
    .section{display:none;margin-top:12px}
    .section.active{display:block}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.row.two{grid-template-columns:1fr 1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--b);
      border-radius:14px;
      background:#fff;
      font-size:15px;
      outline:none;
    }
    textarea{min-height:92px;resize:vertical}
    .req{color:var(--danger);font-weight:800;margin-left:4px}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      appearance:none;border:none;cursor:pointer;
      padding:12px 14px;border-radius:14px;
      font-weight:800;font-size:14px;
    }
    .btn-primary{
      background: linear-gradient(90deg, #00ffcc, #7b5cff, #ff4da6);
      color:#06232a;
    }
    .btn-ghost{
      background:rgba(255,255,255,.75);
      border:1px solid var(--b);
      color:var(--text);
    }
    .btn-danger{background:rgba(231,76,60,.12);border:1px solid rgba(231,76,60,.35);color:var(--danger)}
    .btn-line{background:rgba(6,199,85,.14);border:1px solid rgba(6,199,85,.35);color:#0a5f2e}
    .small{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:rgba(0,0,0,.06);margin:14px 0}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 12px;border-radius:999px;
      background:rgba(255,255,255,.75);border:1px solid var(--b);
      font-weight:800;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--ok)}
    .dot.off{background:var(--danger)}
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--b);
      background:#fff;
    }
    .table th,.table td{
      font-size:12px;padding:10px;border-bottom:1px solid var(--b);
      text-align:left;vertical-align:top;
    }
    .table th{background:rgba(0,0,0,.03)}
    .table tr:last-child td{border-bottom:none}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .stickybar{
      position:fixed;left:0;right:0;bottom:0;
      padding:10px 12px;
      background:rgba(255,255,255,.80);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(0,0,0,.06);
    }
    .stickybar .wrap{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .stickybar .wrap > div{display:flex;gap:10px;flex-wrap:wrap}
    .toast{
      position:fixed;left:50%;bottom:92px;transform:translateX(-50%);
      background:rgba(0,0,0,.78);color:#fff;
      padding:10px 12px;border-radius:12px;font-size:12px;
      max-width:92vw;display:none;
    }

    /* 印刷（PDF）用 */
    @media print{
      body{background:#fff;padding:0}
      .header,.grid,.stickybar,.toast{display:none !important}
      #printRoot{display:block !important}
    }
    #printRoot{display:none}
    .printWrap{
      font-family: "Hiragino Sans","Noto Sans JP","Yu Gothic","Meiryo",sans-serif;
      padding:18px;
    }
    .printHead{
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:3px solid #111;
      padding-bottom:10px;
      margin-bottom:12px;
    }
    .printBrand{display:flex;align-items:center;gap:10px}
    .printBrand .mark{
      width:42px;height:42px;border-radius:14px;
      background:linear-gradient(90deg,#00ffcc,#7b5cff,#ff4da6);
    }
    .printTitle{font-size:18px;margin:0}
    .printMeta{font-size:12px;color:#333;text-align:right}
    .printBox{
      border:1px solid #111;border-radius:12px;overflow:hidden;margin:10px 0 14px;
    }
    .printBox .cap{
      background:#111;color:#fff;font-weight:800;font-size:12px;padding:8px 10px;
    }
    .printBox .body{padding:10px}
    .printGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .printKV{border:1px solid #ddd;border-radius:10px;padding:8px}
    .printKV b{display:block;font-size:11px;color:#555;margin-bottom:3px}
    .printKV span{font-size:13px;color:#111;word-break:break-word}
    .printTable{
      width:100%;border-collapse:collapse;margin-top:8px
    }
    .printTable th,.printTable td{
      border:1px solid #333;padding:7px;font-size:11px;vertical-align:top
    }
    .printTable th{background:#f2f2f2}
    .photos{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .photos img{max-width:240px;border:1px solid #333;border-radius:10px}
  </style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <div class="logo" aria-label="OFA">
      <!-- 簡易ロゴ（差し替え不要でOFAっぽい） -->
      <svg viewBox="0 0 100 100" role="img" aria-label="OFA">
        <defs>
          <linearGradient id="g" x1="0" x2="1">
            <stop offset="0" stop-color="#00ffcc"/>
            <stop offset=".55" stop-color="#7b5cff"/>
            <stop offset="1" stop-color="#ff4da6"/>
          </linearGradient>
        </defs>
        <rect x="0" y="0" width="100" height="100" rx="26" fill="url(#g)"/>
        <text x="50" y="60" text-anchor="middle" font-size="34" font-weight="900" fill="#06232a" font-family="system-ui, -apple-system">OFA</text>
      </svg>
    </div>
    <div class="title">
      <h1>OFA 点呼 / 日報 / 月報（端末完結）</h1>
      <p>Firebase/GASなし｜保存＝端末内｜写真＝PDFに埋め込み（アップロードなし）｜CSV/JSONバックアップ</p>
      <div class="pillrow">
        <div class="pill ok">✅ 日本語CSV（BOM付）</div>
        <div class="pill ok">✅ PDFは印刷方式で文字化け防止</div>
        <div class="pill ok">✅ 出発/帰着点呼を完全分離</div>
        <div class="pill ok">✅ ODO差分→日報へ自動反映</div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>① 基本情報（最初に1回）</h2>

      <div class="row two">
        <div>
          <label>氏名（本名）<span class="req">*</span></label>
          <input id="base_name" placeholder="例：森下 洸" />
        </div>
        <div>
          <label>拠点（47都道府県）<span class="req">*</span></label>
          <select id="base_pref"></select>
          <div id="pref_free_wrap" style="display:none;margin-top:8px">
            <label>拠点（自由記入）</label>
            <input id="base_pref_free" placeholder="例：鹿児島（春山）/ 南九州 / その他など" />
          </div>
          <div class="small" style="margin-top:6px">※「その他/自由記入」を選ぶと入力できます</div>
        </div>
      </div>

      <div class="row two" style="margin-top:10px">
        <div>
          <label>車両番号（ナンバー）<span class="req">*</span></label>
          <input id="base_carNo" placeholder="例：鹿児島 480 れ 12-34" />
        </div>
        <div>
          <label>運転免許証番号<span class="req">*</span></label>
          <input id="base_licenseNo" placeholder="例：第123456789012" />
        </div>
      </div>

      <div class="row two" style="margin-top:10px">
        <div>
          <label>電話番号<span class="req">*</span></label>
          <input id="base_phone" inputmode="tel" placeholder="例：090-1234-5678" />
        </div>
        <div>
          <label>メールアドレス<span class="req">*</span></label>
          <input id="base_email" inputmode="email" placeholder="例：example@gmail.com" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>運転免許証（写真：PDFに埋め込み）</label>
          <input id="base_licensePhoto" type="file" accept="image/*" />
          <div class="small" style="margin-top:6px">※アップロードしません。端末内でPDFに埋め込むだけです。</div>
        </div>
      </div>

      <div class="btnrow">
        <button class="btn-primary" id="btnSaveBase">基本情報を保存</button>
        <button class="btn-ghost" id="btnClearBase">基本情報をリセット</button>
        <a class="btn-line" href="https://lin.ee/7sO7SCQ" target="_blank" rel="noopener" style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center;">
          OFAメンバー専用LINEへ問い合わせ
        </a>
      </div>

      <div class="hr"></div>

      <h2>② 操作（点呼 / 日報 / 履歴・月報）</h2>
      <div class="tabs">
        <button class="tabbtn active" data-tab="tenko">点呼（出発/帰着）</button>
        <button class="tabbtn" data-tab="daily">日報</button>
        <button class="tabbtn" data-tab="history">履歴 / 月報</button>
      </div>

      <!-- 点呼 -->
      <div class="section active" id="sec_tenko">
        <div class="note">
          <b>重要：</b>出発点呼→帰着点呼の順で入力。帰着ODOを入れると <b>走行距離（ODO差）</b> が自動計算され、日報に自動反映されます。
        </div>

        <div class="row two" style="margin-top:12px">
          <div>
            <label>点呼区分<span class="req">*</span></label>
            <select id="tenko_type">
              <option value="departure">出発（業務開始前）</option>
              <option value="arrival">帰着（業務終了後）</option>
            </select>
          </div>
          <div>
            <label>点呼日時（自動）</label>
            <input id="tenko_at" readonly />
          </div>
        </div>

        <div class="row two" style="margin-top:10px">
          <div>
            <label>点呼実施方法<span class="req">*</span></label>
            <select id="tenko_method">
              <option value="">選択</option>
              <option value="対面">対面</option>
              <option value="電話">電話</option>
              <option value="IT点呼">IT点呼</option>
              <option value="その他">その他</option>
            </select>
          </div>
          <div>
            <label>アルコール（数値）<span class="req">*</span></label>
            <input id="tenko_alcohol" inputmode="decimal" placeholder="例：0.00" />
          </div>
        </div>

        <div class="row two" style="margin-top:10px">
          <div>
            <label>酒気帯び判定<span class="req">*</span></label>
            <select id="tenko_alcJudge">
              <option value="">選択</option>
              <option value="なし">なし</option>
              <option value="疑い">疑い</option>
              <option value="あり">あり</option>
            </select>
          </div>
          <div>
            <label>睡眠時間（h）<span class="req">*</span></label>
            <input id="tenko_sleep" inputmode="decimal" placeholder="例：7.5" />
          </div>
        </div>

        <div class="row two" style="margin-top:10px">
          <div>
            <label>体温（℃）<span class="req">*</span></label>
            <input id="tenko_temp" inputmode="decimal" placeholder="例：36.5" />
          </div>
          <div>
            <label>体調<span class="req">*</span></label>
            <select id="tenko_condition">
              <option value="">選択</option>
              <option value="良好">良好</option>
              <option value="普通">普通</option>
              <option value="不調">不調</option>
            </select>
          </div>
        </div>

        <div class="row two" style="margin-top:10px">
          <div>
            <label>疲労<span class="req">*</span></label>
            <select id="tenko_fatigue">
              <option value="">選択</option>
              <option value="なし">なし</option>
              <option value="少し">少し</option>
              <option value="強い">強い</option>
            </select>
          </div>
          <div>
            <label>服薬<span class="req">*</span></label>
            <select id="tenko_medication">
              <option value="">選択</option>
              <option value="なし">なし</option>
              <option value="あり">あり</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>服薬内容（ありの場合）</label>
            <input id="tenko_med_detail" placeholder="例：風邪薬／頭痛薬など" />
          </div>
        </div>

        <div class="row two" style="margin-top:10px">
          <div>
            <label>ODO（出発）<span class="req">*</span></label>
            <input id="odo_departure" inputmode="numeric" placeholder="例：12345" />
          </div>
          <div>
            <label>ODO（帰着）<span class="req">*</span></label>
            <input id="odo_arrival" inputmode="numeric" placeholder="例：12420" />
            <div class="small" style="margin-top:6px">
              ※出発点呼のときは「ODO（出発）」だけ、帰着点呼のときは「ODO（帰着）」だけでOK
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>備考（自由記入）</label>
            <textarea id="tenko_memo" placeholder="例：体調注意点／イレギュラーなど"></textarea>
          </div>
        </div>

        <div class="hr"></div>

        <h3 style="margin:0 0 10px;font-size:15px">日常点検（スクロール入力・フル）</h3>
        <div class="note" style="margin-bottom:10px">
          <b>NG時は詳細メモ必須。</b>（写真は日報PDFに入れられます）
        </div>

        <div class="row two">
          <div>
            <label>エンジン始動/異音</label>
            <select id="chk_engine">
              <option value="OK">OK</option>
              <option value="NG">NG</option>
            </select>
          </div>
          <div>
            <label>ブレーキ</label>
            <select id="chk_brake">
              <option value="OK">OK</option>
              <option value="NG">NG</option>
            </select>
          </div>
        </div>

        <div class="row two" style="margin-top:10px">
          <div>
            <label>タイヤ（溝/空気圧）</label>
            <select id="chk_tire">
              <option value="OK">OK</option>
              <option value="NG">NG</option>
            </select>
          </div>
          <div>
            <label>ライト（前/後/ウインカー）</label>
            <select id="chk_light">
              <option value="OK">OK</option>
              <option value="NG">NG</option>
            </select>
          </div>
        </div>

        <div class="row two" style="margin-top:10px">
          <div>
            <label>オイル/冷却水</label>
            <select id="chk_oil">
              <option value="OK">OK</option>
              <option value="NG">NG</option>
            </select>
          </div>
          <div>
            <label>ワイパー/ウォッシャー</label>
            <select id="chk_wiper">
              <option value="OK">OK</option>
              <option value="NG">NG</option>
            </select>
          </div>
        </div>

        <div class="row two" style="margin-top:10px">
          <div>
            <label>積載状態（固定/荷崩れ）</label>
            <select id="chk_load">
              <option value="OK">OK</option>
              <option value="NG">NG</option>
            </select>
          </div>
          <div>
            <label>車体損傷（外装/ガラス）</label>
            <select id="chk_body">
              <option value="OK">OK</option>
              <option value="NG">NG</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>日常点検メモ（NG時は必須）</label>
            <textarea id="chk_memo" placeholder="例：ブレーキ鳴き／右前タイヤ空気圧低下 など"></textarea>
          </div>
        </div>

        <div class="btnrow">
          <button class="btn-primary" id="btnSaveTenko">この点呼を保存（端末内）</button>
          <button class="btn-ghost" id="btnTenkoPdf">点呼PDF（印刷/保存）</button>
          <button class="btn-ghost" id="btnTenkoCsv">点呼CSV（日本語）</button>
        </div>
      </div>

      <!-- 日報 -->
      <div class="section" id="sec_daily">
        <div class="note">
          <b>日報は保存“任意”。</b>ただし履歴/月報に出す場合は端末内に保存してください。写真はアップロードせず、PDFに埋め込みます。
        </div>

        <div class="row two" style="margin-top:12px">
          <div>
            <label>日付<span class="req">*</span></label>
            <input id="daily_date" type="date" />
          </div>
          <div>
            <label>案件数（複数案件対応）<span class="req">*</span></label>
            <input id="daily_jobs" inputmode="numeric" placeholder="例：3" />
          </div>
        </div>

        <div class="row two" style="margin-top:10px">
          <div>
            <label>出発ODO（自動反映）</label>
            <input id="daily_odo_start" readonly />
          </div>
          <div>
            <label>帰着ODO（自動反映）</label>
            <input id="daily_odo_end" readonly />
          </div>
        </div>

        <div class="row two" style="margin-top:10px">
          <div>
            <label>走行距離（ODO差）km（自動）</label>
            <input id="daily_km" readonly />
          </div>
          <div>
            <label>稼働時間（h）</label>
            <input id="daily_hours" inputmode="decimal" placeholder="例：9.5" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>日報写真（PDFに埋め込み／アップロードなし）</label>
            <input id="daily_photo" type="file" accept="image/*" multiple />
            <div class="small" style="margin-top:6px">※日報PDFに添付するだけ（端末内処理）</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>日報メモ</label>
            <textarea id="daily_memo" placeholder="例：遅延要因／注意点／改善点など"></textarea>
          </div>
        </div>

        <div class="btnrow">
          <button class="btn-primary" id="btnSaveDaily">日報を保存（端末内）</button>
          <button class="btn-ghost" id="btnDailyPdf">日報PDF（印刷/保存）</button>
          <button class="btn-ghost" id="btnDailyCsv">日報CSV（日本語）</button>
          <button class="btn-ghost" id="btnShareDaily">共有（iPhone最適）</button>
        </div>
      </div>

      <!-- 履歴/月報 -->
      <div class="section" id="sec_history">
        <div class="note">
          端末内に保存されたデータから <b>期間検索→月報CSV</b> を出します。<br/>
          ※この端末のデータのみ（管理者の全検索はサーバが必要なので、端末完結版では「端末ごとの月報」になります）
        </div>

        <div class="row two" style="margin-top:12px">
          <div>
            <label>期間（開始）</label>
            <input id="range_from" type="date" />
          </div>
          <div>
            <label>期間（終了）</label>
            <input id="range_to" type="date" />
          </div>
        </div>

        <div class="row two" style="margin-top:10px">
          <div>
            <label>種別</label>
            <select id="range_kind">
              <option value="all">すべて</option>
              <option value="tenko">点呼</option>
              <option value="daily">日報</option>
            </select>
          </div>
          <div>
            <label>拠点（端末の基本情報）</label>
            <input id="range_base" readonly />
          </div>
        </div>

        <div class="btnrow">
          <button class="btn-primary" id="btnSearch">検索</button>
          <button class="btn-ghost" id="btnExportMonthCsv">月報CSV（日本語）</button>
          <button class="btn-ghost" id="btnBackupJson">バックアップ書き出し（JSON）</button>
          <label class="btn-ghost" style="display:inline-flex;align-items:center;justify-content:center;gap:8px;">
            バックアップ取込（JSON）
            <input id="btnRestoreJson" type="file" accept="application/json" style="display:none" />
          </label>
          <button class="btn-danger" id="btnWipeAll">全データ削除（この端末）</button>
        </div>

        <div class="hr"></div>
        <div id="resultArea"></div>
      </div>
    </div>

    <div class="card">
      <h2>ステータス</h2>
      <div class="badge"><span class="dot" id="dotBase"></span><span id="baseStatus">基本情報：未保存</span></div>
      <div style="height:10px"></div>
      <div class="badge"><span class="dot" id="dotData"></span><span id="dataStatus">保存データ：0件</span></div>
      <div class="hr"></div>

      <h2>使い方（超短縮）</h2>
      <div class="note">
        1) 基本情報を保存<br/>
        2) 点呼：出発→帰着（ODO入力）<br/>
        3) 日報：ODO差が自動反映 → PDF/CSV/共有<br/>
        4) 履歴/月報：期間検索→月報CSV
      </div>

      <div class="hr"></div>
      <h2>共有導線</h2>
      <div class="note">
        iPhoneは「共有」ボタン → LINE/メールへ。<br/>
        PDFは「PDF（印刷/保存）」→ 共有（ファイルアプリ/LINE）で送れます。
      </div>

      <div class="btnrow">
        <a class="btn-line" href="https://lin.ee/7sO7SCQ" target="_blank" rel="noopener"
           style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center;">
          OFAメンバー専用LINEへ問い合わせ
        </a>
      </div>

      <div class="hr"></div>
      <div class="small">
        © OFA GROUP / 端末完結版
      </div>
    </div>
  </div>
</div>

<!-- 印刷用（PDF）DOM -->
<div id="printRoot">
  <div class="printWrap" id="printWrap"></div>
</div>

<div class="toast" id="toast"></div>

<div class="stickybar">
  <div class="wrap">
    <div>
      <button class="btn-ghost" id="btnJumpTenko">点呼へ</button>
      <button class="btn-ghost" id="btnJumpDaily">日報へ</button>
      <button class="btn-ghost" id="btnJumpHistory">履歴/月報へ</button>
    </div>
    <div>
      <button class="btn-primary" id="btnQuickPdf">今日のPDF（点呼+日報）</button>
    </div>
  </div>
</div>

<script>
/* =========================
   端末内保存（localStorage）
   ========================= */
const LS = {
  base: "ofa_base_v1",
  tenko: "ofa_tenko_v1",
  daily: "ofa_daily_v1"
};

const PREFS = [
  "北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県",
  "茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県",
  "新潟県","富山県","石川県","福井県","山梨県","長野県",
  "岐阜県","静岡県","愛知県","三重県",
  "滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県",
  "鳥取県","島根県","岡山県","広島県","山口県",
  "徳島県","香川県","愛媛県","高知県",
  "福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県",
  "その他/自由記入"
];

function nowLocalYMDHM(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function todayYMD(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=> t.style.display="none", 2200);
}
function loadJSON(key, fallback){
  try{
    const s = localStorage.getItem(key);
    if(!s) return fallback;
    return JSON.parse(s);
  }catch(e){ return fallback; }
}
function saveJSON(key, obj){
  localStorage.setItem(key, JSON.stringify(obj));
}
function dlBlob(filename, blob){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
}
function csvWithBOM(csvText){
  const bom = "\ufeff";
  return new Blob([bom + csvText], {type:"text/csv;charset=utf-8"});
}
function escapeCsv(v){
  const s = (v ?? "").toString();
  if(/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}
function toCSV(headers, rows){
  const head = headers.map(escapeCsv).join(",");
  const body = rows.map(r => r.map(escapeCsv).join(",")).join("\n");
  return head + "\n" + body;
}
async function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/* =========================
   UI初期化
   ========================= */
const el = id => document.getElementById(id);

function setTab(tab){
  document.querySelectorAll(".tabbtn").forEach(b=>{
    b.classList.toggle("active", b.dataset.tab===tab);
  });
  document.querySelectorAll(".section").forEach(s=>{
    s.classList.remove("active");
  });
  if(tab==="tenko") el("sec_tenko").classList.add("active");
  if(tab==="daily") el("sec_daily").classList.add("active");
  if(tab==="history") el("sec_history").classList.add("active");
}
document.querySelectorAll(".tabbtn").forEach(b=>{
  b.addEventListener("click", ()=> setTab(b.dataset.tab));
});

function initPrefs(){
  const sel = el("base_pref");
  sel.innerHTML = "";
  PREFS.forEach(p=>{
    const o=document.createElement("option");
    o.value=p; o.textContent=p;
    sel.appendChild(o);
  });
  sel.addEventListener("change", ()=>{
    const isFree = sel.value === "その他/自由記入";
    el("pref_free_wrap").style.display = isFree ? "block" : "none";
  });
}

function applyBaseToUI(base){
  el("base_name").value = base?.name ?? "";
  el("base_pref").value = base?.pref ?? "鹿児島県";
  el("base_pref").dispatchEvent(new Event("change"));
  el("base_pref_free").value = base?.prefFree ?? "";
  el("base_carNo").value = base?.carNo ?? "";
  el("base_licenseNo").value = base?.licenseNo ?? "";
  el("base_phone").value = base?.phone ?? "";
  el("base_email").value = base?.email ?? "";
  el("range_base").value = displayBasePref(base);
  updateStatus();
}

function displayBasePref(base){
  if(!base) return "";
  if(base.pref === "その他/自由記入") return base.prefFree || "（未入力）";
  return base.pref || "";
}

function requireBase(){
  const base = loadJSON(LS.base, null);
  if(!base) return {ok:false, msg:"基本情報が未保存です。先に保存してください。"};
  const prefText = (base.pref==="その他/自由記入") ? (base.prefFree||"") : (base.pref||"");
  if(!base.name || !prefText || !base.carNo || !base.licenseNo || !base.phone || !base.email){
    return {ok:false, msg:"基本情報に未入力があります（氏名/拠点/車番/免許番号/電話/メール）。"};
  }
  return {ok:true, base};
}

function updateStatus(){
  const base = loadJSON(LS.base, null);
  const tenko = loadJSON(LS.tenko, []);
  const daily = loadJSON(LS.daily, []);
  const total = (tenko?.length||0) + (daily?.length||0);

  el("dotBase").classList.toggle("off", !base);
  el("baseStatus").textContent = base ? `基本情報：保存済（${base.name} / ${displayBasePref(base)}）` : "基本情報：未保存";

  el("dotData").classList.toggle("off", total===0);
  el("dataStatus").textContent = `保存データ：${total}件（点呼${tenko.length} / 日報${daily.length}）`;
}

function initTenkoDefaults(){
  el("tenko_at").value = nowLocalYMDHM();
  setInterval(()=>{ el("tenko_at").value = nowLocalYMDHM(); }, 15000);

  el("tenko_type").addEventListener("change", ()=>{
    // 出発→ODO出発を、帰着→ODO帰着を主に使う
    const t = el("tenko_type").value;
    el("odo_departure").disabled = (t==="arrival");
    el("odo_arrival").disabled = (t==="departure");
  });
  el("tenko_type").dispatchEvent(new Event("change"));
}

function initDailyDefaults(){
  el("daily_date").value = todayYMD();
}

/* =========================
   保存処理：基本情報
   ========================= */
el("btnSaveBase").addEventListener("click", async ()=>{
  const name = el("base_name").value.trim();
  const pref = el("base_pref").value;
  const prefFree = el("base_pref_free").value.trim();
  const carNo = el("base_carNo").value.trim();
  const licenseNo = el("base_licenseNo").value.trim();
  const phone = el("base_phone").value.trim();
  const email = el("base_email").value.trim();

  const prefText = (pref==="その他/自由記入") ? prefFree : pref;
  if(!name || !prefText || !carNo || !licenseNo || !phone || !email){
    toast("未入力があります（氏名/拠点/車番/免許/電話/メール）");
    return;
  }

  // 免許写真は端末内にDataURL保存（サイズが大きいとlocalStorage制限に引っかかるので注意）
  let licensePhotoDataUrl = null;
  const f = el("base_licensePhoto").files?.[0];
  if(f){
    try{
      licensePhotoDataUrl = await fileToDataURL(f);
    }catch(e){
      toast("免許写真の読み込みに失敗");
      return;
    }
  }else{
    // 既存を保持
    const old = loadJSON(LS.base, null);
    licensePhotoDataUrl = old?.licensePhotoDataUrl ?? null;
  }

  saveJSON(LS.base, {
    name, pref, prefFree, carNo, licenseNo, phone, email,
    licensePhotoDataUrl,
    savedAt: new Date().toISOString()
  });
  updateStatus();
  el("range_base").value = prefText;
  toast("基本情報を保存しました");
});

el("btnClearBase").addEventListener("click", ()=>{
  if(!confirm("基本情報をリセットしますか？")) return;
  localStorage.removeItem(LS.base);
  applyBaseToUI(null);
  toast("基本情報をリセットしました");
});

/* =========================
   保存処理：点呼
   ========================= */
function buildTenkoRecord(){
  const chkBase = requireBase();
  if(!chkBase.ok) return {ok:false, msg:chkBase.msg};

  const type = el("tenko_type").value; // departure / arrival
  const at = el("tenko_at").value;
  const method = el("tenko_method").value;
  const alcohol = el("tenko_alcohol").value.trim();
  const alcJudge = el("tenko_alcJudge").value;
  const sleepHours = el("tenko_sleep").value.trim();
  const bodyTemp = el("tenko_temp").value.trim();
  const condition = el("tenko_condition").value;
  const fatigue = el("tenko_fatigue").value;
  const medication = el("tenko_medication").value;
  const medicationDetail = el("tenko_med_detail").value.trim();

  const odoStart = el("odo_departure").value.trim();
  const odoEnd = el("odo_arrival").value.trim();
  const memo = el("tenko_memo").value.trim();

  const check = {
    engine: el("chk_engine").value,
    brake: el("chk_brake").value,
    tire: el("chk_tire").value,
    light: el("chk_light").value,
    oil: el("chk_oil").value,
    wiper: el("chk_wiper").value,
    load: el("chk_load").value,
    body: el("chk_body").value,
    memo: el("chk_memo").value.trim()
  };
  const hasNG = Object.values(check).includes("NG");
  if(hasNG && !check.memo){
    return {ok:false, msg:"日常点検でNGがあります。点検メモ（詳細）を入力してください。"};
  }

  // 必須チェック
  if(!method || alcohol==="" || !alcJudge || sleepHours==="" || bodyTemp==="" || !condition || !fatigue || !medication){
    return {ok:false, msg:"点呼の必須項目が未入力です（方法/アルコール/判定/睡眠/体温/体調/疲労/服薬）。"};
  }
  if(type==="departure" && !odoStart) return {ok:false, msg:"出発点呼はODO（出発）が必須です。"};
  if(type==="arrival" && !odoEnd) return {ok:false, msg:"帰着点呼はODO（帰着）が必須です。"};

  const base = chkBase.base;
  const prefText = displayBasePref(base);

  const id = "T_" + Date.now() + "_" + Math.random().toString(16).slice(2);
  const record = {
    id,
    kind:"tenko",
    tenkoType: (type==="departure") ? "出発" : "帰着",
    tenkoAt: at,
    name: base.name,
    base: prefText,
    carNo: base.carNo,
    licenseNo: base.licenseNo,
    phone: base.phone,
    email: base.email,
    method, alcohol, alcJudge,
    sleepHours, bodyTemp, condition, fatigue,
    medication, medicationDetail,
    odoDeparture: odoStart || "",
    odoArrival: odoEnd || "",
    memo,
    dailyCheck: check,
    createdAt: new Date().toISOString()
  };

  return {ok:true, record};
}

function saveTenkoAndReflect(tenkoRecord){
  const tenko = loadJSON(LS.tenko, []);
  tenko.unshift(tenkoRecord);
  saveJSON(LS.tenko, tenko);

  // ODO反映：最新の出発ODO / 帰着ODO を日報へ反映して差分計算
  const dep = findLatestTenko("出発");
  const arr = findLatestTenko("帰着");
  el("daily_odo_start").value = dep?.odoDeparture || "";
  el("daily_odo_end").value = arr?.odoArrival || "";
  reflectKmToDaily();

  updateStatus();
}

function findLatestTenko(typeLabel){ // "出発" or "帰着"
  const tenko = loadJSON(LS.tenko, []);
  return tenko.find(t => t.tenkoType === typeLabel) || null;
}

function reflectKmToDaily(){
  const s = parseInt(el("daily_odo_start").value || "", 10);
  const e = parseInt(el("daily_odo_end").value || "", 10);
  if(Number.isFinite(s) && Number.isFinite(e) && e >= s){
    el("daily_km").value = String(e - s);
  }else{
    el("daily_km").value = "";
  }
}

el("odo_departure").addEventListener("input", ()=>{
  // 出発ODOを日報へ
  el("daily_odo_start").value = el("odo_departure").value.trim();
  reflectKmToDaily();
});
el("odo_arrival").addEventListener("input", ()=>{
  // 帰着ODOを日報へ
  el("daily_odo_end").value = el("odo_arrival").value.trim();
  reflectKmToDaily();
});

el("btnSaveTenko").addEventListener("click", ()=>{
  const built = buildTenkoRecord();
  if(!built.ok){ toast(built.msg); return; }
  saveTenkoAndReflect(built.record);
  toast("点呼を保存しました（端末内）");
});

el("btnTenkoCsv").addEventListener("click", ()=>{
  const built = buildTenkoRecord();
  if(!built.ok){ toast(built.msg); return; }
  const r = built.record;

  const headers = [
    "種別","点呼区分","点呼日時","氏名","拠点","車両番号","免許番号","電話","メール",
    "点呼方法","アルコール数値","酒気帯び判定","睡眠時間(h)","体温(℃)","体調","疲労","服薬","服薬内容",
    "出発ODO","帰着ODO","備考",
    "点検_エンジン","点検_ブレーキ","点検_タイヤ","点検_ライト","点検_オイル/冷却水","点検_ワイパー","点検_積載","点検_車体損傷","点検メモ"
  ];
  const rows = [[
    "点呼", r.tenkoType, r.tenkoAt, r.name, r.base, r.carNo, r.licenseNo, r.phone, r.email,
    r.method, r.alcohol, r.alcJudge, r.sleepHours, r.bodyTemp, r.condition, r.fatigue, r.medication, r.medicationDetail,
    r.odoDeparture, r.odoArrival, r.memo,
    r.dailyCheck.engine, r.dailyCheck.brake, r.dailyCheck.tire, r.dailyCheck.light, r.dailyCheck.oil, r.dailyCheck.wiper, r.dailyCheck.load, r.dailyCheck.body, r.dailyCheck.memo
  ]];

  const csv = toCSV(headers, rows);
  dlBlob(`OFA_tenko_${todayYMD()}_${r.tenkoType}.csv`, csvWithBOM(csv));
  toast("点呼CSVを出力しました（日本語）");
});

el("btnTenkoPdf").addEventListener("click", async ()=>{
  const built = buildTenkoRecord();
  if(!built.ok){ toast(built.msg); return; }
  const base = loadJSON(LS.base, null);
  await renderPrintDoc({
    mode:"点呼",
    base,
    tenko: built.record,
    daily: null,
    photos: []
  });
  toast("PDFは「共有」ではなく「印刷→PDF保存」で確実に送れます");
  setTimeout(()=>window.print(), 250);
});

/* =========================
   保存処理：日報
   ========================= */
async function buildDailyRecord(){
  const chkBase = requireBase();
  if(!chkBase.ok) return {ok:false, msg:chkBase.msg};
  const base = chkBase.base;

  const date = el("daily_date").value;
  const jobs = el("daily_jobs").value.trim();
  if(!date || !jobs) return {ok:false, msg:"日報の必須（日付/案件数）が未入力です。"};

  // ODO差は点呼から自動反映
  const odoStart = el("daily_odo_start").value.trim();
  const odoEnd = el("daily_odo_end").value.trim();
  const km = el("daily_km").value.trim();
  const hours = el("daily_hours").value.trim();
  const memo = el("daily_memo").value.trim();

  // 写真（複数）をDataURLに
  const files = Array.from(el("daily_photo").files || []);
  const photos = [];
  for(const f of files){
    try{
      const url = await fileToDataURL(f);
      photos.push(url);
    }catch(e){
      return {ok:false, msg:"日報写真の読み込みに失敗しました。"};
    }
  }

  const prefText = displayBasePref(base);
  const id = "D_" + Date.now() + "_" + Math.random().toString(16).slice(2);
  const record = {
    id,
    kind:"daily",
    date,
    name: base.name,
    base: prefText,
    carNo: base.carNo,
    licenseNo: base.licenseNo,
    phone: base.phone,
    email: base.email,
    jobs,
    odoStart, odoEnd, km,
    hours,
    memo,
    photoCount: photos.length,
    photos, // 端末内保存（容量注意）
    createdAt: new Date().toISOString()
  };
  return {ok:true, record};
}

el("btnSaveDaily").addEventListener("click", async ()=>{
  const built = await buildDailyRecord();
  if(!built.ok){ toast(built.msg); return; }
  const daily = loadJSON(LS.daily, []);
  daily.unshift(built.record);
  saveJSON(LS.daily, daily);
  updateStatus();
  toast("日報を保存しました（端末内）");
});

el("btnDailyCsv").addEventListener("click", async ()=>{
  const built = await buildDailyRecord();
  if(!built.ok){ toast(built.msg); return; }
  const r = built.record;

  const headers = [
    "種別","日付","氏名","拠点","車両番号","免許番号","電話","メール",
    "案件数","出発ODO","帰着ODO","走行距離(km)","稼働時間(h)","メモ","写真枚数"
  ];
  const rows = [[
    "日報", r.date, r.name, r.base, r.carNo, r.licenseNo, r.phone, r.email,
    r.jobs, r.odoStart, r.odoEnd, r.km, r.hours, r.memo, r.photoCount
  ]];
  const csv = toCSV(headers, rows);
  dlBlob(`OFA_nippou_${r.date}.csv`, csvWithBOM(csv));
  toast("日報CSVを出力しました（日本語）");
});

el("btnDailyPdf").addEventListener("click", async ()=>{
  const built = await buildDailyRecord();
  if(!built.ok){ toast(built.msg); return; }
  const base = loadJSON(LS.base, null);

  // 点呼（最新）も一緒に入れると報告書っぽくなる
  const dep = findLatestTenko("出発");
  const arr = findLatestTenko("帰着");

  await renderPrintDoc({
    mode:"日報",
    base,
    tenko: {dep, arr},
    daily: built.record,
    photos: built.record.photos || []
  });
  toast("PDFは「印刷→PDF保存」が確実（日本語文字化け無し）");
  setTimeout(()=>window.print(), 250);
});

el("btnShareDaily").addEventListener("click", async ()=>{
  // 共有は“CSV”を作って送る（iPhone最適）
  const built = await buildDailyRecord();
  if(!built.ok){ toast(built.msg); return; }
  const r = built.record;

  const headers = [
    "種別","日付","氏名","拠点","車両番号","免許番号","電話","メール",
    "案件数","出発ODO","帰着ODO","走行距離(km)","稼働時間(h)","メモ","写真枚数"
  ];
  const rows = [[
    "日報", r.date, r.name, r.base, r.carNo, r.licenseNo, r.phone, r.email,
    r.jobs, r.odoStart, r.odoEnd, r.km, r.hours, r.memo, r.photoCount
  ]];
  const csv = toCSV(headers, rows);
  const blob = csvWithBOM(csv);
  const file = new File([blob], `OFA_nippou_${r.date}.csv`, {type:"text/csv;charset=utf-8"});

  if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
    try{
      await navigator.share({
        title:`OFA 日報 ${r.date}`,
        text:`OFA 日報（CSV） ${r.name} / ${r.base}`,
        files:[file]
      });
      toast("共有しました");
      return;
    }catch(e){
      toast("共有をキャンセルしました");
      return;
    }
  }

  // 共有不可端末はDL
  dlBlob(file.name, blob);
  toast("この端末は共有非対応のためダウンロードしました");
});

/* =========================
   履歴/月報
   ========================= */
function parseDateYMD(s){
  if(!s) return null;
  const d = new Date(s+"T00:00:00");
  return isNaN(d.getTime()) ? null : d;
}
function inRange(dateStr, fromStr, toStr){
  const d = parseDateYMD(dateStr);
  if(!d) return false;
  const f = parseDateYMD(fromStr);
  const t = parseDateYMD(toStr);
  if(f && d < f) return false;
  if(t && d > t) return false;
  return true;
}

el("btnSearch").addEventListener("click", ()=>{
  const from = el("range_from").value;
  const to = el("range_to").value;
  const kind = el("range_kind").value;

  const tenko = loadJSON(LS.tenko, []);
  const daily = loadJSON(LS.daily, []);

  const res = [];
  if(kind==="all" || kind==="tenko"){
    tenko.forEach(t=>{
      // tenkoAtは "YYYY-MM-DD HH:mm" 形式 → 日付だけ取り出し
      const dt = (t.tenkoAt || "").slice(0,10);
      if(inRange(dt, from, to)) res.push({type:"点呼", key: t.tenkoAt, obj:t});
    });
  }
  if(kind==="all" || kind==="daily"){
    daily.forEach(d=>{
      if(inRange(d.date, from, to)) res.push({type:"日報", key: d.date, obj:d});
    });
  }

  res.sort((a,b)=> (a.key>b.key ? -1 : 1));

  renderResult(res);
  toast(`検索結果：${res.length}件`);
});

function renderResult(items){
  const area = el("resultArea");
  if(!items.length){
    area.innerHTML = `<div class="note">検索結果がありません。</div>`;
    return;
  }
  let html = `
    <table class="table">
      <thead>
        <tr>
          <th>種別</th><th>日時/日付</th><th>内容</th><th>操作</th>
        </tr>
      </thead>
      <tbody>
  `;
  items.forEach(it=>{
    const o = it.obj;
    const when = it.type==="点呼" ? o.tenkoAt : o.date;
    const summary = it.type==="点呼"
      ? `${o.tenkoType} / ODO 出:${o.odoDeparture||"-"} → 帰:${o.odoArrival||"-"} / アル:${o.alcohol}`
      : `案件:${o.jobs} / km:${o.km||"-"} / 稼働:${o.hours||"-"} / 写真:${o.photoCount||0}`;
    html += `
      <tr>
        <td>${it.type}</td>
        <td class="mono">${escapeHtml(when)}</td>
        <td>${escapeHtml(summary)}</td>
        <td>
          <button class="btn-ghost" data-act="view" data-id="${o.id}">表示</button>
          <button class="btn-danger" data-act="del" data-id="${o.id}">削除</button>
        </td>
      </tr>
    `;
  });
  html += `</tbody></table>`;
  area.innerHTML = html;

  area.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.dataset.id;
      const act = btn.dataset.act;

      // 探す
      const tenko = loadJSON(LS.tenko, []);
      const daily = loadJSON(LS.daily, []);
      const t = tenko.find(x=>x.id===id);
      const d = daily.find(x=>x.id===id);

      if(act==="del"){
        if(!confirm("削除しますか？")) return;
        if(t){
          saveJSON(LS.tenko, tenko.filter(x=>x.id!==id));
        }else if(d){
          saveJSON(LS.daily, daily.filter(x=>x.id!==id));
        }
        updateStatus();
        toast("削除しました");
        el("btnSearch").click();
        return;
      }

      if(act==="view"){
        const base = loadJSON(LS.base, null);
        if(t){
          await renderPrintDoc({mode:"点呼", base, tenko:t, daily:null, photos:[]});
          setTimeout(()=>window.print(), 200);
        }else if(d){
          const dep = findLatestTenko("出発");
          const arr = findLatestTenko("帰着");
          await renderPrintDoc({mode:"日報", base, tenko:{dep,arr}, daily:d, photos:d.photos||[]});
          setTimeout(()=>window.print(), 200);
        }
      }
    });
  });
}

function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

el("btnExportMonthCsv").addEventListener("click", ()=>{
  const from = el("range_from").value;
  const to = el("range_to").value;
  const kind = el("range_kind").value;

  const tenko = loadJSON(LS.tenko, []);
  const daily = loadJSON(LS.daily, []);

  const rows = [];
  const headers = [
    "種別","日付/日時","氏名","拠点","車両番号","免許番号","電話","メール",
    "点呼区分","点呼方法","アルコール数値","判定","睡眠(h)","体温(℃)","体調","疲労","服薬","服薬内容","出発ODO","帰着ODO",
    "日報_案件数","日報_km","日報_稼働(h)","日報_メモ","日報_写真枚数"
  ];

  if(kind==="all" || kind==="tenko"){
    tenko.forEach(t=>{
      const dt = (t.tenkoAt||"").slice(0,10);
      if(inRange(dt, from, to)){
        rows.push([
          "点呼", t.tenkoAt, t.name, t.base, t.carNo, t.licenseNo, t.phone, t.email,
          t.tenkoType, t.method, t.alcohol, t.alcJudge, t.sleepHours, t.bodyTemp, t.condition, t.fatigue, t.medication, t.medicationDetail,
          t.odoDeparture, t.odoArrival,
          "","","","",""
        ]);
      }
    });
  }
  if(kind==="all" || kind==="daily"){
    daily.forEach(d=>{
      if(inRange(d.date, from, to)){
        rows.push([
          "日報", d.date, d.name, d.base, d.carNo, d.licenseNo, d.phone, d.email,
          "","","","","","","","","","", "",
          d.jobs, d.km, d.hours, d.memo, d.photoCount
        ]);
      }
    });
  }

  if(!rows.length){ toast("対象データがありません"); return; }
  const csv = toCSV(headers, rows);
  const name = `OFA_month_${from||"all"}_${to||"all"}.csv`;
  dlBlob(name, csvWithBOM(csv));
  toast("月報CSVを出力しました（日本語）");
});

el("btnBackupJson").addEventListener("click", ()=>{
  const payload = {
    base: loadJSON(LS.base, null),
    tenko: loadJSON(LS.tenko, []),
    daily: loadJSON(LS.daily, []),
    exportedAt: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json;charset=utf-8"});
  dlBlob(`OFA_backup_${todayYMD()}.json`, blob);
  toast("バックアップを書き出しました");
});

el("btnRestoreJson").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  try{
    const txt = await file.text();
    const json = JSON.parse(txt);
    if(json.base) saveJSON(LS.base, json.base);
    if(Array.isArray(json.tenko)) saveJSON(LS.tenko, json.tenko);
    if(Array.isArray(json.daily)) saveJSON(LS.daily, json.daily);
    applyBaseToUI(loadJSON(LS.base,null));
    updateStatus();
    toast("バックアップを取り込みました");
  }catch(err){
    toast("JSON取込に失敗しました");
  }finally{
    e.target.value = "";
  }
});

el("btnWipeAll").addEventListener("click", ()=>{
  if(!confirm("この端末の全データ（基本/点呼/日報）を削除します。よろしいですか？")) return;
  localStorage.removeItem(LS.base);
  localStorage.removeItem(LS.tenko);
  localStorage.removeItem(LS.daily);
  applyBaseToUI(null);
  updateStatus();
  el("resultArea").innerHTML = "";
  toast("全データを削除しました");
});

/* =========================
   印刷（PDF）レンダリング
   ========================= */
async function renderPrintDoc({mode, base, tenko, daily, photos}){
  const wrap = el("printWrap");
  const basePref = displayBasePref(base);

  // 免許写真（基本情報） + 日報写真
  const licensePhoto = base?.licensePhotoDataUrl ? `<img src="${base.licensePhotoDataUrl}" alt="免許写真" />` : "";
  let dailyPhotos = "";
  if(Array.isArray(photos) && photos.length){
    dailyPhotos = photos.map(u=> `<img src="${u}" alt="日報写真" />`).join("");
  }

  const dep = (tenko?.dep) ? tenko.dep : (tenko?.tenkoType==="出発" ? tenko : null);
  const arr = (tenko?.arr) ? tenko.arr : (tenko?.tenkoType==="帰着" ? tenko : null);

  const odoStart = daily?.odoStart || dep?.odoDeparture || "";
  const odoEnd = daily?.odoEnd || arr?.odoArrival || "";
  const km = daily?.km || (Number.isFinite(parseInt(odoStart,10)) && Number.isFinite(parseInt(odoEnd,10)) ? (parseInt(odoEnd,10)-parseInt(odoStart,10)) : "");

  wrap.innerHTML = `
    <div class="printHead">
      <div class="printBrand">
        <div class="mark"></div>
        <div>
          <p class="printTitle" style="margin:0;font-weight:900;">OFA 報告書（${escapeHtml(mode)}）</p>
          <div style="font-size:12px;color:#333;">One for All, All for One</div>
        </div>
      </div>
      <div class="printMeta">
        <div>作成：${escapeHtml(nowLocalYMDHM())}</div>
        <div>氏名：${escapeHtml(base?.name||"")}</div>
        <div>拠点：${escapeHtml(basePref||"")}</div>
      </div>
    </div>

    <div class="printBox">
      <div class="cap">基本情報</div>
      <div class="body">
        <div class="printGrid">
          <div class="printKV"><b>氏名</b><span>${escapeHtml(base?.name||"")}</span></div>
          <div class="printKV"><b>拠点</b><span>${escapeHtml(basePref||"")}</span></div>
          <div class="printKV"><b>車両番号</b><span>${escapeHtml(base?.carNo||"")}</span></div>
          <div class="printKV"><b>免許番号</b><span>${escapeHtml(base?.licenseNo||"")}</span></div>
          <div class="printKV"><b>電話</b><span>${escapeHtml(base?.phone||"")}</span></div>
          <div class="printKV"><b>メール</b><span>${escapeHtml(base?.email||"")}</span></div>
        </div>

        ${base?.licensePhotoDataUrl ? `
          <div style="margin-top:10px;font-weight:800;font-size:12px">運転免許証（写真）</div>
          <div class="photos">${licensePhoto}</div>
        ` : ``}
      </div>
    </div>

    <div class="printBox">
      <div class="cap">点呼（出発 / 帰着）</div>
      <div class="body">
        <table class="printTable">
          <tr>
            <th style="width:22%">項目</th>
            <th>出発</th>
            <th>帰着</th>
          </tr>
          <tr>
            <th>点呼日時</th>
            <td>${escapeHtml(dep?.tenkoAt||"")}</td>
            <td>${escapeHtml(arr?.tenkoAt||"")}</td>
          </tr>
          <tr>
            <th>点呼方法</th>
            <td>${escapeHtml(dep?.method||"")}</td>
            <td>${escapeHtml(arr?.method||"")}</td>
          </tr>
          <tr>
            <th>アルコール / 判定</th>
            <td>${escapeHtml(dep?.alcohol||"")} / ${escapeHtml(dep?.alcJudge||"")}</td>
            <td>${escapeHtml(arr?.alcohol||"")} / ${escapeHtml(arr?.alcJudge||"")}</td>
          </tr>
          <tr>
            <th>睡眠(h) / 体温(℃)</th>
            <td>${escapeHtml(dep?.sleepHours||"")} / ${escapeHtml(dep?.bodyTemp||"")}</td>
            <td>${escapeHtml(arr?.sleepHours||"")} / ${escapeHtml(arr?.bodyTemp||"")}</td>
          </tr>
          <tr>
            <th>体調 / 疲労</th>
            <td>${escapeHtml(dep?.condition||"")} / ${escapeHtml(dep?.fatigue||"")}</td>
            <td>${escapeHtml(arr?.condition||"")} / ${escapeHtml(arr?.fatigue||"")}</td>
          </tr>
          <tr>
            <th>ODO</th>
            <td>出発：${escapeHtml(dep?.odoDeparture||"")}</td>
            <td>帰着：${escapeHtml(arr?.odoArrival||"")}</td>
          </tr>
          <tr>
            <th>備考</th>
            <td>${escapeHtml(dep?.memo||"")}</td>
            <td>${escapeHtml(arr?.memo||"")}</td>
          </tr>
        </table>

        <div style="margin-top:10px;font-weight:900;font-size:12px">日常点検</div>
        <table class="printTable">
          <tr>
            <th>エンジン</th><th>ブレーキ</th><th>タイヤ</th><th>ライト</th><th>オイル/冷却水</th><th>ワイパー</th><th>積載</th><th>車体損傷</th>
          </tr>
          <tr>
            <td>${escapeHtml((dep?.dailyCheck||arr?.dailyCheck||{}).engine||"")}</td>
            <td>${escapeHtml((dep?.dailyCheck||arr?.dailyCheck||{}).brake||"")}</td>
            <td>${escapeHtml((dep?.dailyCheck||arr?.dailyCheck||{}).tire||"")}</td>
            <td>${escapeHtml((dep?.dailyCheck||arr?.dailyCheck||{}).light||"")}</td>
            <td>${escapeHtml((dep?.dailyCheck||arr?.dailyCheck||{}).oil||"")}</td>
            <td>${escapeHtml((dep?.dailyCheck||arr?.dailyCheck||{}).wiper||"")}</td>
            <td>${escapeHtml((dep?.dailyCheck||arr?.dailyCheck||{}).load||"")}</td>
            <td>${escapeHtml((dep?.dailyCheck||arr?.dailyCheck||{}).body||"")}</td>
          </tr>
          <tr>
            <th colspan="8">点検メモ</th>
          </tr>
          <tr>
            <td colspan="8">${escapeHtml((dep?.dailyCheck||arr?.dailyCheck||{}).memo||"")}</td>
          </tr>
        </table>
      </div>
    </div>

    ${daily ? `
      <div class="printBox">
        <div class="cap">日報</div>
        <div class="body">
          <div class="printGrid">
            <div class="printKV"><b>日付</b><span>${escapeHtml(daily.date||"")}</span></div>
            <div class="printKV"><b>案件数</b><span>${escapeHtml(daily.jobs||"")}</span></div>
            <div class="printKV"><b>出発ODO</b><span>${escapeHtml(odoStart||"")}</span></div>
            <div class="printKV"><b>帰着ODO</b><span>${escapeHtml(odoEnd||"")}</span></div>
            <div class="printKV"><b>走行距離(km)</b><span>${escapeHtml(km||"")}</span></div>
            <div class="printKV"><b>稼働時間(h)</b><span>${escapeHtml(daily.hours||"")}</span></div>
          </div>

          <div style="margin-top:10px;font-weight:900;font-size:12px">メモ</div>
          <div style="border:1px solid #333;border-radius:10px;padding:10px;font-size:12px;white-space:pre-wrap;">${escapeHtml(daily.memo||"")}</div>

          ${photos && photos.length ? `
            <div style="margin-top:10px;font-weight:900;font-size:12px">日報写真（PDF埋め込み）</div>
            <div class="photos">${dailyPhotos}</div>
          `:``}
        </div>
      </div>
    `:``}

    <div style="margin-top:14px;font-size:11px;color:#333;text-align:center;">
      © OFA GROUP
    </div>
  `;
}

/* =========================
   便利ボタン（ジャンプ）
   ========================= */
el("btnJumpTenko").addEventListener("click", ()=>{ setTab("tenko"); window.scrollTo({top:0,behavior:"smooth"}); });
el("btnJumpDaily").addEventListener("click", ()=>{ setTab("daily"); window.scrollTo({top:0,behavior:"smooth"}); });
el("btnJumpHistory").addEventListener("click", ()=>{ setTab("history"); window.scrollTo({top:0,behavior:"smooth"}); });

el("btnQuickPdf").addEventListener("click", async ()=>{
  const base = loadJSON(LS.base, null);
  const chk = requireBase();
  if(!chk.ok){ toast(chk.msg); return; }
  const dep = findLatestTenko("出発");
  const arr = findLatestTenko("帰着");

  // 今日の日報（保存済みから探す）
  const daily = loadJSON(LS.daily, []);
  const today = todayYMD();
  const d = daily.find(x=>x.date===today) || null;

  await renderPrintDoc({mode:"総合", base, tenko:{dep,arr}, daily:d, photos:d?.photos||[]});
  toast("総合PDFを開きました（印刷→PDF保存）");
  setTimeout(()=>window.print(), 250);
});

/* =========================
   起動時
   ========================= */
(function boot(){
  initPrefs();
  initTenkoDefaults();
  initDailyDefaults();

  const base = loadJSON(LS.base, null);
  applyBaseToUI(base);

  // 日報に最新ODO反映
  const dep = findLatestTenko("出発");
  const arr = findLatestTenko("帰着");
  el("daily_odo_start").value = dep?.odoDeparture || "";
  el("daily_odo_end").value = arr?.odoArrival || "";
  reflectKmToDaily();

  updateStatus();
})();
</script>
</body>
</html>
